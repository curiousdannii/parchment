/*
 * Simple JavaScript Inheritance
 * http://ejohn.org/blog/simple-javascript-inheritance/
 *
 * By John Resig
 * Released into the public domain?
 *
 * Inspired by base2 and Prototype
 */
(function(){var b=false,a=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){};Class.extend=function(g){var c=this.prototype;b=true;var f=new this();b=false;for(var e in g){f[e]=typeof g[e]=="function"&&typeof c[e]=="function"&&a.test(g[e])?(function(h,i){return function(){var k=this._super;this._super=c[h];var j=i.apply(this,arguments);this._super=k;return j}})(e,g[e]):g[e]}function d(){if(!b&&this.init){this.init.apply(this,arguments)}}d.prototype=f;d.constructor=d;d.extend=arguments.callee;return d}})();
/*
 * Interchange File Format library
 *
 * Copyright (c) 2003-2009 The Gnusto Contributors
 * Licenced under the GPL v2
 * http://github.com/curiousdannii/gnusto
 */
(function(){var b=function(e,f){return e[f]<<24|e[f+1]<<16|e[f+2]<<8|e[f+3]},a=function(f,g){var e=String.fromCharCode;return e(f[g])+e(f[g+1])+e(f[g+2])+e(f[g+3])},d=Class.extend({init:function c(g){this.type="";this.chunks=[];if(g){if(a(g,0)!="FORM"){throw new Error("Not an IFF file")}this.type=a(g,8);var f=12,e=g.length;while(f<e){var h=b(g,f+4);if(h<0||(h+f)>e){throw new Error("IFF: Chunk out of range")}this.chunks.push({type:a(g,f),offset:f,data:g.slice(f+8,f+8+h)});f+=8+h;if(h%2){f++}}}}});d.num_from=b;d.text_from=a;window.IFF=d})();
/*
 * Copyright (c) 2006 Brandon Aaron (brandon.aaron@gmail.com || http://brandonaaron.net)
 * Dual licensed under the MIT (http://www.opensource.org/licenses/mit-license.php)
 * and GPL (http://www.opensource.org/licenses/gpl-license.php) licenses.
 * Thanks to: http://adomas.org/javascript-mouse-wheel/ for some pointers.
 * Thanks to: Mathias Bank(http://www.mathias-bank.de) for a scope bug fix.
 *
 * $LastChangedDate: 2007-12-20 09:02:08 -0600 (Thu, 20 Dec 2007) $
 * $Rev: 4265 $
 *
 * Version: 3.0
 * 
 * Requires: $ 1.2.2+
 */
(function(a){a.event.special.mousewheel={setup:function(){var b=a.event.special.mousewheel.handler;if(a.browser.mozilla){a(this).bind("mousemove.mousewheel",function(c){a.data(this,"mwcursorposdata",{pageX:c.pageX,pageY:c.pageY,clientX:c.clientX,clientY:c.clientY})})}if(this.addEventListener){this.addEventListener((a.browser.mozilla?"DOMMouseScroll":"mousewheel"),b,false)}else{this.onmousewheel=b}},teardown:function(){var b=a.event.special.mousewheel.handler;a(this).unbind("mousemove.mousewheel");if(this.removeEventListener){this.removeEventListener((a.browser.mozilla?"DOMMouseScroll":"mousewheel"),b,false)}else{this.onmousewheel=function(){}}a.removeData(this,"mwcursorposdata")},handler:function(d){var c=Array.prototype.slice.call(arguments,1);d=a.event.fix(d||window.event);a.extend(d,a.data(this,"mwcursorposdata")||{});var e=0,b=true;if(d.wheelDelta){e=d.wheelDelta/120}if(d.detail){e=-d.detail/3}if(a.browser.opera){e=-d.wheelDelta}d.data=d.data||{};d.type="mousewheel";c.unshift(e);c.unshift(d);return a.event.handle.apply(this,c)}};a.fn.extend({mousewheel:function(b){return b?this.bind("mousewheel",b):this.trigger("mousewheel")},unmousewheel:function(b){return this.unbind("mousewheel",b)}})})(jQuery);
/*
(c) Copyrights 2007 - 2008

Original idea by by Binny V A, http://www.openjs.com/scripts/events/keyboard_shortcuts/
 
jQuery Plugin by Tzury Bar Yochay 
tzury.by@gmail.com
http://evalinux.wordpress.com
http://facebook.com/profile.php?id=513676303

Project's sites: 
http://code.google.com/p/js-hotkeys/
http://github.com/tzuryby/hotkeys/tree/master

License: same as jQuery license. 
*/
(function(b){b.fn.__bind__=b.fn.bind;b.fn.__unbind__=b.fn.unbind;b.fn.__find__=b.fn.find;var a={version:"0.7.8",override:/keydown|keypress|keyup/g,triggersMap:{},specialKeys:{27:"esc",9:"tab",32:"space",13:"return",8:"backspace",145:"scroll",20:"capslock",144:"numlock",19:"pause",45:"insert",36:"home",46:"del",35:"end",33:"pageup",34:"pagedown",37:"left",38:"up",39:"right",40:"down",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12"},shiftNums:{"`":"~","1":"!","2":"@","3":"#","4":"$","5":"%","6":"^","7":"&","8":"*","9":"(","0":")","-":"_","=":"+",";":":","'":'"',",":"<",".":">","/":"?","\\":"|"},newTrigger:function(d,c,f){var e={};e[d]={};e[d][c]={cb:f,disableInInput:false};return e}};if(b.browser.mozilla){a.specialKeys=b.extend(a.specialKeys,{96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9"})}b.fn.find=function(c){this.query=c;return b.fn.__find__.apply(this,arguments)};b.fn.unbind=function(h,f,g){if(b.isFunction(f)){g=f;f=null}if(f&&typeof f==="string"){var e=((this.prevObject&&this.prevObject.query)||(this[0].id&&this[0].id)||this[0]).toString();var d=h.split(" ");for(var c=0;c<d.length;c++){delete a.triggersMap[e][d[c]][f]}}return this.__unbind__(h,g)};b.fn.bind=function(j,g,k){var e=j.match(a.override);if(b.isFunction(g)||!e){return this.__bind__(j,g,k)}else{var l=null,f=b.trim(j.replace(a.override,""));if(f){l=this.__bind__(f,g,k)}if(typeof g==="string"){g={combi:g}}if(g.combi){for(var m=0;m<e.length;m++){var d=e[m];var h=g.combi.toLowerCase(),i=a.newTrigger(d,h,k),n=((this.prevObject&&this.prevObject.query)||(this[0].id&&this[0].id)||this[0]).toString();i[d][h].disableInInput=g.disableInInput;if(!a.triggersMap[n]){a.triggersMap[n]=i}else{if(!a.triggersMap[n][d]){a.triggersMap[n][d]=i[d]}}var c=a.triggersMap[n][d][h];if(!c){a.triggersMap[n][d][h]=[i[d][h]]}else{if(c.constructor!==Array){a.triggersMap[n][d][h]=[c]}else{a.triggersMap[n][d][h][c.length]=i[d][h]}}this.each(function(){var o=b(this);if(o.attr("hkId")&&o.attr("hkId")!==n){n=o.attr("hkId")+";"+n}o.attr("hkId",n)});l=this.__bind__(e.join(" "),g,a.handler)}}return l}};a.findElement=function(c){if(!b(c).attr("hkId")){if(b.browser.opera||b.browser.safari){while(!b(c).attr("hkId")&&c.parentNode){c=c.parentNode}}}return c};a.handler=function(f){var i=a.findElement(f.currentTarget),k=b(i),d=k.attr("hkId");if(d){d=d.split(";");var h=f.which,q=f.type,e=a.specialKeys[h],p=!e&&String.fromCharCode(h).toLowerCase(),j=f.shiftKey,c=f.ctrlKey,n=f.altKey||f.originalEvent.altKey,g=null;for(var s=0;s<d.length;s++){if(a.triggersMap[d[s]][q]){g=a.triggersMap[d[s]][q];break}}if(g){var o;if(!j&&!c&&!n){o=g[e]||(p&&g[p])}else{var m="";if(n){m+="alt+"}if(c){m+="ctrl+"}if(j){m+="shift+"}o=g[m+e];if(!o){if(p){o=g[m+p]||g[m+a.shiftNums[p]]||(m==="shift+"&&g[a.shiftNums[p]])}}}if(o){var r=false;for(var s=0;s<o.length;s++){if(o[s].disableInInput){var l=b(f.target);if(k.is("input")||k.is("textarea")||l.is("input")||l.is("textarea")){return true}}r=r||o[s].cb.apply(this,[f])}return r}}}};window.hotkeys=a;return b})(jQuery);function Querystring(a){this.params={};this.get=Querystring_get;if(a==null){}a=location.search.substring(1,location.search.length);if(a.length==0){return}a=a.replace(/\+/g," ");var c=a.split("&");for(var d=0;d<c.length;d++){var f=c[d].split("=");var b=unescape(f[0]);var e=(f.length==2)?unescape(f[1]):b;this.params[b]=e}}function Querystring_get(a,b){var c=this.params[a];return(c!=null)?c:b}
/*
 * Taken from "Remedial Javascript" by Douglas Crockford:
 * http://javascript.crockford.com/remedial.html
 */
function typeOf(b){var a=typeof b;if(a==="object"){if(b){if(typeof b.length==="number"&&!(b.propertyIsEnumerable("length"))&&typeof b.splice==="function"){a="array"}}else{a="null"}}return a}function isEmpty(c){var b,a;if(typeOf(c)==="object"){for(b in c){a=c[b];if(a!==undefined&&typeOf(a)!=="function"){return false}}}return true}String.prototype.entityify=function(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")};String.prototype.quote=function(){var e,b,a=this.length,d='"';for(b=0;b<a;b+=1){e=this.charAt(b);if(e>=" "){if(e==="\\"||e==='"'){d+="\\"}d+=e}else{switch(e){case"\b":d+="\\b";break;case"\f":d+="\\f";break;case"\n":d+="\\n";break;case"\r":d+="\\r";break;case"\t":d+="\\t";break;default:e=e.charCodeAt();d+="\\u00"+Math.floor(e/16).toString(16)+(e%16).toString(16)}}}return d+'"'};String.prototype.supplant=function(a){return this.replace(/{([^{}]*)}/g,function(d,c){var e=a[c];return typeof e==="string"||typeof e==="number"?e:d})};String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")};function FatalError(a){this.message=a;this.traceback=this._makeTraceback(arguments.callee);this.onError(this)}FatalError.prototype={onError:function(a){},_makeTraceback:function(a){var c="";var b=0;var f=100;while(a!=null&&b<f){var d=a.toString();if(!d){c="\n  (anonymous function)"+c}else{var g=d.match(/function (\w*)/);if(!g||!g[1]){c="\n  (anonymous function)"+c}else{c="\n  "+g[1]+c}}try{a=a.caller}catch(h){a=null}b++}if(b==f){c="..."+c}return"Traceback (most recent call last):\n"+c}};function iff_parse(d){function c(h){return d[h]<<24|d[h+1]<<16|d[h+2]<<8|d[h+3]}function a(h){return String.fromCharCode(d[h])+String.fromCharCode(d[h+1])+String.fromCharCode(d[h+2])+String.fromCharCode(d[h+3])}var e=[a(8)];var f=12;while(f<d.length){var b=[a(f)];var g=c(f+4);if(g<0||(g+f)>d.length){throw new FatalError("WEEBLE, panic\n");return[]}b.push(f+8);b.push(g);e.push(b);f+=8+g;if(g%2){f++}}return e}function Beret(a){this.m_engine=a}Beret.prototype={load:function b_load(l){function b(j){for(var i=0;i<j.length;i++){if(j.charCodeAt(i)!=l[i]){return false}}return true}if(l[0]<9){this.m_filetype="ok story naked zcode";this.m_engine.loadStory(l)}else{if(b("FORM")){var g=iff_parse(l);if(g.length==0){this.m_filetype="invalid unknown iff"}else{if(g[0]=="IFZS"){var c=0;var r=0;var q=0;var m=0;for(var e=1;e<g.length;e++){var p=g[e][0];if(p=="IFhd"){var k=g[e][1];var o=g[e][1]+2;if((!this.m_engine)||(this.m_engine.getByte(2)!=l[k])||(this.m_engine.getByte(3)!=l[k+1])||(this.m_engine.getByte(18)!=l[o])||(this.m_engine.getByte(19)!=l[o+1])||(this.m_engine.getByte(20)!=l[o+2])||(this.m_engine.getByte(21)!=l[o+3])||(this.m_engine.getByte(22)!=l[o+4])||(this.m_engine.getByte(23)!=l[o+5])){this.m_filetype="mismatch";break}var f=g[e][1]+10;m=l[f]<<16|l[f+1]<<8|l[f+2]}else{if(p=="Stks"){if(q!=0){throw new FatalError("fixme: error: multiple Stks\n")}q=l.slice(g[e][1],g[e][2]+g[e][1])}else{if(p=="CMem"||p=="UMem"){if(c!=0){throw new FatalError("fixme: error: multiple memory segments\n")}r=(p=="CMem");c=l.slice(g[e][1],g[e][2]+g[e][1])}}}}if(c==0){throw new FatalError("fixme: error: no memory in quetzal\n")}else{if(q==0){throw new FatalError("fixme: error: no stacks in quetzal\n")}else{if(m==0){throw new FatalError("fixme: error: no header in quetzal\n")}else{this.m_filetype="ok saved quetzal zcode";this.m_engine.loadSavedGame(c.length,c,r,q.length,q,m)}}}}else{if(g[0]=="IFRS"){this.m_filetype="invalid story blorb";var n={ZCOD:"zcode",GLUL:"glulx",TADG:"tads",ALAN:"alan",HUGO:"hugo",SAAI:"scottadams",SAII:"scottadams",MSRL:"magneticscrolls"};for(var d=1;d<g.length;d++){if(g[d][0] in n){var a=g[d][1];var h=g[d][2];this.load(l.slice(a,a+h));this.m_filetype="ok story blorb "+n[g[d][0]];return}}}else{this.m_filetype="error unknown iff"}}}}else{this.m_filetype="error unknown general"}}},filetype:function b_filetype(){return this.m_filetype},engine:function b_engine(){return this.m_engine},m_filetype:"error none unseen",m_engine:null};
/*
 * File functions and classes
 *
 * Copyright (c) 2003-2009 The Parchment Contributors
 * Licenced under the GPL v2
 * http://code.google.com/p/parchment
 */
(function(e){var a=function(n,o){var o=o||[],m=0,k;for(k=n.length%16;m<k;++m){o.push(n.charCodeAt(m))}for(k=n.length;m<k;){o.push(n.charCodeAt(m++),n.charCodeAt(m++),n.charCodeAt(m++),n.charCodeAt(m++),n.charCodeAt(m++),n.charCodeAt(m++),n.charCodeAt(m++),n.charCodeAt(m++),n.charCodeAt(m++),n.charCodeAt(m++),n.charCodeAt(m++),n.charCodeAt(m++),n.charCodeAt(m++),n.charCodeAt(m++),n.charCodeAt(m++),n.charCodeAt(m++))}return o},i=function(p,o){var o=o||"",n=0,k,m=String.fromCharCode;for(k=p.length%8;n<k;++n){o+=m(p[n])}for(k=p.length;n<k;){o+=(m(p[n++])+m(p[n++])+m(p[n++])+m(p[n++])+m(p[n++])+m(p[n++])+m(p[n++])+m(p[n++]))}return o};if(e.atob){var c=function(l,k){var k=k||[];return a(atob(l),k)},h=function(l,k){var k=k||"";return btoa(i(l,k))}}else{var f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",b={A:0,B:1,C:2,D:3,E:4,F:5,G:6,H:7,I:8,J:9,K:10,L:11,M:12,N:13,O:14,P:15,Q:16,R:17,S:18,T:19,U:20,V:21,W:22,X:23,Y:24,Z:25,a:26,b:27,c:28,d:29,e:30,f:31,g:32,h:33,i:34,j:35,k:36,l:37,m:38,n:39,o:40,p:41,q:42,r:43,s:44,t:45,u:46,v:47,w:48,x:49,y:50,z:51,0:52,1:53,2:54,3:55,4:56,5:57,6:58,7:59,8:60,9:61,"+":62,"/":63,"=":64},c=function(q,o){var o=o||[],r,n,m,v,u,t,s;for(var p=0,k=q.length;p<k;){v=b[q.charAt(p++)];u=b[q.charAt(p++)];t=b[q.charAt(p++)];s=b[q.charAt(p++)];r=(v<<2)+(u>>4);n=((u&15)<<4)+(t>>2);m=((t&3)<<6)+s;o.push(r,n,m)}if(s==64){o.pop()}if(t==64){o.pop()}return o},h=function(q,o){var o=o||"",r,n,m,v,u,t,s;for(var p=0,k=q.length;p<k;){r=q[p++];n=q[p++];m=q[p++];v=r>>2;u=((r&3)<<4)+(n>>4);t=((n&15)<<2)+(m>>6);s=m&63;o+=(f.charAt(v)+f.charAt(u)+f.charAt(t)+f.charAt(s))}if(isNaN(n)){o=o.slice(0,-2)+"=="}else{if(isNaN(m)){o=o.slice(0,-1)+"="}}return o}}var j=IFF.extend({init:function g(r,m){this.title=m;if(r[0]<9){this.filetype="ok story naked zcode";this._super();this.chunks.push({type:"ZCOD",data:r});this.zcode=r}else{if(IFF.text_from(r,0)=="FORM"){this._super(r);if(this.type=="IFRS"){this.images=[];this.resources=[];for(var p=0,k=this.chunks.length;p<k;p++){var q=this.chunks[p].type;if(q=="RIdx"){for(var n=0,s=IFF.num_from(this.chunks[p].data,0);n<s;n++){this.resources.push({usage:IFF.text_from(this.chunks[p].data,4+n*12),number:IFF.num_from(this.chunks[p].data,8+n*12),start:IFF.num_from(this.chunks[p].data,12+n*12)})}}else{if(q=="ZCOD"&&!this.zcode){this.zcode=this.chunks[p].data}else{if(q=="IFmd"){this.metadata=i(this.chunks[p].data);var o=$(this.metadata);if(o){this.metadataDOM=o;if($("title",o)){this.title=$("title",o).text()}if($("ifid",o)){this.ifid=$("ifid",o).text()}}}else{if(q=="Fspc"){this.frontispiece=IFF.num_from(this.chunks[p].data,0)}}}}}if(this.zcode){this.filetype="ok story blorbed zcode"}else{this.filetype="error: no zcode in blorb"}}else{if(this.type=="IFZS"){this.filetype="error: trying to load a Quetzal savefile"}else{this.filetype="error unknown iff"}}}else{this.filetype="error unknown general"}}},load:function d(k){if(this.zcode){k.loadStory(this.zcode)}e.document.title=this.title+" - Parchment"}});e.file={text_to_array:a,array_to_text:i,base64_decode:c,base64_encode:h,story:j}})(window);