/*

Gnusto
======

Built: 2019-01-23

Copyright (c) 2003-2019 The Gnusto Contributors
GNU GPL licenced
https://github.com/curiousdannii/gnusto

String.prototype.quote() taken from "Remedial Javascript" by Douglas Crockford: http://javascript.crockford.com/remedial.html

*/
function handleZ_je(a,b){if(b.length<2)return"";if(2==b.length)return a._brancher(b[0]+"=="+b[1]);for(var c="",d=1;d<b.length;d++)1!=d&&(c+="||"),c=c+"t=="+b[d];return"t="+b[0]+";"+a._brancher(c)}function handleZ_jl(a,b){var c,d;return c=isNotConst.test(b[0])?"t="+b[0]+";t=((t & 0x8000 ? ~0xFFFF : 0) | t);":"t="+a._unsigned2signed(b[0])+";",d=isNotConst.test(b[1])?"t2="+b[1]+";t2=((t2 & 0x8000 ? ~0xFFFF : 0) | t2);":"t2="+a._unsigned2signed(b[1])+";",c+d+a._brancher("t<t2")}function handleZ_jg(a,b){var c,d;return c=isNotConst.test(b[0])?"t="+b[0]+";t=((t & 0x8000 ? ~0xFFFF : 0) | t);":"t="+a._unsigned2signed(b[0])+";",d=isNotConst.test(b[1])?"t2="+b[1]+";t2=((t2 & 0x8000 ? ~0xFFFF : 0) | t2);":"t2="+a._unsigned2signed(b[1])+";",c+d+a._brancher("t>t2")}function handleZ_inc_chk(a,b){var c=handleZ_inc(a,b);return c+="{var t1=incdec; t1 = ((t1 & 0x8000 ? ~0xFFFF : 0) | t1); var t2="+b[1]+"; t2=((t2 & 0x8000 ? ~0xFFFF : 0) | t2);"+a._brancher("t1 > t2")+"}"}function handleZ_dec_chk(a,b){var c=handleZ_dec(a,b);return c+="{var t1=incdec; t1 = ((t1 & 0x8000 ? ~0xFFFF : 0) | t1); var t2="+b[1]+"; t2=((t2 & 0x8000 ? ~0xFFFF : 0) | t2);"+a._brancher("t1 < t2")+"}"}function handleZ_jin(a,b){return a._brancher("_obj_in("+b[0]+","+b[1]+")")}function handleZ_test(a,b){return"t="+b[1]+";"+a._brancher("("+b[0]+"&t)==t")}function handleZ_or(a,b){return a._storer("("+b[0]+"|"+b[1]+")")}function handleZ_and(a,b){return a._storer("("+b[0]+"&"+b[1]+")")}function handleZ_test_attr(a,b){return a._brancher("_test_attr("+b[0]+","+b[1]+")")}function handleZ_set_attr(a,b){return"_set_attr("+b[0]+","+b[1]+")"}function handleZ_clear_attr(a,b){return"_clear_attr("+b[0]+","+b[1]+")"}function handleZ_store(a,b){var c;return c=isNaN(b[0])?"("+b[0]+" == 0) ? m_gamestack[m_gamestack.length - 1] = "+b[1]+" : ("+b[0]+" < 0x10) ? m_locals[( "+b[0]+" - 1 )] = "+b[1]+" : setWord("+b[1]+", m_vars_start + ( "+b[0]+" - 16 ) * 2 )":0==b[0]?"m_gamestack[m_gamestack.length - 1] = "+b[1]:b[0]<16?"m_locals[( "+b[0]+" - 1 )] = "+b[1]:"setWord("+b[1]+", m_vars_start + ( "+b[0]+" - 16 ) * 2 )"}function handleZ_insert_obj(a,b){return"_insert_obj("+b[0]+","+b[1]+")"}function handleZ_loadw(a,b){if(isNotConst.test(b[0])||isNotConst.test(b[1]))var c="var tmp_"+ ++temp_var+" = ("+b[0]+" + 2 * "+b[1]+") & 0xFFFF, ",d="tmp_"+temp_var,e=d+"+1";else var c="var ",d=b[0]+2*b[1]&65535,e=d+1;var f="tmp_"+ ++temp_var;return c+f+" = (m_memory["+d+"] << 8) | m_memory["+e+"];"+a._storer(f)}function handleZ_loadb(a,b){return a._storer("m_memory[0xFFFF&("+b[0]+"+"+b[1]+")]")}function handleZ_get_prop(a,b){return a._storer("_get_prop("+b[0]+","+b[1]+")")}function handleZ_get_prop_addr(a,b){return a._storer("_get_prop_addr("+b[0]+","+b[1]+")")}function handleZ_get_next_prop(a,b){return a._storer("_get_next_prop("+b[0]+","+b[1]+")")}function handleZ_add(a,b){return a._storer("("+b[0]+" + "+b[1]+") & 0xFFFF")}function handleZ_sub(a,b){return a._storer("("+b[0]+" - "+b[1]+") & 0xFFFF")}function handleZ_mul(a,b){return a._storer("("+b[0]+"*"+b[1]+") & 0xFFFF")}function handleZ_div(a,b){return a._storer("_trunc_divide("+b[0]+","+b[1]+")")}function handleZ_mod(a,b){return a._storer("_trunc_modulo("+b[0]+","+b[1]+")")}function handleZ_set_colour(a,b){return"m_pc="+a.m_pc+";m_effects=["+GNUSTO_EFFECT_STYLE+",-1,"+b[0]+","+b[1]+"];return"}function handleZ_throw(a,b){return a.m_compilation_running=0,"_throw_stack_frame("+b[0]+");return"}function handleZ_jz(a,b){return a._brancher(b[0]+"==0")}function handleZ_get_sibling(a,b){return"t=_get_sibling("+b[0]+");"+a._storer("t")+";"+a._brancher("t")}function handleZ_get_child(a,b){return"t=_get_child("+b[0]+");"+a._storer("t")+";"+a._brancher("t")}function handleZ_get_parent(a,b){return a._storer("_get_parent("+b[0]+")")}function handleZ_get_prop_len(a,b){return a._storer("_get_prop_len("+b[0]+")")}function handleZ_inc(a,b){var c="var incdec; ";return c+=isNaN(b[0])?"var incdec; if ("+b[0]+" == 0) { incdec = m_gamestack[m_gamestack.length - 1] = (m_gamestack[m_gamestack.length - 1] + 1) & 0xFFFF; } else if ("+b[0]+" < 0x10) { incdec = m_locals[( "+b[0]+" - 1 )] = (m_locals[( "+b[0]+" - 1 )] + 1) & 0xFFFF; } else { var val = getUnsignedWord(m_vars_start + ( "+b[0]+" - 16 ) * 2 ); val++; setWord(val, m_vars_start + ( "+b[0]+" - 16 ) * 2 ); incdec = val; }":0==b[0]?"incdec = m_gamestack[m_gamestack.length - 1] = (m_gamestack[m_gamestack.length - 1] + 1) & 0xFFFF;":b[0]<16?"incdec = m_locals[( "+b[0]+" - 1 )] = (m_locals[( "+b[0]+" - 1 )] + 1) & 0xFFFF;":"{var val = getWord(m_vars_start + ( "+b[0]+" - 16 ) * 2 ); val++; setWord(val, m_vars_start + ( "+b[0]+" - 16 ) * 2 ); incdec = val;}"}function handleZ_dec(a,b){var c="var incdec; ";return c+=isNaN(b[0])?"if ("+b[0]+" == 0) { incdec = m_gamestack[m_gamestack.length - 1] = (m_gamestack[m_gamestack.length - 1] - 1) & 0xFFFF; } else if ("+b[0]+" < 0x10) { incdec = m_locals[( "+b[0]+" - 1 )] = (m_locals[( "+b[0]+" - 1 )] - 1) & 0xFFFF; } else { var val = getUnsignedWord(m_vars_start + ( "+b[0]+" - 16 ) * 2 ); val--; setWord(val, m_vars_start + ( "+b[0]+" - 16 ) * 2 ); incdec = val; }":0==b[0]?"incdec = m_gamestack[m_gamestack.length - 1] = (m_gamestack[m_gamestack.length - 1] - 1) & 0xFFFF;":b[0]<16?"incdec = m_locals[( "+b[0]+" - 1 )] = (m_locals[( "+b[0]+" - 1 )] - 1) & 0xFFFF;":"{var val = getUnsignedWord(m_vars_start + ( "+b[0]+" - 16 ) * 2 ); val--; setWord(val, m_vars_start + ( "+b[0]+" - 16 ) * 2 ); incdec = val;}"}function handleZ_print_addr(a,b){return a._handler_zOut("_zscii_from("+b[0]+")",0)}function handleZ_remove_obj(a,b){return"_remove_obj("+b[0]+","+b[1]+")"}function handleZ_print_obj(a,b){return a._handler_zOut("_name_of_object("+b[0]+")",0)}function handleZ_ret(a,b){return a.m_compilation_running=0,"_func_return("+b[0]+");return"}function handleZ_jump(a,b){a.m_compilation_running=0,32768&b[0]&&(b[0]=-65536|b[0]);var c=b[0]+a.m_pc-2;return"m_pc="+c+";return"}function handleZ_print_paddr(a,b){return a._handler_zOut("_zscii_from("+a.m_pc_translate_for_string(b[0])+")",0)}function handleZ_load(a,b){var c;return c=isNaN(b[0])?"("+b[0]+" == 0) ? m_gamestack[m_gamestack.length - 1] : ("+b[0]+" < 0x10) ? m_locals[( "+b[0]+" - 1 )] : getUnsignedWord( m_vars_start + ( "+b[0]+" - 16 ) * 2 )":0==b[0]?"m_gamestack[m_gamestack.length - 1]":b[0]<16?"m_locals[( "+b[0]+" - 1 )]":"getUnsignedWord( m_vars_start + ( "+b[0]+" - 16 ) * 2 )",a._storer(c)}function handleZ_rtrue(a,b){return a.m_compilation_running=0,"_func_return(1);return"}function handleZ_rfalse(a,b){return a.m_compilation_running=0,"_func_return(0);return"}function handleZ_print(a,b){return a._handler_print("",0)}function handleZ_print_ret(a,b){return a.m_compilation_running=0,a._handler_print("\n",1)+";_func_return(1);return"}function handleZ_nop(a,b){return""}function handleZ_restart(a,b){return a.m_compilation_running=0,"m_effects=["+GNUSTO_EFFECT_RESTART+"];return"}function handleZ_ret_popped(a,b){return a.m_compilation_running=0,"_func_return(m_gamestack.pop());return"}function handleZ_catch(a,b){return a._storer("m_call_stack.length")}function handleZ_pop(a,b){return"m_gamestack.pop()"}function handleZ_quit(a,b){return a.m_compilation_running=0,"m_effects=["+GNUSTO_EFFECT_QUIT+"];return"}function handleZ_new_line(a,b){return a._handler_zOut("'\\n'",0)}function handleZ_show_status(a,b){return a._handler_zOut(""),""}function handleZ_verify(a,b){return a._brancher("_verify()")}function handleZ_illegal_extended(a,b){gnusto_error(199)}function handleZ_piracy(a,b){a.m_compilation_running=0;var c="m_rebound=function(){"+a._brancher("(!0)")+"};";return"m_pc="+a.m_pc+";"+c+"m_effects=["+GNUSTO_EFFECT_PIRACY+"];return"}function handleZ_call_1n(a,b){return a._generate_gosub(b[0],"",0)}function handleZ_call_1s(a,b){return a._generate_gosub(b[0],"",1)}function handleZ_call_2n(a,b){return a._generate_gosub(b[0],b[1],0)}function handleZ_call_2s(a,b){return a._generate_gosub(b[0],b[1],1)}function handleZ_call_vn(a,b){return a._generate_gosub(b[0],b.slice(1),0)}function handleZ_call_vs(a,b){return a._generate_gosub(b[0],b.slice(1),1)}function handleZ_store_w(a,b){if(isNotConst.test(b[0])||isNotConst.test(b[1]))var c="var tmp_"+ ++temp_var+" = ("+b[0]+" + 2 * "+b[1]+") & 0xFFFF;",d="tmp_"+temp_var,e=d+"+1";else var c="",d=b[0]+2*b[1]&65535,e=d+1;if(isNotConst.test(b[2])){var f="tmp_"+ ++temp_var;return c+"var "+f+" = "+b[2]+";m_memory["+d+"] = ("+f+" >> 8) & 0xFF;m_memory["+e+"] = "+f+" & 0xFF;"}return a.m_value_asserts&&(null==b[2]||b[2]===!0||b[2]===!1||b[2]<0||b[2]>65535)&&a.logger("Z_store_w value",b[2]),c+"m_memory["+d+"] = "+(b[2]>>8&255)+";m_memory["+e+"] = "+(255&b[2])}function handleZ_storeb(a,b){return"setByte("+b[2]+",("+b[0]+"+"+b[1]+")&0xFFFF)"}function handleZ_putprop(a,b){return"_put_prop("+b[0]+","+b[1]+","+b[2]+")"}function handleZ_read(a,b){var c,d;a.m_compilation_running=0;var e,f,g="_aread(m_answers[0],m_rebound_args[1],m_rebound_args[2],m_answers[1])";a.m_version>=5&&(g=a._storer(g)),a.m_version>=5?(e="m_memory[0xFFFF&a0+1]",f="m_memory[0xFFFF&a0]"):(e="0",f="m_memory[0xFFFF&a0]+1"),b[2]&&b[3]&&a.m_version>=4?(c=b[2],d=a.m_pc_translate_for_routine(b[3])):(c="0",d="0");var h="m_rebound=function(){var t=1*m_answers[0];if(t<0){_func_interrupt(m_rebound_args[0],onISRReturn_for_read);}else{"+g+";}};",i="m_rebound_args=["+d+",a0,"+b[1]+",];";return"var a0=eval("+b[0]+");m_pc="+a.m_pc+";"+i+h+"m_effects=["+GNUSTO_EFFECT_INPUT+","+c+","+e+","+f+",_terminating_characters()];return"}function handleZ_print_char(a,b){return a._handler_zOut("_zscii_char_to_ascii("+b[0]+")",0)}function handleZ_print_num(a,b){return a._handler_zOut('""+_unsigned2signed('+b[0]+")",0)}function handleZ_random(a,b){return a._storer("_random_number("+b[0]+")")}function handleZ_push(a,b){return"m_gamestack.push("+b[0]+")"}function handleZ_pull(a,b){var c="var pull = m_gamestack.pop(); ";return c+=handleZ_store(a,[b[0],"pull"])}function handleZ_split_window(a,b){return a.m_compilation_running=0,"m_pc="+a.m_pc+";m_effects=["+GNUSTO_EFFECT_SPLITWINDOW+","+b[0]+"];return"}function handleZ_set_window(a,b){return a.m_compilation_running=0,"m_pc="+a.m_pc+";m_effects=["+GNUSTO_EFFECT_SETWINDOW+","+b[0]+"];return"}function handleZ_erase_window(a,b){return a.m_compilation_running=0,"m_pc="+a.m_pc+";m_effects=["+GNUSTO_EFFECT_ERASEWINDOW+","+a._unsigned2signed(b[0])+"];return"}function handleZ_erase_line(a,b){return a.m_compilation_running=0,"m_pc="+a.m_pc+";m_effects=["+GNUSTO_EFFECT_ERASELINE+","+b[0]+"];return"}function handleZ_set_cursor(a,b){return a.m_compilation_running=0,"m_pc="+a.m_pc+";m_effects=["+GNUSTO_EFFECT_SETCURSOR+","+b[0]+","+b[1]+"];return"}function handleZ_get_cursor(a,b){return a.m_compilation_running=0,"m_pc="+a.m_pc+";m_effects=["+GNUSTO_EFFECT_GETCURSOR+","+b[0]+"];return"}function handleZ_set_text_style(a,b){return a.m_compilation_running=0,"m_pc="+a.m_pc+";m_effects=["+GNUSTO_EFFECT_STYLE+","+b[0]+",0,0];return"}function handleZ_buffer_mode(a,b){return a.m_compilation_running=0,"m_pc="+a.m_pc+";m_effects=["+GNUSTO_EFFECT_SETBUFFERMODE+","+b[0]+"];return"}function handleZ_output_stream(a,b){return"_set_output_stream("+b[0]+","+b[1]+")"}function handleZ_input_stream(a,b){return a.m_compilation_running=0,"m_pc="+a.m_pc+";m_effects=["+GNUSTO_EFFECT_SETINPUTSTREAM+","+b[0]+"];return"}function handleZ_sound_effect(a,b){for(a.m_compilation_running=0;b.length<5;)b.push(0);return"m_pc="+a.m_pc+";m_effects=["+GNUSTO_EFFECT_SOUND+","+b[0]+","+b[1]+","+b[2]+","+b[3]+","+b[4]+"];return"}function handleZ_read_char(a,b){var c,d,e;return a.m_compilation_running=0,b[1]&&b[2]&&a.m_version>=4?(c=b[1],d="m_rebound_args=["+a.m_pc_translate_for_routine(b[2])+"];",e="m_rebound=function(){var t=m_answers[0];if(t<0){_func_interrupt(m_rebound_args[0],onISRReturn_for_read_char);}else{"+a._storer("_ascii_code_to_zscii_code(t)")+"}};"):(c="0",d="",e="m_rebound=function(){"+a._storer("_ascii_code_to_zscii_code(m_answers[0])")+"};"),"m_pc="+a.m_pc+";"+d+e+"m_effects=["+GNUSTO_EFFECT_INPUT_CHAR+","+c+"];return"}function handleZ_scan_table(a,b){return 4==b.length?"t=_scan_table("+b[0]+","+b[1]+"&0xFFFF,"+b[2]+"&0xFFFF,"+b[3]+");"+a._storer("t")+";"+a._brancher("t"):"t=_scan_table("+b[0]+","+b[1]+"&0xFFFF,"+b[2]+"&0xFFFF,130);"+a._storer("t")+";"+a._brancher("t")}function handleZ_not(a,b){return a._storer("~"+b[0]+"&0xffff")}function handleZ_tokenise(a,b){return"_tokenise("+b[0]+","+b[1]+","+b[2]+","+b[3]+")"}function handleZ_encode_text(a,b){return"_encode_text("+b[0]+","+b[1]+","+b[2]+","+b[3]+")"}function handleZ_copy_table(a,b){return"_copy_table("+b[0]+","+b[1]+","+b[2]+")"}function handleZ_print_table(a,b){return b.length<3&&b.push(1),b.length<4&&b.push(0),"m_pc="+a.m_pc+";m_effects=_print_table("+b[0]+","+b[1]+","+b[2]+","+b[3]+");return"}function handleZ_check_arg_count(a,b){return a._brancher(b[0]+"<=_param_count()")}function handleZ_saveV123(a,b){a.m_compilation_running=0;var c="m_rebound=function(){"+a._brancher("m_answers[0]")+"};";return"m_state_to_save=_saveable_state(1);m_pc="+a.m_pc+";"+c+";m_effects=["+GNUSTO_EFFECT_SAVE+"];return"}function handleZ_saveV45678(a,b){a.m_compilation_running=0;var c="m_rebound=function() { "+a._storer("m_answers[0]")+"};";return"m_state_to_save=_saveable_state("+(4==a.m_version?"1":"3")+");m_pc="+a.m_pc+";"+c+";m_effects=["+GNUSTO_EFFECT_SAVE+"];return"}function handleZ_restoreV123(a,b){return a.m_compilation_running=0,a._brancher(""),"m_pc="+a.m_pc+";m_effects=["+GNUSTO_EFFECT_RESTORE+"];return"}function handleZ_restoreV45678(a,b){a.m_compilation_running=0;var c="m_rebound=function() { var t=m_answers[0]; if (t==0){"+a._storer("t")+"}};";return"m_pc="+a.m_pc+";"+c+"m_effects=["+GNUSTO_EFFECT_RESTORE+"];return"}function handleZ_log_shift(a,b){return a._storer("_log_shift("+b[0]+","+b[1]+")")}function handleZ_art_shift(a,b){return a._storer("_art_shift("+b[0]+","+b[1]+")")}function handleZ_set_font(a,b){return a._storer("("+b[0]+"<2?1:0)")}function handleZ_save_undo(a,b){return a._storer("_save_undo("+a.m_pc+")")}function handleZ_restore_undo(a,b){return"if(_restore_undo())return;"+a._storer("0")}function handleZ_print_unicode(a,b){return a._handler_zOut("String.fromCharCode("+b[0]+")",0)}function handleZ_check_unicode(a,b){return a._storer("3")}function handleZ_gestalt(a,b){return a._storer("gestalt("+b[0]+", "+(b.length<2?0:b[1])+")")}function handleZ_parchment(a,b){return a._storer("op_parchment("+b[0]+", "+(b.length<2?0:b[1])+")")}function pc_translate_v123(a){return"(("+a+")&0xFFFF)*2"}function pc_translate_v45(a){return"(("+a+")&0xFFFF)*4"}function pc_translate_v67R(a){return"(("+a+")&0xFFFF)*4+"+this.m_routine_start}function pc_translate_v67S(a){return"(("+a+")&0xFFFF)*4+"+this.m_string_start}function pc_translate_v8(a){return"(("+a+")&0xFFFF)*8"}function gnusto_error(a){message="Component: engine\n",message+="Code: "+a+"\n";for(var b=1;b<arguments.length;b++)arguments[b]&&arguments[b].toString&&(message+="\nDetail: "+arguments[b].toString());throw new FatalError(message)}function onISRReturn_for_read_char(a,b){b?(a.engine.m_answers[0]=0,a.rebound()):(a.engine.m_effects=a.effects,a.engine.m_rebound=a.rebound,a.engine.m_rebound_args=a.rebound_args)}function onISRReturn_for_read(a,b){var c=a.engine;b?(c.m_answers[0]=0,c.m_answers[1]="",a.rebound()):(c.m_effects=a.effects,c.m_rebound=a.rebound,c.m_rebound_args=a.rebound_args)}function GnustoEngine(a){a?this.logger=function(b,c){a("gnusto-engine: "+b+": "+c)}:this.logger=function(){}}var Quetzal=IFF.subClass({init:function(a){if(this._super(a),a){if("IFZS"!==this.type)throw new Error("Not a Quetzal savefile");for(var b=0,c=this.chunks.length;c>b;b++){var d=this.chunks[b].type,e=this.chunks[b].data;"CMem"===d||"UMem"===d?(this.memory=e,this.compressed="CMem"===d):"Stks"===d?this.stacks=e:"IFhd"===d&&(this.release=e.slice(0,2),this.serial=e.slice(2,8),this.checksum=e.slice(8,10),this.pc=e[10]<<16|e[11]<<8|e[12])}}},write:function(){this.type="IFZS";var a=this.pc,b=this.release.concat(this.serial,this.checksum,a>>16&255,a>>8&255,255&a);return this.chunks=[{type:"IFhd",data:b},{type:this.compressed?"CMem":"UMem",data:this.memory},{type:"Stks",data:this.stacks}],this._super()}});String.prototype.quote=function(){var a,b,c=this.length,d='"';for(b=0;c>b;b+=1)if(a=this.charAt(b),a>=" ")("\\"===a||'"'===a)&&(d+="\\"),d+=a;else switch(a){case"\b":d+="\\b";break;case"\f":d+="\\f";break;case"\n":d+="\\n";break;case"\r":d+="\\r";break;case"	":d+="\\t";break;default:a=a.charCodeAt(),d+="\\u00"+Math.floor(a/16).toString(16)+(a%16).toString(16)}return d+'"'};var CVS_VERSION="$Date: 2005/04/26 01:50:32 $",ENGINE_DESCRIPTION="Gnusto's interactive fiction engine",default_unicode_translation_table={155:228,156:246,157:252,158:196,159:214,160:220,161:223,162:187,163:171,164:235,165:239,166:255,167:203,168:207,169:225,170:233,171:237,172:243,173:250,174:253,175:193,176:201,177:205,178:211,179:218,180:221,181:224,182:232,183:236,184:242,185:249,186:192,187:200,188:204,189:210,190:217,191:226,192:234,193:238,194:244,195:251,196:194,197:202,198:206,199:212,200:219,201:229,202:197,203:248,204:216,205:227,206:241,207:245,208:195,209:209,210:213,211:230,212:198,213:231,214:199,215:254,216:240,217:222,218:208,219:163,220:339,221:338,222:161,223:191},reverse_unicode_table={},isNotConst=/\D/,temp_var=0,PARENT_REC=0,SIBLING_REC=1,CHILD_REC=2,CALLED_FROM_INTERRUPT=0;window||(this.window={});var dummy,t,t2,PARCHMENT_SECURITY_OVERRIDE=window.PARCHMENT_SECURITY_OVERRIDE,GNUSTO_EFFECT_INPUT='"RS"',GNUSTO_EFFECT_INPUT_CHAR='"RC"',GNUSTO_EFFECT_SAVE='"DS"',GNUSTO_EFFECT_RESTORE='"DR"',GNUSTO_EFFECT_QUIT='"QU"',GNUSTO_EFFECT_RESTART='"NU"',GNUSTO_EFFECT_WIMP_OUT='"WO"',GNUSTO_EFFECT_BREAKPOINT='"BP"',GNUSTO_EFFECT_FLAGS_CHANGED='"XC"',GNUSTO_EFFECT_PIRACY='"CP"',GNUSTO_EFFECT_STYLE='"SS"',GNUSTO_EFFECT_SOUND='"FX"',GNUSTO_EFFECT_SPLITWINDOW='"TW"',GNUSTO_EFFECT_SETWINDOW='"SW"',GNUSTO_EFFECT_ERASEWINDOW='"YW"',GNUSTO_EFFECT_ERASELINE='"YL"',GNUSTO_EFFECT_SETCURSOR='"SC"',GNUSTO_EFFECT_SETBUFFERMODE='"SB"',GNUSTO_EFFECT_SETINPUTSTREAM='"SI"',GNUSTO_EFFECT_GETCURSOR='"GC"',GNUSTO_EFFECT_PRINTTABLE='"PT"',handlers_v578={1:handleZ_je,2:handleZ_jl,3:handleZ_jg,4:handleZ_dec_chk,5:handleZ_inc_chk,6:handleZ_jin,7:handleZ_test,8:handleZ_or,9:handleZ_and,10:handleZ_test_attr,11:handleZ_set_attr,12:handleZ_clear_attr,13:handleZ_store,14:handleZ_insert_obj,15:handleZ_loadw,16:handleZ_loadb,17:handleZ_get_prop,18:handleZ_get_prop_addr,19:handleZ_get_next_prop,20:handleZ_add,21:handleZ_sub,22:handleZ_mul,23:handleZ_div,24:handleZ_mod,25:handleZ_call_2s,26:handleZ_call_2n,27:handleZ_set_colour,28:handleZ_throw,128:handleZ_jz,129:handleZ_get_sibling,130:handleZ_get_child,131:handleZ_get_parent,132:handleZ_get_prop_len,133:handleZ_inc,134:handleZ_dec,135:handleZ_print_addr,136:handleZ_call_1s,137:handleZ_remove_obj,138:handleZ_print_obj,139:handleZ_ret,140:handleZ_jump,141:handleZ_print_paddr,142:handleZ_load,143:handleZ_call_1n,176:handleZ_rtrue,177:handleZ_rfalse,178:handleZ_print,179:handleZ_print_ret,180:handleZ_nop,183:handleZ_restart,184:handleZ_ret_popped,185:handleZ_catch,186:handleZ_quit,187:handleZ_new_line,189:handleZ_verify,190:handleZ_illegal_extended,191:handleZ_piracy,224:handleZ_call_vs,225:handleZ_store_w,226:handleZ_storeb,227:handleZ_putprop,228:handleZ_read,229:handleZ_print_char,230:handleZ_print_num,231:handleZ_random,232:handleZ_push,233:handleZ_pull,234:handleZ_split_window,235:handleZ_set_window,236:handleZ_call_vs,237:handleZ_erase_window,238:handleZ_erase_line,239:handleZ_set_cursor,240:handleZ_get_cursor,241:handleZ_set_text_style,242:handleZ_buffer_mode,243:handleZ_output_stream,244:handleZ_input_stream,245:handleZ_sound_effect,246:handleZ_read_char,247:handleZ_scan_table,248:handleZ_not,249:handleZ_call_vn,250:handleZ_call_vn,251:handleZ_tokenise,252:handleZ_encode_text,253:handleZ_copy_table,254:handleZ_print_table,255:handleZ_check_arg_count,1e3:handleZ_saveV45678,1001:handleZ_restoreV45678,1002:handleZ_log_shift,1003:handleZ_art_shift,1004:handleZ_set_font,1009:handleZ_save_undo,1010:handleZ_restore_undo,1011:handleZ_print_unicode,1012:handleZ_check_unicode,1030:handleZ_gestalt,1031:handleZ_parchment},handlers_fixups={1:{25:0,26:0,27:0,28:0,136:0,143:handleZ_not,181:handleZ_saveV123,182:handleZ_restoreV123,185:handleZ_pop,188:handleZ_show_status,190:0,191:0,236:0,237:0,238:0,239:0,240:0,241:0,242:0,246:0,247:0,248:0,249:0,250:0,251:0,252:0,253:0,254:0,255:0},2:{25:0,26:0,27:0,28:0,136:0,143:handleZ_not,181:handleZ_saveV123,182:handleZ_restoreV123,185:handleZ_pop,188:handleZ_show_status,190:0,191:0,236:0,237:0,238:0,239:0,240:0,241:0,242:0,246:0,247:0,248:0,249:0,250:0,251:0,252:0,253:0,254:0,255:0},3:{25:0,26:0,27:0,28:0,136:0,143:handleZ_not,181:handleZ_saveV123,182:handleZ_restoreV123,185:handleZ_pop,188:handleZ_show_status,190:0,191:0,236:0,237:0,238:0,239:0,240:0,241:0,242:0,246:0,247:0,248:0,249:0,250:0,251:0,252:0,253:0,254:0,255:0},4:{26:0,27:0,28:0,143:handleZ_not,181:handleZ_saveV45678,182:handleZ_restoreV45678,185:handleZ_pop,190:0,191:0,248:0,249:0,250:0,251:0,252:0,253:0,254:0,255:0},5:"",6:void 0,7:"",8:""};GnustoEngine.prototype={loadStory:function(a){this.m_memory=a,this._initial_setup()},loadSavedGame:function a(b){function c(a,b){for(var c=f[a++],d=1;b>d;d++)c=c<<8|f[a++];return c}var d=new Quetzal(b),e=d.memory,f=d.stacks,g=d.pc;if(d.compressed){for(var h=[],i=0,j=0;i<e.length;){j>=this.m_original_memory.length&&gnusto_error(999,"overshoot in decompression");var k=e[i++];if(0==k){var l=e[i++]+1;h=h.concat(this.m_original_memory.slice(j,j+l)),j+=l}else h.push(k^this.m_original_memory[j++])}e=h}this.m_call_stack=[],this.m_gamestack=[],this.m_locals_stack=[],this.m_locals=[],this.m_result_targets=[];var m=0;m=c(7,1),this.m_gamestack_callbreaks=[];for(var n=m,o=8,p=0;m>p;p++)this.m_gamestack.push(c(o,2)),o+=2;for(;o<f.length;){this.m_call_stack.push(c(o,3)),o+=3;var q=f[o++],r=f[o++];16&q&&(r=-1);var s=15&q;this.m_locals_stack.unshift(s),this.m_result_targets.push(r);for(var t=f[o++]+1,u=0;t>1;)t>>=1,u++;this.m_param_counts.unshift(u),m=c(o,2),o+=2,n+=m,this.m_gamestack_callbreaks.push(n);for(var v=[],w=0;s>w;w++)v.push(c(o,2)),o+=2;this.m_locals=v.concat(this.m_locals);for(var p=0;m>p;p++)this.m_gamestack.push(c(o,2)),o+=2}for(var x=0;16>x;x++)this.m_locals.push(0);this.m_memory=e.concat(this.m_memory.slice(e.length));var y=(this.m_version<=4?1:3)+1;this.m_pc=g-y,this.m_version<=3?eval("var t=new Function('with(this){'+this._brancher('1')+'}');t.call(this);"):this._varcode_set(2,this.m_memory[this.m_pc++])},resetStory:function(){this.m_memory=this.m_original_memory.slice(),this._initial_setup()},version:function(){gnusto_error(101,"'version' not implemented")},signature:function(){gnusto_error(101,"'signature' not implemented")},cvsVersion:function(){return CVS_VERSION.substring(7,26)},setGoldenTrail:function(a){a?this.m_goldenTrail=1:this.m_goldenTrail=0},setCopperTrail:function(a){a?this.m_copperTrail=1:this.m_copperTrail=0},effect:function(a){return this.m_effects[a]},answer:function(a,b){this.m_answers[a]=b},run:function b(){var a=0,b=0,c,d=this.m_single_step?1:1e4;for(this.m_rebound&&(this.m_rebound(),this.m_rebound=0,this.m_rebound_args=[]),this.m_effects=[];0==this.m_effects.length;){if(b++>=d)return this.m_effects=["WO"],1;a=this.m_pc,this.m_jit[a]?c=this.m_jit[a]:(c=eval("with (this) {dummy="+this._compile()+"}"),a>=this.m_stat_start&&(this.m_jit[a]=c)),c()}},walk:function(a){gnusto_error(101,"'walk' not implemented")},setRandomSeed:function(a){a>0?this._random_number(-a):this._random_number(a)},saveGame:function(){function a(a,b){for(var c=[],d=0;b>d;d++)c[b-d-1]=255&a,a>>=8;return c}var b=this.m_state_to_save,c=[],d=0,e=this.m_locals.length-16,f=0,g=[0,0,0,0,0,0],h=new Quetzal;h.release=b.m_memory.slice(2,4),h.serial=b.m_memory.slice(18,24),h.checksum=b.m_memory.slice(28,30),h.pc=b.m_pc,h.compressed=1;for(var i=0,j=this.m_stat_start;j>i;i++)b.m_memory[i]==this.m_original_memory[i]?(d++,256==d&&(c.push(0),c.push(255),d=0)):(0!=d&&(c.push(0),c.push(d-1),d=0),c.push(b.m_memory[i]^this.m_original_memory[i]));0!=d&&(c.push(0),c.push(d-1)),h.memory=c,g=g.concat(a(this.m_gamestack_callbreaks[0],2));for(var k=0;k<this.m_gamestack_callbreaks[0];k++)g=g.concat(a(this.m_gamestack[f++],2));for(var l=0;l<this.m_call_stack.length;l++){g=g.concat(a(this.m_call_stack[l],3));var m=this.m_locals_stack[this.m_locals_stack.length-(l+1)],n=m,o=this.m_result_targets[l],p=this.m_param_counts[this.m_param_counts.length-(l+1)],q=this.m_gamestack_callbreaks[l]-f;-1==o&&(o=0,n|=16),g=g.concat([n,o,(1<<p)-1,q>>8&255,255&q]),e-=m;for(var r=0;m>r;r++)g=g.concat(a(this.m_locals[e+r],2));for(var k=0;q>k;k++)g=g.concat(a(this.m_gamestack[f++],2))}return h.stacks=g,this.m_quetzal_image=h.write(),this.m_quetzal_image.length},saveGameData:function(a,b){var c=this.m_quetzal_image;return this.m_quetzal_image=0,c},architecture:function(){return"none"},piracy:function(){return-1},tandy:function(){return-1},status:function(){return"this is the status, hurrah!"},getStatusLine:function(a){var b=this.getUnsignedWord(this.m_vars_start),c=this.getUnsignedWord(this.m_property_list_addr_start+this.m_object_size*b),d=this._zscii_from(c+1);if(d.length>a){d=d.substring(0,a-3);var e="...",f=""}else{if(this.m_version>3&&2==(2&this.getByte(1))){var g=this.getUnsignedWord(this.m_vars_start+2),h=this.getUnsignedWord(this.m_vars_start+4);if(10>h)var e=g+":0"+h;else var e=g+":"+h}else var e="Score: "+this.getUnsignedWord(this.m_vars_start+2)+"  Moves: "+this.getUnsignedWord(this.m_vars_start+4);d.length+e.length+1>a&&(e=" S:"+this.getUnsignedWord(this.m_vars_start+2)+" M:"+this.getUnsignedWord(this.m_vars_start+4),d.length+e.length+1>a&&(e=" "+this.getUnsignedWord(this.m_vars_start+2)+"/"+this.getUnsignedWord(this.m_vars_start+4)),d.length+e.length+1>a&&(e=""));for(var f="";d.length+e.length+f.length<a;)f+=" "}return d+f+e},gestalt:function(a,b){return 1==a?258:32==a&&(0==b||1==b&&PARCHMENT_SECURITY_OVERRIDE)?1:0},op_parchment:function(a,b){var c=this;return 1==a&&PARCHMENT_SECURITY_OVERRIDE?(1==b?(c.op_parchment_data.saved_buffer=c.m_console_buffer,c.m_console_buffer="",c.op_parchment_data.raw_eval=1):(c.op_parchment_data.raw_eval&&(eval(c.m_console_buffer),c.m_console_buffer=c.op_parchment_data.saved_buffer),c.op_parchment_data.raw_eval=0),1):0},_initial_setup:function(){this.m_jit=[],this.m_compilation_running=0,this.m_gamestack=[],this.m_gamestack_callbreaks=[],this.m_call_stack=[],this.m_locals=[],this.m_locals_stack=[],this.m_param_counts=[],this.m_result_targets=[],this.m_goldenTrail=0,this.m_copperTrail=0,this.m_version=this.m_memory[0],this.m_original_memory=this.m_memory.slice(),this.m_himem=this.getUnsignedWord(4),this.m_pc=this.getUnsignedWord(6),this.m_dict_start=this.getUnsignedWord(8),this.m_objs_start=this.getUnsignedWord(10),this.m_vars_start=this.getUnsignedWord(12),this.m_stat_start=this.getUnsignedWord(14),this.m_abbr_start=this.getUnsignedWord(24),this.m_version>=4?(this.m_alpha_start=this.getUnsignedWord(52),this.m_object_tree_start=this.m_objs_start+112,this.m_property_list_addr_start=this.m_object_tree_start+12,this.m_object_size=14):(this.m_alpha_start=0,this.m_object_tree_start=this.m_objs_start+53,this.m_property_list_addr_start=this.m_object_tree_start+7,this.m_object_size=9),this.m_hext_start=this.getUnsignedWord(54),this.m_version<=3?(this.m_pc_translate_for_routine=pc_translate_v123,this.m_pc_translate_for_string=pc_translate_v123):this.m_version<=5?(this.m_pc_translate_for_routine=pc_translate_v45,this.m_pc_translate_for_string=pc_translate_v45):this.m_version<=7?(this.m_routine_start=8*this.getUnsignedWord(40),this.m_string_start=8*this.getUnsignedWord(42),this.m_pc_translate_for_routine=pc_translate_v67R,this.m_pc_translate_for_string=pc_translate_v67S):8==this.m_version?(this.m_pc_translate_for_routine=pc_translate_v8,this.m_pc_translate_for_string=pc_translate_v8):gnusto_error(170,"impossible: unknown z-version got this far"),this.m_version in handlers_fixups||gnusto_error(311,"unknown z-machine version");var a=handlers_fixups[this.m_version];switch(typeof a){case"undefined":gnusto_error(101,"z-machine version not implemented");break;case"string":this.m_handlers=handlers_v578;break;case"object":this.m_handlers={};for(var b in handlers_v578)this.m_handlers[b]=handlers_v578[b];for(var c in a)"function"==typeof a[c]?this.m_handlers[c]=a[c]:delete this.m_handlers[c];break;default:gnusto_error(170,"impossible: weird stuff in fixups table")}this.m_separator_count=this.m_memory[this.m_dict_start];for(var d=0;d<this.m_separator_count;d++)this.m_separators[d]=this._zscii_char_to_ascii(this.m_memory[this.m_dict_start+d+1]);if(this.m_hext_start>0&&(this.m_unicode_start=this.getUnsignedWord(this.m_hext_start+6),this.m_unicode_start>0)){this.m_custom_unicode_charcount=this.m_memory[this.m_unicode_start],this.m_unicode_start+=1;for(var d=0;d<this.m_custom_unicode_charcount;d++)reverse_unicode_table[this.getUnsignedWord(this.m_unicode_start+2*d)]=d+155}if(!(this.m_unicode_start>0))for(var d in default_unicode_translation_table)reverse_unicode_table[default_unicode_translation_table[d]]=d;this.m_rebound=0,this.m_rebound_args=[],this.m_output_to_console=1,this.m_streamthrees=[],this.m_output_to_script=0,this.m_console_buffer="",this.m_transcript_buffer="",this.m_zalphabet[0]="abcdefghijklmnopqrstuvwxyz",this.m_zalphabet[1]="ABCDEFGHIJKLMNOPQRSTUVWXYZ",1==this.m_version?this.m_zalphabet[2]="T0123456789.,!?_#'\"/\\<-:()":this.m_zalphabet[2]="T\n0123456789.,!?_#'\"/\\-:()";var e,f;if(this.m_alpha_start>0)for(var g=0;3>g;g++){for(var h="",i=0;26>i;i++)f=this.m_memory[this.m_alpha_start+26*g+i],f>=155&&251>=f?h+=0==this.m_unicode_start?String.fromCharCode(default_unicode_translation_table[f]):f-154<=this.m_custom_unicode_charcount?String.fromCharCode(this.getUnsignedWord(this.m_unicode_start+2*(f-155))):" ":(e=String.fromCharCode(f),"^"==e&&(e="\n"),h+=e);this.m_zalphabet[g]=h}for(var d=0;16>d;d++)this.m_locals[d]=0;this.m_printing_header_bits=0,this.m_leftovers="",this.m_memory[30]=1,this.m_memory[31]=0,this.m_memory[1]|=29,this.m_memory[38]=1,this.m_memory[39]=1,this.m_memory[50]=1,this.m_memory[51]=PARCHMENT_SECURITY_OVERRIDE?2:0},_unsigned2signed:function(a){return(32768&a?-65536:0)|a},_signed2unsigned:function(a){return 65535&a},getByte:function(a){if(this.m_value_asserts){(null==a||a===!0||a===!1||0>a||a>=this.m_original_memory.length)&&this.logger("getByte addr",a);var b=this.m_memory[a];(null==b||b===!0||b===!1||0>b||b>255)&&this.logger("getByte byte",b)}return this.m_memory[a]},setByte:function(a,b){this.m_value_asserts&&(null==b||b===!0||b===!1||0>b||b>=this.m_stat_start)&&this.logger("setByte addr",b),this.m_memory[b]=255&a},getWord:function(a){if(this.m_value_asserts){(null==a||a===!0||a===!1||0>a||a>=this.m_original_memory.length)&&this.logger("getWord addr",a);var b=this.m_memory[a];(null==b||b===!0||b===!1||0>b||b>255)&&this.logger("getWord high byte",b);var b=this.m_memory[a+1];(null==b||b===!0||b===!1||0>b||b>255)&&this.logger("getWord low byte",b)}var c=this.m_memory[a]<<8|this.m_memory[a+1];return(32768&c?-65536:0)|c},getUnsignedWord:function(a){if(this.m_value_asserts){(null==a||a===!0||a===!1||0>a||a>=this.m_original_memory.length)&&this.logger("getUnsignedWord addr",a);var b=this.m_memory[a];(null==b||b===!0||b===!1||0>b||b>255)&&this.logger("getUnsignedWord high byte",b);var b=this.m_memory[a+1];(null==b||b===!0||b===!1||0>b||b>255)&&this.logger("getUnsignedWord low byte",b)}return this.m_memory[a]<<8|this.m_memory[a+1]},setWord:function(a,b){this.m_value_asserts&&(null==b||b===!0||b===!1||0>b||b>=this.m_stat_start)&&this.logger("setWord",b),this.m_memory[b]=a>>8&255,this.m_memory[b+1]=255&a},_handle_variable_parameters:function(a,b,c){var d,e=0,f="";for(1==c&&(b=b<<8|255);;){var g=49152&b;if(49152==g)return f;0==g?(a[e++]=this.getUnsignedWord(this.m_pc),this.m_pc+=2):16384==g?a[e++]=this.m_memory[this.m_pc++]:32768==g&&(d=this._code_for_varcode(this.m_memory[this.m_pc++]),f+=d[0],a[e++]=d[1]),b=b<<2|3}},_compile:function(){this.m_compilation_running=1;var a,b,c="",d=this.m_pc;
temp_var=0;do{var e=[],f=this.m_pc;(null==f||0>f||f>=this.m_original_memory.length)&&gnusto_error(206,f);var g=this.m_memory[this.m_pc++];if(0==g)gnusto_error(201);else if(190==g)g=1e3+this.m_memory[this.m_pc++],c+=this._handle_variable_parameters(e,this.m_memory[this.m_pc++],1);else if(128&g)if(64&g)if(32&g||(g&=31),250==g||236==g){var h=this.getUnsignedWord(this.m_pc);this.m_pc+=2,c+=this._handle_variable_parameters(e,h,2)}else c+=this._handle_variable_parameters(e,this.m_memory[this.m_pc++],1);else switch(48&g){case 0:e[0]=this.getUnsignedWord(this.m_pc),this.m_pc+=2,g=15&g|128;break;case 16:e[0]=this.m_memory[this.m_pc++],g=15&g|128;break;case 32:a=this._code_for_varcode(this.m_memory[this.m_pc++]),c+=a[0],e[0]=a[1],g=15&g|128;break;case 48:g=15&g|176}else 64&g?(a=this._code_for_varcode(this.m_memory[this.m_pc++]),c+=a[0],e[0]=a[1]):e[0]=this.m_memory[this.m_pc++],32&g?(a=this._code_for_varcode(this.m_memory[this.m_pc++]),c+=a[0],e[1]=a[1]):e[1]=this.m_memory[this.m_pc++],g&=31;this.m_handlers[g]?c=c+this.m_handlers[g](this,e)+";":g>=1128&&1255>=g&&"special_instruction_EXT"+(g-1e3)in this?c=c+this["special_instruction_EXT"+(g-1e3)](e)+";":gnusto_error(200,this.m_pc.toString(16))}while(this.m_compilation_running);(this.m_single_step||this.m_debug_mode)&&(c=c+"m_pc="+this.m_pc),c=c.replace(/m_gamestack\.push\(([^;]+)\);var tmp_(\d+) = m_gamestack\.pop\(\);/,"var tmp_$2 = $1;"),b="function JIT_"+d.toString(16)+"_"+d;var i=function(a){for(;!vm_functions[a]&&a>0;)a--;return vm_functions[a]};return b+=window.vm_functions?"_"+i(d):"",b+"(){"+c+"}"},_param_count:function(){return this.m_param_counts[0]},_set_output_stream:function(a,b){if(a=this._unsigned2signed(a),0==a);else if(1==a)this.m_output_to_console=1;else if(2==a)this.m_memory[17]|=1;else if(3==a)this.m_streamthrees.length>15&&gnusto_error(202),this.m_streamthrees.unshift([b,b+2]);else if(4==a)this.m_output_to_script=1;else if(-1==a)this.m_output_to_console=0;else if(-2==a)this.m_memory[17]&=-2;else if(-3==a){this.m_streamthrees.length<1&&gnusto_error(203);var c=this.m_streamthrees.shift();this.setWord(c[1]-c[0]-2,c[0])}else-4==a?this.m_output_to_script=0:gnusto_error(204,a)},_trunc_divide:function(a,b){var c;return a=this._unsigned2signed(a),b=this._unsigned2signed(b),0==b?(gnusto_error(701),0):(c=a/b,c>0?65535&Math.floor(c):65535&Math.ceil(c))},_trunc_modulo:function(a,b){return a=this._unsigned2signed(a),b=this._unsigned2signed(b),0==b?(gnusto_error(701),0):a%b&65535},_zscii_char_to_ascii:function(a){0>a&&gnusto_error(702,a);var b;if(0==a)return"";if(10==a||13==a)return"\n";if(a>=32&&126>=a||0==a)b=a;else{if(!(a>=155&&251>=a))return"*";if(0==this.m_unicode_start)return String.fromCharCode(default_unicode_translation_table[a]);if(a-154<=this.m_custom_unicode_charcount)return String.fromCharCode(this.getUnsignedWord(this.m_unicode_start+2*(a-155)));gnusto_error(703,a)}return String.fromCharCode(b)},_ascii_code_to_zscii_code:function(a){var b={10:13,13:13,37:131,38:129,39:132,40:130};if(isNaN(a)){if(a.keyCode&&b[a.keyCode])return b[a.keyCode];var a=a.charCode}if(10==a||13==a)return 13;if(a>31&&127>a||0==a)return a;0>a&&gnusto_error(702,"Illegal unicode character:"+a);var c=reverse_unicode_table[a];return c||(c=42),c},_random_number:function(a){if(a=this._unsigned2signed(a),0==a)return this.m_random_use_seed=this.m_random_use_sequence=0,0;if(-999>a)return this.m_random_state=Math.abs(a),this.m_random_use_seed=1,this.m_random_use_sequence=0,0;if(0>a)return this.m_random_sequence_max=Math.abs(a)-1,this.m_random_state=0,this.m_random_use_seed=0,this.m_random_use_sequence=1,0;if(this.m_random_use_seed)return this.m_random_state--,1+Math.round(8.71*Math.abs(Math.tan(this.m_random_state))*a)%a;if(this.m_random_use_sequence){var b=this.m_random_state;return this.m_random_state=this.m_random_state+1,this.m_random_state>this.m_random_sequence_max&&(this.m_random_state=0),1+b%a}return 1+Math.round((a-1)*Math.random())},_func_gosub:function(a,b,c,d){this.m_call_stack.push(c),this.m_pc=a;var e=this.m_memory[this.m_pc++];if(this.m_version<5){for(var f=[],g=0;e>g;g++)g<b.length?f.push(b[g]):f.push(this.getUnsignedWord(this.m_pc)),this.m_pc+=2;this.m_locals=f.concat(this.m_locals)}else for(var h=e;h>0;h--)h<=b.length?this.m_locals.unshift(b[h-1]):this.m_locals.unshift(0);this.m_locals_stack.unshift(e),this.m_param_counts.unshift(b.length),this.m_result_targets.push(d),this.m_gamestack_callbreaks.push(this.m_gamestack.length),0==a&&this._func_return(0)},_func_interrupt:function(a,b){this.m_interrupt_information.push({on_return:b,rebound:this.m_rebound,rebound_args:this.m_rebound_args,engine:this,pc:this.m_pc,effects:this.m_effects}),this._func_gosub(a,[],CALLED_FROM_INTERRUPT,-1)},_tokenise:function(a,b,c,d){function e(a,b,c){function d(a,b,c){for(var d,e,f=0;;){if(f==b.length)return 0;if(d=a.m_memory[c+f],e=b.charCodeAt(f),d!=e)return e>d?-1:1;f++}}var e=a.m_memory[c+a.m_separator_count+1],f=a.getWord(c+a.m_separator_count+2),g=a.m_dict_start+a.m_separator_count+4,h=1;0>f&&(h=0,f=-f);if(b=a._into_zscii(b),h)for(var i,j,k,l=0,m=f-1;;){if(i=l+Math.round((m-l)/2),j=g+i*e,k=d(a,b,j),0>k){if(l==m)return 0;l=i+1}else{if(!(k>0))return j;if(l==m)return 0;m=i-1}if(l>m)return 0}else for(var n=0;f>n;n++){var o=g+n*e;if(0==d(a,b,o))return o}return 0}function f(a,b,c,f){var i=e(a,c,b);return d&&0==i?h+=4:(a.setWord(i,h),h+=2,a.setByte(c.length,h++),a.setByte(f,h++)),g++,1}var g=0,h=b+2,i=b+1;isNaN(c)&&(c=0),isNaN(d)&&(d=0);var j=this.m_memory[a],k="";if(0==c&&(c=this.m_dict_start),this.m_version<=4){j++;for(var l=a+1;;){var m=this.m_memory[l++];if(0==m)break;k+=String.fromCharCode(m)}}else for(var n=0;n<this.m_memory[a+1];n++)k+=String.fromCharCode(this.m_memory[a+2+n]);var o,p=[],q="",r=0;o=this.m_version<=4?1:2;for(var s=0;s<k.length;s++)" "==k.charAt(s)?""!=q&&(p[r]=q,f(this,c,p[r],s-p[r].length+o),r++,q=""):this._is_separator(k.charAt(s))?(""!=q&&(p[r]=q,f(this,c,p[r],s-p[r].length+o),r++),p[r]=k.charAt(s),f(this,c,p[r],s+o),r++,q=""):q+=k.charAt(s);""!=q&&(p[r]=q,f(this,c,p[r],s-p[r].length+o)),this.setByte(g,i)},_aread:function(a,b,c,d){b&=65535,c&=65535;var e,f,g;this.m_version<=4?(e=this.m_memory[b]+1,f=d.substring(0,e).toLowerCase(),g=b+1,this.setByte(0,b+1+f.length)):(e=this.m_memory[b],f=d.substring(0,e).toLowerCase(),g=b+2,this.setByte(f.length,b+1));for(var h=0;h<f.length;h++)this.setByte(this._ascii_code_to_zscii_code(f.charCodeAt(h)),g+h);return(0!=c||this.m_version<5)&&this._tokenise(b,c,0,0),13==a?10:a},_terminating_characters:function(){if(this.m_version<5)return"\r";for(var a=this.getUnsignedWord(46),b="\r";;){var c=this.m_memory[a++];if(0==c)break;(c>=129&&154>=c||c>=252)&&(b+=String.fromCharCode(c))}return b},_func_return:function(a){this.m_locals=this.m_locals.slice(this.m_locals_stack.shift()),this.m_param_counts.shift(),this.m_pc=this.m_call_stack.pop(),this.m_gamestack.length=this.m_gamestack_callbreaks.pop();var b=this.m_result_targets.pop();if(-1!=b&&null!=a&&(0==b?this.m_gamestack.push(a):16>b?this.m_locals[b-1]=a:this.setWord(a,this.m_vars_start+2*(b-16))),this.m_pc==CALLED_FROM_INTERRUPT){var c=this.m_interrupt_information.pop();this.m_pc=c.pc,c.on_return(c,a)}},_throw_stack_frame:function(a){for((a>this.m_call_stack.length||1>a)&&gnusto_error(207,a);this.m_call_stack.length>a-1;)this._func_return(null)},_get_prop_addr:function(a,b){if(0==a)return 0;var c=this._property_search(a,b,-1);return c[2]?c[0]:0},_get_prop_len:function(a){if((null==a||a===!0||a===!1||0>a||a>=this.m_stat_start)&&this.logger("get_prop_len",a),0==a)return 0;if(this.m_version<4)return 1+(this.m_memory[a-1]>>5);var b=this.m_memory[a-1];return 128&b?(b=63&b,0==b?64:b):64&b?2:1},_get_next_prop:function(a,b){if(0==a)return 0;var c=this._property_search(a,-1,b);return c[2]?c[3]:c[4]?0:(gnusto_error(205,b),void gnusto_error(173))},_get_prop:function(a,b){if(0==a)return 0;var c=this._property_search(a,b,-1);return this.m_value_asserts&&(null==c[0]||c[0]===!0||c[0]===!1||c[0]<0||c[0]>=this.m_stat_start)&&this.logger("get_prop",c[0]),1==c[1]?this.m_memory[c[0]]:2==c[1]?this.m_memory[c[0]]<<8|this.m_memory[c[0]+1]:this.getUnsignedWord(c[0])},_property_search:function(a,b,c){var d=this.getUnsignedWord(this.m_property_list_addr_start+a*this.m_object_size);d=d+2*this.m_memory[d]+1;for(var e=0;;){var f=1,g=this.m_memory[d++];if(this.m_version<4?(f=(g>>5)+1,g=31&g):(128&g?(f=63&this.m_memory[d++],0==f&&(f=64)):64&g&&(f=2),g=63&g),g==b||e==c)return[d,f,1,g,0];if(b>g)return b>0?[this.m_objs_start+2*(b-1),2,0,b,0]:[-1,-1,0,b,e==b];d+=f,e=g}gnusto_error(175)},_set_attr:function(a,b){if(0!=a){var c=this.m_object_tree_start+a*this.m_object_size+(b>>3),d=this.m_memory[c];this.setByte(d|128>>b%8,c)}},_clear_attr:function(a,b){if(0!=a){var c=this.m_object_tree_start+a*this.m_object_size+(b>>3),d=this.m_memory[c];this.setByte(d&~(128>>b%8),c)}},_test_attr:function(a,b){return 0==a?0:this.m_memory[this.m_object_tree_start+a*this.m_object_size+(b>>3)]&128>>b%8?1:0},_put_prop:function(a,b,c){if(0!=a){var d=this._property_search(a,b,-1);d[2]||gnusto_error(704),1==d[1]?this.setByte(c,d[0]):2==d[1]?this.setWord(c,d[0]):gnusto_error(705)}},_get_older_sibling:function(a){if(0==a)return 0;var b=this._get_child(this._get_parent(a));if(a==b)return 0;for(;b;){var c=this._get_sibling(b);if(c==a)return b;b=c}return 0},_insert_obj:function(a,b){var c=this._get_parent(a),d=this._get_older_sibling(a),e=this._get_sibling(a);c&&this._get_child(c)==a&&this._set_child(c,e),d&&this._set_sibling(d,e),this._set_parent(a,b),b&&(this._set_sibling(a,this._get_child(b)),this._set_child(b,a))},_remove_obj:function(a,b){this._insert_obj(a,0)},_get_family:function(a,b){return 0==a?0:this.m_version<4?this.m_memory[this.m_object_tree_start+4+b+a*this.m_object_size]:this.getUnsignedWord(this.m_object_tree_start+6+2*b+a*this.m_object_size)},_get_parent:function(a){return this._get_family(a,PARENT_REC)},_get_child:function(a){return this._get_family(a,CHILD_REC)},_get_sibling:function(a){return this._get_family(a,SIBLING_REC)},_set_family:function(a,b,c){this.m_version<4?this.setByte(b,this.m_object_tree_start+4+c+a*this.m_object_size):this.setWord(b,this.m_object_tree_start+6+2*c+a*this.m_object_size)},_set_parent:function(a,b){this._set_family(a,b,PARENT_REC)},_set_child:function(a,b){this._set_family(a,b,CHILD_REC)},_set_sibling:function(a,b){this._set_family(a,b,SIBLING_REC)},_obj_in:function(a,b){return this._get_parent(a)==b},_copy_table:function(a,b,c){if(c=this._unsigned2signed(c),0==b)for(var d=0;c>d;d++)this.setByte(0,d+a);else{var e=0;if(0>c?(c=-c,e=1):e=a>b?1:0,e)for(var d=0;c>d;d++)this.setByte(this.m_memory[a+d],b+d);else for(var d=c-1;d>=0;d--)this.setByte(this.m_memory[a+d],b+d)}},_scan_table:function(a,b,c,d){var e=127&d,f=128==(128&d),g=b+c*e;if(f)for(;g>b;){if((255&this.m_memory[65535&b])==(a>>8&255)&&(255&this.m_memory[65535&b+1])==(255&a))return b;b+=e}else for(;g>b;){if((255&this.m_memory[65535&b])==(65535&a))return b;b+=e}return 0},_print_table:function(a,b,c,d){for(var e=[],f=0;c>f;f++){for(var g="",h=0;b>h;h++)0>a&&(a&=65535),g+=this._zscii_char_to_ascii(this.m_memory[a++]);e.push(g),a+=d}var i=["PT",e.length];return i=i.concat(e)},_zscii_from:function(a,b,c){if(a in this.m_jit)return c?this.m_jit[a]:this.m_jit[a][0];var d="",e=1,f=a,g=0,h=g,i=-2,j=0;b||(b=65535);for(var k=a+b;e;){var l=this.getUnsignedWord(a);a+=2,e=0==(32768&l)&&k>a;for(var m=2;m>=0;m--){var n=l>>5*m&31;j?(d+=this._zscii_from(2*this.getUnsignedWord(2*(32*(j-1)+n)+this.m_abbr_start)),j=0,h=g):-2==i?n>5?2==h&&6==n?i=-1:(d+=this.m_zalphabet[h].charAt(n-6),h=g):0==n?(d+=" ",h=g):4>n?this.getByte(0)>2?j=n:2==n?(h+=1,h>2&&(h=0)):3==n?(h-=1,0>h&&(h=2)):2==this.getByte(0)?j=1:(d+="\n",h=g):this.getByte(0)>2?h=n-3:(4==n?(g+=1,g>2&&(g=0)):(g-=1,0>g&&(g=2)),h=g):-1==i?i=n:(d+=this._zscii_char_to_ascii((i<<5)+n),i=-2,h=g)}}return f>=this.m_stat_start&&(this.m_jit[f]=[d,a]),c?[d,a]:d},_encode_text:function(a,b,c,d){a=a+c&65535;for(var e="";b>0;){var f=this.m_memory[a];if(0==f)break;e+=String.fromCharCode(f),a++,b--}for(var g=this._into_zscii(e),h=0;h<g.length;h++){var i=g[h].charCodeAt(0);this.setByte(i,d++)}},_into_zscii:function(a){function b(a){if(e.push(a),3==e.length){var b=e[0]<<10|e[1]<<5|e[2];d.length==c-2&&(b|=32768),d=d+String.fromCharCode(b>>8)+String.fromCharCode(255&b),e=[]}}var c,d="",e=[];c=this.m_version<4?4:6;for(var f,g,h=0;h<a.length&&d.length<c;){if(f=a.charCodeAt(h++),f>=65&&90>=f)f+=32;else if(f>154)if(0==this.m_unicode_start)f>=158&&160>=f||f>=167&&168>=f||f>=208&&210>=f?f-=3:f>=175&&180>=f?f-=6:f>=186&&190>=f||f>=196&&200>=f?f-=5:217==f||218==f?f-=2:(202==f||204==f||212==f||214==f||221==f)&&(f-=1);else{var i=this._ascii_code_to_zscii_code(this._zscii_char_to_ascii(f).toLowerCase().charCodeAt(0));i>0&&251>=i&&i!="*".charCodeAt(0)&&(f=i)}var j=String.fromCharCode(this._zscii_char_to_ascii(f).charCodeAt(0));g=this.m_zalphabet[0].indexOf(j),-1!=g?b(g+6):(g=this.m_zalphabet[1].indexOf(j),-1!=g?(b(this.getByte(0)>2?4:2),b(g+6)):(g=this.m_zalphabet[2].indexOf(j),-1!=g?(b(this.getByte(0)>2?5:3),b(g+6)):(b(this.getByte(0)>2?5:3),b(6),b(f>>5),b(31&f))))}for(;d.length<c;)b(5);return d.substring(0,c)},_name_of_object:function(a){if(0==a)return"<void>";var b=this.m_property_list_addr_start+a*this.m_object_size;return this._zscii_from(this.getUnsignedWord(b)+1)},_print_leftovers:function(){this._zOut(this.m_leftovers),this.m_leftovers=""},_zOut:function(a){if(this.m_streamthrees.length){for(var b=(this.m_streamthrees[0],this.m_streamthrees[0][1]),c=0;c<a.length;c++)this.setByte(this._ascii_code_to_zscii_code(a.charCodeAt(c)),b++);this.m_streamthrees[0][1]=b}else{var d=3&this.m_memory[17],e=d!=this.m_printing_header_bits;if(this.m_printing_header_bits=d,e)return this.m_leftovers=a,this.m_rebound=this._print_leftovers,1;this.m_output_to_console&&(this.m_console_buffer=this.m_console_buffer+a),1&d&&(this.m_transcript_buffer=this.m_transcript_buffer+a)}return 0},consoleText:function(){var a=this,b=a.m_console_buffer.replace("\x00","","g");return a.op_parchment_data.raw_eval?"":(a.m_console_buffer="",b)},_transcript_text:function(){var a=this.m_transcript_buffer.replace("\x00","","g");return this.m_transcript_buffer="",a},_is_separator:function(a){for(var b=0;b<this.m_separator_count;b++)if(a==this.m_separators[b])return 1;return 0},_code_for_varcode:function(a){var b,c="";if(0==a)c="var tmp_"+ ++temp_var+" = m_gamestack.pop();",b="tmp_"+temp_var;else if(16>a)b="m_locals["+(a-1)+"]";else{var d=this.m_vars_start+2*(a-16),e=d+1,f="tmp_"+ ++temp_var;c="var "+f+" = (m_memory["+d+"] << 8) | m_memory["+e+"];",b=f}return[c,b]},_varcode_set:function(a,b){0==b?this.m_gamestack.push(a):16>b?this.m_locals[b-1]=a:this.setWord(a,this.m_vars_start+2*(b-16))},_brancher:function(a){var b=1,c=this.m_memory[this.m_pc++],d=63&c;128&c&&(b=0),64&c||(d=d<<8|this.m_memory[this.m_pc++],8192&d&&(d=-8192|8191&d));var e=a;return e=b?"if(!("+e+"))":"if("+e+")",0==d?e+"{_func_return(0);return;}":1==d?e+"{_func_return(1);return;}":(d=this.m_pc+d-2,e+"{m_pc="+d+";return;}")},_storer:function(a){var b=this.m_memory[this.m_pc++];return a.substring&&"_func_gosub"==a.substring(0,11)?(this.m_compilation_running=0,",-1)"!=a.substring(a.length-4)&&gnusto_error(100,a),a.substring(0,a.length-3)+b+")"):0==b?"m_gamestack.push("+a+")":16>b?"m_locals["+(b-1)+"]="+a:"setWord("+a+","+(this.m_vars_start+2*(b-16))+")"},_generate_gosub:function(a,b,c){this.m_compilation_running=0;var d=-1;return c&&(d=this.m_memory[this.m_pc++]),"_func_gosub("+this.m_pc_translate_for_routine(a)+",["+b.toString()+"],"+this.m_pc+","+d+")"},_handler_zOut:function(a,b){var c;return c=b?"_func_return(1)":"m_pc=0x"+this.m_pc.toString(16),"if(_zOut("+a+")){"+c+";m_effects=["+GNUSTO_EFFECT_FLAGS_CHANGED+"];return 1}"},_handler_print:function(a,b){var c=this._zscii_from(this.m_pc,65535,1),d=c[0];return a&&(d+=a),d=d.quote(),this.m_pc=c[1],this._handler_zOut(d,b)},_log_shift:function(a,b){return 32768&b?a>>>65536-b&65535:a<<b&65535},_art_shift:function(a,b){return a=this._unsigned2signed(a),32768&b?a>>65536-b&65535:a<<b&65535},_touch:function(a){this.m_goldenTrail&&this.logger("pc",a.toString(16)),this.m_pc=a},_save_undo:function(a){return this.m_undo.push({m_call_stack:this.m_call_stack.slice(),m_locals:this.m_locals.slice(),m_locals_stack:this.m_locals_stack.slice(),m_param_counts:this.m_param_counts.slice(),m_result_targets:this.m_result_targets.slice(),m_gamestack:this.m_gamestack.slice(),m_gamestack_callbreaks:this.m_gamestack_callbreaks.slice(),m_memory:this.m_memory.slice(0,this.m_stat_start),m_resultvar:this.m_memory[a],m_pc:a+1}),1},_restore_undo:function(){if(0==this.m_undo.length)return 0;var a=this.m_undo.pop();this.m_call_stack=a.m_call_stack,this.m_locals=a.m_locals,this.m_locals_stack=a.m_locals_stack,this.m_param_counts=a.m_param_counts,this.m_result_targets=a.m_result_targets,this.m_gamestack=a.m_gamestack,this.m_gamestack_callbreaks=a.m_gamestack_callbreaks;var b=a.m_memory;return this.m_memory=b.concat(this.m_memory.slice(b.length)),this._varcode_set(2,a.m_resultvar),this.m_pc=a.m_pc,1},_saveable_state:function(a){var b={m_memory:this.m_memory.slice(0,this.m_stat_start),m_pc:this.m_pc+a,m_call_stack:this.m_call_stack.slice(),m_locals:this.m_locals.slice(),m_locals_stack:this.m_locals_stack.slice(),m_param_counts:this.m_param_counts.slice(),m_result_targets:this.m_result_targets.slice(),m_gamestack:this.m_gamestack.slice(),m_gamestack_callbreaks:this.m_gamestack_callbreaks.slice()};return b},_verify:function(){for(var a=0,b=this.m_original_memory[28]<<8|this.m_original_memory[29],c=64;c<this.m_original_memory.length;c++)a+=this.m_original_memory[c];return(65535&a)==b},m_local_game_file:0,m_memory:[],m_handlers:0,m_jit:[],m_goldenTrail:0,m_copperTrail:0,m_compilation_running:0,m_gamestack:0,m_gamestack_callbreaks:[],m_himem:0,m_pc:0,m_dict_start:0,m_objs_start:0,m_vars_start:0,m_stat_start:0,m_abbr_start:0,m_hext_start:0,m_alpha_start:0,m_zalphabet:[],m_string_start:0,m_routine_start:0,m_unicode_start:0,m_custom_unicode_charcount:0,m_separator_count:0,m_separators:[],m_version:0,m_call_stack:[],m_locals:[],m_locals_stack:0,m_param_counts:0,m_result_targets:[],m_rebound:0,m_rebound_args:[],m_output_to_console:0,m_streamthrees:[],m_output_to_script:0,m_single_step:0,m_debug_mode:0,m_parser_debugging:0,m_value_asserts:0,m_breakpoints:{},m_console_buffer:"",m_transcript_buffer:"",m_effects:[],m_answers:[],m_random_state:0,m_random_use_seed:0,m_random_use_sequence:0,m_random_sequence_max:0,m_printing_header_bits:0,m_leftovers:"",m_pc_translate_for_routine:pc_translate_v45,m_pc_translate_for_string:pc_translate_v45,m_undo:[],m_state_to_save:0,m_quetzal_image:0,m_original_memory:[],m_object_tree_start:0,m_property_list_addr_start:0,m_object_size:14,m_interrupt_information:[],op_parchment_data:{}};var ZVMUI=Class.subClass({init:function(a,b){this.e=a,this.buffer="",extend(this,this.formatters[a.env.formatter]||{}),this.mono=b,this.process_colours(),this.currentwin=0,this.status=[],a.orders.push({code:"stream",name:"status"},{code:"stream",name:"main"},{code:"find",name:"main"})},clear_window:function(){this.e.orders.push({code:"clear",name:"main",bg:this.bg})},erase_line:function(a){1===a&&(this.flush(),this.status.push({code:"eraseline"}))},erase_window:function(a){this.flush(),1>a&&this.clear_window(),-1===a&&this.split_window(0),(-2===a||1===a)&&this.status.push({code:"clear"})},flush:function(){if(""!==this.buffer){var a={code:"stream",text:this.buffer,props:this.format()};(this.currentwin?this.status:this.e.orders).push(a),this.buffer=""}},format:function(){var a,b={},c=[],d=this.fg,e=this.bg;return this.bold&&c.push("zvm-bold"),this.italic&&c.push("zvm-italic"),this.mono&&c.push("zvm-mono"),this.reverse&&(a=d,d=e||this.env.bg,e=a||this.env.fg),"undefined"!=typeof d&&(isNaN(d)?b.css={color:d}:c.push("zvm-fg-"+d)),"undefined"!=typeof e&&(isNaN(e)?(b.css||(b.css={}),b.css["background-color"]=e):c.push("zvm-bg-"+e)),c.length&&(b["class"]=c.join(" ")),b},get_cursor:function(a){this.status.push({code:"get_cursor",addr:a}),this.e.act()},process_colours:function(){function a(a){var b,c=Math.round,d=/(\d+),\s*(\d+),\s*(\d+)|#(\w{1,2})(\w{1,2})(\w{1,2})/.exec(a);return d[1]?b=[d[1],d[2],d[3]]:(b=[parseInt(d[4],16),parseInt(d[5],16),parseInt(d[6],16)],4===a.length&&(b=[b[0]<<4|b[0],b[1]<<4|b[1],b[2]<<4|b[2]])),c(b[2]/8.226)<<10|c(b[1]/8.226)<<5|c(b[0]/8.226)}var b=[65534,65535,0,29,832,957,22944,31775,30624,32767,23254,17969,11627],c=this.e.env.fgcolour,d=this.e.env.bgcolour,e=c?a(c):65535,f=d?a(d):65535,g=b.indexOf(e),h=b.indexOf(f);2>g&&(g=c||2),2>h&&(h=d||9),this.env={fg:g,bg:h,fg_true:e,bg_true:f}},set_colour:function(a,b){this.flush(),1===a&&(this.fg=void 0),a>1&&13>a&&(this.fg=a),1===b&&(this.bg=void 0),b>1&&13>b&&(this.bg=b)},set_cursor:function(a,b){this.flush(),this.status.push({code:"cursor",to:[a-1,b-1]})},set_font:function(a){if(1!==a&&4!==a)return 0;var b=4&this.mono?4:1;return a!==b&&(this.flush(),this.mono^=4),b},set_style:function(a){this.flush(),0===a&&(this.reverse=this.bold=this.italic=0,this.mono&=254),1&a&&(this.reverse=1),2&a&&(this.bold=1),4&a&&(this.italic=1),8&a&&(this.mono|=1)},set_true_colour:function(a,b){function c(a){var b=Math.round(8.226*(31&a))<<16|Math.round(8.226*((992&a)>>5))<<8|Math.round(8.226*((31744&a)>>10));for(b=b.toString(16);b.length<6;)b="0"+b;return"#"+b}this.flush(),65535===a?this.fg=void 0:32768>a&&(this.fg=c(a)),65535===b?this.bg=void 0:32768>b&&(this.bg=c(b))},set_window:function(a){this.flush(),this.currentwin=a,this.e.orders.push({code:"find",name:a?"status":"main"}),a&&this.status.push({code:"cursor",to:[0,0]})},split_window:function(a){this.flush(),this.status.push({code:"height",lines:a})},update_header:function(){var a=this.e.m;a.setUint8(44,isNaN(this.env.bg)?1:this.env.bg),a.setUint8(45,isNaN(this.env.fg)?1:this.env.fg),this.e.extension_table(5,this.env.fg_true),this.e.extension_table(6,this.env.bg_true)},formatters:{}}),GnustoRunner=Object.subClass({init:function(a,b){var c=this;b=window.engine=this.e=new GnustoEngine(window.console&&function(){console.log(msg)}||function(){}),this.io=new StructIO(a),this.env=this.io.env,this.io.TextInput.callback=function(a){c.inputEvent(a)}},fromParchment:function(a){var b,c=a.code,d=this.e;"load"==c&&d.loadStory(a.data),"restart"==c&&(this.restart(),b=1),"save"==c&&(d.answer(0,a.result||1),b=1),"restore"==c&&(this.ui||this.restart(),a.data?d.loadSavedGame(a.data):d.answer(0,0),b=1),b&&this.run()},restart:function(){var a=this.e,b=this.io;a.setByte(255,32),a.setByte(b.env.width,33),a.setWord(b.env.width,34),a.setWord(255,36),b.target=b.container.empty(),this.orders=[],this.ui=new ZVMUI(this,2&a.getByte(17)),b.event(this.orders),this.orders=[]},run:function(){var a,b,c,d,e,f,g=this.e,h=this.ui;for(this.orders=[];!e;)if(g.run(),a=g.consoleText(),a&&(h.buffer+=a),b='"'+g.effect(0)+'"',c=g.effect(1),d=g.effect(2),b==GNUSTO_EFFECT_INPUT&&(e=1,h.flush(),this.orders.push({code:"read",target:this.currentwin})),b==GNUSTO_EFFECT_INPUT_CHAR&&(e=1,this.orders.push({code:"char"})),b==GNUSTO_EFFECT_SAVE&&(e=1,g.saveGame(),this.toParchment({code:"save",data:g.saveGameData()})),b==GNUSTO_EFFECT_RESTORE&&(e=1,this.toParchment({code:"restore"})),b==GNUSTO_EFFECT_QUIT&&(e=1),b==GNUSTO_EFFECT_RESTART&&(g.resetStory(),this.restart(),h=this.ui),b==GNUSTO_EFFECT_FLAGS_CHANGED&&(h.flush(),h.mono=253&h.mono|2&g.m_printing_header_bits),b==GNUSTO_EFFECT_STYLE&&(0>c?h.set_colour(d,g.effect(3)):h.set_style(c)),b==GNUSTO_EFFECT_SPLITWINDOW&&h.split_window(c),b==GNUSTO_EFFECT_SETWINDOW&&h.set_window(c),b==GNUSTO_EFFECT_ERASEWINDOW&&h.erase_window(c),b==GNUSTO_EFFECT_ERASELINE&&h.erase_line(c),b==GNUSTO_EFFECT_SETCURSOR&&h.set_cursor(c,d),b==GNUSTO_EFFECT_GETCURSOR&&(e=1,h.get_cursor(c)),b==GNUSTO_EFFECT_PRINTTABLE)for(f=0;c>f;f++)h.buffer+="\n"+g.effect(2+f);h.flush(),h.status.length&&(this.orders.push({code:"stream",to:"status",data:this.ui.status}),h.status=[]),this.io.event(this.orders)},inputEvent:function(a){var b=this.e,c=a.code;"read"==c&&(this.ui.buffer+=a.response+"\n",b.answer(0,a.terminator),b.answer(1,a.response)),"char"==c&&b.answer(0,a.response),"get_cursor"==c&&(b.setWord(a.addr,a.pos[0]),b.setWord(a.addr+2,a.pos[1])),this.run()},act:function(){}});