/*
 * Parchment
 * Built: 2010-05-06
 *
 * Copyright (c) 2008-2010 The Parchment Contributors
 * Licenced under the GPL v2
 * http://code.google.com/p/parchment
 */
$.ajaxSetup({cache:true,dataType:"text",ifModified:location.protocol!=="file:"});var parchment={options:{default_story:"stories/troll.z5.js",lib_path:"lib/",page_title:1,proxy_url:"http://zcode.appspot.com/proxy/"},lib:{}};
/*
 * Simple JavaScript Inheritance
 * http://ejohn.org/blog/simple-javascript-inheritance/
 *
 * By John Resig
 * Released into the public domain?
 *
 * Inspired by base2 and Prototype
 */
(function(){var a=false,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;Object.subClass=function(g){var f=this.prototype;a=true;var e=new this();a=false;for(var d in g){e[d]=typeof g[d]=="function"&&typeof f[d]=="function"&&b.test(g[d])?(function(h,i){return function(){var k=this._super;this._super=f[h];var j=i.apply(this,arguments);this._super=k;return j}})(d,g[d]):g[d]}function c(){if(!a&&this.init){this.init.apply(this,arguments)}}c.prototype=e;c.constructor=c;c.subClass=arguments.callee;return c}})();
/*
 * Interchange File Format library
 *
 * Copyright (c) 2008-2010 The Gnusto Contributors
 * Licenced under the GPL v2
 * http://github.com/curiousdannii/gnusto
 */
(function(){function b(h,i){return h[i]<<24|h[i+1]<<16|h[i+2]<<8|h[i+3]}function c(h){return[(h>>24)&255,(h>>16)&255,(h>>8)&255,h&255]}function e(i,j){var h=String.fromCharCode;return h(i[j])+h(i[j+1])+h(i[j+2])+h(i[j+3])}function g(h){return[h.charCodeAt(0),h.charCodeAt(1),h.charCodeAt(2),h.charCodeAt(3)]}var f=Object.subClass({init:function a(k){this.type="";this.chunks=[];if(k){if(e(k,0)!="FORM"){throw new Error("Not an IFF file")}this.type=e(k,8);var j=12,h=k.length;while(j<h){var m=b(k,j+4);if(m<0||(m+j)>h){throw new Error("IFF: Chunk out of range")}this.chunks.push({type:e(k,j),offset:j,data:k.slice(j+8,j+8+m)});j+=8+m;if(m%2){j++}}}},write:function d(){var m=g(this.type);for(var n=0,j=this.chunks.length;n<j;n++){var k=this.chunks[n],o=k.data,h=o.length;m=m.concat(g(k.type),c(h),o);if(h%2){m.push(0)}}return g("FORM").concat(c(m.length),m)}});f.num_from=b;f.num_to_word=c;f.text_from=e;f.text_to_word=g;window.IFF=f})();function Querystring(a){this.params={};this.get=Querystring_get;if(a==null){}a=location.search.substring(1,location.search.length);if(a.length==0){return}a=a.replace(/\+/g," ");var c=a.split("&");for(var d=0;d<c.length;d++){var f=c[d].split("=");var b=unescape(f[0]);var e=(f.length==2)?unescape(f[1]):b;this.params[b]=e}}function Querystring_get(a,b){var c=this.params[a];return(c!=null)?c:b}
/*
 * Taken from "Remedial Javascript" by Douglas Crockford:
 * http://javascript.crockford.com/remedial.html
 */
function typeOf(b){var a=typeof b;if(a==="object"){if(b){if(typeof b.length==="number"&&!(b.propertyIsEnumerable("length"))&&typeof b.splice==="function"){a="array"}}else{a="null"}}return a}function isEmpty(c){var b,a;if(typeOf(c)==="object"){for(b in c){a=c[b];if(a!==undefined&&typeOf(a)!=="function"){return false}}}return true}String.prototype.entityify=function(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")};String.prototype.quote=function(){var e,b,a=this.length,d='"';for(b=0;b<a;b+=1){e=this.charAt(b);if(e>=" "){if(e==="\\"||e==='"'){d+="\\"}d+=e}else{switch(e){case"\b":d+="\\b";break;case"\f":d+="\\f";break;case"\n":d+="\\n";break;case"\r":d+="\\r";break;case"\t":d+="\\t";break;default:e=e.charCodeAt();d+="\\u00"+Math.floor(e/16).toString(16)+(e%16).toString(16)}}}return d+'"'};String.prototype.supplant=function(a){return this.replace(/{([^{}]*)}/g,function(d,c){var e=a[c];return typeof e==="string"||typeof e==="number"?e:d})};String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")};function FatalError(a){this.message=a;this.traceback=this._makeTraceback(arguments.callee);this.onError(this)}FatalError.prototype={onError:function(b){var a=b.message;if(typeof b.message=="string"){a=a.entityify()}$("#content").append('<div class="error">An error occurred:<br/><pre>'+a+"\n\n"+b.traceback+"</pre></div>")},_makeTraceback:function(a){var d="";var c=0;var b=100;while(a!=null&&c<b){var f=a.toString();if(!f){d="\n  (anonymous function)"+d}else{var g=f.match(/function (\w*)/);if(!g||!g[1]){d="\n  (anonymous function)"+d}else{d="\n  "+g[1]+d}}try{a=a.caller}catch(h){a=null}c++}if(c==b){d="..."+d}return"Traceback (most recent call last):\n"+d}};(function(e){function a(n,o){var o=o||[],m=0,k;for(k=n.length%8;m<k;++m){o.push(n.charCodeAt(m)&255)}for(k=n.length;m<k;){o.push(n.charCodeAt(m++)&255,n.charCodeAt(m++)&255,n.charCodeAt(m++)&255,n.charCodeAt(m++)&255,n.charCodeAt(m++)&255,n.charCodeAt(m++)&255,n.charCodeAt(m++)&255,n.charCodeAt(m++)&255)}return o}function i(p,o){var o=o||"",n=0,k,m=String.fromCharCode;for(k=p.length%8;n<k;++n){o+=m(p[n])}for(k=p.length;n<k;){o+=(m(p[n++])+m(p[n++])+m(p[n++])+m(p[n++])+m(p[n++])+m(p[n++])+m(p[n++])+m(p[n++]))}return o}if(e.atob){var c=function(l,k){return a(atob(l),k)},g=function(l,k){return btoa(i(l,k))}}else{var f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",b=(function(){var k=[],l=0;for(;l<f.length;l++){k[f.charAt(l)]=l}return k})(),c=function(q,o){var o=o||[],r,n,m,v,u,t,s,p=0,k=q.length;while(p<k){v=b[q.charAt(p++)];u=b[q.charAt(p++)];t=b[q.charAt(p++)];s=b[q.charAt(p++)];r=(v<<2)+(u>>4);n=((u&15)<<4)+(t>>2);m=((t&3)<<6)+s;o.push(r,n,m)}if(s==64){o.pop()}if(t==64){o.pop()}return o},g=function(q,o){var o=o||"",r,n,m,v,u,t,s,p=0,k=q.length;while(p<k){r=q[p++];n=q[p++];m=q[p++];v=r>>2;u=((r&3)<<4)+(n>>4);t=((n&15)<<2)+(m>>6);s=m&63;o+=(f.charAt(v)+f.charAt(u)+f.charAt(t)+f.charAt(s))}if(isNaN(n)){o=o.slice(0,-2)+"=="}else{if(isNaN(m)){o=o.slice(0,-1)+"="}}return o}}var j=jQuery.ajaxSettings.xhr(),h={binary:j.overrideMimeType!==undefined&&!$.browser.opera,cross_origin:j.withCredentials!==undefined};j=null;function d(o,r){var n=/^(file:|(\w+:)?\/\/[^\/?#]+)/,p;if($.isArray(o)){p=o[1];o=o[0]}var m=n.exec(location)[0],q=n.exec(o),k=q?q[0]:m,l={};if(k=="file:"&&(m!=k||(!h.binary&&!p))){throw"Can't load local files with this browser, sorry!"}if(o.slice(-3).toLowerCase()==".js"){e.processBase64Zcode=function(s){r(c(s));delete e.processBase64Zcode};$.getScript(o);return}if(h.binary&&m==k){l={beforeSend:function(s){s.overrideMimeType("text/plain; charset=x-user-defined")},success:function(s){r(a($.trim(s)))},url:o}}else{if(m==k&&p){l.url=p}else{l={data:{encode:"base64",url:o},dataType:"jsonp",url:parchment.options.proxy_url}}l.success=function(s){r(c($.trim(s)))}}l.error=function(s,t){throw new FatalError("Error loading story: "+t)};$.ajax(l)}e.file={text_to_array:a,array_to_text:i,base64_decode:c,base64_encode:g,download_to_array:d,support:h}})(window);(function(){var a=$(document);window.gIsIphone=navigator.userAgent.match(/iPhone|iPod|iPad|Android/i);if($.browser.msie&&parseInt($.browser.version)<7){$(function(){var c=$("#top-window"),b=function(){c.style.top=document.documentElement.scrollTop+"px"};c.css("position","absolute").resize(b).scroll(b)})}parchment.lib.LineInput=Object.subClass({init:function(b,e){var d=this,b=$(b),c=$("<input>",{"class":e||"",keydown:function(f){var g=f.which;if(g==38){d.prev_next(1)}if(g==40){d.prev_next(-1)}if(g==33||g==34){}}});d.form=$("<form>",{"class":"LineInput",submit:function(){d.submit();return false}}).append(c);a.bind("click.LineInput",function(){if($(".LineInput").length){c.focus()}});d.history=[];d.input=c;d.container=b},die:function(){a.unbind(".LineInput")},get:function(e){var d=this,b=d.container,c=d.input;d.callback=e||$.noop;d.current=0;d.mutable_history=d.history.slice();d.mutable_history.unshift("");c.width(b.width()-b.children().last().width()).val("");b.append(d.form);c.focus()},submit:function(){var b=this,c=b.input.val();b.form.detach();$('<span class="finished-input">'+c.entityify()+"</span><br>").appendTo(b.container);if(c!=b.history[0]&&/\S/.test(c)){b.history.unshift(c)}a.trigger({type:"LineInput",input:c});b.callback(c)},prev_next:function(g){var c=this,b=c.input,d=c.mutable_history,e=c.current,f=e+g;if(f<d.length&&f>=0){d[e]=b.val();b.val(d[f]);c.current=f}}});parchment.lib.CharInput=Object.subClass({init:function(){var c=this,b=$("<input>",{"class":"CharInput",keydown:function(d){c.keyCode=d.which;return false},keypress:function(d){c.charCode=d.which;c.submit();return false},});a.bind("click.CharInput",function(){if($(".CharInput").length){b.focus()}});c.input=b},die:function(){a.unbind(".CharInput")},get:function(c){var b=this;b.callback=c||$.noop;b.input.appendTo($("body")).focus()},submit:function(){var c=this,b={keyCode:c.keyCode,charCode:c.charCode};c.input.detach();a.trigger({type:"CharInput",input:b});c.callback(b)}})})();(function(e){var g=IFF.subClass({init:function a(o,j){this.title=j;if(o[0]<9){this.filetype="ok story naked zcode";this._super();this.chunks.push({type:"ZCOD",data:o});this.zcode=o}else{if(IFF.text_from(o,0)=="FORM"){this._super(o);if(this.type=="IFRS"){for(var m=0,h=this.chunks.length;m<h;m++){var n=this.chunks[m].type;if(n=="ZCOD"&&!this.zcode){this.zcode=this.chunks[m].data}else{if(n=="IFmd"){this.metadata=file.array_to_text(this.chunks[m].data);var k=$(this.metadata);if(k){if($("title",k)){this.title=$("title",k).text()}if($("ifid",k)){this.ifid=$("ifid",k).text()}if($("release",k)){this.release=$("release",k).text()}}}}}if(this.zcode){this.filetype="ok story blorbed zcode"}else{this.filetype="error: no zcode in blorb"}}else{if(this.type=="IFZS"){this.filetype="error: trying to load a Quetzal savefile"}else{this.filetype="error unknown iff"}}}else{this.filetype="error unknown general"}}},load:function b(h){if(this.zcode){h.loadStory(this.zcode)}}}),d=Object.subClass({add:function(h){this[h.ifid]=h;if(h.url){this.url[h.url]=h}},url:{}}),c=function(j,i){var k,l=1,o,h=parchment.options.lib_path,n=function(p){if($.isArray(p)){k=p}if(--l==0){o=setInterval(m,10)}},m=function(){if(i.loaded_zmachine||e.GnustoEngine&&e.Quetzal&&e.EngineRunner&&e.Console&&e.WebZui&&k){i.loaded_zmachine=true;clearInterval(o);$("#progress-text").html("Starting interpreter...");var u=typeof console!==undefined?function(){}:function(v){e.console.log(v)},r=new GnustoEngine(u),q=new WebZui(i,r,u),t=new EngineRunner(r,q,u),s=new g(k,storyName),p=location.hash;u("Story type: "+s.filetype);s.load(r);if(p&&p!="#"){r.loadSavedGame(file.base64_decode(p.slice(1)));u("Loading savefile")}t.run()}};if(!i.loaded_zmachine){l=3;$.getScript(h+"gnusto.min.js",n);$.getScript(h+"zmachine.min.js",n)}file.download_to_array(j,n)},f=Object.subClass({load:function(n){var j=parchment.options,h=new Querystring(),l=h.get("story",j.default_story),i=$.isArray(l)?l[0]:l;this.url=i;storyName=i.slice(i.lastIndexOf("/")+1);storyName=storyName?storyName+" - Parchment":"Parchment";if(j.page_title){e.document.title=storyName}if(this.stories.url[i]){var k=this.stories.url[i]}else{$("#progress-text").html("Retrieving story file...");try{c(l,this)}catch(m){throw new FatalError(m)}}},stories:new d(),savefiles:{}});e.Library=f})(window);(function(a){var c=a.parchment;function b(){if(a.parchment_options){$.extend(c.options,parchment_options)}var d=new Library();c.library=d;d.load();if(location.href.slice(0,31)=="http://parchment.googlecode.com"){$.getScript("http://www.google-analytics.com/ga.js",function(){_gat._getTracker("UA-7949545-1")._trackPageview()})}}$(b)})(window);