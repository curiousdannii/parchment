/*

Parchment
=========

Built: 2011-03-25

Copyright (c) 2008-2011 The Parchment Contributors
BSD licenced
http://code.google.com/p/parchment

*/
jQuery.ajaxSetup({cache:1,converters:{"* binary":true}});jQuery.ajaxPrefilter("script",function(a){if(a.isLocal){a.crossDomain=1}});var parchment={options:{container:"#parchment",lib_path:"lib/",page_title:1,panels:["search","url","about"],proxy_url:"http://zcode.appspot.com/proxy/"},lib:{}};(function(){var a=false,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;Object.subClass=function(g){var f=this.prototype;a=true;var e=new this();a=false;for(var d in g){e[d]=typeof g[d]=="function"&&typeof f[d]=="function"&&b.test(g[d])?(function(h,i){return function(){var k=this._super;this._super=f[h];var j=i.apply(this,arguments);this._super=k;return j}})(d,g[d]):g[d]}function c(){if(!a&&this.init){this.init.apply(this,arguments)}}c.prototype=e;c.constructor=c;c.subClass=arguments.callee;return c}})();(function(){function b(h,i){return h[i]<<24|h[i+1]<<16|h[i+2]<<8|h[i+3]}function c(h){return[(h>>24)&255,(h>>16)&255,(h>>8)&255,h&255]}function e(h,i){return String.fromCharCode(h[i],h[i+1],h[i+2],h[i+3])}function g(h){return[h.charCodeAt(0),h.charCodeAt(1),h.charCodeAt(2),h.charCodeAt(3)]}var f=Object.subClass({init:function a(k){this.type="";this.chunks=[];if(k){if(e(k,0)!="FORM"){throw new Error("Not an IFF file")}this.type=e(k,8);var j=12,h=k.length;while(j<h){var m=b(k,j+4);if(m<0||(m+j)>h){throw new Error("IFF: Chunk out of range")}this.chunks.push({type:e(k,j),offset:j,data:k.slice(j+8,j+8+m)});j+=8+m;if(m%2){j++}}}},write:function d(){var m=g(this.type);for(var n=0,j=this.chunks.length;n<j;n++){var k=this.chunks[n],o=k.data,h=o.length;m=m.concat(g(k.type),c(h),o);if(h%2){m.push(0)}}return g("FORM").concat(c(m.length),m)}});f.num_from=b;f.num_to_word=c;f.text_from=e;f.text_to_word=g;window.IFF=f})();
/*
 * Taken from "Remedial Javascript" by Douglas Crockford:
 * http://javascript.crockford.com/remedial.html
 */
function typeOf(b){var a=typeof b;if(a==="object"){if(b){if(typeof b.length==="number"&&!(b.propertyIsEnumerable("length"))&&typeof b.splice==="function"){a="array"}}else{a="null"}}return a}function isEmpty(c){var b,a;if(typeOf(c)==="object"){for(b in c){a=c[b];if(a!==undefined&&typeOf(a)!=="function"){return false}}}return true}String.prototype.entityify=function(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")};String.prototype.quote=function(){var e,b,a=this.length,d='"';for(b=0;b<a;b+=1){e=this.charAt(b);if(e>=" "){if(e==="\\"||e==='"'){d+="\\"}d+=e}else{switch(e){case"\b":d+="\\b";break;case"\f":d+="\\f";break;case"\n":d+="\\n";break;case"\r":d+="\\r";break;case"\t":d+="\\t";break;default:e=e.charCodeAt();d+="\\u00"+Math.floor(e/16).toString(16)+(e%16).toString(16)}}}return d+'"'};String.prototype.supplant=function(a){return this.replace(/{([^{}]*)}/g,function(d,c){var e=a[c];return typeof e==="string"||typeof e==="number"?e:d})};String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")};(function(a){window.FatalError=function(b){this.message=b;this.traceback=this._makeTraceback(arguments.callee);this.onError(this);if(a(".load").length>0){a(".load").detach()}};FatalError.prototype={onError:function(c){var b=c.message;if(typeof c.message=="string"){b=b.entityify()}a("#parchment").append('<div class="error">An error occurred:<br/><pre>'+b+"\n\n"+c.traceback+"</pre></div>");if(window.console){console.error(b)}},_makeTraceback:function(b){var f="";var d=0;var c=100;while(b!=null&&d<c){var g=b.toString();if(!g){f="\n  (anonymous function)"+f}else{var h=g.match(/function (\w*)/);if(!h||!h[1]){f="\n  (anonymous function)"+f}else{f="\n  "+h[1]+f}}try{b=b.caller}catch(i){b=null}d++}if(d==c){f="..."+f}return"Traceback (most recent call last):\n"+f}}})(jQuery);(function(g,e){var f=/chrome\/(\d+)/i.exec(navigator.userAgent),d=f&&parseInt(f[1])>4;function a(p,q){var q=q||[],o=0,n;for(n=p.length%8;o<n;++o){q.push(p.charCodeAt(o)&255)}for(n=p.length;o<n;){q.push(p.charCodeAt(o++)&255,p.charCodeAt(o++)&255,p.charCodeAt(o++)&255,p.charCodeAt(o++)&255,p.charCodeAt(o++)&255,p.charCodeAt(o++)&255,p.charCodeAt(o++)&255,p.charCodeAt(o++)&255)}return q}function k(o,n){return(n||"")+String.fromCharCode.apply(1,o)}if(g.atob){var c=function(o,n){return a(atob(o),n)},i=function(o,n){return btoa(k(o,n))}}else{var h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",b=(function(){var n=[],o=0;for(;o<h.length;o++){n[h.charAt(o)]=o}return n})(),c=function(s,q){var q=q||[],t,p,o,x,w,v,u,r=0,n=s.length;while(r<n){x=b[s.charAt(r++)];w=b[s.charAt(r++)];v=b[s.charAt(r++)];u=b[s.charAt(r++)];t=(x<<2)+(w>>4);p=((w&15)<<4)+(v>>2);o=((v&3)<<6)+u;q.push(t,p,o)}if(u==64){q.pop()}if(v==64){q.pop()}return q},i=function(s,q){var q=q||"",t,p,o,x,w,v,u,r=0,n=s.length;while(r<n){t=s[r++];p=s[r++];o=s[r++];x=t>>2;w=((t&3)<<4)+(p>>4);v=((p&15)<<2)+(o>>6);u=o&63;q+=(h.charAt(x)+h.charAt(w)+h.charAt(v)+h.charAt(u))}if(isNaN(p)){q=q.slice(0,-2)+"=="}else{if(isNaN(o)){q=q.slice(0,-1)+"="}}return q}}var l=jQuery.ajaxSettings.xhr(),j={binary:l.overrideMimeType&&!(e.browser.opera&&parseFloat(e.browser.version)<10.5)?"charset":0},m=function(p,s,o){var r,n,q;if(o.base64){if(g.atob){q=atob(e.trim(p));r=a(q)}else{r=c(e.trim(p))}}else{r=a(e.trim(p))}o.responseArray=r;o.responseText=q};l=undefined;e.ajaxPrefilter("binary",function(o,r,p){var q=o.isLocal&&!o.crossDomain&&d?0:j.binary,n=o.xhr;o.binary=q;p.done(m);o.jsonp=false;o.jsonpCallback="processBase64Zcode";p.base64=1;if(o.url.slice(-3).toLowerCase()==".js"){return"jsonp"}if(q&&!o.crossDomain){return"text"}if(o.legacy){o.url=o.legacy;return"jsonp"}o.data="url="+o.url;o.url=parchment.options.proxy_url;if(q&&e.support.cors){return"text"}o.data+="&encode=base64&callback=pproxy";o.jsonpCallback="pproxy";return"jsonp"});e.ajaxPrefilter("text",function(n,p,o){if(n.binary=="charset"){o.base64=0;n.mimeType="text/plain; charset=x-user-defined"}});g.file={text_to_array:a,array_to_text:k,base64_decode:c,base64_encode:i,support:j}})(window,jQuery);(function(a){var c=this,h=a(document),b=a("body"),f=/iPhone|iPod|iPad|Android/i,j=/\S/,d=c.scrollByPages||function(l){var k=h[0].documentElement.clientHeight,m=k-Math.min(k/10,parseInt(b.css("line-height"))*2);scrollBy(0,m*l)},i=c.getSelection||(document.selection&&function(){return document.selection.createRange().text})||function(){return""},e='<p><a href="'+location.href+"?story=http://mirror.ifarchive.org/",g=function(k){return e+k.path+'">'+k.desc.entityify()+"</a></p>"};c.gIsIphone=f.test(navigator.userAgent);if(a.browser.msie&&parseInt(a.browser.version)<7){a(function(){var l=a("#top-window"),k=function(){l.style.top=document.documentElement.scrollTop+"px"};l.css("position","absolute").resize(k).scroll(k)})}parchment.lib.UI=Object.subClass({init:function(k){this.library=k;this.panels={};this.load_indicator=a('<div class="dialog load"><p>Parchment is loading.<p>&gt; <blink>_</blink></div>')},stylesheet_add:function(){var k=arguments,l;for(l=1;l<k.length;l++){if(document.createStyleSheet){document.createStyleSheet(k[l])}else{a("<link>",{rel:"alternate stylesheet",href:k[l],title:k[0],type:"text/css"}).appendTo("head")[0].disabled=true}}},stylesheet_switch:function(l,k){a('link[rel*="stylesheet"][title="'+l+'"]').each(function(){this.disabled=!k})},load_panels:function(){var k=parchment.options.panels,o,n,m,l=function(){var q=RegExp(n.val().replace(" ","( )?"),"i"),p=a.grep(o,function(r){return q.test(r.path+r.desc)});p=p.slice(0,30);m.html(a.map(p,g).join(""))};if(a.inArray("search",k)!=-1){this.panels.search=a('<div class="panel search"><label for="panel_search">Search the IF Archive for games you can play with Parchment. You might also like to search the <a href="http://ifdb.tads.org">IFDB</a> or the <a href="http://ifwiki.org">IF Wiki</a>.</label><input id="panel_search"><div></div></div>');n=this.panels.search.find("input");m=n.next();n.keydown(function(){n.unbind("keydown");a.getJSON("stories/if-archive.json").done(function(p){o=p;n.keyup(l);l()})})}if(a.inArray("url",k)!=-1){this.panels.url=a('<form class="panel url"><label for="panel_url">You may use Parchment to play any story file on the internet, simply copy its address here:</label><input id="panel_url" name="story"></form>')}this.library.container.append(this.panels[k[0]]);this.panels.active=k[0]}});parchment.lib.TextInput=Object.subClass({init:function(k,o){var l=this,k=a(k),n=a("<input>",{autocapitalize:"off",keydown:function(q){var r=q.which,p;if(r==38){l.prev_next(1);p=1}if(r==40){l.prev_next(-1);p=1}if(r==33){d(-1);p=1}if(r==34){d(1);p=1}if(p){return false}}}),m=a("<input>",{"class":"CharInput",keydown:function(p){l.keyCode=p.which},keypress:function(p){l.charCode=p.which;l.submitChar();return false},keyup:function(p){l.submitChar()}});l.form=a("<form>",{"class":"LineInput",submit:function(){l.submitLine();return false}}).append(n);k.bind("click.TextInput",function(){if(i()==""){if(a(".LineInput").length){n.focus()}if(a(".CharInput").length){m.focus()}}});l.history=[];l.container=k;l.stream=a(o);l.lineInput=n;l.charInput=m},die:function(){this.container.unbind(".TextInput")},getLine:function(o,n){var m=this,k=m.stream.children().last(),l=m.lineInput;m.callback=o||a.noop;m.current=0;m.mutable_history=m.history.slice();m.mutable_history.unshift("");m.style=n||"";l.width(m.stream.width()-k.width()).val("").addClass(m.style);k.append(m.form);setTimeout(function(){l.focus()},1)},submitLine:function(){var k=this,l=k.lineInput.val();k.form.detach();k.lineInput.removeClass(k.style);a('<span class="finished-input">'+l.entityify()+"</span><br>").appendTo(k.stream.children().last());if(l!=k.history[0]&&j.test(l)){k.history.unshift(l)}h.trigger({type:"LineInput",input:l});k.callback(l)},prev_next:function(p){var l=this,k=l.lineInput,m=l.mutable_history,n=l.current,o=n+p;if(o<m.length&&o>=0){m[n]=k.val();k.val(m[o]);l.current=o}},getChar:function(m){var l=this,k=l.charInput;l.callback=m||a.noop;l.keyCode=l.charCode=0;l.container.append(k);setTimeout(function(){k.focus()},1)},submitChar:function(){var m=this,n=m.keyCode,k=m.charCode,l={keyCode:n,charCode:k};if(!n&&!k){return}m.charInput.detach();h.trigger({type:"CharInput",input:l});m.callback(l)}})})(jQuery);(function(g,d){var a=/story=([^;&]+)/,h=/vm=(\w+)/,i=/([-\w\s_]+)(\.[\w]+(\.js)?)?$/,k=/\.js$/,e=function(){throw new FatalError("Parchment could not load load the story. Check your connection, and that the URL is correct.")};parchment.lib.Story=IFF.subClass({init:function j(r,n){this.title=n;if(r[0]<9){this._super();this.chunks.push({type:"ZCOD",data:r});this.zcode=r}else{if(IFF.text_from(r,0)=="Glul"){this._super();this.chunks.push({type:"GLUL",data:r});this.glulx=r}else{if(IFF.text_from(r,0)=="FORM"){this._super(r);if(this.type=="IFRS"){for(var p=0,m=this.chunks.length;p<m;p++){var q=this.chunks[p].type;if(q=="ZCOD"&&!this.zcode){this.zcode=this.chunks[p].data}else{if(q=="GLUL"&&!this.glulx){this.glulx=this.chunks[p].data}else{if(q=="IFmd"){this.metadata=file.array_to_text(this.chunks[p].data);var o=d(this.metadata);if(o){if(d("title",o)){this.title=d("title",o).text()}if(d("ifid",o)){this.ifid=d("ifid",o).text()}if(d("release",o)){this.release=d("release",o).text()}}}}}}}}}}},load:function f(l){if(this.zcode){l.loadStory(this.zcode)}}});var b=Object.subClass({add:function(l){this[l.ifid]=l;if(l.url){this.url[l.url]=l}},url:{}}),c=Object.subClass({init:function(){this.container=d(parchment.options.container);this.ui=new parchment.lib.UI(this)},load:function(s){var l=this,n=parchment.options,q=a.exec(location.search),m,p=h.exec(location.search),o=0;if(n.lock_story){q=n.default_story}else{if(n.default_story||q){q=q&&unescape(q[1])||n.default_story}else{return this.ui.load_panels()}}d("#about").remove();d("body").append(l.ui.load_indicator);if(!d.isArray(q)){q=[q,0]}m=q[0];l.url=m;storyName=i.exec(m);storyName=storyName?storyName[1]+" - Parchment":"Parchment";if(n.page_title){g.document.title=storyName}if(p){p=parchment.vms[p[1]]}else{for(;o<parchment.vms.length;o++){if(parchment.vms[o].match.test(m)){p=parchment.vms[o];break}}}if(!p){throw new FatalError("File type is not supported!")}try{this.launch(p,q)}catch(r){throw new FatalError(r)}},launch:function(p,q){var m=this,r=[d.ajax(q[0],{dataType:"binary",legacy:q[1]}).done(function(t,u,s){s.library=m}).fail(e)],l=[],o=0,n;if(!p.loaded){p.loaded=1;while(o<p.files.length){n=parchment.options.lib_path+p.files[o++];if(k.test(n)){l.push(d.getScript(n))}else{this.ui.stylesheet_add(p.id,n)}}r[1]=d.when.apply(1,l)}d.when.apply(1,r).done(p.launcher)},stories:new b(),savefiles:{}});parchment.lib.Library=c;parchment.vms=[]})(window,jQuery);parchment.vms.quixe={id:"quixe",match:/(ulx|glb|(g|glulx.+)(blorb|blb))(.js)?$/i,files:["prototype.min.js","glkote.min.js","quixe.min.js","../src/quixe/media/i7-glkote.css","../src/quixe/media/dialog.css"],launcher:function(b){var d=b[2],a=d.library,c=new parchment.lib.Story(d.responseArray,storyName),e={inspacing:0,outspacing:0,vm:Quixe,};a.ui.stylesheet_switch("quixe",1);jQuery("#parchment").html('<div id="gameport"><div id="windowport"></div><div id="errorpane" style="display:none;"><div id="errorcontent">...</div></div><div id="layouttestpane">This should not be visible<div id="layouttest_grid" class="WindowFrame GridWindow"><div id="layouttest_gridline" class="GridLine"><span id="layouttest_gridspan" class="Style_normal">12345678</span></div><div id="layouttest_gridline2" class="GridLine"><span class="Style_normal">12345678</span></div></div><div id="layouttest_buffer" class="WindowFrame BufferWindow"><div id="layouttest_bufferline" class="BufferLine"><span id="layouttest_bufferspan" class="Style_normal">12345678</span></div><div id="layouttest_bufferline2" class="BufferLine"><span class="Style_normal">12345678</span></div></div></div></div>');if(jQuery(".load").length>0){jQuery(".load").detach()}Quixe.prepare(c.glulx,e);Glk.init(e)}};parchment.vms.push(parchment.vms.quixe);parchment.vms.gnusto={id:"gnusto",match:/(z[1-8]|zlb|(z|zcode.+)(blorb|blb))(.js)?$/i,files:["gnusto.min.js","zmachine.min.js"],launcher:function(c){var h=window.console&&function(i){console.log(i)}||function(){},g=c[2],d=new GnustoEngine(h),b=new parchment.lib.ZUI(g.library,d,h),f=new EngineRunner(d,b,h),e=new parchment.lib.Story(g.responseArray,storyName),a=location.hash;h("Story type: "+e.filetype);e.load(d);if(a&&a!="#"){d.loadSavedGame(file.base64_decode(a.slice(1)));h("Loading savefile")}f.run()}};parchment.vms.push(parchment.vms.gnusto);(function(a,b){var c=a.parchment;b(function(){if(a.parchment_options){b.extend(c.options,parchment_options)}var d=new c.lib.Library();c.library=d;d.load();if(location.href.indexOf("iplayif.com")!=-1){b.getScript("http://google-analytics.com/ga.js",function(){_gat._getTracker("UA-7949545-3")._trackPageview()})}})})(this,jQuery);