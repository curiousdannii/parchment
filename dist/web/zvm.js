var zt=Object.create;var J=Object.defineProperty;var Vt=Object.getOwnPropertyDescriptor;var It=Object.getOwnPropertyNames;var Rt=Object.getPrototypeOf,Lt=Object.prototype.hasOwnProperty;var w=(t,i)=>()=>(i||t((i={exports:{}}).exports,i),i.exports);var Pt=(t,i,e,s)=>{if(i&&typeof i=="object"||typeof i=="function")for(let r of It(i))!Lt.call(t,r)&&r!==e&&J(t,r,{get:()=>i[r],enumerable:!(s=Vt(i,r))||s.enumerable});return t};var H=(t,i,e)=>(e=t!=null?zt(Rt(t)):{},Pt(i||!t||!t.__esModule?J(e,"default",{value:t,enumerable:!0}):e,t));var b=w((_i,X)=>{"use strict";function O(){for(var t=arguments[0],i=1,e,s;i<arguments.length;){e=arguments[i++];for(s in e)t[s]=e[s]}return t}function K(){}K.subClass=function(t){function i(){this.init&&this.init.apply(this,arguments)}return i.prototype=O(Object.create(this.prototype),t),i.subClass=this.subClass,i.super=i.prototype.super=this.prototype,i};function Zt(t,i,e){return typeof t=="number"?t=new ArrayBuffer(t):t.buffer&&(i|=0,typeof e>"u"&&(e=t.byteLength-i),i+=t.byteOffset,t=t.buffer),O(new DataView(t,i,e),{getUint8Array:function(s,r){return s+=this.byteOffset,new Uint8Array(this.buffer.slice(s,s+r))},getUint16Array:function(s,r){return s+=this.byteOffset,W(new Uint8Array(this.buffer,s,r*2))},setUint8Array:function(s,r){r instanceof ArrayBuffer&&(r=new Uint8Array(r)),new Uint8Array(this.buffer,this.byteOffset,this.byteLength).set(r,s)},getFourCC:function(s){return String.fromCharCode(this.getUint8(s),this.getUint8(s+1),this.getUint8(s+2),this.getUint8(s+3))},setFourCC:function(s,r){this.setUint8(s,r.charCodeAt(0)),this.setUint8(s+1,r.charCodeAt(1)),this.setUint8(s+2,r.charCodeAt(2)),this.setUint8(s+3,r.charCodeAt(3))}})}function Nt(t){return t<<16>>16}function Tt(t){return t&65535}function W(t){for(var i=0,e=t.length,s=new Uint16Array(e/2);i<e;)s[i/2]=t[i++]<<8|t[i++];return s}X.exports={extend:O,Class:K,MemoryView:Zt,U2S16:Nt,S2U16:Tt,Uint8toUint16Array:W}});var V=w((pi,tt)=>{"use strict";var Y=b(),k=Y.MemoryView,z=Y.Class.subClass({init:function(t){if(this.type="",this.chunks=[],t){var i=k(t),e=12,s,r;if(i.getFourCC(0)!=="FORM")throw new Error("Not an IFF file");for(this.type=i.getFourCC(8),s=i.getUint32(4)+8;e<s;){if(r=i.getUint32(e+4),r<0||r+e>s)throw new Error("IFF chunk out of range");this.chunks.push({type:i.getFourCC(e),offset:e,data:i.getUint8Array(e+8,r)}),e+=8+r,r%2&&e++}}},write:function(){for(var t=12,i=0,e=12,s,r;i<this.chunks.length;)this.chunks[i].data.buffer&&(this.chunks[i].data=this.chunks[i].data.buffer),this.chunks[i].length=this.chunks[i].data.byteLength||this.chunks[i].data.length,t+=8+this.chunks[i++].length,t%2&&t++;for(s=k(t),s.setFourCC(0,"FORM"),s.setUint32(4,t-8),s.setFourCC(8,this.type),i=0;i<this.chunks.length;)r=this.chunks[i++],s.setFourCC(e,r.type),s.setUint32(e+4,r.length),s.setUint8Array(e+8,r.data),e+=8+r.length,e%2&&e++;return s.buffer}}),$=z.subClass({init:function(t){if(this.super.init.call(this,t),t){if(this.type!=="IFRS")throw new Error("Not a Blorb file");if(this.chunks[0].type!=="RIdx")throw new Error("Malformed Blorb: chunk 1 is not RIdx");for(var i=k(this.chunks[0].data),e=4;e<this.chunks[0].data.length;){if(i.getFourCC(e)==="Exec"&&i.getUint32(e+4)===0){this.exec=this.chunks.filter(function(s){return s.offset===i.getUint32(e+8)})[0];return}e+=12}}}}),Qt=z.subClass({init:function(t){if(this.super.init.call(this,t),t){if(this.type!=="IFZS")throw new Error("Not a Quetzal savefile");for(var i=0,e,s,r;i<this.chunks.length;)e=this.chunks[i].type,s=this.chunks[i++].data,e==="CMem"||e==="UMem"?(this.memory=s,this.compressed=e==="CMem"):e==="Stks"?this.stacks=s:e==="IFhd"&&(r=k(s.buffer),this.release=r.getUint16(0),this.serial=r.getUint8Array(2,6),this.checksum=r.getUint16(8),this.pc=r.getUint32(9)&16777215)}},write:function(){this.type="IFZS";var t=k(13);return t.setUint16(0,this.release),t.setUint8Array(2,this.serial),t.setUint32(9,this.pc),t.setUint16(8,this.checksum),this.chunks=[{type:"IFhd",data:t},{type:this.compressed?"CMem":"UMem",data:this.memory},{type:"Stks",data:this.stacks}],this.super.write.call(this)}});function Jt(t){var i=k(t),e,s,r;if(i.getFourCC(0)==="FORM"&&i.getFourCC(8)==="IFRS"?(e=new $(t),e.exec&&(s=e.exec.type,t=e.exec.data,s==="GLUL"&&(i=k(t),r=i.getUint32(4)),s==="ZCOD"&&(r=t[0]))):i.getFourCC(0)==="Glul"?(s="GLUL",r=i.getUint32(4)):(r=i.getUint8(0),r>0&&r<9&&(s="ZCOD")),s&&r)return{format:s,version:r,data:t}}tt.exports={IFF:z,Blorb:$,Quetzal:Qt,identify:Jt}});var L=w((gi,ft)=>{"use strict";var it=b(),S=it.Class,Ht=it.U2S16,et=S.subClass({init:function(t,i){this.e=t,this.v=i},toString:function(){return this.v},U2S:function(){return Ht(this.v)}}),Kt=et.subClass({toString:function(){var t=this.v;return this.indirect?"e.indirect("+t+")":t===0?"s[--e.sp]":--t<15?"l["+t+"]":"e.m.getUint16("+(this.e.globals+(t-15)*2)+")"},store:function(t){var i=this.v;return this.indirect?"e.indirect("+i+","+t+")":this.returnval?"e.variable("+i+","+t+")":i===0?"t="+t+";s[e.sp++]=t":--i<15?"l["+i+"]="+t:"e.ram.setUint16("+(this.e.globals+(i-15)*2)+","+t+")"},U2S:function(){return"e.U2S("+this+")"}}),A=S.subClass({init:function(t,i,e,s,r,n){this.e=t,this.context=i,this.code=e,this.pc=s,this.labels=[this.pc+"/"+this.code],this.next=r,this.operands=n,this.post&&this.post()},toString:function(){return this.label()+(this.func?this.func.apply(this,this.operands):"")},args:function(t){return this.operands.join(t)},label:function(){return"/* "+this.labels.join()+" */ "}}),I=A.subClass({stopper:1}),st=I.subClass({post:function(){this.origfunc=this.func,this.func=this.newfunc},newfunc:function(){return"e.stop=1;e.pc="+this.next+";"+this.origfunc.apply(this,arguments)}}),Wt=st.subClass({storer:1,post:function(){this.storer=this.operands.pop(),this.origfunc=this.func,this.func=this.newfunc}}),rt=S.subClass({init:function(t,i){this.ops=t||[],this.code=i||"||"},toString:function(){for(var t=0,i=[],e;t<this.ops.length;)e=this.ops[t++],i.push(e.func?(e.iftrue?"":"!(")+e.func.apply(e,e.operands)+(e.iftrue?"":")"):e);return(this.invert?"(!(":"(")+i.join(this.code)+(this.invert?"))":")")}}),nt=A.subClass({brancher:1,keyword:"if",post:function(){var t,i,e=this.operands.pop(),s=e[1];this.iftrue=e[0],s===0||s===1?t="e.ret("+s+")":(s+=this.next-2,this.context.targets.push(s),t="e.pc="+s),this.result=t+";return",this.offset=s,this.cond=new rt([this]),this.context.ops.length&&(i=this.context.ops.pop(),i.offset===s?(this.cond.ops.unshift(i.cond),this.labels=i.labels,this.labels.push(this.pc+"/"+this.code)):this.context.ops.push(i))},toString:function(){var t=this.result;return t instanceof R&&(this.e.options.debug&&(t.context=this.context),t=t+(t.stopper?"; return":""),this.result.ops.length>1&&(t=`
`+t+`
`,this.e.options.debug&&(t+=this.context.spacer))),this.label()+this.keyword+this.cond+" {"+t+"}"}}),ht=nt.subClass({storer:1,post:function(){ht.super.post.call(this),this.storer=this.operands.pop(),this.storer.returnval=1,this.origfunc=this.func,this.func=this.newfunc},newfunc:function(){return this.storer.store(this.origfunc.apply(this,arguments))}}),ot=A.subClass({storer:1,post:function(){this.storer=this.operands.pop()},toString:function(){var t=ot.super.toString.call(this);return this.storer?this.storer.store(t):t}}),at=I.subClass({result:{v:-1},toString:function(){return this.label()+"e.call("+this.operands.shift()+","+this.result.v+","+this.next+",["+this.args()+"])"}}),Xt=at.subClass({storer:1,post:function(){this.result=this.operands.pop()}}),R=S.subClass({init:function(t,i){this.e=t,this.pc=i,this.pre=[],this.ops=[],this.post=[],this.targets=[],t.options.debug&&(this.spacer="")},toString:function(){return this.e.options.debug?(this.context&&(this.spacer=this.context.spacer+"  "),this.pre.join("")+(this.ops.length>1?this.spacer:"")+this.ops.join(`;
`+this.spacer)+this.post.join("")):this.pre.join("")+this.ops.join(";")+this.post.join("")}}),ut=R.subClass({toString:function(){return this.pre.unshift(`var l=e.l,s=e.s,t=0;
`),ut.super.toString.call(this)}});function Yt(t,i,e){return e=e||{},i&&(e.func=i),t.subClass(e)}ft.exports={Operand:et,Variable:Kt,Opcode:A,Stopper:I,Pauser:st,PauserStorer:Wt,BrancherLogic:rt,Brancher:nt,BrancherStorer:ht,Storer:ot,Caller:at,CallerStorer:Xt,Context:R,RoutineContext:ut,opcode_builder:Yt}});var xt=w((wt,Ut)=>{"use strict";var d=L(),j=d.Variable,l=d.Opcode,g=d.Stopper,P=d.Pauser,D=d.PauserStorer,m=d.Brancher,Z=d.BrancherStorer,_=d.Storer,G=d.Caller,E=d.CallerStorer,a=d.opcode_builder,dt=function(t){return""+t},T=new j(wt.e,0),lt=a(m,function(){return 1}),ct=a(_,function(t){return"e.S2U(~"+t+")"}),N=_.subClass({storer:0,post:function(){var t=this.operands,i=t[0],e=i instanceof j;t[0]=new j(this.e,e?i:i.v),(e||i.v===0)&&(t[0].indirect=1),this.storer=this.code===142?t.pop():t.shift(),t.length===0&&t.push(T)},func:dt}),_t=l.subClass({func:function(t){var i=t.v-1,e=this.code%2?1:-1;return t instanceof j||i>14?"e.incdec("+t+","+e+")":(i<0?"e.s[e.sp-1]":"e.l["+i+"]")+(e===1?"++":"--")}}),pt=g.subClass({brancher:1,toString:function(){return"e.stop=1;e."+(this.code===181?"save":"restore")+"("+(this.pc+1)+")"}}),gt=a(D,function(){return"e.restore("+(this.next-1)+")"}),mt=a(D,function(){return"e.save("+(this.next-1)+")"});Ut.exports=function(t){return{1:a(m,function(){return arguments.length===2?this.args("==="):"e.jeq("+this.args()+")"}),2:a(m,function(i,e){return i.U2S()+"<"+e.U2S()}),3:a(m,function(i,e){return i.U2S()+">"+e.U2S()}),4:a(m,function(i,e){return"e.U2S(e.incdec("+i+",-1))<"+e.U2S()}),5:a(m,function(i,e){return"e.U2S(e.incdec("+i+",1))>"+e.U2S()}),6:a(m,function(){return"e.jin("+this.args()+")"}),7:a(m,function(){return"e.test("+this.args()+")"}),8:a(_,function(){return this.args("|")}),9:a(_,function(){return this.args("&")}),10:a(m,function(){return"e.test_attr("+this.args()+")"}),11:a(l,function(){return"e.set_attr("+this.args()+")"}),12:a(l,function(){return"e.clear_attr("+this.args()+")"}),13:N,14:a(l,function(){return"e.insert_obj("+this.args()+")"}),15:a(_,function(i,e){return"e.m.getUint16(e.S2U("+i+"+2*"+e.U2S()+"))"}),16:a(_,function(i,e){return"e.m.getUint8(e.S2U("+i+"+"+e.U2S()+"))"}),17:a(_,function(){return"e.get_prop("+this.args()+")"}),18:a(_,function(){return"e.find_prop("+this.args()+")"}),19:a(_,function(){return"e.find_prop("+this.args(",0,")+")"}),20:a(_,function(){return"e.S2U("+this.args("+")+")"}),21:a(_,function(){return"e.S2U("+this.args("-")+")"}),22:a(_,function(){return"e.S2U("+this.args("*")+")"}),23:a(_,function(i,e){return"e.S2U(parseInt("+i.U2S()+"/"+e.U2S()+"))"}),24:a(_,function(i,e){return"e.S2U("+i.U2S()+"%"+e.U2S()+")"}),25:E,26:G,27:a(l,function(){return"e.set_colour("+this.args()+")"}),28:a(g,function(i,e){return"while(e.frames.length+1>"+e+"){e.frameptr=e.frames.pop()}return "+i}),128:a(m,function(i){return i+"===0"}),129:a(Z,function(i){return"e.get_sibling("+i+")"}),130:a(Z,function(i){return"e.get_child("+i+")"}),131:a(_,function(i){return"e.get_parent("+i+")"}),132:a(_,function(i){return"e.get_prop_len("+i+")"}),133:_t,134:_t,135:a(l,function(i){return"e.print(2,"+i+")"}),136:E,137:a(l,function(i){return"e.remove_obj("+i+")"}),138:a(l,function(i){return"e.print(3,"+i+")"}),139:a(g,function(i){return"return "+i}),140:a(g,function(i){return"e.pc="+i.U2S()+"+"+(this.next-2)}),141:a(l,function(i){return"e.print(2,"+i+"*"+this.e.addr_multipler+")"}),142:N.subClass({storer:1}),143:t<5?ct:G,176:a(g,function(){return"return 1"}),177:a(g,function(){return"return 0"}),178:a(l,function(i){return"e.print(2,"+i+")"},{printer:1}),179:a(g,function(i){return"e.print(2,"+i+");e.print(1,13);return 1"},{printer:1}),180:l,181:t<4?pt:mt,182:t<4?pt:gt,183:a(g,function(){return"e.restart()"}),184:a(g,function(i){return"return "+i},{post:function(){this.operands.push(T)}}),185:t<5?a(l,function(){return"s[--e.sp]"}):a(_,function(){return"e.frames.length+1"}),186:a(P,function(){return"e.quit=1;e.Glk.glk_exit()"}),187:a(l,function(){return"e.print(1,13)"}),188:t<4?a(g,function(){return"e.pc="+this.next+";e.v3_status()"}):l,189:lt,191:lt,224:E,225:a(l,function(i,e,s){return"e.ram.setUint16(e.S2U("+i+"+2*"+e.U2S()+"),"+s+")"}),226:a(l,function(i,e,s){return"e.ram.setUint8(e.S2U("+i+"+"+e.U2S()+"),"+s+")"}),227:a(l,function(){return"e.put_prop("+this.args()+")"}),228:t<5?a(P,function(){return"e.read(0,"+this.args()+")"}):a(D,function(){return"e.read("+this.storer.v+","+this.args()+")"}),229:a(l,function(i){return"e.print(4,"+i+")"}),230:a(l,function(i){return"e.print(0,"+i.U2S()+")"}),231:a(_,function(i){return"e.random("+i.U2S()+")"}),232:a(_,dt,{post:function(){this.storer=T},storer:0}),233:N,234:a(l,function(i){return"e.split_window("+i+")"}),235:a(l,function(i){return"e.set_window("+i+")"}),236:E,237:a(l,function(i){return"e.erase_window("+i.U2S()+")"}),238:a(l,function(i){return"e.erase_line("+i+")"}),239:a(l,function(i,e){return"e.set_cursor("+i+"-1,"+e+"-1)"}),240:a(l,function(i){return"e.get_cursor("+i+")"}),241:a(l,function(i){return"e.set_style("+i+")"}),242:l,243:a(g,function(){return"e.pc="+this.next+";e.output_stream("+this.args()+")"}),244:a(P,function(){return"e.input_stream("+this.args()+")"}),245:l,246:a(D,function(){return"e.read_char("+this.storer.v+","+(this.args()||"1")+")"}),247:a(Z,function(){return"e.scan_table("+this.args()+")"}),248:ct,249:G,250:G,251:a(l,function(){return"e.tokenise("+this.args()+")"}),252:a(l,function(){return"e.encode_text("+this.args()+")"}),253:a(l,function(){return"e.copy_table("+this.args()+")"}),254:a(l,function(){return"e.print_table("+this.args()+")"}),255:a(m,function(i){return"e.stack.getUint8(e.frameptr+5)&(1<<("+i+"-1))"}),1e3:mt,1001:gt,1002:a(_,function(i,e){return"e.S2U(e.log_shift("+i+","+e.U2S()+"))"}),1003:a(_,function(i,e){return"e.S2U(e.art_shift("+i.U2S()+","+e.U2S()+"))"}),1004:a(_,function(i){return"e.set_font("+i+")"}),1009:a(_,function(){return"e.save_undo("+this.next+","+this.storer.v+")"}),1010:a(l,function(){return"if(e.restore_undo())return"},{storer:1}),1011:a(l,function(i){return"e.print(1,"+i+")"}),1012:a(_,function(){return 3}),1013:a(l,function(){return"e.set_true_colour("+this.args()+")"}),1014:l.subClass({brancher:1}),1030:a(_,function(){return"e.gestalt("+this.args()+")"})}}});var Ct=w((mi,yt)=>{"use strict";var kt=V(),y=b(),$t=y.extend,vt=y.U2S16,ti=y.S2U16;function Q(t){let i=s=>typeof s=="object"?Q(s):s,e={};if(Array.isArray(t))return t.map(i);for(let s in t)s!=="buffer"&&s!=="str"&&(e[s]=i(t[s]));return e}var bt=function(){var t=new Uint8Array(2),i=new Uint16Array(t.buffer);return i[0]=1,t[0]===1}();function B(t,i,e,s){if(bt&&!s)for(;i<e;)t.setUint16(i,t.getUint16(i,1)),i+=2}yt.exports={art_shift:function(t,i){return i>0?t<<i:t>>-i},call:function(t,i,e,s){if(t===0)return i>=0&&this.variable(i,0),this.pc=e;this.pc=t*this.addr_multipler;var r=this.m.getUint8(this.pc++),n=this.stack,h=0,o=this.frameptr;for(n.setUint16(o+6,this.sp),this.frames.push(o),o=this.frameptr=this.s.byteOffset+this.sp*2,n.setUint32(o,e<<8),n.setUint8(o+3,(i>=0?0:16)|r),n.setUint8(o+4,i>=0?i:0),n.setUint8(o+5,(1<<s.length)-1),this.make_stacks(),this.sp=0;h<r;)this.l[h]=h<s.length?s[h]:this.version<5?this.m.getUint16(this.pc+h*2):0,h++;this.version<5&&(this.pc+=r*2)},clear_attr:function(t,i){var e=this.objects+(this.version3?9:14)*t+i/8|0;this.ram.setUint8(e,this.m.getUint8(e)&~(128>>i%8))},copy_table:function(t,i,e){e=vt(e);var s=this.ram,r=0,n=e<0;if(e=Math.abs(e),i===0){for(;r<e;)s.setUint8(t+r++,0);return}if(n)for(;r<e;)s.setUint8(i+r,this.m.getUint8(t+r++));else s.setUint8Array(i,this.m.getUint8Array(t,e))},do_autorestore:function(t){let i=this.Glk;i.restore_allstate(t.glk),this.io=t.io;let e=new i.RefBox,s;for(;s=i.glk_window_iterate(s,e);)e.value===201&&(this.mainwin=s,s.linebuf&&(t.read_data.buffer=s.linebuf)),e.value===202&&(this.statuswin=s),e.value===203&&(this.upperwin=s);for(s=null;s=i.glk_stream_iterate(s,e);)e.value===210&&(this.io.streams[2].str=s),e.value===211&&(this.io.streams[4].str=s);this.restart(1),this.restore_file(this.options.Dialog.streaming?new Uint8Array(t.ram):Uint8Array.from(t.ram),1),this.read_data=t.read_data,this.xorshift_seed=t.xorshift_seed},do_autosave:function(t){if(!this.options.Dialog)throw new Error("A reference to Dialog is required");let i=null;if((t||0)>=0){let e=this.save_file(this.pc,1);i={glk:this.Glk.save_allstate(),io:Q(this.io),ram:this.options.Dialog.streaming?e:Array.from(new Uint8Array(e)),read_data:Q(this.read_data),xorshift_seed:this.xorshift_seed}}this.options.Dialog.autosave_write(this.signature,i)},encode_text:function(t,i,e,s){this.ram.setUint8Array(s,this.encode(this.m.getUint8Array(t+e,i)))},extension_table:function(t,i){var e=this.extension;if(!e||t>this.extension_count)return 0;if(e+=2*t,i===void 0)return this.m.getUint16(e);this.ram.setUint16(e,i)},find_prop:function(t,i,e){var s=this.m,r=this.version3,n,h,o=0,u=s.getUint16(this.objects+(r?9:14)*t+(r?7:12));for(u+=s.getUint8(u)*2+1;;){if(n=s.getUint8(u),h=n&(r?31:63),o===e)return h;if(h===i)return u+(!r&&n&128?2:1);if(h<i)return 0;o=h,r?u+=(n>>5)+2:n&128?(h=s.getUint8(u+1)&63,u+=h?h+2:66):u+=n&64?3:2}},gestalt:function(t){switch(t){case 1:return 258}return 0},get_child:function(t){return this.version3?this.m.getUint8(this.objects+9*t+6):this.m.getUint16(this.objects+14*t+10)},get_sibling:function(t){return this.version3?this.m.getUint8(this.objects+9*t+5):this.m.getUint16(this.objects+14*t+8)},get_parent:function(t){return this.version3?this.m.getUint8(this.objects+9*t+4):this.m.getUint16(this.objects+14*t+6)},get_prop:function(t,i){var e=this.m,s=this.find_prop(t,i),r;return s?(r=e.getUint8(s-1),e[(this.version3?r>>5:r&64)?"getUint16":"getUint8"](s)):e.getUint16(this.properties+2*(i-1))},get_prop_len:function(t){if(t===0)return 0;var i=this.m.getUint8(t-1);return this.version3?(i>>5)+1:i&128?(i&=63,i===0?64:i):i&64?2:1},incdec:function(t,i){if(t===0)return this.s[this.sp-1]+=i,this.s[this.sp-1];if(--t<15)return this.l[t]+=i,this.l[t];var e=this.globals+(t-15)*2;return this.ram.setUint16(e,this.m.getUint16(e)+i),this.ram.getUint16(e)},indirect:function(t,i){return t===0?arguments.length>1?this.s[this.sp-1]=i:this.s[this.sp-1]:this.variable(t,i)},insert_obj:function(t,i){this.remove_obj(t),this.set_family(t,i,i,t,t,this.get_child(i))},jeq:function(){for(var t=1;t<arguments.length;)if(arguments[t++]===arguments[0])return 1},jin:function(t,i){return this.get_parent(t)===i},log:function(t){this.options.GlkOte&&this.options.GlkOte.log(t)},log_shift:function(t,i){return i>0?t<<i:t>>>-i},make_stacks:function(){var t=this.stack.getUint8(this.frameptr+3)&15;this.l=new Uint16Array(this.stack.buffer,this.frameptr+8,t),this.s=new Uint16Array(this.stack.buffer,this.frameptr+8+t*2)},put_prop:function(t,i,e){var s=this.find_prop(t,i),r;s&&(r=this.m.getUint8(s-1),this.ram[(this.version3?r>>5:r&64)?"setUint16":"setUint8"](s,e))},random:function(t){var i=this.xorshift_seed;return t<1?(this.xorshift_seed=t,0):i===0?1+Math.random()*t|0:(i^=i<<13,i^=i>>17,this.xorshift_seed=i^=i<<5,1+(i&32767)%t)},remove_obj:function(t){var i=this.get_parent(t),e,s,r;if(i!==0)if(e=this.get_child(i),s=this.get_sibling(t),e===t)this.set_family(t,0,i,s);else{for(;r=this.get_sibling(e),r!==t;)e=r;this.set_family(t,0,0,0,e,s)}},restart:function(t){var i=this.ram,e=i.getUint8(0),s=e===3,r=s?2:e===8?8:4,n=i.getUint8(17),h=i.getUint16(10),o=e>4?i.getUint16(54):0,u=y.MemoryView(this.options.stack_len);i.setUint8Array(0,this.origram),i.setUint8(17,n),$t(this,{stack:u,frameptr:0,frames:[],s:new Uint16Array(u.buffer,8),sp:0,l:[],undo:[],undo_len:0,glk_blocking_call:null,version:e,version3:s,pc:i.getUint16(6),properties:h,objects:h+(s?53:112),globals:i.getUint16(12),eof:(i.getUint16(26)||65536)*r,extension:o,extension_count:o?i.getUint16(o):0,addr_multipler:r,opcodes:xt()(e)}),this.init_text(),t||this.init_io(),this.update_header()},restore:function(t){this.pc=t,this.fileref_create_by_prompt({func:"restore",mode:2,usage:1})},restore_file:function(t,i){var e=this.ram,s=new kt.Quetzal(t),r=s.memory,n=this.stack,h=e.getUint8(17),o,u=0,f=0;if(e.getUint16(2)!==s.release||e.getUint16(28)!==s.checksum)return 0;for(;u<6;)if(e.getUint8(18+u)!==s.serial[u++])return 0;if(u=0,e.setUint8Array(0,this.origram),s.compressed)for(;u<r.length;)o=r[u++],o===0?f+=1+r[u++]:e.setUint8(f,o^this.origram[f++]);else e.setUint8Array(0,r);for(e.setUint8(17,h),n.setUint8Array(0,s.stacks),this.frames=[],u=0;u<s.stacks.byteLength;)this.frameptr=u,this.frames.push(u),B(n,f=u+8,f+=(n.getUint8(u+3)&15)*2,i),B(n,f,f+=n.getUint16(u+6)*2,i),u=f;return this.frames.pop(),this.sp=n.getUint16(this.frameptr+6),this.make_stacks(),this.pc=s.pc,this.update_header(),this.version3&&this.split_window(0),2},restore_undo:function(){if(this.undo.length===0)return 0;var t=this.undo.pop();return this.frameptr=t.frameptr,this.pc=t.pc,this.undo_len-=t.ram.byteLength+t.stack.byteLength,t.ram[17]=this.m.getUint8(17),this.ram.setUint8Array(0,t.ram),this.frames=t.frames,this.sp=t.sp,this.stack.setUint8Array(0,t.stack),this.make_stacks(),this.variable(t.var,2),1},ret:function(t){var i=this.stack,e=this.frameptr,s=i.getUint8(e+3)&16?-1:i.getUint8(e+4);this.pc=i.getUint32(e)>>8,e=this.frameptr=this.frames.pop(),this.make_stacks(),this.sp=i.getUint16(e+6),s>=0&&this.variable(s,t||0)},save:function(t){this.pc=t,this.fileref_create_by_prompt({func:"save",mode:1,usage:1})},save_file:function(t,i){var e=this.m,s=new kt.Quetzal,r=y.MemoryView(this.stack.buffer.slice()),n=0,h,o,u=this.frameptr,f;if(s.release=e.getUint16(2),s.serial=e.getUint8Array(18,6),s.checksum=e.getUint16(28),s.pc=t,i)s.memory=this.m.getUint8Array(0,this.staticmem);else{let c=[];for(s.compressed=1,h=0;h<this.staticmem;h++)f=e.getUint8(h)^this.origram[h],f===0?++n===256&&(c.push(0,255),n=0):(n&&(c.push(0,n-1),n=0),c.push(f));s.memory=c}if(r.setUint16(u+6,this.sp),bt&&!i){let c=this.frames.slice();for(c.push(u),h=0;h<c.length;h++)u=c[h],B(r,o=u+8,o+=(r.getUint8(u+3)&15)*2),B(r,o,o+=r.getUint16(u+6)*2)}return s.stacks=r.getUint8Array(0,this.frameptr+8+(r.getUint8(u+3)&15)*2+this.sp*2),s.write()},save_restore_handler:function(t){var i=this.m,e=this.Glk,s=0,r=[],n,h,o;t&&(this.fileref_data.func==="save"?(e.glk_put_buffer_stream(t,new Uint8Array(this.save_file(this.pc))),s=1):(r=new Uint8Array(128*1024),e.glk_get_buffer_stream(t,r),s=this.restore_file(r.buffer)),e.glk_stream_close(t)),this.version3?(n=i.getUint8(this.pc++),h=n&128,o=n&64?n&63:(n<<8|i.getUint8(this.pc++))<<18>>18,!s==!h&&(o===0||o===1?this.ret(o):this.pc+=o-2)):this.variable(i.getUint8(this.pc++),s)},save_undo:function(t,i){var e;return this.undo_len>this.options.undo_len&&(e=this.undo.shift(),this.undo_len-=e.ram.byteLength+e.stack.byteLength),e={frameptr:this.frameptr,frames:this.frames.slice(),pc:t,ram:this.m.getUint8Array(0,this.staticmem),sp:this.sp,stack:this.stack.getUint8Array(0,this.s.byteOffset+this.sp*2),var:i},this.undo_len+=e.ram.byteLength+e.stack.byteLength,this.undo.push(e),1},scan_table:function(t,i,e,s){s=s||130;var r=s&128?"getUint16":"getUint8";for(s&=127,e=i+e*s;i<e;){if(this.m[r](i)===t)return i;i+=s}return 0},set_attr:function(t,i){var e=this.objects+(this.version3?9:14)*t+i/8|0;this.ram.setUint8(e,this.m.getUint8(e)|128>>i%8)},set_family:function(t,i,e,s,r,n){var h=this.ram,o=this.objects;this.version3?(h.setUint8(o+9*t+4,i),e&&h.setUint8(o+9*e+6,s),r&&h.setUint8(o+9*r+5,n)):(h.setUint16(o+14*t+6,i),e&&h.setUint16(o+14*e+10,s),r&&h.setUint16(o+14*r+8,n))},test:function(t,i){return(t&i)===i},test_attr:function(t,i){return this.m.getUint8(this.objects+(this.version3?9:14)*t+i/8|0)<<i%8&128},variable:function(t,i){var e=i!==void 0,s;if(t===0)if(e)this.s[this.sp++]=i;else return this.s[--this.sp];else if(--t<15)if(e)this.l[t]=i;else return this.l[t];else if(s=this.globals+(t-15)*2,e)this.ram.setUint16(s,i);else return this.m.getUint16(s);return i},U2S:vt,S2U:ti}});var St=w((di,Ft)=>{Ft.exports={init_text:function(){var t=this,i=this.m,e=this.version>4&&i.getUint16(52),s=this.extension_table(3),r=s&&i.getUint8(s++);this.abbr_addr=i.getUint16(24);function n(o){for(var u=[[],[],[]],f=0;f<78;)u[f/26|0][f%26]=o[f++];u[2][1]=13,t.alphabets=u}function h(o){for(var u={13:"\r"},f={13:13},c=0;c<o.length;)u[155+c]=String.fromCharCode(o[c]),f[o[c]]=155+c++;for(c=32;c<127;)u[c]=String.fromCharCode(c),f[c]=c++;t.unicode_table=u,t.reverse_unicode_table=f}n(e?i.getUint8Array(e,78):this.text_to_zscii(`abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ \r0123456789.,!?_#'"/\\-:()`,1)),h(s?i.getUint16Array(s,r):this.text_to_zscii(unescape("%E4%F6%FC%C4%D6%DC%DF%BB%AB%EB%EF%FF%CB%CF%E1%E9%ED%F3%FA%FD%C1%C9%CD%D3%DA%DD%E0%E8%EC%F2%F9%C0%C8%CC%D2%D9%E2%EA%EE%F4%FB%C2%CA%CE%D4%DB%E5%C5%F8%D8%E3%F1%F5%C3%D1%D5%E6%C6%E7%C7%FE%F0%DE%D0%A3%u0153%u0152%A1%BF"),1)),this.dictionaries={},this.dict=i.getUint16(8),this.parse_dict(this.dict)},decode:function(t,i){var e=this.m,s=t,r,n=[],h=0,o,u=0,f=[],c=[],p,x=0;if(this.jit[t])return this.jit[t];for(i=i?i+t:this.eof;t<i&&(r=e.getUint16(t),t+=2,n.push(r>>10&31,r>>5&31,r&31),!(r&32768)););for(;h<n.length;)o=n[h++],o===0?f.push(32):o<4?(p=1,f.push(-1),c.push("\uE000+this.abbr("+(32*(o-1)+n[h++])+")+\uE000")):o<6?u=o:u===2&&o===6?h+1<n.length&&f.push(n[h++]<<5|n[h++]):o<32&&f.push(this.alphabets[u][o-6]),u=u<4?0:u-3,h%3===0&&(h+=x,x=0);return f=this.zscii_to_text(f,c),p&&(f={toString:Function('return"'+f.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\r/g,"\\r").replace(/\uE000/g,'"')+'"').bind(this)}),s>=this.staticmem&&(this.jit[s]=f),f},encode:function(t){for(var i=this.alphabets,e=[],s=this.version3?6:9,r=0,n,h,o=[];e.length<s;)n=t[r++],n===32?e.push(0):(h=i[0].indexOf(n))>=0?e.push(h+6):(h=i[1].indexOf(n))>=0?e.push(4,h+6):(h=i[2].indexOf(n))>=0?e.push(5,h+6):n===void 0?e.push(5):e.push(5,6,n>>5,n&31);for(e.length=s,r=0;r<s;)o.push(e[r++]<<2|e[r]>>3,(e[r++]&7)<<5|e[r++]);return o[o.length-2]|=128,o},zscii_to_text:function(t,i){for(var e=0,s=t.length,r,n=0,h="";e<s;)r=t[e++],r===-1&&(h+=i[n++]),(r=this.unicode_table[r])&&(h+=r);return h},text_to_zscii:function(t,i){for(var e=[],s=0,r=t.length,n;s<r;)n=t.charCodeAt(s++),i||(n=this.reverse_unicode_table[n]||63),e.push(n);return e},parse_dict:function(t){var i=this.m,e=t,s={},r,n,h=i.getUint8(t++);for(s.separators=Array.prototype.slice.call(i.getUint8Array(t,h)),t+=h,r=i.getUint8(t++),n=t+2+r*i.getUint16(t),t+=2;t<n;)s[Array.prototype.toString.call(i.getUint8Array(t,this.version3?4:6))]=t,t+=r;return this.dictionaries[e]=s,s},abbr:function(t){return this.decode(this.m.getUint16(this.abbr_addr+2*t)*2)},tokenise:function(t,i,e,s){e=e||this.dict,e=this.dictionaries[e]||this.parse_dict(e);var r=this.m,n=this.ram,h=1e3,o=1,u,f=e.separators,c,p=[],x,v,U=0;for(this.version>4&&(h=r.getUint8(t+o++)+2);o<h&&(u=r.getUint8(t+o),u!==0);)u===32||f.indexOf(u)>=0?(u!==32&&p.push([[u],o]),c=null):(c||(p.push([[],o]),c=p[p.length-1][0]),c.push(u)),o++;for(x=Math.min(p.length,r.getUint8(i));U<x;)v=e[""+this.encode(p[U][0])],(!s||v)&&(n.setUint16(i+2+U*4,v||0),n.setUint8(i+4+U*4,p[U][0].length),n.setUint8(i+5+U*4,p[U][1])),U++;n.setUint8(i+1,U)}}});var jt=w((wi,Et)=>{"use strict";var ii=b(),ei=ii.U2S16,si=function(){for(var t={4294967289:8,4294967290:13,4294967288:27,4294967292:129,4294967291:130,4294967294:131,4294967293:132,4294967283:146,4294967285:148,4294967284:152,4294967286:154},i=0;i<12;)t[4294967279-i]=133+i++;return t}(),ri=[0,2,1,10,4,9,5,6];function At(t){let i=[0,8,16,25,33,41,49,58,66,74,82,90,99,107,115,123,132,140,148,156,165,173,181,189,197,206,214,222,230,239,247,255];return i[t&31]<<16|i[(t&992)>>5]<<8|i[(t&31744)>>10]}var Gt=[65534,65535,0,29,832,957,22944,31775,30624,32767,23254,17969,11627];Et.exports={init_io:function(){this.io={reverse:0,bold:0,italic:0,bg:-1,fg:-1,mono:this.m.getUint8(17)&2,transcript:this.m.getUint8(17)&1,streams:[0,1,{},[],{}],currentwin:0,height:0,glkheight:0,maxheight:0,seenheight:0,width:0,row:0,col:0},this.open_windows()},erase_line:function(t){if(t===1){var i=this.io,e=i.row,s=i.col;this._print(Array(i.width-i.col+1).join(" ")),this.set_cursor(e,s)}},erase_window:function(t){t<1&&(this.Glk.glk_window_clear(this.mainwin),this.io.bg>=0?this.Glk.glk_stylehint_set(3,0,8,this.io.bg):this.io.bg===-1&&this.Glk.glk_stylehint_clear(3,0,8)),t!==0&&(t===-1&&this.split_window(0),this.upperwin&&(this.Glk.glk_window_clear(this.upperwin),this.set_cursor(0,0)))},fileref_create_by_prompt:function(t){typeof t.run>"u"&&(t.run=1),this.fileref_data=t,this.glk_blocking_call="fileref_create_by_prompt",this.Glk.glk_fileref_create_by_prompt(t.usage,t.mode,t.rock||0)},fix_upper_window:function(){var t=this.Glk,i=this.io;i.seenheight>=i.maxheight&&(i.maxheight=i.height),this.upperwin&&(i.maxheight===0?(t.glk_window_close(this.upperwin),this.upperwin=null):i.maxheight!==i.glkheight&&t.glk_window_set_arrangement(t.glk_window_get_parent(this.upperwin),18,i.maxheight,null),i.glkheight=i.maxheight),i.seenheight=i.maxheight,i.maxheight=i.height},format:function(){this.Glk.glk_set_style(ri[!!this.io.mono|this.io.italic|this.io.bold]),this.Glk.glk_gestalt(4352,0)&&this.Glk.garglk_set_reversevideo(this.io.reverse)},get_cursor:function(t){this.ram.setUint16(t,this.io.row+1),this.ram.setUint16(t+2,this.io.col+1)},handle_char_input:function(t){var i=this.io.streams[4],e=si[t]||this.reverse_unicode_table[t]||63;this.variable(this.read_data.storer,e),i.mode===1&&(i.cache+=e),i.mode===2&&this.Glk.glk_put_char_stream_uni(i.str,e)},handle_create_fileref:function(t){var i=this.Glk,e=this.fileref_data,s;return t&&(e.unicode?s=i.glk_stream_open_file_uni(t,e.mode,e.rock||0):s=i.glk_stream_open_file(t,e.mode,e.rock||0),i.glk_fileref_destroy(t)),(e.func==="restore"||e.func==="save")&&this.save_restore_handler(s),e.func==="input_stream"&&(this.io.streams[0]=s),e.func==="output_stream"&&this.output_stream_handler(s),e.run},handle_line_input:function(t,i){var e=this.ram,s=this.read_data,r=this.io.streams,n=String.fromCharCode.apply(null,s.buffer.slice(0,t))+`
`,h=this.text_to_zscii(n.slice(0,-1).toLowerCase());r[2].mode===1&&(r[2].cache+=n),r[2].mode===2&&this.Glk.glk_put_jstring_stream(r[2].str,n),r[4].mode===1&&(r[4].cache+=n),r[4].mode===2&&this.Glk.glk_put_jstring_stream(r[4].str,n),this.version<5?(h.push(0),e.setUint8Array(s.bufaddr+1,h)):(e.setUint8(s.bufaddr+1,t),e.setUint8Array(s.bufaddr+2,h),this.variable(s.storer,isNaN(i)?13:i)),s.parseaddr&&this.tokenise(s.bufaddr,s.parseaddr)},input_stream:function(t){var i=this.io;t&&!i.streams[0]&&this.fileref_create_by_prompt({func:"input_stream",mode:2,rock:212,unicode:1,usage:259}),!t&&i.streams[0]&&(this.Glk.glk_stream_close(i.streams[0]),i.streams[0]=0)},open_windows:function(){let t=this.Glk;if(this.mainwin)t.glk_stylehint_clear(0,0,8),this.Glk.glk_gestalt(4352,0)&&t.garglk_set_zcolors_stream(this.mainwin.str,this.io.fg,this.io.bg),t.glk_window_clear(this.mainwin),this.upperwin&&(t.glk_window_close(this.upperwin),this.upperwin=null);else{let i=[1,2,4,5,6,9,10];for(let e=0;e<7;e++)t.glk_stylehint_set(0,i[e],3,0),t.glk_stylehint_set(0,i[e],4,0),t.glk_stylehint_set(0,i[e],5,0),t.glk_stylehint_set(0,i[e],6,1);t.glk_stylehint_set(0,4,4,1),t.glk_stylehint_set(0,1,5,1),t.glk_stylehint_set(0,5,4,1),t.glk_stylehint_set(0,5,5,1),t.glk_stylehint_set(0,2,6,0),t.glk_stylehint_set(0,9,4,1),t.glk_stylehint_set(0,9,6,0),t.glk_stylehint_set(0,10,5,1),t.glk_stylehint_set(0,10,6,0),t.glk_stylehint_set(0,6,4,1),t.glk_stylehint_set(0,6,5,1),t.glk_stylehint_set(0,6,6,0),this.mainwin=t.glk_window_open(0,0,0,3,201),t.glk_set_window(this.mainwin),this.version3&&(this.statuswin=t.glk_window_open(this.mainwin,18,1,4,202),this.statuswin&&this.Glk.glk_gestalt(4352,0)&&t.garglk_set_reversevideo_stream(t.glk_window_get_stream(this.statuswin),1))}},output_stream:function(t,i,e){var s=this.ram,r=this.io.streams,n,h;t=ei(t),t===1&&(r[1]=1),t===-1&&(r[1]=0),t===2&&!r[2].mode&&(this.fileref_create_by_prompt({func:"output_stream",mode:5,rock:210,run:!e,str:2,unicode:1,usage:258}),r[2].cache="",r[2].mode=1,e||(this.stop=1)),t===-2&&(s.setUint8(17,s.getUint8(17)&254),r[2].mode===2&&this.Glk.glk_stream_close(r[2].str),r[2].mode=this.io.transcript=0),t===3&&r[3].unshift([i,""]),t===-3&&(n=r[3].shift(),h=this.text_to_zscii(n[1]),s.setUint16(n[0],h.length),s.setUint8Array(n[0]+2,h)),t===4&&!r[4].mode&&(this.fileref_create_by_prompt({func:"output_stream",mode:5,rock:211,str:4,unicode:1,usage:259}),r[4].cache="",r[4].mode=1,this.stop=1),t===-4&&(r[4].mode===2&&this.Glk.glk_stream_close(r[4].str),r[4].mode=0)},output_stream_handler:function(t){var i=this.ram,e=this.io.streams,s=this.fileref_data;s.str===2&&(i.setUint8(17,i.getUint8(17)&254|(t?1:0)),t?(e[2].mode=2,e[2].str=t,this.io.transcript=1,e[2].cache&&this.Glk.glk_put_jstring_stream(e[2].str,e[2].cache)):e[2].mode=this.io.transcript=0),s.str===4&&(t?(e[4].mode=2,e[4].str=t,e[4].cache&&this.Glk.glk_put_jstring_stream(e[4].str,e[4].cache)):e[4].mode=0)},_print:function(t){var i=this.Glk,e=this.io,s=0;if(e.streams[3].length)e.streams[3][0][1]+=t;else if(t=t.replace(/\r/g,`
`),(this.m.getUint8(17)&1)!==e.transcript&&this.output_stream(e.transcript?-2:2,0,1),(this.m.getUint8(17)&2)!==(e.mono&2)&&(e.mono^=2,this.format()),e.currentwin&&this.upperwin)for(;s<t.length&&e.row<e.height;)i.glk_put_jstring(t[s++]),e.col++,e.col===e.width&&(e.col=0,e.row++);else e.currentwin||(e.streams[1]&&i.glk_put_jstring(t),e.streams[2].mode===1&&(e.streams[2].cache+=t),e.streams[2].mode===2&&i.glk_put_jstring_stream(e.streams[2].str,t))},print:function(t,i){var e,s;if(t===0&&(s=i),t===1&&(s=String.fromCharCode(i)),t===2&&(s=this.jit[i]||this.decode(i)),t===3&&(e=this.m.getUint16(this.objects+(this.version3?9:14)*i+(this.version3?7:12)),s=this.decode(e+1,this.m.getUint8(e)*2)),t===4){if(!this.unicode_table[i])return;s=this.unicode_table[i]}this._print(""+s)},print_table:function(t,i,e,s){e=e||1,s=s||0;for(var r=0;r++<e;)this._print(this.zscii_to_text(this.m.getUint8Array(t,i))+(r<e?"\r":"")),t+=i+s},read:function(t,i,e,s,r){var n=this.m.getUint8(i),h=0,o,u;if(this.version3&&this.v3_status(),this.version<5&&n--,o=Array(n),o.fill(0),this.read_data={buffer:o,bufaddr:i,parseaddr:e,routine:r,storer:t,time:s},this.io.streams[0]){if(u=this.Glk.glk_get_line_stream_uni(this.io.streams[0],o),o[u-1]===10&&u--,u)return this._print(String.fromCharCode.apply(null,o.slice(0,u))+`
`),this.handle_line_input(u),this.stop=0;this.input_stream(0)}this.Glk.glk_request_line_event_uni(this.io.currentwin?this.upperwin:this.mainwin,o,h),this.fix_upper_window()},read_char:function(t,i,e,s){if(this.io.streams[0]){var r=this.Glk.glk_get_char_stream_uni(this.io.streams[0]);if(r===-1)this.input_stream(0);else return this.variable(t,r),this.stop=0}this.read_data={routine:s,storer:t,time:e},this.Glk.glk_request_char_event_uni(this.io.currentwin?this.upperwin:this.mainwin),this.fix_upper_window()},set_colour:function(t,i){this.set_true_colour(Gt[t],Gt[i])},set_cursor:function(t,i){var e=this.io;!e.currentwin||(t>=e.height&&this.split_window(t+1),this.upperwin&&t>=0&&i>=0&&i<e.width&&(this.Glk.glk_window_move_cursor(this.upperwin,i,t),e.row=t,e.col=i))},set_font:function(t){var i=this.io.mono&4?4:1;return t===0?i:t!==1&&t!==4?0:(t!==i&&(this.io.mono^=4,this.format()),i)},set_style:function(t){var i=this.io;t===0&&(i.reverse=i.bold=i.italic=0,i.mono&=254),t&1&&(i.reverse=1),t&2&&(i.bold=4),t&4&&(i.italic=2),t&8&&(i.mono|=1),this.format()},set_true_colour:function(t,i){let e=this.Glk;if(e.glk_gestalt(4352,0)){let s,r;t===65534?s=-2:(t===65535?s=-1:s=At(t),this.io.fg=s),i===65534?r=-2:(i===65535?r=-1:r=At(i),this.io.bg=r),e.garglk_set_zcolors_stream(this.mainwin.str,s,r),this.upperwin&&e.garglk_set_zcolors_stream(this.upperwin.str,s,r)}},set_window:function(t){this.io.currentwin=t,t&&this.set_cursor(0,0),this.Glk.glk_set_window(this.upperwin&&t?this.upperwin:this.mainwin),this.format()},split_window:function(t){var i=this.Glk,e=this.io,s=e.row,r=e.col,n=e.height,h;if(e.height=t,this.upperwin&&t>n){for(h=i.glk_window_get_stream(this.upperwin);n<t;)i.glk_window_move_cursor(this.upperwin,0,n++),i.glk_put_jstring_stream(h,Array(e.width+1).join(" "));i.glk_window_move_cursor(this.upperwin,r,s)}t>e.maxheight&&(e.maxheight=t,this.upperwin?i.glk_window_set_arrangement(i.glk_window_get_parent(this.upperwin),18,e.maxheight,null):(this.io.bg>=0&&i.glk_stylehint_set(4,0,8,this.io.bg),this.upperwin=i.glk_window_open(this.mainwin,18,e.maxheight,4,203),this.Glk.glk_gestalt(4352,0)&&i.garglk_set_zcolors_stream(this.upperwin.str,this.io.fg,this.io.bg),i.glk_stylehint_clear(4,0,8)),e.glkheight=e.maxheight),t&&(e.row>=t&&this.set_cursor(0,0),this.version3&&i.glk_window_clear(this.upperwin))},update_header:function(){var t=this.ram;if(this.xorshift_seed=0,this.update_screen_size(),this.version3)return t.setUint8(1,t.getUint8(1)&143|(this.statuswin?32:16)|64);t.setUint8(1,(this.Glk.glk_gestalt(4352,0)?1:0)|t.getUint8(1)&2|28|0),t.setUint8(17,t.getUint8(17)&87),this.version>4&&t.setUint16(38,257),t.setUint16(50,258),this.extension_table(4,0)},update_screen_size:function(){let t=this.Glk,i=new t.RefBox,e=new t.RefBox,s=t.glk_window_open(this.mainwin,18,0,4,0),r=0,n=0;t.glk_window_get_size(this.mainwin,e,i),r=i.get_value(),this.upperwin&&(t.glk_window_get_size(this.upperwin,e,i),r+=i.get_value()),this.statuswin&&(t.glk_window_get_size(this.statuswin,e,i),r+=i.get_value()),s&&(t.glk_window_get_size(s,e,0),t.glk_window_close(s)),n=e.get_value(),r=Math.min(r,254),n=this.io.width=Math.min(n,255),this.version>3&&(this.ram.setUint8(32,r),this.ram.setUint8(33,n)),this.version>4&&(this.ram.setUint16(34,n),this.ram.setUint16(36,r)),this.io.col>=n&&(this.io.col=n-1)},v3_status:function(){if(!!this.statuswin){var t=this.Glk,i=t.glk_window_get_stream(this.statuswin),e=this.m,s=this.io.width,r=e.getUint16(this.globals+2),n=e.getUint16(this.globals+4),h=e.getUint16(this.objects+9*e.getUint16(this.globals)+7),o=""+this.decode(h+1,e.getUint8(h)*2),u;e.getUint8(1)&2?u="Time: "+(r%12===0?12:r%12)+":"+(n<10?"0":"")+n+" "+(r>11?"PM":"AM"):u="Score: "+r+"  Turns: "+n,t.glk_window_move_cursor(this.statuswin,0,0),t.glk_put_jstring_stream(i,Array(s+1).join(" ")),t.glk_window_move_cursor(this.statuswin,0,0),t.glk_put_jstring_stream(i," "+o.slice(0,s-u.length-4)),t.glk_window_move_cursor(this.statuswin,s-u.length-1,0),t.glk_put_jstring_stream(i,u)}}}});var Bt=w((Ui,Dt)=>{var C=L();Dt.exports.disassemble=function(){var t,i,e=this.m,s=this.opcodes,r,n,h,o,u,f=new C.RoutineContext(this,this.pc);function c(p,x){for(var v=0;v<4;v++)x.push((p&192)>>6),p<<=2}for(;;){if(i=t=this.pc,n=e.getUint8(t++),n===190?(o=-1,n=e.getUint8(t++)+1e3):n&128?n&64?(o=-1,n&32||(n&=31)):(o=[(n&48)>>4],o[0]<3&&(n&=207)):(o=[n&64?2:1,n&32?2:1],n&=31),!s[n])throw this.log(""+f),this.stop=1,new Error("Unknown opcode #"+n+" at pc="+i);for(h=s[n].prototype,o===-1&&(o=[],c(e.getUint8(t++),o),(n===236||n===250)&&c(e.getUint8(t++),o)),u=[],r=0;r<o.length;)o[r]===0&&(u.push(new C.Operand(this,e.getUint16(t))),t+=2),o[r]===1&&u.push(new C.Operand(this,e.getUint8(t++))),o[r++]===2&&u.push(new C.Variable(this,e.getUint8(t++)));if(h.storer&&u.push(new C.Variable(this,e.getUint8(t++))),h.brancher&&(r=e.getUint8(t++),u.push([r&128,r&64?r&63:(r<<8|e.getUint8(t++))<<18>>18])),h.printer)for(u.push(t);t<this.eof&&(r=e.getUint8(t),t+=2,!(r&128)););if(this.pc=t,f.ops.push(new s[n](this,f,n,i,t,u)),r=0,h.stopper&&!r)break}return f}});var qt=w((xi,Mt)=>{"use strict";var F=b(),ni=V(),hi={stack_len:100*1e3,undo_len:1e3*1e3},oi={init:function(){this.jit={},this.init=this.start},prepare:function(t,i){if(!i.Glk)throw new Error("A reference to Glk is required");this.Glk=i.Glk,this.data=t,this.options=F.extend({},hi,i)},start:function(){var t=this.Glk,i;try{if(i=ni.identify(this.data),delete this.data,!i||i.format!=="ZCOD")throw new Error("This is not a Z-Code file");if([3,4,5,8].indexOf(i.version)<0)throw new Error("Unsupported Z-Machine version: "+i.version);this.m=F.MemoryView(i.data),this.staticmem=this.m.getUint16(14),this.ram=F.MemoryView(this.m,0,this.staticmem),this.origram=this.m.getUint8Array(0,this.staticmem);let e="",s=0;for(;s<30;)e+=(this.origram[s]<16?"0":"")+this.origram[s++].toString(16);this.signature=e;let r,n=this.options.Dialog;if(n){if(this.options.clear_vm_autosave)n.autosave_write(e,null);else if(this.options.do_vm_autosave)try{let h=n.autosave_read(e);h&&(this.do_autorestore(h),r=1)}catch(h){this.log("Autorestore failed, deleting it: "+h),n.autosave_write(e,null)}}r||(this.restart(),this.run()),this.quit||(this.glk_event=new t.RefStruct,this.glk_blocking_call?this.glk_event.push_field(this.glk_blocking_call):t.glk_select(this.glk_event)),t.update()}catch(e){t.fatal_error(e),console.log(e)}},resume:function(t){var i=this.Glk,e=this.glk_event,s,r;try{s=e.get_field(0),s===2&&(this.handle_char_input(e.get_field(2)),r=1),s===3&&(this.handle_line_input(e.get_field(2),e.get_field(3)),r=1),s===5&&this.update_screen_size(),s==="fileref_create_by_prompt"&&(r=this.handle_create_fileref(t)),this.glk_blocking_call=null,r&&this.run(),this.quit||(this.glk_event=new i.RefStruct,this.glk_blocking_call?this.glk_event.push_field(this.glk_blocking_call):i.glk_select(this.glk_event)),i.update()}catch(n){i.fatal_error(n),console.log(n)}},get_signature:function(){return this.signature},run:function(){var t,i;for(this.stop=0;!this.stop;)t=this.pc,this.jit[t]||this.compile(),i=this.jit[t](this),isNaN(i)||this.ret(i)},compile:function(){var t=this.disassemble();this.jit[t.pc]=new Function("e",""+t),t.pc<this.staticmem&&this.log("Caching a JIT function in dynamic memory: "+t.pc)}},ai=F.Class.subClass(F.extend(oi,Ct(),St(),jt(),Bt()));Mt.exports=ai});var Ot=w((ki,M)=>{var ui={serialize:()=>({})},q=class{constructor(){this.class_map={fileref:{},stream:{},window:{}},this.last_used_id=101}check_autosave(){return!this.vm.glk_blocking_call}class_obj_from_id(i,e){return this.class_map[i][e]}class_register(i,e,s){if(s){if(e.disprock!==s)throw new Error("class_register: object is not already registered");this.last_used_id<=s&&(this.last_used_id=s+1)}else{if(e.disprock)throw new Error("class_register: object is already registered");e.disprock=this.last_used_id++}this.class_map[i][e.disprock]=e}class_unregister(i,e){if(!e.disprock||this.class_map[i][e.disprock]==null)throw new Error("class_unregister: object is not registered");delete this.class_map[i][e.disprock],e.disprock=null}get_retained_array(i){return{arg:ui,arr:i.slice(),len:i.length}}prepare_resume(){}retain_array(){}set_vm(i){this.vm=i}unretain_array(){}};typeof M=="object"&&M.exports&&(M.exports=q);typeof window<"u"&&(window.GiDispa=new q)});var fi=H(qt(),1),li=H(Ot(),1);var export_ZVM=fi.default;var export_ZVMDispatch=li.default;export{export_ZVM as ZVM,export_ZVMDispatch as ZVMDispatch};
//# sourceMappingURL=zvm.js.map
