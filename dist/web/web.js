var Ui=Object.create;var Hr=Object.defineProperty;var Bi=Object.getOwnPropertyDescriptor;var Di=Object.getOwnPropertyNames;var Ri=Object.getPrototypeOf,Ci=Object.prototype.hasOwnProperty;var Gi=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);var Ti=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Di(e))!Ci.call(r,i)&&i!==t&&Hr(r,i,{get:()=>e[i],enumerable:!(n=Bi(e,i))||n.enumerable});return r};var Wi=(r,e,t)=>(t=r!=null?Ui(Ri(r)):{},Ti(e||!r||!r.__esModule?Hr(t,"default",{value:r,enumerable:!0}):t,r));var Dn=Gi((ar,lr)=>{(function(r,e){typeof define=="function"&&define.amd?define([],e):typeof ar<"u"?e():(e(),r.FileSaver={})})(ar,function(){"use strict";function r(s,l){return typeof l>"u"?l={autoBom:!1}:typeof l!="object"&&(console.warn("Deprecated: Expected third argument to be a object"),l={autoBom:!l}),l.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(s.type)?new Blob(["\uFEFF",s],{type:s.type}):s}function e(s,l,u){var c=new XMLHttpRequest;c.open("GET",s),c.responseType="blob",c.onload=function(){a(c.response,l,u)},c.onerror=function(){console.error("could not download file")},c.send()}function t(s){var l=new XMLHttpRequest;l.open("HEAD",s,!1);try{l.send()}catch{}return 200<=l.status&&299>=l.status}function n(s){try{s.dispatchEvent(new MouseEvent("click"))}catch{var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),s.dispatchEvent(l)}}var i=typeof window=="object"&&window.window===window?window:typeof self=="object"&&self.self===self?self:typeof global=="object"&&global.global===global?global:void 0,o=i.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),a=i.saveAs||(typeof window!="object"||window!==i?function(){}:"download"in HTMLAnchorElement.prototype&&!o?function(s,l,u){var c=i.URL||i.webkitURL,f=document.createElement("a");l=l||s.name||"download",f.download=l,f.rel="noopener",typeof s=="string"?(f.href=s,f.origin===location.origin?n(f):t(f.href)?e(s,l,u):n(f,f.target="_blank")):(f.href=c.createObjectURL(s),setTimeout(function(){c.revokeObjectURL(f.href)},4e4),setTimeout(function(){n(f)},0))}:"msSaveOrOpenBlob"in navigator?function(s,l,u){if(l=l||s.name||"download",typeof s!="string")navigator.msSaveOrOpenBlob(r(s,u),l);else if(t(s))e(s,l,u);else{var c=document.createElement("a");c.href=s,c.target="_blank",setTimeout(function(){n(c)})}}:function(s,l,u,c){if(c=c||open("","_blank"),c&&(c.document.title=c.document.body.innerText="downloading..."),typeof s=="string")return e(s,l,u);var f=s.type==="application/octet-stream",d=/constructor/i.test(i.HTMLElement)||i.safari,h=/CriOS\/[\d]+/.test(navigator.userAgent);if((h||f&&d||o)&&typeof FileReader<"u"){var m=new FileReader;m.onloadend=function(){var S=m.result;S=h?S:S.replace(/^data:[^;]*;/,"data:attachment/file;"),c?c.location.href=S:location=S,c=null},m.readAsDataURL(s)}else{var _=i.URL||i.webkitURL,b=_.createObjectURL(s);c?c.location=b:location.href=b,c=null,setTimeout(function(){_.revokeObjectURL(b)},4e4)}});i.saveAs=a.saveAs=a,typeof lr<"u"&&(lr.exports=a)})});function pt(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var n in t)r[n]=t[n]}return r}var Ii={read:function(r){return r[0]==='"'&&(r=r.slice(1,-1)),r.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(r){return encodeURIComponent(r).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}};function Ht(r,e){function t(i,o,a){if(!(typeof document>"u")){a=pt({},e,a),typeof a.expires=="number"&&(a.expires=new Date(Date.now()+a.expires*864e5)),a.expires&&(a.expires=a.expires.toUTCString()),i=encodeURIComponent(i).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var s="";for(var l in a)a[l]&&(s+="; "+l,a[l]!==!0&&(s+="="+a[l].split(";")[0]));return document.cookie=i+"="+r.write(o,i)+s}}function n(i){if(!(typeof document>"u"||arguments.length&&!i)){for(var o=document.cookie?document.cookie.split("; "):[],a={},s=0;s<o.length;s++){var l=o[s].split("="),u=l.slice(1).join("=");try{var c=decodeURIComponent(l[0]);if(a[c]=r.read(u,c),i===c)break}catch{}}return i?a[i]:a}}return Object.create({set:t,get:n,remove:function(i,o){t(i,"",pt({},o,{expires:-1}))},withAttributes:function(i){return Ht(this.converter,pt({},this.attributes,i))},withConverter:function(i){return Ht(pt({},this.converter,i),this.attributes)}},{attributes:{value:Object.freeze(e)},converter:{value:Object.freeze(r)}})}var Jr=Ht(Ii,{path:"/"});var Qi=typeof global=="object"&&global&&global.Object===Object&&global,qr=Qi;var Oi=typeof self=="object"&&self&&self.Object===Object&&self,Mi=qr||Oi||Function("return this")(),ht=Mi;var Li=ht.Symbol,ye=Li;var Yr=Object.prototype,Vi=Yr.hasOwnProperty,$i=Yr.toString,Ze=ye?ye.toStringTag:void 0;function zi(r){var e=Vi.call(r,Ze),t=r[Ze];try{r[Ze]=void 0;var n=!0}catch{}var i=$i.call(r);return n&&(e?r[Ze]=t:delete r[Ze]),i}var Zr=zi;var Ni=Object.prototype,ji=Ni.toString;function Pi(r){return ji.call(r)}var Kr=Pi;var Hi="[object Null]",Ji="[object Undefined]",Xr=ye?ye.toStringTag:void 0;function qi(r){return r==null?r===void 0?Ji:Hi:Xr&&Xr in Object(r)?Zr(r):Kr(r)}var en=qi;function Yi(r){return r!=null&&typeof r=="object"}var tn=Yi;var Zi="[object Symbol]";function Ki(r){return typeof r=="symbol"||tn(r)&&en(r)==Zi}var mt=Ki;function Xi(r,e){for(var t=-1,n=r==null?0:r.length,i=Array(n);++t<n;)i[t]=e(r[t],t,r);return i}var rn=Xi;var eo=Array.isArray,nn=eo;var to=1/0,on=ye?ye.prototype:void 0,sn=on?on.toString:void 0;function an(r){if(typeof r=="string")return r;if(nn(r))return rn(r,an)+"";if(mt(r))return sn?sn.call(r):"";var e=r+"";return e=="0"&&1/r==-to?"-0":e}var ln=an;var ro=/\s/;function no(r){for(var e=r.length;e--&&ro.test(r.charAt(e)););return e}var fn=no;var io=/^\s+/;function oo(r){return r&&r.slice(0,fn(r)+1).replace(io,"")}var un=oo;function so(r){var e=typeof r;return r!=null&&(e=="object"||e=="function")}var Ae=so;var cn=NaN,ao=/^[-+]0x[0-9a-f]+$/i,lo=/^0b[01]+$/i,fo=/^0o[0-7]+$/i,uo=parseInt;function co(r){if(typeof r=="number")return r;if(mt(r))return cn;if(Ae(r)){var e=typeof r.valueOf=="function"?r.valueOf():r;r=Ae(e)?e+"":e}if(typeof r!="string")return r===0?r:+r;r=un(r);var t=lo.test(r);return t||fo.test(r)?uo(r.slice(2),t?2:8):ao.test(r)?cn:+r}var Jt=co;function po(r){return r==null?"":ln(r)}var dn=po;function ho(r){return function(e){return r?.[e]}}var pn=ho;var mo=function(){return ht.Date.now()},_t=mo;var _o="Expected a function",go=Math.max,yo=Math.min;function wo(r,e,t){var n,i,o,a,s,l,u=0,c=!1,f=!1,d=!0;if(typeof r!="function")throw new TypeError(_o);e=Jt(e)||0,Ae(t)&&(c=!!t.leading,f="maxWait"in t,o=f?go(Jt(t.maxWait)||0,e):o,d="trailing"in t?!!t.trailing:d);function h(E){var G=n,z=i;return n=i=void 0,u=E,a=r.apply(z,G),a}function m(E){return u=E,s=setTimeout(S,e),c?h(E):a}function _(E){var G=E-l,z=E-u,P=e-G;return f?yo(P,o-z):P}function b(E){var G=E-l,z=E-u;return l===void 0||G>=e||G<0||f&&z>=o}function S(){var E=_t();if(b(E))return R(E);s=setTimeout(S,_(E))}function R(E){return s=void 0,d&&n?h(E):(n=i=void 0,a)}function W(){s!==void 0&&clearTimeout(s),u=0,n=l=i=s=void 0}function ee(){return s===void 0?a:R(_t())}function j(){var E=_t(),G=b(E);if(n=arguments,i=this,l=E,G){if(s===void 0)return m(l);if(f)return clearTimeout(s),s=setTimeout(S,e),h(l)}return s===void 0&&(s=setTimeout(S,e)),a}return j.cancel=W,j.flush=ee,j}var Ue=wo;var bo="Expected a function";function xo(r,e,t){var n=!0,i=!0;if(typeof r!="function")throw new TypeError(bo);return Ae(t)&&(n="leading"in t?!!t.leading:n,i="trailing"in t?!!t.trailing:i),Ue(r,e,{leading:n,maxWait:e,trailing:i})}var gt=xo;var vo={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"},ko=pn(vo),hn=ko;var mn=/&(?:amp|lt|gt|quot|#39);/g,So=RegExp(mn.source);function Fo(r){return r=dn(r),r&&So.test(r)?r.replace(mn,hn):r}var qt=Fo;var K=class extends DataView{constructor(e,t,n){e instanceof Uint8Array?super(e.buffer,e.byteOffset,e.byteLength):super(e,t,n)}getFourCC(e){return String.fromCharCode(this.getUint8(e),this.getUint8(e+1),this.getUint8(e+2),this.getUint8(e+3))}getUint8Subarray(e,t){return new Uint8Array(this.buffer,this.byteOffset+(e||0),t)}setFourCC(e,t){this.setUint8(e,t.charCodeAt(0)),this.setUint8(e+1,t.charCodeAt(1)),this.setUint8(e+2,t.charCodeAt(2)),this.setUint8(e+3,t.charCodeAt(3))}setUint8Array(e,t){this.getUint8Subarray(e,t.length).set(t)}};function ve(){return visualViewport?visualViewport.scale-1>.001:!1}var Ve=new TextDecoder,Eo=new TextEncoder;var Ke=class{constructor(){this.type="";this.chunks=[]}parse(e){let t=new K(e);if(t.getFourCC(0)!=="FORM")throw new Error("Not an IFF file");this.type=t.getFourCC(8);let n=12,i=e.length;for(;n<i;){let o=t.getUint32(n+4);if(o<0||o+n>i)throw new Error("IFF chunk out of range");this.chunks.push({data:t.getUint8Subarray(n+8,o),offset:n,type:t.getFourCC(n)}),n+=8+o,n%2&&n++}}write(){let e=12;for(let i of this.chunks)e+=8+i.data.length,e%2&&e++;let t=new K(new ArrayBuffer(e));t.setFourCC(0,"FORM"),t.setUint32(4,e-8),t.setFourCC(8,this.type);let n=12;for(let i of this.chunks)t.setFourCC(n,i.type),t.setUint32(n+4,i.data.length),t.setUint8Array(n+8,i.data),n+=8+i.data.length,n%2&&n++;return t.getUint8Subarray()}};var _n={Data:"data",Exec:"exec",Pict:"pict","Snd ":"sound"},gn="????",$e=class{constructor(e){this.classname="Blorb";this.chunks={};this.is_inited=!1;this.metadata={};e&&this.init(e)}init(e,t){if(!this.is_inited){if(e instanceof Uint8Array){let n=new Ke;if(n.parse(e),n.type!=="IFRS")throw new Error("Not a Blorb file");if(n.chunks[0].type!=="RIdx")throw new Error("Malformed blorb: chunk 1 is not RIdx");for(let i of n.chunks)switch(i.type){case"Dbug":{this.debugdata=i.data;break}case"Fspc":{let o=new K(i.data);this.coverimagenum=o.getUint32(0);break}case"IFmd":{let o=Ve.decode(i.data),a=/<bibliographic>(.+)<\/bibliographic>/is.exec(o),s=/<(\w+)>(.+)<\/\1>/gi,l=/<br\/>/g,u=/\s+/g;if(a){let c;for(;c=s.exec(a[1]);){let f=c[1].toLowerCase(),d=c[2].replace(u," ");f==="description"&&(d=d.replace(l,`
`)),this.metadata[f]=qt(d)}}break}case"RDes":{let o=new K(i.data),a=4;for(;a<o.byteLength;){let s=_n[o.getFourCC(a)],l=o.getUint32(a+4),u=o.getUint32(a+8),c=this.chunks[`${s}:${l}`];c&&(c.alttext=Ve.decode(o.getUint8Subarray(a+12,u))),a+=12+u}break}case"RIdx":{let o=new K(i.data),a=4;for(;a<o.byteLength;){let s=o.getFourCC(a),l=o.getUint32(a+4),u=o.getUint32(a+8);a+=12;let c=n.chunks.filter(h=>h.offset===u)[0];if(!c)throw new Error(`No Blorb chunk at offset ${u}`);let f=c.type,d={blorbtype:f,content:f==="FORM"?e.subarray(c.offset,c.offset+8+c.data.length):c.data,usage:_n[s]};s==="Pict"&&(f==="JPEG"?d.type="jpeg":f==="PNG "?d.type="png":d.type=gn),s==="Data"&&(d.binary=f==="BINA"||f==="FORM"),this.chunks[`${d.usage}:${l}`]=d}break}}}else if(t?.format==="infomap")for(let n in e){if(!Number.isInteger(+n))continue;let i=Object.assign({},e[n]);delete i.image,i.height&&i.width&&(i.imagesize={height:i.height,width:i.width},delete i.height,delete i.width),i.type=i.url.endsWith(".png")?"png":"jpeg",i.usage="pict",this.chunks[`pict:${n}`]=i}else if(!(Array.isArray(e)&&e.length===0))throw new Error("Unsupported Blorb.init data format");this.is_inited=!0}}getlibrary(){return null}get_chunk(e,t){return this.chunks[`${e}:${t}`]||null}get_cover_pict(){return this.coverimagenum??null}get_data_chunk(e){let t=this.chunks[`data:${e}`];return t?.content?{binary:t.binary,data:t.content}:null}get_debug_info(){return this.debugdata}get_exec_data(e){let t=this.chunks["exec:0"];return!t?.content||e&&t.blorbtype!==e?null:t.content}get_image_info(e){let t=this.chunks[`pict:${e}`];if(!t)return null;!t.imagesize&&t.content&&(t.type==="jpeg"?t.imagesize=Ao(t.content):t.type==="png"&&(t.imagesize=Uo(t.content)));let n=Object.assign({image:e},t);return n.imagesize&&(n.height=n.imagesize.height,n.width=n.imagesize.width),n}get_image_url(e){let t=this.chunks[`pict:${e}`];return t?t.url?t.url:t.type!==gn&&t.content?(t.url=URL.createObjectURL(new Blob([t.content],{type:`image/${t.type}`})),t.url):null:null}get_metadata(e){return this.metadata[e]}inited(){return this.is_inited}};function Ao(r){let e=new K(r),t=0;for(;t<e.byteLength;){if(e.getUint8(t)!==255)return;for(;e.getUint8(t)===255;)t++;let n=e.getUint8(t++);if(n===1||n>=208&&n<=217)continue;let i=e.getUint16(t);if(n>=192&&n<=207&&n!==200)return i<7?void 0:{height:e.getUint16(t+3),width:e.getUint16(t+5)};t+=i}}function Uo(r){let e=new K(r);if(e.getFourCC(0)!=="\x89PNG")return;let t=8;for(;t<e.byteLength;){let n=e.getUint32(t),i=e.getFourCC(t+4);if(t+=8,i==="IHDR")return{height:e.getInt32(t+4),width:e.getInt32(t)};t+=n+4}}var Yt={buffercharheight:1,buffercharwidth:1,buffermarginx:0,buffermarginy:0,graphicsmarginx:0,graphicsmarginy:0,gridcharheight:1,gridcharwidth:1,gridmarginx:0,gridmarginy:0,height:50,inspacingx:0,inspacingy:0,outspacingx:0,outspacingy:0,width:80},Zt={8:"delete",9:"tab",13:"return",27:"escape",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",112:"func1",113:"func2",114:"func3",115:"func4",116:"func5",117:"func6",118:"func7",119:"func8",120:"func9",121:"func10",122:"func11",123:"func12"},Kt=40,Xt=13,er=38,yt="\xA0";var yn="-10000px",tr="0.1.0";function rr(r){switch(r){case"command":case"transcript":return".txt";case"save":return".glksave";default:return".glkdata"}}var Xe=class{constructor(){this.classname="GlkOte";this.version=tr;this.accept_func=()=>{};this.autorestoring=!1;this.current_metrics=Object.assign({},Yt);this.disabled=!1;this.generation=0;this.is_inited=!1;this.options={};this.timer=null;this.waiting_for_update=!1}async init(e){if(!e)return this.error("no options provided");if(!e.accept)return this.error("an accept function was not given to GlkOte");this.options=e,this.accept_func=e.accept,e.Blorb&&(this.Blorb=e.Blorb),e.Dialog&&(this.Dialog=e.Dialog),this.is_inited=!0,this.send_event({type:"init"})}error(e){throw typeof e=="string"?new Error(e):e}extevent(e){this.send_event({type:"external",value:e})}getdomcontext(){throw new Error("getdomcontext is not applicable to this GlkOte library")}getdomid(e){throw new Error("getdomid is not applicable to this GlkOte library")}getinterface(){return this.options}getlibrary(e){switch(e){case"Blorb":return this.Blorb;case"Dialog":return this.Dialog;default:return null}}inited(){return this.is_inited}log(e){console.log(e)}setdomcontext(e){throw new Error("setdomcontext is not applicable to this GlkOte library")}update(e){try{if(this.autorestoring=!1,this.waiting_for_update=!1,e.type==="error")return this.error(e.message);if(e.type==="pass")return;if(e.type==="retry"){setTimeout(()=>this.send_event({type:"refresh"}),2e3);return}if(e.type!=="update")return this.error(`Unknown update type: ${e.type}`);if(e.gen===this.generation){this.log(`Ignoring repeated generation number: ${e.gen}`);return}this.generation=e.gen,this.disabled&&this.disable(!1),e.input&&this.cancel_inputs(e.input),e.windows&&this.update_windows(e.windows),e.content&&this.update_content(e.content),e.input&&this.update_inputs(e.input),e.schannels&&this.Blorb&&this.update_schannels(e.schannels),e.timer!==void 0&&(this.timer&&(clearInterval(this.timer),this.timer=null),e.timer&&(this.timer=setInterval(()=>this.ontimer(),e.timer))),e.specialinput&&this.handle_specialinput(e.specialinput),this.disabled=!1,(e.disable||e.specialinput)&&this.disable(!0),e.autorestore&&(this.autorestoring=!0,this.autorestore(e.autorestore)),typeof e.page_margin_bg<"u"&&this.options.set_body_to_page_bg&&this.set_page_bg(e.page_margin_bg),e.disable&&this.exit()}catch(t){this.error(t)}}warning(e){console.warn(e)}autorestore(e){}capabilities(){return["timer"]}exit(){}handle_specialinput(e){if(e.type==="fileref_prompt"){let t=n=>this.send_event({type:"specialresponse",response:"fileref_prompt",value:n});try{this.Dialog?this.Dialog.async?this.Dialog.prompt(rr(e.filetype),e.filemode!=="read").then(n=>{t(n?{filename:n}:null)}):this.Dialog.open(e.filemode!=="read",e.filetype,e.gameid,t):setTimeout(()=>t(null),0)}catch(n){this.log(`Unable to open file dialog: ${n}`),setTimeout(()=>t(null),0)}}else this.error(`Request for unknown special input type: ${e.type}`)}ontimer(){!this.disabled&&this.timer&&this.send_event({type:"timer"})}save_allstate(){}send_event(e){if(!(this.disabled&&e.type!=="specialresponse")){if(this.waiting_for_update){console.log("Trying to send event when waiting for input",e);return}switch(this.waiting_for_update=!0,e.gen=this.generation,e.type){case"arrange":e.metrics=this.current_metrics;break;case"init":e.metrics=this.current_metrics,e.support=this.capabilities();break;case"specialresponse":e.response="fileref_prompt";break}this.accept_func(e)}}set_page_bg(e){}update_schannels(e){}};var re=Uint8Array,ze=Uint16Array,Zo=Int32Array,vn=new re([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),kn=new re([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Ko=new re([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Sn=function(r,e){for(var t=new ze(31),n=0;n<31;++n)t[n]=e+=1<<r[n-1];for(var i=new Zo(t[30]),n=1;n<30;++n)for(var o=t[n];o<t[n+1];++o)i[o]=o-t[n]<<5|n;return{b:t,r:i}},Fn=Sn(vn,2),En=Fn.b,Xo=Fn.r;En[28]=258,Xo[258]=28;var An=Sn(kn,0),es=An.b,Nc=An.r,or=new ze(32768);for(U=0;U<32768;++U)we=(U&43690)>>1|(U&21845)<<1,we=(we&52428)>>2|(we&13107)<<2,we=(we&61680)>>4|(we&3855)<<4,or[U]=((we&65280)>>8|(we&255)<<8)>>1;var we,U,et=(function(r,e,t){for(var n=r.length,i=0,o=new ze(e);i<n;++i)r[i]&&++o[r[i]-1];var a=new ze(e);for(i=1;i<e;++i)a[i]=a[i-1]+o[i-1]<<1;var s;if(t){s=new ze(1<<e);var l=15-e;for(i=0;i<n;++i)if(r[i])for(var u=i<<4|r[i],c=e-r[i],f=a[r[i]-1]++<<c,d=f|(1<<c)-1;f<=d;++f)s[or[f]>>l]=u}else for(s=new ze(n),i=0;i<n;++i)r[i]&&(s[i]=or[a[r[i]-1]++]>>15-r[i]);return s}),tt=new re(288);for(U=0;U<144;++U)tt[U]=8;var U;for(U=144;U<256;++U)tt[U]=9;var U;for(U=256;U<280;++U)tt[U]=7;var U;for(U=280;U<288;++U)tt[U]=8;var U,Un=new re(32);for(U=0;U<32;++U)Un[U]=5;var U;var ts=et(tt,9,1);var rs=et(Un,5,1),nr=function(r){for(var e=r[0],t=1;t<r.length;++t)r[t]>e&&(e=r[t]);return e},ae=function(r,e,t){var n=e/8|0;return(r[n]|r[n+1]<<8)>>(e&7)&t},ir=function(r,e){var t=e/8|0;return(r[t]|r[t+1]<<8|r[t+2]<<16)>>(e&7)},ns=function(r){return(r+7)/8|0},is=function(r,e,t){return(e==null||e<0)&&(e=0),(t==null||t>r.length)&&(t=r.length),new re(r.subarray(e,t))};var os=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],le=function(r,e,t){var n=new Error(e||os[r]);if(n.code=r,Error.captureStackTrace&&Error.captureStackTrace(n,le),!t)throw n;return n},ss=function(r,e,t,n){var i=r.length,o=n?n.length:0;if(!i||e.f&&!e.l)return t||new re(0);var a=!t,s=a||e.i!=2,l=e.i;a&&(t=new re(i*3));var u=function(Nr){var jr=t.length;if(Nr>jr){var Pr=new re(Math.max(jr*2,Nr));Pr.set(t),t=Pr}},c=e.f||0,f=e.p||0,d=e.b||0,h=e.l,m=e.d,_=e.m,b=e.n,S=i*8;do{if(!h){c=ae(r,f,1);var R=ae(r,f+1,3);if(f+=3,R)if(R==1)h=ts,m=rs,_=9,b=5;else if(R==2){var E=ae(r,f,31)+257,G=ae(r,f+10,15)+4,z=E+ae(r,f+5,31)+1;f+=14;for(var P=new re(z),ce=new re(19),H=0;H<G;++H)ce[Ko[H]]=ae(r,f+H*3,7);f+=G*3;for(var Ee=nr(ce),te=(1<<Ee)-1,T=et(ce,Ee,1),H=0;H<z;){var Me=T[ae(r,f,te)];f+=Me&15;var W=Me>>4;if(W<16)P[H++]=W;else{var Q=0,O=0;for(W==16?(O=3+ae(r,f,3),f+=2,Q=P[H-1]):W==17?(O=3+ae(r,f,7),f+=3):W==18&&(O=11+ae(r,f,127),f+=7);O--;)P[H++]=Q}}var V=P.subarray(0,E),v=P.subarray(E);_=nr(V),b=nr(v),h=et(V,_,1),m=et(v,b,1)}else le(1);else{var W=ns(f)+4,ee=r[W-4]|r[W-3]<<8,j=W+ee;if(j>i){l&&le(0);break}s&&u(d+ee),t.set(r.subarray(W,j),d),e.b=d+=ee,e.p=f=j*8,e.f=c;continue}if(f>S){l&&le(0);break}}s&&u(d+131072);for(var g=(1<<_)-1,F=(1<<b)-1,A=f;;A=f){var Q=h[ir(r,f)&g],M=Q>>4;if(f+=Q&15,f>S){l&&le(0);break}if(Q||le(2),M<256)t[d++]=M;else if(M==256){A=f,h=null;break}else{var _e=M-254;if(M>264){var H=M-257,ge=vn[H];_e=ae(r,f,(1<<ge)-1)+En[H],f+=ge}var dt=m[ir(r,f)&F],J=dt>>4;dt||le(3),f+=dt&15;var v=es[J];if(J>3){var ge=kn[J];v+=ir(r,f)&(1<<ge)-1,f+=ge}if(f>S){l&&le(0);break}s&&u(d+131072);var de=d+_e;if(d<v){var Le=o-v,pe=Math.min(v,de);for(Le+d<0&&le(3);d<pe;++d)t[d]=n[Le+d]}for(;d<de;++d)t[d]=t[d-v]}}e.l=h,e.p=A,e.b=d,e.f=c,h&&(c=1,e.m=_,e.d=m,e.n=b)}while(!c);return d!=t.length&&a?is(t,0,d):t.subarray(0,d)};var as=new re(0);var ls=function(r){(r[0]!=31||r[1]!=139||r[2]!=8)&&le(6,"invalid gzip data");var e=r[3],t=10;e&4&&(t+=(r[10]|r[11]<<8)+2);for(var n=(e>>3&1)+(e>>4&1);n>0;n-=!r[t++]);return t+(e&2)},fs=function(r){var e=r.length;return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0};function wt(r,e){var t=ls(r);return t+8>r.length&&le(6,"invalid gzip data"),ss(r.subarray(t,-8),{i:2},e&&e.out||new re(fs(r)),e&&e.dictionary)}var us=typeof TextDecoder<"u"&&new TextDecoder,cs=0;try{us.decode(as,{stream:!0}),cs=1}catch{}var sr=new Map;async function rt(r,e,t){let n=sr.get(e);if(n)return n;let i=ds(r,e,t);return sr.set(e,i),i.then(o=>{sr.set(e,o)}),i}async function ds(r,e,t){if(r.single_file){let a=document.getElementById(e),s=a.text;if(e.endsWith(".js"))return import(`data:text/javascript,${encodeURIComponent(s)}`);if(!e.endsWith(".wasm"))throw new Error(`Can't load ${e} in single file mode`);let l=await Be(s);return a.type.endsWith(";gzip")&&(l=wt(l)),l}let n=r.lib_path??import.meta.url,i;try{i=new URL(e,n)}catch{i=n+e}if(e.endsWith(".js"))return import(i+"");let o=await fetch(i);return bt(o,t)}async function Be(r){if(r.length<3e7)return Bn(r);let t=[],n=0;for(;n<r.length;)t.push(await Bn(r.substring(n,n+=3e7)));let i=new Blob(t);return new Uint8Array(await i.arrayBuffer())}async function Bn(r){let e=await fetch(`data:application/octet-stream;base64,${r}`);if(!e.ok)throw new Error(`Could not parse base64: ${e.status}`);return new Uint8Array(await e.arrayBuffer())}async function bt(r,e){if(!r.ok)throw new Error(`Could not fetch ${r.url}, got ${r.status}`);if(!e)return new Uint8Array(await r.arrayBuffer());let t=[],n=0,i=r.body.getReader();for(;;){let{done:a,value:s}=await i.read();if(a)break;t.push([n,s]),e(s.length),n+=s.length}let o=new Uint8Array(n);for(let[a,s]of t)o.set(s,a);return o}var ci=Wi(Dn(),1);function he(r){if(typeof r!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(r))}function Rn(r,e){for(var t="",n=0,i=-1,o=0,a,s=0;s<=r.length;++s){if(s<r.length)a=r.charCodeAt(s);else{if(a===47)break;a=47}if(a===47){if(!(i===s-1||o===1))if(i!==s-1&&o===2){if(t.length<2||n!==2||t.charCodeAt(t.length-1)!==46||t.charCodeAt(t.length-2)!==46){if(t.length>2){var l=t.lastIndexOf("/");if(l!==t.length-1){l===-1?(t="",n=0):(t=t.slice(0,l),n=t.length-1-t.lastIndexOf("/")),i=s,o=0;continue}}else if(t.length===2||t.length===1){t="",n=0,i=s,o=0;continue}}e&&(t.length>0?t+="/..":t="..",n=2)}else t.length>0?t+="/"+r.slice(i+1,s):t=r.slice(i+1,s),n=s-i-1;i=s,o=0}else a===46&&o!==-1?++o:o=-1}return t}function ps(r,e){var t=e.dir||e.root,n=e.base||(e.name||"")+(e.ext||"");return t?t===e.root?t+n:t+r+n:n}var q={process_cwd:"",setCWD:function(e){q.process_cwd=e},resolve:function(){for(var e="",t=!1,n,i=arguments.length-1;i>=-1&&!t;i--){var o;i>=0?o=arguments[i]:(n===void 0&&(n=q.process_cwd),o=n),he(o),o.length!==0&&o+"/"!==e&&(e=o+"/"+e,t=o.charCodeAt(0)===47)}return e=Rn(e,!t),t?e.length>0?"/"+e:"/":e.length>0?e:"."},normalize:function(e){if(he(e),e.length===0)return".";var t=e.charCodeAt(0)===47,n=e.charCodeAt(e.length-1)===47;return e=Rn(e,!t),e.length===0&&!t&&(e="."),e.length>0&&n&&(e+="/"),t?"/"+e:e},isAbsolute:function(e){return he(e),e.length>0&&e.charCodeAt(0)===47},join:function(){if(arguments.length===0)return".";for(var e,t=0;t<arguments.length;++t){var n=arguments[t];he(n),n.length>0&&(e===void 0?e=n:e+="/"+n)}return e===void 0?".":q.normalize(e)},relative:function(e,t){if(he(e),he(t),e===t)return"";let n=e.replaceAll("\\","/"),i=t.replaceAll("\\","/");if(n!=e&&i!=t)return q.relative(n,i).replaceAll("/","\\");if(n!=e)return q.relative(n,t).replaceAll("/","\\");if(i!=t)return q.relative(e,i);if(e=q.resolve(e),t=q.resolve(t),e===t)return"";for(var o=1;o<e.length&&e.charCodeAt(o)===47;++o);for(var a=e.length,s=a-o,l=1;l<t.length&&t.charCodeAt(l)===47;++l);for(var u=t.length,c=u-l,f=s<c?s:c,d=-1,h=0;h<=f;++h){if(h===f){if(c>f){if(t.charCodeAt(l+h)===47)return t.slice(l+h+1);if(h===0)return t.slice(l+h)}else s>f&&(e.charCodeAt(o+h)===47?d=h:h===0&&(d=0));break}var m=e.charCodeAt(o+h),_=t.charCodeAt(l+h);if(m!==_)break;m===47&&(d=h)}var b="";for(h=o+d+1;h<=a;++h)(h===a||e.charCodeAt(h)===47)&&(b.length===0?b+="..":b+="/..");return b.length>0?b+t.slice(l+d):(l+=d,t.charCodeAt(l)===47&&++l,t.slice(l))},_makeLong:function(e){return e},dirname:function(e){if(he(e),e.length===0)return".";for(var t=e.charCodeAt(0),n=t===47,i=-1,o=!0,a=e.length-1;a>=1;--a)if(t=e.charCodeAt(a),t===47){if(!o){i=a;break}}else o=!1;return i===-1?n?"/":".":n&&i===1?"//":e.slice(0,i)},basename:function(e,t){if(t!==void 0&&typeof t!="string")throw new TypeError('"ext" argument must be a string');he(e);var n=0,i=-1,o=!0,a;if(t!==void 0&&t.length>0&&t.length<=e.length){if(t.length===e.length&&t===e)return"";var s=t.length-1,l=-1;for(a=e.length-1;a>=0;--a){var u=e.charCodeAt(a);if(u===47){if(!o){n=a+1;break}}else l===-1&&(o=!1,l=a+1),s>=0&&(u===t.charCodeAt(s)?--s===-1&&(i=a):(s=-1,i=l))}return n===i?i=l:i===-1&&(i=e.length),e.slice(n,i)}else{for(a=e.length-1;a>=0;--a)if(e.charCodeAt(a)===47){if(!o){n=a+1;break}}else i===-1&&(o=!1,i=a+1);return i===-1?"":e.slice(n,i)}},extname:function(e){he(e);for(var t=-1,n=0,i=-1,o=!0,a=0,s=e.length-1;s>=0;--s){var l=e.charCodeAt(s);if(l===47){if(!o){n=s+1;break}continue}i===-1&&(o=!1,i=s+1),l===46?t===-1?t=s:a!==1&&(a=1):t!==-1&&(a=-1)}return t===-1||i===-1||a===0||a===1&&t===i-1&&t===n+1?"":e.slice(t,i)},format:function(e){if(e===null||typeof e!="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof e);return ps("/",e)},parse:function(e){he(e);var t={root:"",dir:"",base:"",ext:"",name:""};if(e.length===0)return t;var n=e.charCodeAt(0),i=n===47,o;i?(t.root="/",o=1):o=0;for(var a=-1,s=0,l=-1,u=!0,c=e.length-1,f=0;c>=o;--c){if(n=e.charCodeAt(c),n===47){if(!u){s=c+1;break}continue}l===-1&&(u=!1,l=c+1),n===46?a===-1?a=c:f!==1&&(f=1):a!==-1&&(f=-1)}return a===-1||l===-1||f===0||f===1&&a===l-1&&a===s+1?l!==-1&&(s===0&&i?t.base=t.name=e.slice(1,l):t.base=t.name=e.slice(s,l)):(s===0&&i?(t.name=e.slice(1,a),t.base=e.slice(1,l)):(t.name=e.slice(s,a),t.base=e.slice(s,l)),t.ext=e.slice(a,l)),s>0?t.dir=e.slice(0,s-1):i&&(t.dir="/"),t},sep:"/",delimiter:":",win32:null,posix:null};q.posix=q;function C(){}function hs(r,e){for(let t in e)r[t]=e[t];return r}function fr(r){return r()}function vt(){return Object.create(null)}function L(r){r.forEach(fr)}function nt(r){return typeof r=="function"}function ne(r,e){return r!=r?e==e:r!==e||r&&typeof r=="object"||typeof r=="function"}var xt;function ur(r,e){return r===e?!0:(xt||(xt=document.createElement("a")),xt.href=e,r===xt.href)}function Cn(r){return Object.keys(r).length===0}function Gn(r,e,t,n){if(r){let i=Tn(r,e,t,n);return r[0](i)}}function Tn(r,e,t,n){return r[1]&&n?hs(t.ctx.slice(),r[1](n(e))):t.ctx}function Wn(r,e,t,n){if(r[2]&&n){let i=r[2](n(t));if(e.dirty===void 0)return i;if(typeof i=="object"){let o=[],a=Math.max(e.dirty.length,i.length);for(let s=0;s<a;s+=1)o[s]=e.dirty[s]|i[s];return o}return e.dirty|i}return e.dirty}function In(r,e,t,n,i,o){if(i){let a=Tn(e,t,n,o);r.p(a,i)}}function Qn(r){if(r.ctx.length>32){let e=[],t=r.ctx.length/32;for(let n=0;n<t;n++)e[n]=-1;return e}return-1}function kt(r){return r&&nt(r.destroy)?r.destroy:C}var cr=typeof window<"u"?window:typeof globalThis<"u"?globalThis:global;var St=class r{_listeners="WeakMap"in cr?new WeakMap:void 0;_observer=void 0;options;constructor(e){this.options=e}observe(e,t){return this._listeners.set(e,t),this._getObserver().observe(e,this.options),()=>{this._listeners.delete(e),this._observer.unobserve(e)}}_getObserver(){return this._observer??(this._observer=new ResizeObserver(e=>{for(let t of e)r.entries.set(t.target,t),this._listeners.get(t.target)?.(t)}))}};St.entries="WeakMap"in cr?new WeakMap:void 0;var On=!1;function Mn(){On=!0}function Ln(){On=!1}function y(r,e){r.appendChild(e)}function k(r,e,t){r.insertBefore(e,t||null)}function x(r){r.parentNode&&r.parentNode.removeChild(r)}function Ft(r,e){for(let t=0;t<r.length;t+=1)r[t]&&r[t].d(e)}function w(r){return document.createElement(r)}function be(r){return document.createElementNS("http://www.w3.org/2000/svg",r)}function I(r){return document.createTextNode(r)}function B(){return I(" ")}function Et(){return I("")}function D(r,e,t,n){return r.addEventListener(e,t,n),()=>r.removeEventListener(e,t,n)}function Vn(r){return function(e){return e.preventDefault(),r.call(this,e)}}function $n(r){return function(e){return e.stopPropagation(),r.call(this,e)}}function p(r,e,t){t==null?r.removeAttribute(e):r.getAttribute(e)!==t&&r.setAttribute(e,t)}function zn(r){return Array.from(r.childNodes)}function N(r,e){e=""+e,r.data!==e&&(r.data=e)}function Ne(r,e){r.value=e??""}function dr(r,e,t){for(let n=0;n<r.options.length;n+=1){let i=r.options[n];if(i.__value===e){i.selected=!0;return}}(!t||e!==void 0)&&(r.selectedIndex=-1)}function Nn(r){let e=r.querySelector(":checked");return e&&e.__value}function ke(r,e,t){r.classList.toggle(e,!!t)}function At(r,e,{bubbles:t=!1,cancelable:n=!1}={}){return new CustomEvent(r,{detail:e,bubbles:t,cancelable:n})}function jn(r){let e={};return r.childNodes.forEach(t=>{e[t.slot||"default"]=!0}),e}var Se;function xe(r){Se=r}function Pn(){if(!Se)throw new Error("Function called outside component initialization");return Se}function pr(){let r=Pn();return(e,t,{cancelable:n=!1}={})=>{let i=r.$$.callbacks[e];if(i){let o=At(e,t,{cancelable:n});return i.slice().forEach(a=>{a.call(r,o)}),!o.defaultPrevented}return!0}}var De=[];var fe=[],Pe=[],mr=[],vs=Promise.resolve(),_r=!1;function Hn(){_r||(_r=!0,vs.then(Ut))}function Re(r){Pe.push(r)}function gr(r){mr.push(r)}var hr=new Set,je=0;function Ut(){if(je!==0)return;let r=Se;do{try{for(;je<De.length;){let e=De[je];je++,xe(e),ks(e.$$)}}catch(e){throw De.length=0,je=0,e}for(xe(null),De.length=0,je=0;fe.length;)fe.pop()();for(let e=0;e<Pe.length;e+=1){let t=Pe[e];hr.has(t)||(hr.add(t),t())}Pe.length=0}while(De.length);for(;mr.length;)mr.pop()();_r=!1,hr.clear(),xe(r)}function ks(r){if(r.fragment!==null){r.update(),L(r.before_update);let e=r.dirty;r.dirty=[-1],r.fragment&&r.fragment.p(r.ctx,e),r.after_update.forEach(Re)}}function Jn(r){let e=[],t=[];Pe.forEach(n=>r.indexOf(n)===-1?e.push(n):t.push(n)),t.forEach(n=>n()),Pe=e}var Bt=new Set,Ce;function yr(){Ce={r:0,c:[],p:Ce}}function wr(){Ce.r||L(Ce.c),Ce=Ce.p}function Y(r,e){r&&r.i&&(Bt.delete(r),r.i(e))}function ie(r,e,t,n){if(r&&r.o){if(Bt.has(r))return;Bt.add(r),Ce.c.push(()=>{Bt.delete(r),n&&(t&&r.d(1),n())}),r.o(e)}else n&&n()}function Fe(r){return r?.length!==void 0?r:Array.from(r)}var Ss=["allowfullscreen","allowpaymentrequest","async","autofocus","autoplay","checked","controls","default","defer","disabled","formnovalidate","hidden","inert","ismap","loop","multiple","muted","nomodule","novalidate","open","playsinline","readonly","required","reversed","selected"],Fs=new Set([...Ss]);function xr(r,e,t){let n=r.$$.props[e];n!==void 0&&(r.$$.bound[n]=t,t(r.$$.ctx[n]))}function He(r){r&&r.c()}function Ge(r,e,t){let{fragment:n,after_update:i}=r.$$;n&&n.m(e,t),Re(()=>{let o=r.$$.on_mount.map(fr).filter(nt);r.$$.on_destroy?r.$$.on_destroy.push(...o):L(o),r.$$.on_mount=[]}),i.forEach(Re)}function Te(r,e){let t=r.$$;t.fragment!==null&&(Jn(t.after_update),L(t.on_destroy),t.fragment&&t.fragment.d(e),t.on_destroy=t.fragment=null,t.ctx=[])}function As(r,e){r.$$.dirty[0]===-1&&(De.push(r),Hn(),r.$$.dirty.fill(0)),r.$$.dirty[e/31|0]|=1<<e%31}function oe(r,e,t,n,i,o,a=null,s=[-1]){let l=Se;xe(r);let u=r.$$={fragment:null,ctx:[],props:o,update:C,not_equal:i,bound:vt(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(l?l.$$.context:[])),callbacks:vt(),dirty:s,skip_bound:!1,root:e.target||l.$$.root};a&&a(u.root);let c=!1;if(u.ctx=t?t(r,e.props||{},(f,d,...h)=>{let m=h.length?h[0]:d;return u.ctx&&i(u.ctx[f],u.ctx[f]=m)&&(!u.skip_bound&&u.bound[f]&&u.bound[f](m),c&&As(r,f)),d}):[],u.update(),c=!0,L(u.before_update),u.fragment=n?n(u.ctx):!1,e.target){if(e.hydrate){Mn();let f=zn(e.target);u.fragment&&u.fragment.l(f),f.forEach(x)}else u.fragment&&u.fragment.c();e.intro&&Y(r.$$.fragment),Ge(r,e.target,e.anchor),Ln(),Ut()}xe(l)}var Us;typeof HTMLElement=="function"&&(Us=class extends HTMLElement{$$ctor;$$s;$$c;$$cn=!1;$$d={};$$r=!1;$$p_d={};$$l={};$$l_u=new Map;constructor(r,e,t){super(),this.$$ctor=r,this.$$s=e,t&&this.attachShadow({mode:"open"})}addEventListener(r,e,t){if(this.$$l[r]=this.$$l[r]||[],this.$$l[r].push(e),this.$$c){let n=this.$$c.$on(r,e);this.$$l_u.set(e,n)}super.addEventListener(r,e,t)}removeEventListener(r,e,t){if(super.removeEventListener(r,e,t),this.$$c){let n=this.$$l_u.get(e);n&&(n(),this.$$l_u.delete(e))}if(this.$$l[r]){let n=this.$$l[r].indexOf(e);n>=0&&this.$$l[r].splice(n,1)}}async connectedCallback(){if(this.$$cn=!0,!this.$$c){let r=function(i){return()=>{let o;return{c:function(){o=w("slot"),i!=="default"&&p(o,"name",i)},m:function(l,u){k(l,o,u)},d:function(l){l&&x(o)}}}};if(await Promise.resolve(),!this.$$cn||this.$$c)return;let e={},t=jn(this);for(let i of this.$$s)i in t&&(e[i]=[r(i)]);for(let i of this.attributes){let o=this.$$g_p(i.name);o in this.$$d||(this.$$d[o]=br(o,i.value,this.$$p_d,"toProp"))}for(let i in this.$$p_d)!(i in this.$$d)&&this[i]!==void 0&&(this.$$d[i]=this[i],delete this[i]);this.$$c=new this.$$ctor({target:this.shadowRoot||this,props:{...this.$$d,$$slots:e,$$scope:{ctx:[]}}});let n=()=>{this.$$r=!0;for(let i in this.$$p_d)if(this.$$d[i]=this.$$c.$$.ctx[this.$$c.$$.props[i]],this.$$p_d[i].reflect){let o=br(i,this.$$d[i],this.$$p_d,"toAttribute");o==null?this.removeAttribute(this.$$p_d[i].attribute||i):this.setAttribute(this.$$p_d[i].attribute||i,o)}this.$$r=!1};this.$$c.$$.after_update.push(n),n();for(let i in this.$$l)for(let o of this.$$l[i]){let a=this.$$c.$on(i,o);this.$$l_u.set(o,a)}this.$$l={}}}attributeChangedCallback(r,e,t){this.$$r||(r=this.$$g_p(r),this.$$d[r]=br(r,t,this.$$p_d,"toProp"),this.$$c?.$set({[r]:this.$$d[r]}))}disconnectedCallback(){this.$$cn=!1,Promise.resolve().then(()=>{!this.$$cn&&this.$$c&&(this.$$c.$destroy(),this.$$c=void 0)})}$$g_p(r){return Object.keys(this.$$p_d).find(e=>this.$$p_d[e].attribute===r||!this.$$p_d[e].attribute&&e.toLowerCase()===r)||r}});function br(r,e,t,n){let i=t[r]?.type;if(e=i==="Boolean"&&typeof e!="boolean"?e!=null:e,!n||!t[r])return e;if(n==="toAttribute")switch(i){case"Object":case"Array":return e==null?null:JSON.stringify(e);case"Boolean":return e?"":null;case"Number":return e??null;default:return e}else switch(i){case"Object":case"Array":return e&&JSON.parse(e);case"Boolean":return e;case"Number":return e!=null?+e:e;default:return e}}var Z=class{$$=void 0;$$set=void 0;$destroy(){Te(this,1),this.$destroy=C}$on(e,t){if(!nt(t))return C;let n=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return n.push(t),()=>{let i=n.indexOf(t);i!==-1&&n.splice(i,1)}}$set(e){this.$$set&&!Cn(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}};typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add("4");function Ds(r){let e,t,n,i,o,a,s,l,u,c,f,d,h,m=r[8].default,_=Gn(m,r,r[7],null);return{c(){e=w("dialog"),t=w("div"),n=w("div"),i=w("div"),o=I(r[3]),a=I("\xA0"),s=B(),l=w("button"),l.textContent="\u2716",u=B(),_&&_.c(),p(i,"id","title"),p(i,"class","svelte-1j9ahxx"),p(l,"class","close svelte-1j9ahxx"),p(l,"aria-label","Close"),p(n,"class","head svelte-1j9ahxx"),p(t,"class","inner svelte-1j9ahxx"),p(e,"class",c="asyncglk_ui "+r[0]+" svelte-1j9ahxx"),ke(e,"fullscreen",r[1]),ke(e,"manually_positioned",typeof visualViewport<"u")},m(b,S){k(b,e,S),y(e,t),y(t,n),y(n,i),y(i,o),y(i,a),y(n,s),y(n,l),y(t,u),_&&_.m(t,null),r[9](e),f=!0,d||(h=[D(l,"click",r[4]),D(e,"close",r[4])],d=!0)},p(b,[S]){(!f||S&8)&&N(o,b[3]),_&&_.p&&(!f||S&128)&&In(_,m,b,b[7],f?Wn(m,b[7],S,null):Qn(b[7]),null),(!f||S&1&&c!==(c="asyncglk_ui "+b[0]+" svelte-1j9ahxx"))&&p(e,"class",c),(!f||S&3)&&ke(e,"fullscreen",b[1]),(!f||S&1)&&ke(e,"manually_positioned",typeof visualViewport<"u")},i(b){f||(Y(_,b),f=!0)},o(b){ie(_,b),f=!1},d(b){b&&x(e),_&&_.d(b),r[9](null),d=!1,L(h)}}}function Rs(r,e,t){let{$$slots:n={},$$scope:i}=e,o,{extra_class:a=""}=e,{fullscreen:s=!1}=e,l,u="";async function c(_){t(3,u=_);let b=new Promise(S=>l=S);return o.showModal(),visualViewport&&(visualViewport.addEventListener("resize",h),s&&t(2,o.style.height=visualViewport.height+"px",o),t(2,o.style.top=(visualViewport.height-o.offsetHeight)/2+"px",o)),b}function f(_){o.close(),visualViewport&&(visualViewport.removeEventListener("resize",h),t(2,o.style.height="",o)),l(_)}function d(){f(!1)}function h(){ve()||(s&&t(2,o.style.height=visualViewport.height+"px",o),t(2,o.style.top=(visualViewport.height-o.offsetHeight)/2+"px",o))}function m(_){fe[_?"unshift":"push"](()=>{o=_,t(2,o)})}return r.$$set=_=>{"extra_class"in _&&t(0,a=_.extra_class),"fullscreen"in _&&t(1,s=_.fullscreen),"$$scope"in _&&t(7,i=_.$$scope)},[a,s,o,u,d,c,f,i,n,m]}var vr=class extends Z{constructor(e){super(),oe(this,e,Rs,Ds,ne,{extra_class:0,fullscreen:1,open:5,resolve:6})}get open(){return this.$$.ctx[5]}get resolve(){return this.$$.ctx[6]}},Dt=vr;function qn(r){let e,t,n,i;return{c(){e=w("textarea"),p(e,"id","val_input"),p(e,"autocapitalize","off"),p(e,"rows","1"),p(e,"class","svelte-1b53z4t")},m(o,a){k(o,e,a),n||(i=[D(e,"keydown",r[5]),kt(t=r[4].call(null,e))],n=!0)},p:C,d(o){o&&x(e),n=!1,L(i)}}}function Yn(r){let e,t,n;return{c(){e=w("button"),e.textContent="Cancel",p(e,"class","close")},m(i,o){k(i,e,o),t||(n=D(e,"click",r[3]),t=!0)},p:C,d(i){i&&x(e),t=!1,n()}}}function Cs(r){let e,t,n,i,o,a,s,l,u,c,f,d=r[1]===We&&qn(r),h=r[1]!==Rt&&Yn(r);return{c(){e=w("p"),t=I(r[0]),n=B(),i=w("div"),d&&d.c(),o=B(),a=w("div"),s=w("div"),h&&h.c(),l=B(),u=w("button"),u.textContent="Ok",p(u,"class","submit"),p(a,"class","foot uirow")},m(m,_){k(m,e,_),y(e,t),k(m,n,_),k(m,i,_),d&&d.m(i,null),k(m,o,_),k(m,a,_),y(a,s),h&&h.m(s,null),y(s,l),y(s,u),c||(f=D(u,"click",r[6]),c=!0)},p(m,_){_&1&&N(t,m[0]),m[1]===We?d?d.p(m,_):(d=qn(m),d.c(),d.m(i,null)):d&&(d.d(1),d=null),m[1]!==Rt?h?h.p(m,_):(h=Yn(m),h.c(),h.m(s,l)):h&&(h.d(1),h=null)},d(m){m&&(x(e),x(n),x(i),x(o),x(a)),d&&d.d(),h&&h.d(),c=!1,f()}}}function Gs(r){let e,t,n={$$slots:{default:[Cs]},$$scope:{ctx:r}};return e=new Dt({props:n}),r[10](e),{c(){He(e.$$.fragment)},m(i,o){Ge(e,i,o),t=!0},p(i,[o]){let a={};o&4099&&(a.$$scope={dirty:o,ctx:i}),e.$set(a)},i(i){t||(Y(e.$$.fragment,i),t=!0)},o(i){ie(e.$$.fragment,i),t=!1},d(i){r[10](null),Te(e,i)}}}function Ts(r,e,t){let n,{initial:i=void 0}=e,{message:o}=e,{mode:a}=e,{title:s}=e,l;function u(){let _=n.open(s);return l&&(l.value=i||"",l.focus()),_}function c(){n.resolve(!1)}function f(_){l=_,l.focus(),l.value=i||""}function d(_){_.code==="Enter"&&(h(),_.preventDefault())}function h(){if(a===We){let _=l.value.trim();n.resolve(_||!1)}else n.resolve(!0)}function m(_){fe[_?"unshift":"push"](()=>{n=_,t(2,n)})}return r.$$set=_=>{"initial"in _&&t(7,i=_.initial),"message"in _&&t(0,o=_.message),"mode"in _&&t(1,a=_.mode),"title"in _&&t(8,s=_.title)},[o,a,n,c,f,d,h,i,s,u,m]}var kr=class extends Z{constructor(e){super(),oe(this,e,Ts,Gs,ne,{initial:7,message:0,mode:1,title:8,open:9})}get open(){return this.$$.ctx[9]}},Ct=kr;var Rt=0,Sr=1,We=2,Je=class{constructor(){this.browseable=!1;this.next=this}async delete(e){}async exists(e){return null}async read(e){return null}async write(e){}};async function Gt(r,e){let t=new Ct({target:document.body,props:{message:e,mode:Rt,title:r}});await t.open(),t.$destroy()}var Tt=class{constructor(e){this.browseable=!1;this.next=new Je;this.store=new Map;this.options=e}async download(e,t){let[n,i]=await Ws(this.options,e,t),o=Is(n);return this.store.set(o,i),o}async upload(e){let t=await Fr(e),n="/upload/"+e.name;return this.store.set(n,t),n}async delete(e){if(this.store.has(e))this.store.delete(e);else return this.next.delete(e)}async exists(e){return this.store.has(e)?!0:this.next.exists(e)}async read(e){return this.store.has(e)?this.store.get(e):this.next.read(e)}write(e){return this.next.write(e)}};async function Ws(r,e,t){let n=new URL(e,document.URL);e=n+"";let i=n.hostname,o=n.protocol===document.location.protocol,a=i===document.location.hostname,s;if(n.protocol==="embedded:"){let f=document.getElementById(n.pathname),d=f.text,h=await Be(d);return f.type.endsWith(";gzip")&&(h=wt(h)),[e,h]}let l=o&&a||n.protocol==="data:",u=r.direct_domains;if(!l&&u){for(let f of u)if(i.endsWith(f)){n.protocol="https:",l=!0;break}}if(l)try{s=await fetch(""+n),e=s.url??e}catch{throw new Error("Failed to fetch storyfile (possible CORS error)")}else if(r.use_proxy&&r.proxy_url)s=await fetch(`${r.proxy_url}?url=${n}`),e=s.headers.get("Final-Url")??e;else throw new Error("Storyfile not in list of direct domains and proxy disabled");if(!s.ok){if(s.status===451){let f="<p>Storyfile is unavailable for legal reasons";throw s.headers.get("Content-type")?.startsWith("text/html")&&(f+=`<p>The server might have <a href='${encodeURI(s.url)}'>more information</a>`),f}throw new Error(`Could not fetch storyfile, got ${s.status}`)}let c=await bt(s,t);if(e.endsWith(".js")){let f=Ve.decode(c),d=/processBase64Zcode\(['"]([a-zA-Z0-9+/=]+)['"]\)/.exec(f);if(!d)throw new Error("Abnormal JSified story");return[e,await Be(d[1])]}return[e,c]}function Fr(r){return new Promise((e,t)=>{let n=new FileReader;n.onerror=()=>t(n.error),n.onload=()=>e(new Uint8Array(n.result)),n.readAsArrayBuffer(r)})}function Is(r){return r.startsWith("https:")?"/download/https/"+r.substring(8):"/download/http/"+r.substring(7)}var Qs=["\u04A0\u04BF\u0500\u051F\u0680\u06BF\u0760\u079F\u07C0\u07DF\u1000\u101F\u10A0\u10BF\u1100\u115F\u1180\u119F\u11E0\u123F\u1260\u127F\u12E0\u12FF\u1320\u133F\u13A0\u13DF\u1420\u165F\u16A0\u16DF\u1780\u179F\u1820\u185F\u18C0\u18DF\u1980\u199F\u19E0\u19FF\u1A20\u1A3F\u1BC0\u1BDF\u1C00\u1C1F\u1D00\u1D1F\u21E0\u21FF\u22C0\u22DF\u2340\u23DF\u2400\u241F\u2500\u275F\u2780\u27BF\u2800\u297F\u29A0\u29BF\u2A20\u2A5F\u2A80\u2ABF\u2AE0\u2B5F\u2C00\u2C1F\u2C80\u2CDF\u2D00\u2D1F\u2D40\u2D5F\u2EA0\u2EDF\u31C0\u31DF\u3400\u4D9F\u4DC0\u9FBF\uA000\uA47F\uA4A0\uA4BF\uA500\uA5FF\uA640\uA65F\uA6A0\uA6DF\uA700\uA75F\uA780\uA79F\uA840\uA85F","\u0180\u019F\u0240\u029F"],Wt={},Er={};Qs.forEach((r,e)=>{let t=[];r.match(/../gu).forEach(i=>{let o=i.codePointAt(0),a=i.codePointAt(1);for(let s=o;s<=a;s++)t.push(String.fromCodePoint(s))});let n=15-8*e;Wt[n]=t,t.forEach((i,o)=>{Er[i]=[n,o]})});var Ar=r=>{let e=r.length,t="",n=0,i=0;for(let o=0;o<e;o++){let a=r[o];for(let s=7;s>=0;s--){let l=a>>s&1;n=(n<<1)+l,i++,i===15&&(t+=Wt[i][n],n=0,i=0)}}if(i!==0){for(;!(i in Wt);)n=(n<<1)+1,i++;t+=Wt[i][n]}return t},Zn=r=>{let e=r.length,t=new Uint8Array(Math.floor(e*15/8)),n=0,i=0,o=0;for(let a=0;a<e;a++){let s=r.charAt(a);if(!(s in Er))throw new Error(`Unrecognised Base32768 character: ${s}`);let[l,u]=Er[s];if(l!==15&&a!==e-1)throw new Error("Secondary character found before end of input at position "+String(a));for(let c=l-1;c>=0;c--){let f=u>>c&1;i=(i<<1)+f,o++,o===8&&(t[n]=i,n++,i=0,o=0)}}if(i!==(1<<o)-1)throw new Error("Padding mismatch");return new Uint8Array(t.buffer,0,n)};var Ur="dialog_metadata",Kn="dialog_storage_version";var it=class{constructor(e,t,n,i){this._metadata={};this.next=new Je;this.transaction=!1;this.browseable=i??!1,this.dirs=n,this.prefix=e,this.store=t,t===localStorage&&Ms()}async delete(e){if(e.startsWith(this.prefix))this.store.removeItem(e),await this.update_metadata(e,1);else return this.next.delete(e)}async exists(e){return e.startsWith(this.prefix)?this.store.getItem(e)!==null:this.next.exists(e)}async metadata(){return this._metadata=JSON.parse(this.store.getItem(Ur)||"{}"),this._metadata[this.dirs.working+"/.dir"]={atime:0,mtime:0},this._metadata}async read(e){if(e.startsWith(this.prefix)){let t=this.store.getItem(e);return t!==null?(await this.update_metadata(e,2),Zn(t)):null}else return this.next.read(e)}async rename(e,t,n){if(await this.transaction_start(),e){for(let i of Object.keys(this._metadata))if(i.startsWith(t)){let o=i.replace(t,n);await this.rename_file(i,o)}}else await this.rename_file(t,n);this.transaction_end()}async rename_file(e,t){let n=await this.read(e);await this.write({new_path:n}),await this.update_metadata(t,3,e),await this.delete(e)}async transaction_start(){let e=this.transaction;return this.transaction=!0,e||await this.metadata(),e}transaction_end(){this.transaction=!1,delete this._metadata[this.dirs.working+"/.dir"],this.store.setItem(Ur,JSON.stringify(this._metadata))}async update_metadata(e,t,n){let i=Date.now();switch(this.transaction||await this.metadata(),t){case 1:delete this._metadata[e];break;case 2:this._metadata[e].atime=i;break;case 3:this._metadata[e]=this._metadata[n],delete this._metadata[n];break;case 4:this._metadata[e]||(this._metadata[e]={atime:i,mtime:i}),this._metadata[e].mtime=i}this.transaction||this.transaction_end()}async write(e){let t=await this.transaction_start(),n=!1,i=!1;for(let[o,a]of Object.entries(e))if(o.startsWith(this.prefix)){n=!0;try{this.store.setItem(o,Ar(a)),this.update_metadata(o,4)}catch{Gt("localStorage full",`The file ${o.replace(/\//g,"/\u200B")} could not be written as your browser's localStorage is full! Please delete some files, and then try again.`)}delete e[o]}else i=!0;t||(this.transaction=!1,n&&this.transaction_end()),i&&this.next.write(e)}},Os={data:"glkdata",save:"glksave",transcript:"txt"};function Ms(){let r=Date.now(),e=parseInt(localStorage.getItem(Kn)||"0",10);if(e<2){console.log("Dialog: updating localStorage to version 2");let t={};for(let[n,i]of Object.entries(localStorage))if(n.startsWith("autosave:")&&localStorage.removeItem(n),n.startsWith("content:")){let o=/^content:(\w+):(\w*):(.+)$/.exec(n);if(o){let a=`/usr/${o[3]}.${Os[o[1]]||o[1]}`;i!==""&&e<1&&(i=Ar(/\[[,\d]*\]/.test(i)?JSON.parse(i):Uint8Array.from(i,c=>c.charCodeAt(0)))),localStorage.setItem(a,i);let s="dirent"+n.substring(7),l=localStorage.getItem(s)||"",u=/^created:\d+,modified:(\d+)$/.exec(l);t[a]={atime:parseInt(u?.[1]||"",10)||r,mtime:parseInt(u?.[1]||"",10)||r},localStorage.removeItem(s)}localStorage.removeItem(n)}localStorage.setItem(Ur,JSON.stringify(t)),localStorage.setItem(Kn,"2")}if(e>2)throw new Error("dialog_storage_version is newer than this library supports")}function Xn(r,e,t){let n=r.slice();return n[3]=e[t],n[5]=t,n}function Ls(r){let e;return{c(){e=w("span"),e.textContent="\xA0/\xA0",p(e,"class","slash svelte-909yjd")},m(t,n){k(t,e,n)},d(t){t&&x(e)}}}function Vs(r){let e,t=(r[3]==="usr"?"My files":r[3])+"",n;return{c(){e=w("span"),n=I(t)},m(i,o){k(i,e,o),y(e,n)},p(i,o){o&1&&t!==(t=(i[3]==="usr"?"My files":i[3])+"")&&N(n,t)},d(i){i&&x(e)}}}function $s(r){let e,t,n=(r[3]==="usr"?"My files":r[3])+"",i,o,a,s;return{c(){e=w("span"),t=w("button"),i=I(n),p(t,"class","flat svelte-909yjd"),p(t,"data-path",o="/"+r[0].slice(0,r[5]+1).join("/"))},m(l,u){k(l,e,u),y(e,t),y(t,i),a||(s=D(t,"click",r[1]),a=!0)},p(l,u){u&1&&n!==(n=(l[3]==="usr"?"My files":l[3])+"")&&N(i,n),u&1&&o!==(o="/"+l[0].slice(0,l[5]+1).join("/"))&&p(t,"data-path",o)},d(l){l&&x(e),a=!1,s()}}}function ei(r){let e,t,n=r[5]!==0&&Ls(r);function i(s,l){return s[0][s[5]+1]?$s:Vs}let o=i(r,-1),a=o(r);return{c(){n&&n.c(),e=B(),a.c(),t=Et()},m(s,l){n&&n.m(s,l),k(s,e,l),a.m(s,l),k(s,t,l)},p(s,l){o===(o=i(s,l))&&a?a.p(s,l):(a.d(1),a=o(s),a&&(a.c(),a.m(t.parentNode,t)))},d(s){s&&(x(e),x(t)),n&&n.d(s),a.d(s)}}}function zs(r){let e,t=Fe(r[0]),n=[];for(let i=0;i<t.length;i+=1)n[i]=ei(Xn(r,t,i));return{c(){e=w("div");for(let i=0;i<n.length;i+=1)n[i].c();p(e,"id","dirtree"),p(e,"class","svelte-909yjd")},m(i,o){k(i,e,o);for(let a=0;a<n.length;a+=1)n[a]&&n[a].m(e,null)},p(i,[o]){if(o&3){t=Fe(i[0]);let a;for(a=0;a<t.length;a+=1){let s=Xn(i,t,a);n[a]?n[a].p(s,o):(n[a]=ei(s),n[a].c(),n[a].m(e,null))}for(;a<n.length;a+=1)n[a].d(1);n.length=t.length}},i:C,o:C,d(i){i&&x(e),Ft(n,i)}}}function Ns(r,e,t){let{cur_dir:n}=e,i;function o(a){let s=a.target;t(2,n=s.dataset.path)}return r.$$set=a=>{"cur_dir"in a&&t(2,n=a.cur_dir)},r.$$.update=()=>{r.$$.dirty&4&&t(0,i=n.substring(1).split("/"))},[i,o,n]}var Br=class extends Z{constructor(e){super(),oe(this,e,Ns,zs,ne,{cur_dir:2})}},ti=Br;function js(r){let e,t;return{c(){e=be("svg"),t=be("path"),p(t,"stroke-linecap","round"),p(t,"stroke-linejoin","round"),p(t,"d","M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z"),p(e,"xmlns","http://www.w3.org/2000/svg"),p(e,"fill","none"),p(e,"viewBox","0 0 24 24"),p(e,"height","20px"),p(e,"width","20px"),p(e,"stroke-width","1.5"),p(e,"stroke","currentColor"),p(e,"class","svelte-1wgzrj7")},m(n,i){k(n,e,i),y(e,t)},d(n){n&&x(e)}}}function Ps(r){let e,t;return{c(){e=be("svg"),t=be("path"),p(t,"stroke-linecap","round"),p(t,"stroke-linejoin","round"),p(t,"d","M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z"),p(e,"xmlns","http://www.w3.org/2000/svg"),p(e,"fill","none"),p(e,"viewBox","0 0 24 24"),p(e,"height","20px"),p(e,"width","20px"),p(e,"stroke-width","1.5"),p(e,"stroke","currentColor"),p(e,"class","svelte-1wgzrj7")},m(n,i){k(n,e,i),y(e,t)},d(n){n&&x(e)}}}function Hs(r){let e,t;return{c(){e=be("svg"),t=be("path"),p(t,"stroke-linecap","round"),p(t,"stroke-linejoin","round"),p(t,"d","M10.125 2.25h-4.5c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125v-9M10.125 2.25h.375a9 9 0 0 1 9 9v.375M10.125 2.25A3.375 3.375 0 0 1 13.5 5.625v1.5c0 .621.504 1.125 1.125 1.125h1.5a3.375 3.375 0 0 1 3.375 3.375M9 15l2.25 2.25L15 12"),p(e,"xmlns","http://www.w3.org/2000/svg"),p(e,"fill","none"),p(e,"viewBox","0 0 24 24"),p(e,"height","20px"),p(e,"width","20px"),p(e,"stroke-width","1.5"),p(e,"stroke","currentColor"),p(e,"class","svelte-1wgzrj7")},m(n,i){k(n,e,i),y(e,t)},d(n){n&&x(e)}}}function Js(r){let e,t;return{c(){e=be("svg"),t=be("path"),p(t,"stroke-linecap","round"),p(t,"stroke-linejoin","round"),p(t,"d","M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z"),p(e,"xmlns","http://www.w3.org/2000/svg"),p(e,"fill","none"),p(e,"viewBox","0 0 24 24"),p(e,"height","20px"),p(e,"width","20px"),p(e,"stroke-width","1.5"),p(e,"stroke","currentColor"),p(e,"class","svelte-1wgzrj7")},m(n,i){k(n,e,i),y(e,t)},d(n){n&&x(e)}}}function ri(r){let e,t,n,i,o,a,s,l,u=!r[0].dir&&r[0].meta&&ni(r);function c(h,m){return h[0].dir?Ys:qs}let f=c(r,-1),d=f(r);return{c(){u&&u.c(),e=B(),t=w("div"),d.c(),n=B(),i=w("button"),i.textContent="Rename",o=B(),a=w("button"),a.textContent="Delete",p(t,"class","actions svelte-1wgzrj7")},m(h,m){u&&u.m(h,m),k(h,e,m),k(h,t,m),d.m(t,null),y(t,n),y(t,i),y(t,o),y(t,a),s||(l=[D(i,"click",r[8]),D(a,"click",r[3])],s=!0)},p(h,m){!h[0].dir&&h[0].meta?u?u.p(h,m):(u=ni(h),u.c(),u.m(e.parentNode,e)):u&&(u.d(1),u=null),f===(f=c(h,m))&&d?d.p(h,m):(d.d(1),d=f(h),d&&(d.c(),d.m(t,n)))},d(h){h&&(x(e),x(t)),u&&u.d(h),d.d(),s=!1,L(l)}}}function ni(r){let e,t,n=new Date(r[0].meta.mtime).toDateString()+"",i;return{c(){e=w("div"),t=I("Last modified: "),i=I(n),p(e,"class","date svelte-1wgzrj7")},m(o,a){k(o,e,a),y(e,t),y(e,i)},p(o,a){a&1&&n!==(n=new Date(o[0].meta.mtime).toDateString()+"")&&N(i,n)},d(o){o&&x(e)}}}function qs(r){let e,t,n;return{c(){e=w("button"),e.textContent="Download"},m(i,o){k(i,e,o),t||(n=D(e,"click",r[5]),t=!0)},p:C,d(i){i&&x(e),t=!1,n()}}}function Ys(r){let e,t,n;return{c(){e=w("button"),e.textContent="Open"},m(i,o){k(i,e,o),t||(n=D(e,"click",r[7]),t=!0)},p:C,d(i){i&&x(e),t=!1,n()}}}function Zs(r){let e,t,n,i,o,a,s,l=r[0].name+"",u,c,f,d;function h(S,R){return R&1&&(i=null),R&1&&(o=null),S[0].dir?Js:(i==null&&(i=!!(S[0].name.endsWith(".glksave")||S[0].name.endsWith(".sav"))),i?Hs:(o==null&&(o=!!S[0].name.endsWith(".txt")),o?Ps:js))}let m=h(r,-1),_=m(r),b=r[1]&&ri(r);return{c(){e=w("div"),t=w("button"),n=w("div"),_.c(),a=B(),s=w("div"),u=I(l),c=B(),b&&b.c(),p(n,"class","icon svelte-1wgzrj7"),p(n,"aria-hidden","true"),p(s,"class","name svelte-1wgzrj7"),p(t,"aria-selected",r[1]),p(t,"class","flat svelte-1wgzrj7"),p(t,"role","option"),p(e,"class","filelistitem svelte-1wgzrj7"),ke(e,"selected",r[1])},m(S,R){k(S,e,R),y(e,t),y(t,n),_.m(n,null),y(t,a),y(t,s),y(s,u),y(e,c),b&&b.m(e,null),f||(d=[D(t,"click",r[2]),D(t,"dblclick",$n(Vn(r[4]))),D(t,"keydown",r[6])],f=!0)},p(S,[R]){m!==(m=h(S,R))&&(_.d(1),_=m(S),_&&(_.c(),_.m(n,null))),R&1&&l!==(l=S[0].name+"")&&N(u,l),R&2&&p(t,"aria-selected",S[1]),S[1]?b?b.p(S,R):(b=ri(S),b.c(),b.m(e,null)):b&&(b.d(1),b=null),R&2&&ke(e,"selected",S[1])},i:C,o:C,d(S){S&&x(e),_.d(),b&&b.d(),f=!1,L(d)}}}function Ks(r,e,t){let n=pr(),{data:i}=e,{selected:o}=e,{selected_file:a}=e;function s(){t(9,a=i)}function l(){n("file_delete",i)}function u(){n("file_doubleclicked",i)}function c(){n("file_download",i)}function f(m){if(m.code==="ArrowDown"){let _=m.target.nextElementSibling;_&&(_.click(),_.focus())}if(m.code==="ArrowUp"){let _=m.target.previousElementSibling;_&&(_.click(),_.focus())}m.code==="Enter"&&(n("file_doubleclicked",i),m.preventDefault())}function d(){n("file_doubleclicked",i)}function h(){n("file_rename",i)}return r.$$set=m=>{"data"in m&&t(0,i=m.data),"selected"in m&&t(1,o=m.selected),"selected_file"in m&&t(9,a=m.selected_file)},[i,o,s,l,u,c,f,d,h,a]}var Dr=class extends Z{constructor(e){super(),oe(this,e,Ks,Zs,ne,{data:0,selected:1,selected_file:9})}},ii=Dr;function oi(r,e,t){let n=r.slice();return n[33]=e[t],n}function si(r){let e,t,n;function i(a){r[26](a)}let o={data:r[33],selected:r[33].full_path===r[3]?.full_path};return r[3]!==void 0&&(o.selected_file=r[3]),e=new ii({props:o}),fe.push(()=>xr(e,"selected_file",i)),e.$on("file_delete",r[13]),e.$on("file_doubleclicked",r[14]),e.$on("file_download",r[15]),e.$on("file_rename",r[16]),{c(){He(e.$$.fragment)},m(a,s){Ge(e,a,s),n=!0},p(a,s){let l={};s[0]&32&&(l.data=a[33]),s[0]&40&&(l.selected=a[33].full_path===a[3]?.full_path),!t&&s[0]&8&&(t=!0,l.selected_file=a[3],gr(()=>t=!1)),e.$set(l)},i(a){n||(Y(e.$$.fragment,a),n=!0)},o(a){ie(e.$$.fragment,a),n=!1},d(a){Te(e,a)}}}function ai(r){let e,t,n,i,o,a,s;return{c(){e=w("div"),t=w("label"),t.textContent="File name:",n=B(),i=w("textarea"),p(t,"for","filename_input"),p(i,"id","filename_input"),p(i,"autocapitalize","off"),p(i,"rows","1"),p(i,"class","svelte-1wjxkp6"),p(e,"class","filename svelte-1wjxkp6")},m(l,u){k(l,e,u),y(e,t),y(e,n),y(e,i),a||(s=[D(i,"keydown",r[17]),kt(o=r[12].call(null,i))],a=!0)},p:C,d(l){l&&x(e),a=!1,L(s)}}}function li(r){let e,t,n,i,o,a;function s(c,f){return c[6].label?ea:Xs}let l=s(r,[-1,-1]),u=l(r);return{c(){e=w("label"),e.textContent="File type:",t=B(),n=w("select"),u.c(),i=w("option"),i.textContent="All files",p(e,"for","dialog_filter"),i.__value="*",Ne(i,i.__value),p(n,"id","dialog_filter"),p(n,"class","svelte-1wjxkp6"),r[1]===void 0&&Re(()=>r[27].call(n))},m(c,f){k(c,e,f),k(c,t,f),k(c,n,f),u.m(n,null),y(n,i),dr(n,r[1],!0),o||(a=D(n,"change",r[27]),o=!0)},p(c,f){l===(l=s(c,f))&&u?u.p(c,f):(u.d(1),u=l(c),u&&(u.c(),u.m(n,i))),f[0]&66&&dr(n,c[1])},d(c){c&&(x(e),x(t),x(n)),u.d(),o=!1,a()}}}function Xs(r){let e,t=r[6].extensions[0]+"",n,i,o;return{c(){e=w("option"),n=I(t),i=I(" file"),e.__value=o=r[6].extensions.join(),Ne(e,e.__value)},m(a,s){k(a,e,s),y(e,n),y(e,i)},p(a,s){s[0]&64&&t!==(t=a[6].extensions[0]+"")&&N(n,t),s[0]&64&&o!==(o=a[6].extensions.join())&&(e.__value=o,Ne(e,e.__value))},d(a){a&&x(e)}}}function ea(r){let e,t=r[6].label+"",n,i;return{c(){e=w("option"),n=I(t),e.__value=i=r[6].extensions.join(),Ne(e,e.__value)},m(o,a){k(o,e,a),y(e,n)},p(o,a){a[0]&64&&t!==(t=o[6].label+"")&&N(n,t),a[0]&64&&i!==(i=o[6].extensions.join())&&(e.__value=i,Ne(e,e.__value))},d(o){o&&x(e)}}}function fi(r){let e;function t(o,a){return o[9]?ra:ta}let i=t(r,[-1,-1])(r);return{c(){e=w("div"),i.c(),p(e,"id","storage_warning"),p(e,"class","svelte-1wjxkp6")},m(o,a){k(o,e,a),i.m(e,null)},p:C,d(o){o&&x(e),i.d()}}}function ta(r){let e;return{c(){e=I("Note: Files saved in this browser may be lost by clearing cookies, or depending on your browser settings.")},m(t,n){k(t,e,n)},d(t){t&&x(e)}}}function ra(r){let e;return{c(){e=I("Warning: Files saved in this browser will be lost if you don't visit again within a week.")},m(t,n){k(t,e,n)},d(t){t&&x(e)}}}function na(r){let e,t,n,i,o,a,s,l,u,c,f,d,h,m,_,b,S,R,W,ee,j,E,G,z,P,ce;function H(v){r[25](v)}let Ee={};r[0]!==void 0&&(Ee.cur_dir=r[0]),s=new ti({props:Ee}),fe.push(()=>xr(s,"cur_dir",H));let te=Fe(r[5]),T=[];for(let v=0;v<te.length;v+=1)T[v]=si(oi(r,te,v));let Me=v=>ie(T[v],1,1,()=>{T[v]=null}),Q=r[2]&&ai(r),O=r[6]&&li(r),V=r[2]&&fi(r);return{c(){e=w("div"),t=w("div"),n=w("button"),n.textContent="Add file",i=B(),o=w("button"),o.textContent="New Folder",a=B(),He(s.$$.fragment),u=B(),c=w("div");for(let v=0;v<T.length;v+=1)T[v].c();f=B(),Q&&Q.c(),d=B(),h=w("div"),m=w("div"),O&&O.c(),_=B(),b=w("div"),S=w("button"),S.textContent="Cancel",R=B(),W=w("button"),ee=I(r[7]),j=B(),V&&V.c(),E=B(),G=w("input"),p(t,"id","actions"),p(t,"class","svelte-1wjxkp6"),p(c,"id","filelist"),p(c,"role","listbox"),p(c,"class","svelte-1wjxkp6"),p(m,"id","filter"),p(m,"class","svelte-1wjxkp6"),p(S,"class","close"),p(W,"class","submit"),p(h,"class","foot uirow"),p(G,"id","add_file"),p(G,"type","file"),G.multiple=!0,p(G,"class","svelte-1wjxkp6")},m(v,g){k(v,e,g),y(e,t),y(t,n),y(t,i),y(t,o),y(e,a),Ge(s,e,null),k(v,u,g),k(v,c,g);for(let F=0;F<T.length;F+=1)T[F]&&T[F].m(c,null);k(v,f,g),Q&&Q.m(v,g),k(v,d,g),k(v,h,g),y(h,m),O&&O.m(m,null),y(h,_),y(h,b),y(b,S),y(b,R),y(b,W),y(W,ee),k(v,j,g),V&&V.m(v,g),k(v,E,g),k(v,G,g),r[28](G),z=!0,P||(ce=[D(n,"click",r[10]),D(o,"click",r[18]),D(S,"click",r[11]),D(W,"click",r[19]),D(G,"change",r[20])],P=!0)},p(v,g){let F={};if(!l&&g[0]&1&&(l=!0,F.cur_dir=v[0],gr(()=>l=!1)),s.$set(F),g[0]&122920){te=Fe(v[5]);let A;for(A=0;A<te.length;A+=1){let M=oi(v,te,A);T[A]?(T[A].p(M,g),Y(T[A],1)):(T[A]=si(M),T[A].c(),Y(T[A],1),T[A].m(c,null))}for(yr(),A=te.length;A<T.length;A+=1)Me(A);wr()}v[2]?Q?Q.p(v,g):(Q=ai(v),Q.c(),Q.m(d.parentNode,d)):Q&&(Q.d(1),Q=null),v[6]?O?O.p(v,g):(O=li(v),O.c(),O.m(m,null)):O&&(O.d(1),O=null),(!z||g[0]&128)&&N(ee,v[7]),v[2]?V?V.p(v,g):(V=fi(v),V.c(),V.m(E.parentNode,E)):V&&(V.d(1),V=null)},i(v){if(!z){Y(s.$$.fragment,v);for(let g=0;g<te.length;g+=1)Y(T[g]);z=!0}},o(v){ie(s.$$.fragment,v),T=T.filter(Boolean);for(let g=0;g<T.length;g+=1)ie(T[g]);z=!1},d(v){v&&(x(e),x(u),x(c),x(f),x(d),x(h),x(j),x(E),x(G)),Te(s),Ft(T,v),Q&&Q.d(v),O&&O.d(),V&&V.d(v),r[28](null),P=!1,L(ce)}}}function ia(r){let e,t,n={extra_class:"asyncglk_file_dialog "+(r[2]?"":"selecting"),fullscreen:!0,$$slots:{default:[na]},$$scope:{ctx:r}};return e=new Dt({props:n}),r[29](e),{c(){He(e.$$.fragment)},m(i,o){Ge(e,i,o),t=!0},p(i,o){let a={};o[0]&4&&(a.extra_class="asyncglk_file_dialog "+(i[2]?"":"selecting")),o[0]&495|o[1]&32&&(a.$$scope={dirty:o,ctx:i}),e.$set(a)},i(i){t||(Y(e.$$.fragment,i),t=!0)},o(i){ie(e.$$.fragment,i),t=!1},d(i){r[29](null),Te(e,i)}}}function oa(r,e,t){let n,{controller:i}=e,{cur_dir:o="/usr"}=e,a=[],s="",l,u,{metadata:c={}}=e,f,d,h="",m,_=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);function b(g){t(21,c=g.metadata),g.filter?.extensions.join()!==u?.extensions.join()&&(s!=="*"&&t(1,s=g.filter?.extensions.join()??"*"),t(6,u=g.filter),u||t(1,s="*")),t(2,f=g.save),t(7,h=g.submit_label),t(3,d=void 0);let F=n.open(g.title);return f&&l&&(l.focus(),t(24,l.value="",l)),F.then(A=>typeof A=="string"?A:null)}function S(g,F,A){let M={},_e=g+"/",ge=_e.length;for(let[J,de]of Object.entries(A))if(J.startsWith(_e)){let Le=J.substring(ge),pe=q.parse(Le);pe.dir?!pe.dir.includes("/")&&!M[pe.dir]&&(M[pe.dir]={dir:!0,full_path:_e+pe.dir,name:pe.dir}):M[pe.base]={dir:!1,full_path:J,meta:de,name:pe.base}}return Object.values(M).filter(J=>{if(J.name.endsWith(".dir"))return!1;if(J.dir||F==="*")return!0;let de=F.split(",");for(let Le of de)if(J.name.endsWith(Le))return!0;return!1}).sort((J,de)=>J.dir!==de.dir?+de.dir-+J.dir:J.name.localeCompare(de.name))}async function R(g,F,A,M){let _e=new Ct({target:document.body,props:{initial:M,message:A,mode:g,title:F}}),ge=await _e.open();return await _e.$destroy(),ge}async function W(g){for(let F of a)if(g===F.name)return!!await R(Sr,"Overwrite file",`Are you sure you want to overwrite ${g}?`);return!0}function ee(){m.click()}function j(){n.resolve(!1)}function E(g){t(24,l=g),l.focus(),t(24,l.value="",l)}async function G(g){let F=g.detail;await R(Sr,"Delete file",`Are you sure you want to delete ${F.dir?"the folder ":""}${F.name}?`)&&i.delete(F)}function z(g){let F=g.detail;F.dir?t(0,o=F.full_path):(t(24,l.value=F.name,l),te())}function P(g){let F=g.detail;i.download(F)}async function ce(g){let F=g.detail,A=F.dir?"folder":"file",M=await R(We,`Rename ${A}`,`Enter new ${A} name`,F.name);M&&await W(M)&&i.rename(F,M)}function H(g){g.code==="Enter"&&(te(),g.preventDefault())}async function Ee(){let g=await R(We,"New folder","Enter new folder name");if(g){let F=o+"/"+g;i.new_folder(F)}}async function te(){if(f){let g=l.value.trim();await W(g)&&n.resolve(g?o+"/"+g:!1)}else n.resolve(d?.full_path??!1)}async function T(){if(m.files){let g={},F=!1;for(let A of m.files)await W(A.name)&&(g[o+"/"+A.name]=A,F=!0);F&&i.upload(g)}t(8,m.value="",m)}function Me(g){o=g,t(0,o)}function Q(g){d=g,t(3,d),t(0,o)}function O(){s=Nn(this),t(1,s),t(6,u)}function V(g){fe[g?"unshift":"push"](()=>{m=g,t(8,m)})}function v(g){fe[g?"unshift":"push"](()=>{n=g,t(4,n)})}return r.$$set=g=>{"controller"in g&&t(22,i=g.controller),"cur_dir"in g&&t(0,o=g.cur_dir),"metadata"in g&&t(21,c=g.metadata)},r.$$.update=()=>{r.$$.dirty[0]&1&&t(3,d=void 0),r.$$.dirty[0]&2097155&&t(5,a=S(o,s,c)),r.$$.dirty[0]&16777228&&f&&l&&d&&!d.dir&&t(24,l.value=d.name,l)},[o,s,f,d,n,a,u,h,m,_,ee,j,E,G,z,P,ce,H,Ee,te,T,c,i,b,l,Me,Q,O,V,v]}var Rr=class extends Z{constructor(e){super(),oe(this,e,oa,ia,ne,{controller:22,cur_dir:0,metadata:21,prompt:23},null,[-1,-1])}get prompt(){return this.$$.ctx[23]}},ui=Rr;var ot=class{constructor(){this.async=!0;this.dirs={storyfile:"",system_cwd:"/",temp:"/tmp",working:"/usr"};this.providers=[]}async init(e){this.downloader=new Tt(e);try{this.providers=[this.downloader,new it("/tmp",sessionStorage,this.dirs),new it("/",localStorage,this.dirs,!0)]}catch{this.providers=[this.downloader]}for(let[t,n]of this.providers.entries()){let i=this.providers[t+1];i&&(n.next=i),n.browseable&&(this.controller=new Cr(n))}}async download(e,t){let n=await this.downloader.download(e,t);return this.setup(n),n}get_dirs(){return this.dirs}async prompt(e,t){return this.controller?this.controller.prompt(e,t):(await Gt(`Cannot ${t?"save":"open"}`,"LocalStorage is not currently supported in this browser. You should be able to enable it in your browser settings; it may be under a setting about cookies."),null)}set_storyfile_dir(e){return{storyfile:e}}async upload(e){let t=await this.downloader.upload(e);return this.setup(t),t}async delete(e){await this.providers[0].delete(e)}async exists(e){return!!await this.providers[0].exists(e)}async read(e){return this.providers[0].read(e)}async write(e){await this.providers[0].write(e)}setup(e){let t=q.parse(e);this.dirs.storyfile=t.dir,this.dirs.working="/usr/"+t.name.toLowerCase().trim(),this.controller?.update_working(this.dirs.working)}},Cr=class{constructor(e){this.metadata={};this.dialog=new ui({target:document.body,props:{controller:this}}),this.provider=e}async prompt(e,t){let n=t?"Save":"Open",i=sa(e);return this.metadata=await this.provider.metadata(),this.dialog.prompt({filter:i,metadata:this.metadata,save:t,submit_label:n,title:`${n} a ${i?.title}`})}async delete(e){if(e.dir){let t=e.full_path+"/";for(let n of Object.keys(this.metadata))n.startsWith(t)&&(delete this.metadata[n],await this.provider.delete(n))}else await this.provider.delete(e.full_path),delete this.metadata[e.full_path];await this.update()}async download(e){let t=await this.provider.read(e.full_path);(0,ci.saveAs)(new Blob([t]),e.name)}async new_folder(e){let t=Date.now(),n=e+"/.dir";await this.provider.write({[n]:new Uint8Array(0)}),this.metadata[n]={atime:t,mtime:t},this.dialog.$set({cur_dir:e,metadata:this.metadata})}async rename(e,t){let i=q.parse(e.full_path).dir+"/"+t;await this.provider.rename(e.dir,e.full_path,i),await this.update(!0)}async update(e=!1){e&&(this.metadata=await this.provider.metadata()),this.dialog.$set({metadata:this.metadata})}update_working(e){this.dialog.$set({cur_dir:e})}async upload(e){let t=Date.now(),n={};for(let[i,o]of Object.entries(e))n[i]=await Fr(o),this.metadata[i]={atime:t,mtime:t};await this.provider.write(n),await this.update()}};function sa(r){switch(r){case".glkdata":return{extensions:[".glkdata"],label:"Data file",title:"data file"};case".glksave":return{extensions:[".glksave",".sav"],label:"Save file",title:"savefile"};case".txt":return{extensions:[".txt"],label:"Transcript or log",title:"log"}}}function se(r,e){return $(`<${r}>`,{class:e})}var It=class{constructor(e){this.context_element=e.context_element,this.errorcontent_id=e.errorcontent_id,this.errorpane_id=e.errorpane_id,this.gameport_id=e.gameport_id,this.loadingpane_id=e.loadingpane_id,this.prefix=e.prefix,this.windowport_id=e.windowport_id}create(e,t,n){return n??={},typeof n=="string"&&(n={class:n}),n.id=this.prefix+t,$(`<${e}>`,n)}gameport(){return $(`#${this.gameport_id}`,this.context_element)}id(e){return $(`#${this.prefix}${e}`,this.context_element)}windowport(){return $(`#${this.windowport_id}`,this.context_element)}};function Qt(){let r=document.activeElement?.tagName;return r==="INPUT"||r==="TEXTAREA"}var ue=/iPad|iPhone|iPod/.test(navigator.platform)||navigator.platform==="MacIntel"&&(navigator.maxTouchPoints??0)>1;function me(r){return{height:r.outerHeight(),width:r.outerWidth()}}function aa(r,e){return e.buffercharheight!==r.buffercharheight||e.buffercharwidth!==r.buffercharwidth||e.gridcharheight!==r.gridcharheight||e.gridcharwidth!==r.gridcharwidth||e.height!==r.height||e.width!==r.width}var st=class{constructor(e){this.height_with_keyboard=(visualViewport?.height||window.innerHeight)/2;this.on_gameport_resize=gt(async()=>{if(this.glkote.disabled||!this.glkote.inited()){this.on_gameport_resize();return}let e=Object.assign({},this.metrics);await this.measure(),aa(this.metrics,e)&&this.glkote.send_event({type:"arrange"})},200,{leading:!1});this.on_visualViewport_resize=()=>{let e=visualViewport.height;Qt()&&(this.height_with_keyboard=e),this.set_gameport_height(e)};this.glkote=e,this.metrics=e.current_metrics,document.readyState==="complete"?this.loaded=Promise.resolve():this.loaded=new Promise(t=>{window.addEventListener("load",t,{once:!0})}),window.ResizeObserver?(this.observer=new ResizeObserver(this.on_gameport_resize),this.observer.observe(this.glkote.dom.gameport()[0])):$(window).on("resize",this.on_gameport_resize),ue&&(this.on_visualViewport_resize=gt(this.on_visualViewport_resize,700)),visualViewport&&$(visualViewport).on("resize",this.on_visualViewport_resize)}destroy(){this.observer?this.observer.disconnect():$(window).off("resize",this.on_gameport_resize),visualViewport&&$(visualViewport).off("resize",this.on_visualViewport_resize)}async measure(){let e=this.glkote.dom,t=e.gameport();if(!t.length)throw new Error(`Cannot find gameport element #${e.gameport_id}`);e.id("layouttestpane").remove();let n=e.create("div","layout_test_pane");n.text("This should not be visible");let i=$("<div>");se("span","Style_normal").text("12345678").appendTo(i);let o=se("div","WindowFrame BufferWindow"),a=se("div","BufferWindowInner").appendTo(o),s=i.clone().addClass("BufferLine").appendTo(a),l=i.clone().addClass("BufferLine").appendTo(a);se("span","InvisibleCursor").appendTo(l);let u=s.children("span");n.append(o);let c=se("div","WindowFrame GraphicsWindow"),f=$("<canvas>",{height:32,width:64}).appendTo(c);n.append(c);let d=se("div","WindowFrame GridWindow"),h=i.clone().addClass("GridLine").appendTo(d),m=i.clone().addClass("GridLine").appendTo(d),_=h.children("span");n.append(d),t.append(n),await this.loaded;let b=getComputedStyle(d[0]).getPropertyValue("--glkote-grid-mono-family").split(",")[0].replace(/"/g,"");await document.fonts.load(`14px ${b}`),this.metrics.height=t.height(),this.metrics.width=t.width();let S=me(o),R=me(u),W=me(s),ee=me(l);this.metrics.buffercharheight=Math.max(1,l.position().top-s.position().top),this.metrics.buffercharwidth=Math.max(1,u.width()/8),this.metrics.buffermarginx=S.width-R.width,this.metrics.buffermarginy=S.height-(W.height+ee.height);let j=me(c),E=me(f);this.metrics.graphicsmarginx=j.width-E.width,this.metrics.graphicsmarginy=j.height-E.height;let G=me(d),z=me(_),P=me(h),ce=me(m);this.metrics.gridcharheight=Math.max(1,m.position().top-h.position().top),this.metrics.gridcharwidth=Math.max(1,_.width()/8),this.metrics.gridmarginx=G.width-z.width,this.metrics.gridmarginy=G.height-(P.height+ce.height),n.remove()}set_gameport_height(e){ve()||(e||(e=this.height_with_keyboard),this.glkote.dom.gameport().outerHeight(e,!0),window.scrollTo(0,0),this.on_gameport_resize())}};var X,at=null;function pi(){return(at===null||at.byteLength===0)&&(at=new Uint8Array(X.memory.buffer)),at}var hi=0;function la(r,e){let t=e(r.length*1,1)>>>0;return pi().set(r,t/1),hi=r.length,t}var Ie=null;function di(){return(Ie===null||Ie.buffer.detached===!0||Ie.buffer.detached===void 0&&Ie.buffer!==X.memory.buffer)&&(Ie=new DataView(X.memory.buffer)),Ie}function fa(r,e){return r=r>>>0,pi().subarray(r/1,r/1+e)}function mi(r){try{let i=X.__wbindgen_add_to_stack_pointer(-16),o=la(r,X.__wbindgen_malloc),a=hi;X.decode(i,o,a);var e=di().getInt32(i+0,!0),t=di().getInt32(i+4,!0),n=fa(e,t).slice();return X.__wbindgen_free(e,t*1,1),n}finally{X.__wbindgen_add_to_stack_pointer(16)}}async function ua(r,e){if(typeof Response=="function"&&r instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(r,e)}catch(n){if(r.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",n);else throw n}let t=await r.arrayBuffer();return await WebAssembly.instantiate(t,e)}else{let t=await WebAssembly.instantiate(r,e);return t instanceof WebAssembly.Instance?{instance:t,module:r}:t}}function ca(){let r={};return r.wbg={},r}function da(r,e){return X=r.exports,_i.__wbindgen_wasm_module=e,Ie=null,at=null,X}async function _i(r){if(X!==void 0)return X;typeof r<"u"&&(Object.getPrototypeOf(r)===Object.prototype?{module_or_path:r}=r:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof r>"u"&&(r=new URL("glkaudio_bg.wasm",import.meta.url));let e=ca();(typeof r=="string"||typeof Request=="function"&&r instanceof Request||typeof URL=="function"&&r instanceof URL)&&(r=fetch(r));let{instance:t,module:n}=await ua(await r,e);return da(t,n)}var gi=_i;var pa="SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU3LjU2LjEwMQAAAAAAAAAAAAAA//tAwAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAACAAABhgC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7//////////////////////////////////////////////////////////////////8AAAAATGF2YzU3LjY0AAAAAAAAAAAAAAAAJAUHAAAAAAAAAYYoRBqpAAAAAAD/+xDEAAPAAAGkAAAAIAAANIAAAARMQU1FMy45OS41VVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/7EMQpg8AAAaQAAAAgAAA0gAAABFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV",Ot=class extends Map{constructor(e){super(),this.glkote=e,this.context=new AudioContext,this.prime()}async update(e){let t=[];for(let n of e){let{id:i,ops:o}=n;t.push(i),this.has(i)||this.set(i,new Gr(this.glkote,this.context)),o&&this.get(i).do_ops(o)}for(let[n,i]of this)t.includes(n)||(i.delete(),this.delete(n))}async prime(){let e=this.context,t=this.context.createBufferSource(),n=await Be(pa);t.buffer=await e.decodeAudioData(n.buffer),t.connect(e.destination),t.start(),setTimeout(()=>{t.disconnect(),t.stop()},10)}},Gr=class{constructor(e,t){this.buffer=null;this.notify=0;this.paused=!1;this.paused_time=0;this.repeats=0;this.snd=0;this.source=null;this.start_time=0;this.vol_timer=0;this.on_stop=()=>{this.stop(),this.repeats!==0?this.play():this.notify&&this.glkote.send_event({type:"sound",notify:this.notify,snd:this.snd})};this.context=t,this.glkote=e,this.gain=t.createGain(),this.gain.connect(t.destination)}delete(){this.stop(),this.vol_timer&&clearTimeout(this.vol_timer),this.gain.disconnect()}async do_ops(e){let t=this.context;for(let n of e)switch(n.op){case"pause":this.paused||(this.paused=!0,this.paused_time=t.currentTime-this.start_time,this.stop());break;case"play":{this.stop(),this.notify=n.notify??0,this.paused_time=0,this.repeats=n.repeats??1,this.snd=n.snd;let i=this.glkote.Blorb.get_chunk("sound",n.snd);if(!i)continue;try{this.buffer=await t.decodeAudioData(i.content.slice().buffer)}catch{X||await gi({module_or_path:rt(this.glkote.options,"glkaudio_bg.wasm")});let o=mi(i.content);this.buffer=await t.decodeAudioData(o.buffer)}this.paused||this.play();break}case"stop":this.stop(),this.buffer=null;break;case"unpause":this.paused&&(this.buffer?this.play():this.paused=!1);break;case"volume":{let i=t.currentTime,o=this.gain.gain,a=o.value;o.cancelScheduledValues(i),o.value=a,this.vol_timer&&clearTimeout(this.vol_timer);let s=()=>{this.glkote.send_event({type:"volume",notify:n.notify})};n.dur?(o.setValueAtTime(a||1e-4,i),o.exponentialRampToValueAtTime(n.vol||1e-4,i+n.dur/1e3),n.notify&&(this.vol_timer=setTimeout(s,n.dur))):(o.value=n.vol,n.notify&&s(),this.vol_timer=0);break}}}play(){let e=this.context.createBufferSource();this.source=e,e.addEventListener("ended",this.on_stop),e.buffer=this.buffer,e.connect(this.gain),this.start_time=this.context.currentTime-this.paused_time,e.start(0,this.paused_time),this.paused?(this.paused=!1,this.paused_time=0):this.repeats>0&&this.repeats--}stop(){let e=this.source;e&&(e.removeEventListener("ended",this.on_stop),e.stop(),e.disconnect(),this.source=null)}};function ha(r){if(Array.isArray(r)){for(var e=0,t=Array(r.length);e<r.length;e++)t[e]=r[e];return t}else return Array.from(r)}var Wr=!1;typeof window<"u"&&(Tr={get passive(){Wr=!0}},window.addEventListener("testPassive",null,Tr),window.removeEventListener("testPassive",null,Tr));var Tr,Mt=typeof window<"u"&&window.navigator&&window.navigator.platform&&(/iP(ad|hone|od)/.test(window.navigator.platform)||window.navigator.platform==="MacIntel"&&window.navigator.maxTouchPoints>1),Oe=[],Lt=!1,yi=-1,lt=void 0,Qe=void 0,ft=void 0,wi=function(e){return Oe.some(function(t){return!!(t.options.allowTouchMove&&t.options.allowTouchMove(e))})},Vt=function(e){var t=e||window.event;return wi(t.target)||t.touches.length>1?!0:(t.preventDefault&&t.preventDefault(),!1)},ma=function(e){if(ft===void 0){var t=!!e&&e.reserveScrollBarGap===!0,n=window.innerWidth-document.documentElement.clientWidth;if(t&&n>0){var i=parseInt(window.getComputedStyle(document.body).getPropertyValue("padding-right"),10);ft=document.body.style.paddingRight,document.body.style.paddingRight=i+n+"px"}}lt===void 0&&(lt=document.body.style.overflow,document.body.style.overflow="hidden")},_a=function(){ft!==void 0&&(document.body.style.paddingRight=ft,ft=void 0),lt!==void 0&&(document.body.style.overflow=lt,lt=void 0)},ga=function(){return window.requestAnimationFrame(function(){if(Qe===void 0){Qe={position:document.body.style.position,top:document.body.style.top,left:document.body.style.left};var e=window,t=e.scrollY,n=e.scrollX,i=e.innerHeight;document.body.style.position="fixed",document.body.style.top=-t,document.body.style.left=-n,setTimeout(function(){return window.requestAnimationFrame(function(){var o=i-window.innerHeight;o&&t>=i&&(document.body.style.top=-(t+o))})},300)}})},ya=function(){if(Qe!==void 0){var e=-parseInt(document.body.style.top,10),t=-parseInt(document.body.style.left,10);document.body.style.position=Qe.position,document.body.style.top=Qe.top,document.body.style.left=Qe.left,window.scrollTo(t,e),Qe=void 0}},wa=function(e){return e?e.scrollHeight-e.scrollTop<=e.clientHeight:!1},ba=function(e,t){var n=e.targetTouches[0].clientY-yi;return wi(e.target)?!1:t&&t.scrollTop===0&&n>0||wa(t)&&n<0?Vt(e):(e.stopPropagation(),!0)},bi=function(e,t){if(!e){console.error("disableBodyScroll unsuccessful - targetElement must be provided when calling disableBodyScroll on IOS devices.");return}if(!Oe.some(function(i){return i.targetElement===e})){var n={targetElement:e,options:t||{}};Oe=[].concat(ha(Oe),[n]),Mt?ga():ma(t),Mt&&(e.ontouchstart=function(i){i.targetTouches.length===1&&(yi=i.targetTouches[0].clientY)},e.ontouchmove=function(i){i.targetTouches.length===1&&ba(i,e)},Lt||(document.addEventListener("touchmove",Vt,Wr?{passive:!1}:void 0),Lt=!0))}};var xi=function(e){if(!e){console.error("enableBodyScroll unsuccessful - targetElement must be provided when calling enableBodyScroll on IOS devices.");return}Oe=Oe.filter(function(t){return t.targetElement!==e}),Mt&&(e.ontouchstart=null,e.ontouchmove=null,Lt&&Oe.length===0&&(document.removeEventListener("touchmove",Vt,Wr?{passive:!1}:void 0),Lt=!1)),Mt?ya():_a()};var vi=25,$t=class{constructor(e){this.history_index=0;this.is_line=!1;this.refocused=!1;this.set_gameport_height=Ue(e=>{this.window.manager.glkote.metrics_calculator.set_gameport_height(e?window.innerHeight:0)},50);this.window=e,this.el=$("<textarea>",{"aria-hidden":"true",autocapitalize:"off",class:"Input",data:{window:e},on:{blur:()=>this.onblur(),focus:()=>this.onfocus(),input:t=>this.oninput(t),keydown:t=>this.onkeydown(t),keypress:t=>this.onkeypress(t)},rows:1}).prop("disabled",!0).appendTo(e.frameel)}destroy(){this.el.remove()}onblur(){ue&&!Qt()&&this.set_gameport_height(!0)}onfocus(){this.window.type==="buffer"&&!ve()&&this.window.scroll_to_bottom(),ue&&this.set_gameport_height(!1)}oninput(e){if(!this.window.inputs?.type)return this.el.trigger("blur"),!1;if(this.window.inputs.type==="char"){let t=e.target.value[0];return this.submit_char(t),t===" "&&this.el.trigger("blur").trigger("focus"),!1}}onkeydown(e){if(!this.window.inputs?.type)return this.el.trigger("blur"),!1;let t=e.which;if(t){if(this.is_line){if(t===Kt||t===er){let n=this.window.manager.history,i;return t===Kt&&this.history_index>0?(this.history_index--,i=1):t===er&&this.history_index<n.length&&(this.history_index++,i=1),i&&this.el.val(this.history_index===0?"":n[this.history_index-1]),!1}else if(this.window.inputs.terminators){let n=Zt[t];if(this.window.inputs.terminators.includes(n))return this.submit_line(e.target.value,n),!1}}else{let n=Zt[t];if(n)return this.submit_char(n),!1}e.stopPropagation()}}onkeypress(e){if(!this.window.inputs?.type)return this.el.trigger("blur"),!1;let t=e.which;if(t)if(this.is_line){if(t===Xt)return this.submit_line(e.target.value),!1}else{let n=t===Xt?"return":String.fromCharCode(t);return this.submit_char(n),!1}}refocus(){if(!(this.refocused||document.activeElement===this.el[0])){if(this.refocused=!0,this.window.type==="buffer"&&this.window.innerel.outerHeight()-this.window.updatescrolltop>this.window.height_above_keyboard){ue&&this.set_gameport_height(!0);return}this.el[0].focus({preventScroll:!0})}}reset(){this.history_index=0,this.refocused=!1,this.el.attr({"aria-hidden":"true",class:"Input"}).css({"background-color":"",color:"",left:yn,top:"",width:""}).val("");let e=this.window.type==="buffer"?this.window.innerel:this.window.frameel;this.el.parent().is(e)||this.el.appendTo(e)}submit_char(e){this.window.send_text_event({type:"char",value:e})}submit_line(e,t){let n=this.window.manager.history;e&&e!==n[0]&&(n.unshift(e),n.length>vi&&(n.length=vi)),this.window.send_text_event({type:"line",terminator:t,value:e})}update(){this.reset();let e=this.window.inputs;if(!(e.type!=="char"&&e.type!=="line")){if(this.is_line=e.type==="line",this.el.attr({"aria-hidden":"false",maxlength:this.is_line?e.maxlen:1}).prop("disabled",!1).val(e.initial||""),this.is_line){if(this.window.type==="graphics")throw new Error(`Cannot request line input in graphics window ${this.window.id}`);this.el.addClass("LineInput")}switch(this.window.type){case"buffer":(this.window.lastline||this.window.innerel).append(this.el);break;case"grid":{let t=this.window.metrics;this.el.css({left:e.xpos*t.gridcharwidth+t.gridmarginx/2,top:e.ypos*t.gridcharheight+t.gridmarginy/2,width:(e.maxlen||1)*t.gridcharwidth});break}}if(this.window.type!=="graphics"){let t=this.window.last_run_styles;if(t){let n=!!t.reverse;this.el.toggleClass("reverse",n),Ir(t,n,this.el)}}}}};function jt(){return window.getSelection()+""==""}var zt=class{constructor(e){this.desired=!0;this.blorb=e.blorb,this.dom=e.dom,this.id=e.id,this.manager=e.manager,this.metrics=e.metrics,this.type=e.type,this.frameel=this.dom.create("div",`window${e.id}`,{class:`WindowFrame ${Sa[this.type]} WindowRock_${e.rock}`,click:t=>this.onclick(t)}).appendTo(this.dom.windowport()),this.textinput=new $t(this)}destroy(e){this.textinput.destroy(),e?this.frameel.remove():this.inputs=void 0}measure_height(){}onclick(e){if(this.inputs?.type&&jt())return this.textinput.el.trigger("focus"),!1}send_text_event(e){this.measure_height(),this.textinput.reset(),this.inputs.type=void 0,this.manager.active_window=this,e.window=this.id,this.manager.send_event(e)}};function Ir(r,e,t){let n=Object.assign({},r);if(e){let i=n["background-color"],o=n.color;i?n.color=i:delete n.color,o?n["background-color"]=o:delete n["background-color"],delete n.reverse}t.css(n)}function xa(r){let e=[""],t=/\s/,n=!1;for(let i of r){let o=t.test(i);!o&&n&&e.unshift(""),e[0]+=i,n=o}return e.reverse(),e}var Nt=class extends zt{constructor(e){super(e);let t=n=>this.onlink(n);this.frameel.on("click","a",function(){t(this)}),e.styles&&(this.styles=e.styles,this.add_stylehints())}add_stylehints(){let e=`#window${this.id}`,t={};if(this.styles){for(let[a,s]of Object.entries(this.styles)){let l=`${e} ${a}`.trim(),u=t[l]=Object.assign({},s);if(a){let c=u["background-color"],f=u.color;if(c||f){let d=t[`${l}.reverse`]={};c&&(d.color=c),f&&(d["background-color"]=f)}delete u.monospace,u.reverse&&(delete u["background-color"],delete u.color),delete u.reverse,Object.keys(u).length===0&&delete t[l]}}t[`${e} .Style_input`]&&(t[`${e} .LineInput`]=t[`${e} .Style_input`])}let n=t[`${e} .Style_normal`],i=this.bg||n?.["background-color"],o=this.fg||n?.color;(i||o)&&(t[e]||(t[e]={}),t[e]["background-color"]=i||`var(--glkote-${this.type}-bg)`,t[`${e}.reverse`]={"background-color":o||`var(--glkote-${this.type}-reverse-bg)`}),Object.keys(t).length&&(this.frameel.children("style").remove(),this.frameel.prepend(`<style>${Object.entries(t).map(a=>{let[s,l]=a;return`${s} {${Object.entries(l).map(u=>{let[c,f]=u;return`${c}: ${f}`}).join("; ")}}`}).join(`
`)}</style>`))}create_text_run(e,t){let n=e.style,i=e.css_styles?.monospace??this.styles?.[`.Style_${n}`]?.monospace,o="";typeof i<"u"&&(n==="preformatted"?i||(o=" proportional"):i&&(o=" monospace"));let a=e.css_styles?.reverse??this.styles?.[`.Style_${n}`]?.reverse,s=se("span",`Style_${n}${a?" reverse":""}${o}`);e.css_styles&&Ir(e.css_styles,!!a,s),typeof t>"u"&&(t=!!i||n==="preformatted");let l=t?$(xa(e.text).map(u=>s.clone().text(u)[0])):s.text(e.text);return e.hyperlink?$("<a>",{data:{glklink:e.hyperlink},href:"#"}).append(l):l}onlink(e){let t=$(e).data("glklink");if(t)return this.inputs?.hyperlink&&this.manager.send_event({type:"hyperlink",value:t,window:this.id}),!1}refresh_styles(e,t){let n;typeof e<"u"&&e!==this.bg&&(this.bg=e,n=1),typeof t<"u"&&t!==this.fg&&(this.fg=t,n=1),n&&this.add_stylehints()}},va={inlinecenter:"ImageInlineCenter",inlinedown:"ImageInlineDown",inlineup:"ImageInlineUp",marginleft:"ImageMarginLeft",marginright:"ImageMarginRight"},Qr=class extends Nt{constructor(t){super(t);this.type="buffer";this.is_scrolled_down=!0;this.updatescrolltop=0;this.onscroll=()=>{let t=this.frameel[0];this.is_scrolled_down=t.scrollHeight-t.scrollTop-t.clientHeight<1};this.frameel.attr({"aria-live":"polite",role:"log",tabindex:-1}).on("scroll",this.onscroll),ue&&bi(this.frameel[0]),this.innerel=se("div","BufferWindowInner").append(this.textinput.el).appendTo(this.frameel),this.height_above_keyboard=this.frameel.height()}destroy(t){ue&&xi(this.frameel[0]),super.destroy(t)}measure_height(){this.height_above_keyboard=this.frameel.height()}onclick(t){if(this.inputs?.type&&jt()){if(this.lastline&&this.height_above_keyboard){let n=this.lastline[0].getBoundingClientRect();if(n.bottom<0||n.top>document.documentElement.clientHeight)return!1}return this.textinput.el.trigger("focus"),!1}}scroll_to_bottom(t){(!t||this.is_scrolled_down)&&(this.frameel.scrollTop(this.innerel.height()),this.is_scrolled_down=!0)}update(t){if(t.clear&&(this.textinput.reset(),this.innerel.children(".BufferLine").remove(),this.is_scrolled_down=!0,this.lastline=void 0,this.last_run_styles=void 0,this.refresh_styles(t.bg,t.fg)),!t.text)return;this.frameel.attr("aria-busy","true"),this.updatescrolltop=Math.max(0,(this.lastline?.position().top||0)-20);let n=0;for(;n<t.text.length;){let i=t.text[n++],o=i.content,a,s;if(i.append&&this.lastline)a=this.lastline,s=1;else if(a=se("div","BufferLine"),this.innerel.append(a),this.lastline=a,!o?.length){a.addClass("BlankPara"),a.append(se("span","BlankLineSpace").text(yt));continue}if(i.flowbreak&&a.addClass("FlowBreak"),!!o?.length)for(let l=0;l<o.length;l++){let u,c=o[l];if(typeof c=="string")u={style:o[l++],text:o[l]};else if("special"in c&&c.special==="image"){let f=$("<img>",{alt:c.alttext||`Image ${c.image}`,class:va[c.alignment||"inlineup"],height:c.height,src:this.blorb&&this.blorb.get_image_url(c.image)||c.url,width:c.width});if(c.hyperlink){$("<a>",{data:{glklink:c.hyperlink},href:"#"}).append(f).appendTo(a);continue}a.append(f);continue}else u=c;s||(s=1,a.addClass(`Style_${u.style}_par`)),a.append(this.create_text_run(u,n===t.text.length?!0:void 0)),this.last_run_styles=u.css_styles}}ve()||this.frameel.scrollTop(this.updatescrolltop),this.frameel.attr("aria-busy","false")}},Or=class extends zt{constructor(t){super(t);this.type="graphics";this.fillcolour="";this.framequeue=[];this.height=0;this.image_cache=new Map;this.width=0;this.clear_cache=Ue(()=>{this.image_cache.clear()},5e3);this.canvas=this.dom.create("canvas",`win${t.id}_canvas`,{data:{window:this}}),this.frameel.append(this.canvas),this.manager.canvasResizeObserver?.observe(this.canvas[0]),this.buffer=this.dom.create("canvas",`win${t.id}_buffer`)}decode_image(t,n){let i=new Image;return i.src=n,i.decode().then(()=>{this.image_cache.set(t,i)}).catch(()=>{})}destroy(t){this.manager.canvasResizeObserver?.unobserve(this.canvas[0]),super.destroy(t)}onclick(t){return this.inputs?.mouse&&t.button===0?(this.inputs.mouse=!1,this.manager.send_event({type:"mouse",window:this.id,x:Math.floor(t.offsetX-this.metrics.graphicsmarginx/2),y:Math.floor(t.offsetY-this.metrics.graphicsmarginy/2)}),!1):super.onclick(t)}set_dimensions(t,n){this.canvas.css({height:t,width:n}),this.height=t,this.width=n;let i=devicePixelRatio;t=t*i,n=n*i,this.buffer.attr({height:t,width:n}),this.canvas.attr({height:t,width:n})}async update(){let t=this.buffer[0].getContext("2d");for(let n=0;n<this.framequeue.length;n++){let i=this.framequeue[n];if(!this.height||!this.width)break;if(!i.length)continue;let o=[];for(let s of i)if(s.special==="image"){let l=s.url||s.image;if(this.image_cache.has(l))continue;let u=s.url||this.blorb&&this.blorb.get_image_url(s.image);u&&o.push(this.decode_image(l,u))}await Promise.all(o);let a=devicePixelRatio;for(let s of i)switch(s.special){case"fill":t.fillStyle=s.color||this.fillcolour,Number.isFinite(s.x)?t.fillRect(s.x*a,s.y*a,s.width*a,s.height*a):t.fillRect(0,0,parseInt(this.buffer.attr("width")),parseInt(this.buffer.attr("height")));break;case"image":{let l=this.image_cache.get(s.url||s.image);l&&t.drawImage(l,s.x*a,s.y*a,s.width*a,s.height*a);break}case"setcolor":this.fillcolour=s.color;break}}this.height&&this.width&&this.canvas[0].getContext("2d").drawImage(this.buffer[0],0,0),this.framequeue.length=0,this.clear_cache()}},Mr=class extends Nt{constructor(t){super(t);this.type="grid";this.height=0;this.lines=[];this.width=0;this.frameel.attr({"aria-atomic":"true","aria-live":"off",role:"status"})}onclick(t){return this.inputs?.mouse&&t.button===0&&jt()?(this.inputs.mouse=!1,this.manager.send_event({type:"mouse",window:this.id,x:Math.floor((t.offsetX-this.metrics.gridmarginx/2)/this.metrics.gridcharwidth),y:Math.floor((t.offsetY-this.metrics.gridmarginy/2)/this.metrics.gridcharheight)}),!1):super.onclick(t)}update(t){t.clear&&(this.last_run_styles=void 0,this.refresh_styles(t.bg,t.fg)),this.frameel.attr("aria-busy","true");for(let n of t.lines){let i=this.lines[n.line];if(!i.length)throw new Error(`Got content for nonexistent line ${n.line} of window ${this.id}`);let o=n.content;if(!o||!o.length)i.text(yt);else{i.empty();for(let a=0;a<o.length;a++){let s;typeof o[a]=="string"?s={style:o[a++],text:o[a]}:s=o[a],i.append(this.create_text_run(s,!1)),this.last_run_styles=s.css_styles}}}this.frameel.toggleClass("reverse",$(`#window${this.id} span:not(.reverse)`).length===0).attr({"aria-busy":"false","aria-live":this.lines.length>3?"polite":"off"})}},ka={buffer:Qr,graphics:Or,grid:Mr},Sa={buffer:"BufferWindow",graphics:"GraphicsWindow",grid:"GridWindow"},ut=class extends Map{constructor(t){super();this.history=[];this.onkeydown=t=>{if(!this.glkote.disabled&&t.target.nodeName!=="input"&&!(t.target.nodeName==="div"&&$(t.target).is(".BufferWindow:focus"))){let n=[...this.values()],i=n.filter(o=>o.inputs?.type)[0]||n.filter(o=>o.type==="buffer")[0];i&&(i.frameel.trigger("click"),i.textinput.el.is(":focus")?i.textinput.el.trigger(t):i.type==="buffer"&&i.frameel.trigger("focus"))}};if(this.dom=t.dom,this.glkote=t,this.metrics=t.current_metrics,window.ResizeObserver){let n=new ResizeObserver(i=>{typeof i?.[0].devicePixelContentBoxSize?.[0].blockSize<"u"&&(this.canvasResizeObserver=new ResizeObserver(o=>this.oncanvasresize(o))),n.disconnect()});n.observe(document.body)}this.send_event=n=>t.send_event(n),$(document).on("keydown",this.onkeydown),this.dom.gameport().on("click",()=>this.onclick())}destroy(){for(let t of this.values())t.destroy(!1),this.delete(t.id);$(document).off("keydown",this.onkeydown)}cancel_inputs(t){let n={};for(let i of t)n[i.id]=i;for(let i of this.values())!n[i.id]&&i.inputs&&(i.textinput.el.is(":focus")&&(this.active_window=i),i.textinput.el.prop("disabled",!0),delete i.inputs)}oncanvasresize(t){for(let n of t){let i=n.devicePixelContentBoxSize[0],o=i.blockSize,a=i.inlineSize,s=$(n.target).data("window");s.buffer.attr({height:o,width:a}),s.canvas.attr({height:o,width:a})}this.send_event({type:"redraw"})}onclick(){if(!this.glkote.disabled&&jt()){for(let t of this.values())if(t.inputs?.type){t.frameel.trigger("click");break}}}update(t){for(let i of this.values())i.desired=!1;for(let i of t){let o=i.id,a=i.type,s=this.get(o);if(!s)s=new ka[a]({blorb:this.blorb,dom:this.dom,id:o,manager:this,metrics:this.metrics,rock:i.rock,styles:i.styles,type:a}),this.set(o,s);else if(s.type!==a)throw new Error(`Window ${o} was created with type ${s.type}, but now is described as type ${a}`);if(s.desired=!0,s.type==="graphics"&&(s.height!==i.graphheight||s.width!==i.graphwidth)&&s.set_dimensions(i.graphheight,i.graphwidth),s.type==="grid"){if(i.gridheight>s.height)for(let l=s.height;l<i.gridheight;l++){let u=this.dom.create("div",`win${s.id}_ln${l}`,"GridLine");u.append(yt),s.frameel.append(u),s.lines[l]=u}if(i.gridheight<s.height)for(let l=i.gridheight;l<s.height;l++)this.dom.id(`win${s.id}_ln${l}`).remove();s.height=i.gridheight,s.lines.length=s.height,s.width=i.gridwidth}s.frameel.css({height:i.height,left:i.left,top:i.top,width:i.width}).toggleClass("hidden",!!i.hidden),s.type==="buffer"&&s.scroll_to_bottom(!0)}let n=[];for(let i of this.values())i.desired||n.push(i);for(let i of n)i.destroy(!0),this.delete(i.id)}update_content(t){for(let n of t){let i=this.get(n.id);if(!i)throw new Error(`Got content update for window ${n.id}, which does not exist`);switch(i.type){case"buffer":i.update(n);break;case"graphics":i.framequeue.push(n.draw),i.framequeue.length===1&&i.update();break;case"grid":i.update(n);break}}}update_inputs(t){for(let n of t){let i=this.get(n.id);if(!i)throw new Error(`Got input update for window ${n.id}, which does not exist`);let o=i.inputs?.gen;i.inputs=n,n.type&&n.gen!==o&&i.textinput.update()}this.active_window&&(this.has(this.active_window.id)&&this.active_window.inputs?.type?this.active_window.textinput.refocus():[...this.values()].filter(n=>n.inputs?.type)[0]?.textinput.refocus())}};var ct=class{constructor(e,t){this.enabled=!1;this.handler=e=>this.web_handler(e);this.label="";this.session=Date.now()+Math.ceil(Math.random()*1e4).toString(16);this.url="";this.windows=t,e.recording_handler&&(this.enabled=!0,this.handler=e.recording_handler,this.url="(custom handler)"),e.recording_url&&(this.enabled=!0,this.url=e.recording_url),this.label=e.recording_label??"",this.enabled&&console.log(`Transcript recording active: session ${this.session} "${this.label}", destination ${this.url}`)}record_event(e){this.event=e,this.timestamp=Date.now()}record_update(e){if(!e.content)return;let t=this.event,n=t.type,i="";if(n==="char"||n==="line")i=t.value;else if(!(!n||n==="external"||n==="init"||n==="specialresponse"))return;let o="";for(let a of e.content){let s=this.windows.get(a.id);if(!s||s.type!=="buffer")continue;let l=a.text||[];for(let u of l){u.append||(o+=`
`);let c=u.content;if(c?.length)for(let f=0;f<c.length;f++){let d=c[f];typeof d=="string"?o+=c[++f]:"text"in d&&(o+=d.text)}}}this.handler({format:"simple",input:i,label:this.label,output:o,outtimestamp:Date.now(),sessionId:this.session,timestamp:this.timestamp})}async web_handler(e){try{let t=await fetch(this.url,{body:JSON.stringify(e),headers:{"Content-Type":"application/json"},method:"POST"});if(!t.ok)throw new Error(`Could not submit transcript update, got ${t.status}`)}catch(t){this.enabled=!1,console.log(`Transcript recording failed; disabling. Error: ${t}`)}}};var qe=class extends Xe{constructor(){super();this.dom=new It({context_element:void 0,errorcontent_id:"errorcontent",errorpane_id:"errorpane",gameport_id:"gameport",loadingpane_id:"loadingpane",prefix:"",windowport_id:"windowport"});this.showing_error=!1;this.showing_loading=!0;this.metrics_calculator=new st(this),this.windows=new ut(this)}async init(t){try{if(!t)throw new Error("no options provided");if(typeof jQuery>"u")throw new Error("jQuery is not loaded");t.dom_prefix&&(this.dom.prefix=t.dom_prefix),t.errorcontent&&(this.dom.errorcontent_id=t.errorcontent),t.errorpane&&(this.dom.errorpane_id=t.errorpane),t.gameport&&(this.dom.gameport_id=t.gameport),t.loadingpane&&(this.dom.loadingpane_id=t.loadingpane),t.windowport&&(this.dom.windowport_id=t.windowport),t.Blorb&&(this.windows.blorb=t.Blorb);let n=this.dom.windowport();if(!n.length)throw new Error(`Cannot find windowport element #${this.dom.windowport_id}`);n.empty();let i="initial-scale=1,interactive-widget=resizes-content,minimum-scale=1,width=device-width";if(ue&&(i+=",maximum-scale=1"),document.head.querySelector('meta[name="viewport"]').content=i,await this.metrics_calculator.measure(),t.recording_url||t.recording_handler)if(t.recording_format&&t.recording_format!=="simple")console.warn('GlkOte: only the "simple" recording_format is supported');else{let o=new URLSearchParams(document.location.search).get("feedback"),a=t.recording_cookie||"transcript_recording_opt_out";o&&o!=="1"||document.cookie.includes(`${a}=1`)?console.log("User has opted out of transcript recording."):this.transcript_recorder=new ct(t,this.windows)}return typeof AudioContext<"u"&&(this.schannels=new Ot(this)),super.init(t)}catch(n){this.error(n)}}autorestore(t){Array.isArray(t.history)&&(this.windows.history=t.history);for(let n of this.windows.values())n.type==="buffer"&&n.scroll_to_bottom();if(t.graphics_bg)for(let[n,i]of t.graphics_bg)this.windows.get(n).fillcolour=i;t.transcript_recorder_session&&this.transcript_recorder&&(this.transcript_recorder.session=t.transcript_recorder_session,console.log(`Resuming autosaved transcript recording session: ${t.transcript_recorder_session}`)),setTimeout(()=>this.send_event({type:"arrange"}),0)}cancel_inputs(t){this.windows.cancel_inputs(t)}capabilities(){let t=["garglktext","graphics","graphicswin","hyperlinks","timer"];return typeof AudioContext<"u"&&t.push("sounds"),t}disable(t){for(let n of this.windows.values())n.textinput.el.prop("disabled",t||!n.inputs?.type);this.disabled=t}embellish_error(){if(typeof $>"u")return;let t=$(`#${this.dom.errorpane_id}`);if(t.find("#errorclose").length||$("<button>",{"aria-label":"Close",click:()=>(t.hide(),!1),id:"errorclose",text:"\u2716",type:"button"}).appendTo(t),this.autorestoring&&!this.Dialog?.async&&this.Dialog?.autosave_clear){let n=$("<a>",{click:async()=>{this.Dialog.async||await this.Dialog.autosave_clear(),location.reload()},text:"Clear autosave and restart"});$("<div>").append(n).appendTo(t)}}error(t){t??="???";let n;typeof t=="string"?(n=t,t=new Error(t)):n=t.toString();let i=document.getElementById(this.dom.errorcontent_id);if(!i)throw new Error(n);i.innerHTML=n;let o=document.getElementById(this.dom.errorpane_id);o.className==="WarningPane"&&(o.className=""),this.embellish_error(),o.style.display="",this.showing_error=!0,this.hide_loading(),console.error(t)}exit(){this.metrics_calculator.destroy(),this.windows.destroy()}getdomcontext(){return this.dom.context_element}getdomid(t){switch(t){case"errorcontent":return this.dom.errorcontent_id;case"errorpane":return this.dom.errorpane_id;case"gameport":return this.dom.gameport_id;case"loadingpane":return this.dom.loadingpane_id;case"windowport":return this.dom.windowport_id;default:return t}}hide_loading(){if(!this.showing_loading)return;this.showing_loading=!1;let t=document.getElementById(this.dom.loadingpane_id);t&&(t.style.display="none")}save_allstate(){let t=[];for(let n of this.windows.values())n.type==="graphics"&&t.push([n.id,n.fillcolour]);return{graphics_bg:t,history:this.windows.history,transcript_recorder_session:this.transcript_recorder?.session}}send_event(t){if(t.type!=="init"&&t.type!=="refresh"&&t.type!=="specialresponse"){for(let n of this.windows.values())if(n.inputs?.type){let i=n.textinput.el.val();i&&(t.partial||(t.partial={}),t.partial[n.id]=i)}}this.transcript_recorder?.enabled&&this.transcript_recorder.record_event(t),super.send_event(t)}setdomcontext(t){this.dom.context_element=t}set_page_bg(t){$("body").css("background-color",t)}update(t){this.showing_loading&&this.hide_loading(),super.update(t),this.transcript_recorder?.enabled&&t.type==="update"&&!t.autorestore&&this.transcript_recorder.record_update(t)}update_content(t){this.windows.update_content(t)}update_inputs(t){this.windows.update_inputs(t)}update_schannels(t){this.schannels?.update(t)}update_windows(t){this.windows.update(t)}warning(t){if(this.showing_error)return;let n=$(`#${this.dom.errorpane_id}`);if(!t){n.hide();return}let i=document.getElementById(this.dom.errorcontent_id);if(!i){console.warn(t);return}i.innerHTML=t,this.embellish_error(),n.addClass("WarningPane"),n.show(),this.hide_loading()}};var Lr={"bocfel.wasm":{size:2249570,gz:605215},"git.wasm":{size:1246266,gz:373380},"glulxe.wasm":{size:1254082,gz:374178},"hugo.wasm":{size:960701,gz:300721},"scare.wasm":{size:1630293,gz:486983},"tads.wasm":{size:3821166,gz:1107347},"glkaudio_bg.wasm":{size:556140,gz:295809}};async function Ye(r,e,t){let[n,i]=t,o=Object.assign({},e,{arguments:[r.path]});(await n.default({wasmBinary:i})).start(o)}var Ea=[{id:"blorb",extensions:/\.(blb|blorb)/i},{id:"adrift4",extensions:/\.taf/i,engines:[{id:"scare",load:["scare.js","scare.wasm"],start:Ye}]},{id:"hugo",extensions:/\.hex/i,engines:[{id:"hugo",load:["hugo.js","hugo.wasm"],start:Ye}]},{id:"glulx",blorbable:!0,extensions:/\.(gblorb|glb|ulx)/i,engines:[{id:"glulxe",load:["glulxe.js","glulxe.wasm"],start:Ye},{id:"git",load:["git.js","git.wasm"],start:Ye}]},{id:"tads",extensions:/\.(gam|t3)/i,engines:[{id:"tads",load:["tads.js","tads.wasm"],start:Ye}]},{id:"zcode",blorbable:!0,extensions:/\.(zblorb|zlb|z3|z4|z5|z8)/i,engines:[{id:"bocfel",load:["bocfel.js","bocfel.wasm"],start:Ye}]}];function Vr(r,e){for(let t of Ea)if(t.id===r||e&&t.extensions.test(e))return t;throw new Error("Unknown storyfile format")}function ki(r){let e={GLUL:"glulx",ZCOD:"zcode"},t=r.get_chunk("exec",0)?.blorbtype;if(t&&e[t])return Vr(e[t]);throw new Error("Unknown storyfile format in Blorb")}function Si(){return{auto_launch:1,autoplay:window.self===window.top,Dialog:new ot,direct_domains:["ifarchive.org","mirror.ifarchive.org","unbox.ifarchive.org","www.ifarchive.org"],do_vm_autosave:1,GlkOte:new qe,lib_path:import.meta.url,proxy_url:"https://iplayif.com/proxy/",set_body_to_page_bg:1,theme_cookie:"parchment_theme",use_proxy:1}}function Fi(r){let e=new URLSearchParams(document.location.search),t={};for(let n of r)if(e.has(n)){let i=e.get(n);try{t[n]=JSON.parse(i)}catch{t[n]=i}}return t}var Aa=["B","kB","MB","GB","TB","PB","EB","ZB","YB"],Ua=["B","KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"],Ba=["b","kbit","Mbit","Gbit","Tbit","Pbit","Ebit","Zbit","Ybit"],Da=["b","kibit","Mibit","Gibit","Tibit","Pibit","Eibit","Zibit","Yibit"],Ei=(r,e,t)=>{let n=r;return typeof e=="string"||Array.isArray(e)?n=r.toLocaleString(e,t):(e===!0||t!==void 0)&&(n=r.toLocaleString(void 0,t)),n};function Pt(r,e){if(!Number.isFinite(r))throw new TypeError(`Expected a finite number, got ${typeof r}: ${r}`);e={bits:!1,binary:!1,space:!0,...e};let t=e.bits?e.binary?Da:Ba:e.binary?Ua:Aa,n=e.space?" ":"";if(e.signed&&r===0)return` 0${n}${t[0]}`;let i=r<0,o=i?"-":e.signed?"+":"";i&&(r=-r);let a;if(e.minimumFractionDigits!==void 0&&(a={minimumFractionDigits:e.minimumFractionDigits}),e.maximumFractionDigits!==void 0&&(a={maximumFractionDigits:e.maximumFractionDigits,...a}),r<1){let c=Ei(r,e.locale,a);return o+c+n+t[0]}let s=Math.min(Math.floor(e.binary?Math.log(r)/Math.log(1024):Math.log10(r)/3),t.length-1);r/=(e.binary?1024:1e3)**s,a||(r=r.toPrecision(3));let l=Ei(Number(r),e.locale,a),u=t[s];return o+l+n+u}function Ra(r){let e,t,n,i;return{c(){e=w("p"),t=w("button"),t.textContent="Play!"},m(o,a){k(o,e,a),y(e,t),n||(i=D(t,"click",r[7]),n=!0)},p:C,d(o){o&&x(e),n=!1,i()}}}function Ca(r){let e;function t(o,a){return o[4]?Ta:Ga}let n=t(r,-1),i=n(r);return{c(){i.c(),e=Et()},m(o,a){i.m(o,a),k(o,e,a)},p(o,a){n===(n=t(o,a))&&i?i.p(o,a):(i.d(1),i=n(o),i&&(i.c(),i.m(e.parentNode,e)))},d(o){o&&x(e),i.d(o)}}}function Ga(r){let e;return{c(){e=w("p"),e.innerHTML='<progress class="svelte-i6dww7"></progress>'},m(t,n){k(t,e,n)},p:C,d(t){t&&x(e)}}}function Ta(r){let e,t,n,i,o=Pt(r[6],{maximumFractionDigits:1,minimumFractionDigits:1})+"",a;return{c(){e=w("p"),t=w("progress"),n=B(),i=w("p"),a=I(o),p(t,"max",r[5]),t.value=r[3],p(t,"class","svelte-i6dww7")},m(s,l){k(s,e,l),y(e,t),k(s,n,l),k(s,i,l),y(i,a)},p(s,l){l&32&&p(t,"max",s[5]),l&8&&(t.value=s[3]),l&64&&o!==(o=Pt(s[6],{maximumFractionDigits:1,minimumFractionDigits:1})+"")&&N(a,o)},d(s){s&&(x(e),x(n),x(i))}}}function Wa(r){let e,t,n,i,o,a,s,l;function u(d,h){return d[0]?Ca:Ra}let c=u(r,-1),f=c(r);return{c(){e=w("div"),t=w("h1"),n=I(r[2]),i=B(),o=w("p"),a=w("img"),l=B(),f.c(),ur(a.src,s=r[1])||p(a,"src",s),p(a,"alt","Cover art"),p(e,"id","loadingpane"),p(e,"class","asyncglk_ui")},m(d,h){k(d,e,h),y(e,t),y(t,n),y(e,i),y(e,o),y(o,a),y(e,l),f.m(e,null)},p(d,[h]){h&4&&N(n,d[2]),h&2&&!ur(a.src,s=d[1])&&p(a,"src",s),c===(c=u(d,h))&&f?f.p(d,h):(f.d(1),f=c(d),f&&(f.c(),f.m(e,null)))},i:C,o:C,d(d){d&&x(e),f.d()}}}function Ia(r,e,t){let{cover_image_url:n}=e,{play:i}=e,{playing:o=!1}=e,{title:a}=e,s=0,l=!1,u=0,c=0;function f(m,_){t(5,u+=m.size),t(6,c+=m.gz),_&&t(4,l=!0)}function d(m){t(3,s+=m)}function h(){t(0,o=!0),i()}return r.$$set=m=>{"cover_image_url"in m&&t(1,n=m.cover_image_url),"play"in m&&t(8,i=m.play),"playing"in m&&t(0,o=m.playing),"title"in m&&t(2,a=m.title)},[o,n,a,s,l,u,c,h,i,f,d]}var $r=class extends Z{constructor(e){super(),oe(this,e,Ia,Wa,ne,{cover_image_url:1,play:8,playing:0,title:2,add_file:9,update_progress:10})}get add_file(){return this.$$.ctx[9]}get update_progress(){return this.$$.ctx[10]}},Ai=$r;var zr=class{loading_pane;options;story;constructor(e){let t=["autoplay","do_vm_autosave","use_asyncglk"];e?.story||t.push("story"),this.options=Object.assign({},Si(),e,Fi(t))}get_storyfile_path(){return this.options.story?typeof this.options.story=="string"?{url:this.options.story}:this.options.story:this.options.default_story?{url:this.options.default_story?.[0]}:null}async launch(){try{await this.options.Dialog.init(this.options);let e=this.options.theme||Jr.get(this.options.theme_cookie)||(matchMedia("(prefers-color-scheme: dark)").matches?"dark":"");e&&document.documentElement.setAttribute("data-theme",e);let t=this.get_storyfile_path();if(!t){$("#custom-file-upload").show().on("keydown",n=>{(n.keyCode===32||n.keyCode===13)&&n.target.click()}),$("#file-upload").on("change",()=>{let n=$("#file-upload")[0]?.files?.[0];n&&this.load_uploaded_file(n)}),$("#play-url").show(),$("#play-url-button").on("click",()=>this.play_url()),$("#play-url-input").on("keydown",n=>{n.keyCode===13&&this.play_url()});return}this.story=t,this.preload()}catch(e){throw this.options.GlkOte.error(e),e}}preload(){try{let e=this.story;if(!e.path&&!e.url)throw new Error("Needs story path or URL");$("#about").remove();let t=$("#loadingpane img").attr("src");$("#loadingpane").remove();let n=document.getElementById("gameport");this.loading_pane=new Ai({target:n,props:{cover_image_url:t,play:this.load,playing:!!this.options.autoplay,title:e.title??/([/=])([^/=]+)$/.exec(e.path||e.url)[2]}}),this.options.autoplay&&this.load()}catch(e){throw this.options.GlkOte.error(e),e}}load=async()=>{try{let e=this.story,t;e.filesize&&(this.loading_pane.add_file(e.filesize,!0),t=this.loading_pane.update_progress);let n=Vr(e.format,e.path||e.url),i=Object.assign({},this.options);if(n.id==="blorb"){e.path||(e.path=await this.options.Dialog.download(e.url,t));let s=await this.options.Dialog.read(e.path);i.Blorb=new $e(s),n=ki(i.Blorb)}let o=n.engines[0],a=await Promise.all([e.path||this.options.Dialog.download(e.url,t),...o.load.map(s=>(e.filesize&&s in Lr&&this.loading_pane.add_file(Lr[s]),rt(this.options,s,t)))]);if(e.path=a.shift(),n.blorbable&&!i.Blorb){let s=await this.options.Dialog.read(e.path),l=new K(s);l.getFourCC(0)==="FORM"&&l.getFourCC(8)==="IFRS"&&(i.Blorb=new $e(s))}await o.start(e,i,a)}catch(e){throw this.options.GlkOte.error(e),e}};async load_uploaded_file(e){try{this.options.autoplay=1,this.story={path:await this.options.Dialog.upload(e),title:e.name},this.preload()}catch(t){throw this.options.GlkOte.error(t),t}}play_url(){let e=$("#play-url-input").val();if(!e)return;try{new URL(e)}catch{$("#play-url-error").text("Please enter a valid URL");return}let t=new URL(window.location+"");t.searchParams.set("story",e),window.location=t+""}};$(()=>{let r=new zr(window.parchment_options);window.parchment=r,r.options.auto_launch&&r.launch()});
/*! Bundled license information:

js-cookie/dist/js.cookie.mjs:
  (*! js-cookie v3.0.5 | MIT *)

lodash-es/lodash.js:
  (**
   * @license
   * Lodash (Custom Build) <https://lodash.com/>
   * Build: `lodash modularize exports="es" -o ./`
   * Copyright OpenJS Foundation and other contributors <https://openjsf.org/>
   * Released under MIT license <https://lodash.com/license>
   * Based on Underscore.js 1.8.3 <http://underscorejs.org/LICENSE>
   * Copyright Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
   *)
*/
//# sourceMappingURL=web.js.map
