var Gc=Object.create;var Rn=Object.defineProperty;var Oc=Object.getOwnPropertyDescriptor;var Lc=Object.getOwnPropertyNames;var Mc=Object.getPrototypeOf,Wc=Object.prototype.hasOwnProperty;var $c=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),Nc=(n,e)=>{for(var r in e)Rn(n,r,{get:e[r],enumerable:!0})},Pc=(n,e,r,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of Lc(e))!Wc.call(n,a)&&a!==r&&Rn(n,a,{get:()=>e[a],enumerable:!(i=Oc(e,a))||i.enumerable});return n};var jc=(n,e,r)=>(r=n!=null?Gc(Mc(n)):{},Pc(e||!n||!n.__esModule?Rn(r,"default",{value:n,enumerable:!0}):r,n));var zl=$c((es,ts)=>{(function(n,e){typeof define=="function"&&define.amd?define([],e):typeof es<"u"?e():(e(),n.FileSaver={})})(es,function(){"use strict";function n(d,y){return typeof y>"u"?y={autoBom:!1}:typeof y!="object"&&(console.warn("Deprecated: Expected third argument to be a object"),y={autoBom:!y}),y.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(d.type)?new Blob(["\uFEFF",d],{type:d.type}):d}function e(d,y,x){var b=new XMLHttpRequest;b.open("GET",d),b.responseType="blob",b.onload=function(){c(b.response,y,x)},b.onerror=function(){console.error("could not download file")},b.send()}function r(d){var y=new XMLHttpRequest;y.open("HEAD",d,!1);try{y.send()}catch{}return 200<=y.status&&299>=y.status}function i(d){try{d.dispatchEvent(new MouseEvent("click"))}catch{var y=document.createEvent("MouseEvents");y.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),d.dispatchEvent(y)}}var a=typeof window=="object"&&window.window===window?window:typeof self=="object"&&self.self===self?self:typeof global=="object"&&global.global===global?global:void 0,u=a.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),c=a.saveAs||(typeof window!="object"||window!==a?function(){}:"download"in HTMLAnchorElement.prototype&&!u?function(d,y,x){var b=a.URL||a.webkitURL,F=document.createElement("a");y=y||d.name||"download",F.download=y,F.rel="noopener",typeof d=="string"?(F.href=d,F.origin===location.origin?i(F):r(F.href)?e(d,y,x):i(F,F.target="_blank")):(F.href=b.createObjectURL(d),setTimeout(function(){b.revokeObjectURL(F.href)},4e4),setTimeout(function(){i(F)},0))}:"msSaveOrOpenBlob"in navigator?function(d,y,x){if(y=y||d.name||"download",typeof d!="string")navigator.msSaveOrOpenBlob(n(d,x),y);else if(r(d))e(d,y,x);else{var b=document.createElement("a");b.href=d,b.target="_blank",setTimeout(function(){i(b)})}}:function(d,y,x,b){if(b=b||open("","_blank"),b&&(b.document.title=b.document.body.innerText="downloading..."),typeof d=="string")return e(d,y,x);var F=d.type==="application/octet-stream",U=/constructor/i.test(a.HTMLElement)||a.safari,C=/CriOS\/[\d]+/.test(navigator.userAgent);if((C||F&&U||u)&&typeof FileReader<"u"){var M=new FileReader;M.onloadend=function(){var I=M.result;I=C?I:I.replace(/^data:[^;]*;/,"data:attachment/file;"),b?b.location.href=I:location=I,b=null},M.readAsDataURL(d)}else{var z=a.URL||a.webkitURL,W=z.createObjectURL(d);b?b.location=W:location.href=W,b=null,setTimeout(function(){z.revokeObjectURL(W)},4e4)}});a.saveAs=c.saveAs=c,typeof ts<"u"&&(ts.exports=c)})});function Pr(n){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var i in r)n[i]=r[i]}return n}var zc={read:function(n){return n[0]==='"'&&(n=n.slice(1,-1)),n.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(n){return encodeURIComponent(n).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}};function Qn(n,e){function r(a,u,c){if(!(typeof document>"u")){c=Pr({},e,c),typeof c.expires=="number"&&(c.expires=new Date(Date.now()+c.expires*864e5)),c.expires&&(c.expires=c.expires.toUTCString()),a=encodeURIComponent(a).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var d="";for(var y in c)c[y]&&(d+="; "+y,c[y]!==!0&&(d+="="+c[y].split(";")[0]));return document.cookie=a+"="+n.write(u,a)+d}}function i(a){if(!(typeof document>"u"||arguments.length&&!a)){for(var u=document.cookie?document.cookie.split("; "):[],c={},d=0;d<u.length;d++){var y=u[d].split("="),x=y.slice(1).join("=");try{var b=decodeURIComponent(y[0]);if(c[b]=n.read(x,b),a===b)break}catch{}}return a?c[a]:c}}return Object.create({set:r,get:i,remove:function(a,u){r(a,"",Pr({},u,{expires:-1}))},withAttributes:function(a){return Qn(this.converter,Pr({},this.attributes,a))},withConverter:function(a){return Qn(Pr({},this.converter,a),this.attributes)}},{attributes:{value:Object.freeze(e)},converter:{value:Object.freeze(n)}})}var Cs=Qn(zc,{path:"/"});var qc=["B","kB","MB","GB","TB","PB","EB","ZB","YB"],Vc=["B","KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"],Hc=["b","kbit","Mbit","Gbit","Tbit","Pbit","Ebit","Zbit","Ybit"],Jc=["b","kibit","Mibit","Gibit","Tibit","Pibit","Eibit","Zibit","Yibit"],Ds=(n,e,r)=>{let i=n;return typeof e=="string"||Array.isArray(e)?i=n.toLocaleString(e,r):(e===!0||r!==void 0)&&(i=n.toLocaleString(void 0,r)),i};function In(n,e){if(!Number.isFinite(n))throw new TypeError(`Expected a finite number, got ${typeof n}: ${n}`);e={bits:!1,binary:!1,space:!0,...e};let r=e.bits?e.binary?Jc:Hc:e.binary?Vc:qc,i=e.space?" ":"";if(e.signed&&n===0)return` 0${i}${r[0]}`;let a=n<0,u=a?"-":e.signed?"+":"";a&&(n=-n);let c;if(e.minimumFractionDigits!==void 0&&(c={minimumFractionDigits:e.minimumFractionDigits}),e.maximumFractionDigits!==void 0&&(c={maximumFractionDigits:e.maximumFractionDigits,...c}),n<1){let b=Ds(n,e.locale,c);return u+b+i+r[0]}let d=Math.min(Math.floor(e.binary?Math.log(n)/Math.log(1024):Math.log10(n)/3),r.length-1);n/=(e.binary?1024:1e3)**d,c||(n=n.toPrecision(3));let y=Ds(Number(n),e.locale,c),x=r[d];return u+y+i+x}var Yc=typeof global=="object"&&global&&global.Object===Object&&global,jr=Yc;var Kc=typeof self=="object"&&self&&self.Object===Object&&self,Zc=jr||Kc||Function("return this")(),Z=Zc;var Xc=Z.Symbol,ue=Xc;var Rs=Object.prototype,ed=Rs.hasOwnProperty,td=Rs.toString,pr=ue?ue.toStringTag:void 0;function rd(n){var e=ed.call(n,pr),r=n[pr];try{n[pr]=void 0;var i=!0}catch{}var a=td.call(n);return i&&(e?n[pr]=r:delete n[pr]),a}var Qs=rd;var id=Object.prototype,nd=id.toString;function od(n){return nd.call(n)}var Is=od;var sd="[object Null]",ad="[object Undefined]",Gs=ue?ue.toStringTag:void 0;function ld(n){return n==null?n===void 0?ad:sd:Gs&&Gs in Object(n)?Qs(n):Is(n)}var be=ld;function fd(n){return n!=null&&typeof n=="object"}var ce=fd;var ud="[object Symbol]";function cd(n){return typeof n=="symbol"||ce(n)&&be(n)==ud}var zr=cd;function dd(n,e){for(var r=-1,i=n==null?0:n.length,a=Array(i);++r<i;)a[r]=e(n[r],r,n);return a}var Os=dd;var pd=Array.isArray,Ve=pd;var _d=1/0,Ls=ue?ue.prototype:void 0,Ms=Ls?Ls.toString:void 0;function Ws(n){if(typeof n=="string")return n;if(Ve(n))return Os(n,Ws)+"";if(zr(n))return Ms?Ms.call(n):"";var e=n+"";return e=="0"&&1/n==-_d?"-0":e}var $s=Ws;var md=/\s/;function hd(n){for(var e=n.length;e--&&md.test(n.charAt(e)););return e}var Ns=hd;var gd=/^\s+/;function yd(n){return n&&n.slice(0,Ns(n)+1).replace(gd,"")}var Ps=yd;function bd(n){var e=typeof n;return n!=null&&(e=="object"||e=="function")}var ne=bd;var js=NaN,xd=/^[-+]0x[0-9a-f]+$/i,wd=/^0b[01]+$/i,kd=/^0o[0-7]+$/i,vd=parseInt;function Fd(n){if(typeof n=="number")return n;if(zr(n))return js;if(ne(n)){var e=typeof n.valueOf=="function"?n.valueOf():n;n=ne(e)?e+"":e}if(typeof n!="string")return n===0?n:+n;n=Ps(n);var r=wd.test(n);return r||kd.test(n)?vd(n.slice(2),r?2:8):xd.test(n)?js:+n}var Gn=Fd;var Sd="[object AsyncFunction]",Ed="[object Function]",Ud="[object GeneratorFunction]",Bd="[object Proxy]";function Ad(n){if(!ne(n))return!1;var e=be(n);return e==Ed||e==Ud||e==Sd||e==Bd}var qr=Ad;var Td=Z["__core-js_shared__"],Vr=Td;var zs=function(){var n=/[^.]+$/.exec(Vr&&Vr.keys&&Vr.keys.IE_PROTO||"");return n?"Symbol(src)_1."+n:""}();function Cd(n){return!!zs&&zs in n}var qs=Cd;var Dd=Function.prototype,Rd=Dd.toString;function Qd(n){if(n!=null){try{return Rd.call(n)}catch{}try{return n+""}catch{}}return""}var Ce=Qd;var Id=/[\\^$.*+?()[\]{}|]/g,Gd=/^\[object .+?Constructor\]$/,Od=Function.prototype,Ld=Object.prototype,Md=Od.toString,Wd=Ld.hasOwnProperty,$d=RegExp("^"+Md.call(Wd).replace(Id,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function Nd(n){if(!ne(n)||qs(n))return!1;var e=qr(n)?$d:Gd;return e.test(Ce(n))}var Vs=Nd;function Pd(n,e){return n?.[e]}var Hs=Pd;function jd(n,e){var r=Hs(n,e);return Vs(r)?r:void 0}var ae=jd;var zd=ae(Z,"WeakMap"),Hr=zd;var Js=Object.create,qd=function(){function n(){}return function(e){if(!ne(e))return{};if(Js)return Js(e);n.prototype=e;var r=new n;return n.prototype=void 0,r}}(),Ys=qd;function Vd(n,e){var r=-1,i=n.length;for(e||(e=Array(i));++r<i;)e[r]=n[r];return e}var Ks=Vd;var Hd=function(){try{var n=ae(Object,"defineProperty");return n({},"",{}),n}catch{}}(),On=Hd;function Jd(n,e){for(var r=-1,i=n==null?0:n.length;++r<i&&e(n[r],r,n)!==!1;);return n}var Zs=Jd;var Yd=9007199254740991,Kd=/^(?:0|[1-9]\d*)$/;function Zd(n,e){var r=typeof n;return e=e??Yd,!!e&&(r=="number"||r!="symbol"&&Kd.test(n))&&n>-1&&n%1==0&&n<e}var Xs=Zd;function Xd(n,e,r){e=="__proto__"&&On?On(n,e,{configurable:!0,enumerable:!0,value:r,writable:!0}):n[e]=r}var Jr=Xd;function ep(n,e){return n===e||n!==n&&e!==e}var Yr=ep;var tp=Object.prototype,rp=tp.hasOwnProperty;function ip(n,e,r){var i=n[e];(!(rp.call(n,e)&&Yr(i,r))||r===void 0&&!(e in n))&&Jr(n,e,r)}var Kr=ip;function np(n,e,r,i){var a=!r;r||(r={});for(var u=-1,c=e.length;++u<c;){var d=e[u],y=i?i(r[d],n[d],d,r,n):void 0;y===void 0&&(y=n[d]),a?Jr(r,d,y):Kr(r,d,y)}return r}var He=np;var op=9007199254740991;function sp(n){return typeof n=="number"&&n>-1&&n%1==0&&n<=op}var Zr=sp;function ap(n){return n!=null&&Zr(n.length)&&!qr(n)}var Xr=ap;var lp=Object.prototype;function fp(n){var e=n&&n.constructor,r=typeof e=="function"&&e.prototype||lp;return n===r}var Ut=fp;function up(n,e){for(var r=-1,i=Array(n);++r<n;)i[r]=e(r);return i}var ea=up;var cp="[object Arguments]";function dp(n){return ce(n)&&be(n)==cp}var Ln=dp;var ta=Object.prototype,pp=ta.hasOwnProperty,_p=ta.propertyIsEnumerable,mp=Ln(function(){return arguments}())?Ln:function(n){return ce(n)&&pp.call(n,"callee")&&!_p.call(n,"callee")},ra=mp;function hp(){return!1}var ia=hp;var sa=typeof exports=="object"&&exports&&!exports.nodeType&&exports,na=sa&&typeof module=="object"&&module&&!module.nodeType&&module,gp=na&&na.exports===sa,oa=gp?Z.Buffer:void 0,yp=oa?oa.isBuffer:void 0,bp=yp||ia,ei=bp;var xp="[object Arguments]",wp="[object Array]",kp="[object Boolean]",vp="[object Date]",Fp="[object Error]",Sp="[object Function]",Ep="[object Map]",Up="[object Number]",Bp="[object Object]",Ap="[object RegExp]",Tp="[object Set]",Cp="[object String]",Dp="[object WeakMap]",Rp="[object ArrayBuffer]",Qp="[object DataView]",Ip="[object Float32Array]",Gp="[object Float64Array]",Op="[object Int8Array]",Lp="[object Int16Array]",Mp="[object Int32Array]",Wp="[object Uint8Array]",$p="[object Uint8ClampedArray]",Np="[object Uint16Array]",Pp="[object Uint32Array]",Y={};Y[Ip]=Y[Gp]=Y[Op]=Y[Lp]=Y[Mp]=Y[Wp]=Y[$p]=Y[Np]=Y[Pp]=!0;Y[xp]=Y[wp]=Y[Rp]=Y[kp]=Y[Qp]=Y[vp]=Y[Fp]=Y[Sp]=Y[Ep]=Y[Up]=Y[Bp]=Y[Ap]=Y[Tp]=Y[Cp]=Y[Dp]=!1;function jp(n){return ce(n)&&Zr(n.length)&&!!Y[be(n)]}var aa=jp;function zp(n){return function(e){return n(e)}}var Bt=zp;var la=typeof exports=="object"&&exports&&!exports.nodeType&&exports,_r=la&&typeof module=="object"&&module&&!module.nodeType&&module,qp=_r&&_r.exports===la,Mn=qp&&jr.process,Vp=function(){try{var n=_r&&_r.require&&_r.require("util").types;return n||Mn&&Mn.binding&&Mn.binding("util")}catch{}}(),De=Vp;var fa=De&&De.isTypedArray,Hp=fa?Bt(fa):aa,ua=Hp;var Jp=Object.prototype,Yp=Jp.hasOwnProperty;function Kp(n,e){var r=Ve(n),i=!r&&ra(n),a=!r&&!i&&ei(n),u=!r&&!i&&!a&&ua(n),c=r||i||a||u,d=c?ea(n.length,String):[],y=d.length;for(var x in n)(e||Yp.call(n,x))&&!(c&&(x=="length"||a&&(x=="offset"||x=="parent")||u&&(x=="buffer"||x=="byteLength"||x=="byteOffset")||Xs(x,y)))&&d.push(x);return d}var ti=Kp;function Zp(n,e){return function(r){return n(e(r))}}var ri=Zp;var Xp=ri(Object.keys,Object),ca=Xp;var e_=Object.prototype,t_=e_.hasOwnProperty;function r_(n){if(!Ut(n))return ca(n);var e=[];for(var r in Object(n))t_.call(n,r)&&r!="constructor"&&e.push(r);return e}var da=r_;function i_(n){return Xr(n)?ti(n):da(n)}var At=i_;function n_(n){var e=[];if(n!=null)for(var r in Object(n))e.push(r);return e}var pa=n_;var o_=Object.prototype,s_=o_.hasOwnProperty;function a_(n){if(!ne(n))return pa(n);var e=Ut(n),r=[];for(var i in n)i=="constructor"&&(e||!s_.call(n,i))||r.push(i);return r}var _a=a_;function l_(n){return Xr(n)?ti(n,!0):_a(n)}var Tt=l_;var f_=ae(Object,"create"),Re=f_;function u_(){this.__data__=Re?Re(null):{},this.size=0}var ma=u_;function c_(n){var e=this.has(n)&&delete this.__data__[n];return this.size-=e?1:0,e}var ha=c_;var d_="__lodash_hash_undefined__",p_=Object.prototype,__=p_.hasOwnProperty;function m_(n){var e=this.__data__;if(Re){var r=e[n];return r===d_?void 0:r}return __.call(e,n)?e[n]:void 0}var ga=m_;var h_=Object.prototype,g_=h_.hasOwnProperty;function y_(n){var e=this.__data__;return Re?e[n]!==void 0:g_.call(e,n)}var ya=y_;var b_="__lodash_hash_undefined__";function x_(n,e){var r=this.__data__;return this.size+=this.has(n)?0:1,r[n]=Re&&e===void 0?b_:e,this}var ba=x_;function Ct(n){var e=-1,r=n==null?0:n.length;for(this.clear();++e<r;){var i=n[e];this.set(i[0],i[1])}}Ct.prototype.clear=ma;Ct.prototype.delete=ha;Ct.prototype.get=ga;Ct.prototype.has=ya;Ct.prototype.set=ba;var Wn=Ct;function w_(){this.__data__=[],this.size=0}var xa=w_;function k_(n,e){for(var r=n.length;r--;)if(Yr(n[r][0],e))return r;return-1}var Je=k_;var v_=Array.prototype,F_=v_.splice;function S_(n){var e=this.__data__,r=Je(e,n);if(r<0)return!1;var i=e.length-1;return r==i?e.pop():F_.call(e,r,1),--this.size,!0}var wa=S_;function E_(n){var e=this.__data__,r=Je(e,n);return r<0?void 0:e[r][1]}var ka=E_;function U_(n){return Je(this.__data__,n)>-1}var va=U_;function B_(n,e){var r=this.__data__,i=Je(r,n);return i<0?(++this.size,r.push([n,e])):r[i][1]=e,this}var Fa=B_;function Dt(n){var e=-1,r=n==null?0:n.length;for(this.clear();++e<r;){var i=n[e];this.set(i[0],i[1])}}Dt.prototype.clear=xa;Dt.prototype.delete=wa;Dt.prototype.get=ka;Dt.prototype.has=va;Dt.prototype.set=Fa;var Ye=Dt;var A_=ae(Z,"Map"),Ke=A_;function T_(){this.size=0,this.__data__={hash:new Wn,map:new(Ke||Ye),string:new Wn}}var Sa=T_;function C_(n){var e=typeof n;return e=="string"||e=="number"||e=="symbol"||e=="boolean"?n!=="__proto__":n===null}var Ea=C_;function D_(n,e){var r=n.__data__;return Ea(e)?r[typeof e=="string"?"string":"hash"]:r.map}var Ze=D_;function R_(n){var e=Ze(this,n).delete(n);return this.size-=e?1:0,e}var Ua=R_;function Q_(n){return Ze(this,n).get(n)}var Ba=Q_;function I_(n){return Ze(this,n).has(n)}var Aa=I_;function G_(n,e){var r=Ze(this,n),i=r.size;return r.set(n,e),this.size+=r.size==i?0:1,this}var Ta=G_;function Rt(n){var e=-1,r=n==null?0:n.length;for(this.clear();++e<r;){var i=n[e];this.set(i[0],i[1])}}Rt.prototype.clear=Sa;Rt.prototype.delete=Ua;Rt.prototype.get=Ba;Rt.prototype.has=Aa;Rt.prototype.set=Ta;var Ca=Rt;function O_(n){return n==null?"":$s(n)}var Da=O_;function L_(n,e){for(var r=-1,i=e.length,a=n.length;++r<i;)n[a+r]=e[r];return n}var ii=L_;var M_=ri(Object.getPrototypeOf,Object),ni=M_;function W_(n){return function(e){return n?.[e]}}var Ra=W_;function $_(){this.__data__=new Ye,this.size=0}var Qa=$_;function N_(n){var e=this.__data__,r=e.delete(n);return this.size=e.size,r}var Ia=N_;function P_(n){return this.__data__.get(n)}var Ga=P_;function j_(n){return this.__data__.has(n)}var Oa=j_;var z_=200;function q_(n,e){var r=this.__data__;if(r instanceof Ye){var i=r.__data__;if(!Ke||i.length<z_-1)return i.push([n,e]),this.size=++r.size,this;r=this.__data__=new Ca(i)}return r.set(n,e),this.size=r.size,this}var La=q_;function Qt(n){var e=this.__data__=new Ye(n);this.size=e.size}Qt.prototype.clear=Qa;Qt.prototype.delete=Ia;Qt.prototype.get=Ga;Qt.prototype.has=Oa;Qt.prototype.set=La;var Ma=Qt;function V_(n,e){return n&&He(e,At(e),n)}var Wa=V_;function H_(n,e){return n&&He(e,Tt(e),n)}var $a=H_;var za=typeof exports=="object"&&exports&&!exports.nodeType&&exports,Na=za&&typeof module=="object"&&module&&!module.nodeType&&module,J_=Na&&Na.exports===za,Pa=J_?Z.Buffer:void 0,ja=Pa?Pa.allocUnsafe:void 0;function Y_(n,e){if(e)return n.slice();var r=n.length,i=ja?ja(r):new n.constructor(r);return n.copy(i),i}var qa=Y_;function K_(n,e){for(var r=-1,i=n==null?0:n.length,a=0,u=[];++r<i;){var c=n[r];e(c,r,n)&&(u[a++]=c)}return u}var Va=K_;function Z_(){return[]}var oi=Z_;var X_=Object.prototype,e1=X_.propertyIsEnumerable,Ha=Object.getOwnPropertySymbols,t1=Ha?function(n){return n==null?[]:(n=Object(n),Va(Ha(n),function(e){return e1.call(n,e)}))}:oi,It=t1;function r1(n,e){return He(n,It(n),e)}var Ja=r1;var i1=Object.getOwnPropertySymbols,n1=i1?function(n){for(var e=[];n;)ii(e,It(n)),n=ni(n);return e}:oi,si=n1;function o1(n,e){return He(n,si(n),e)}var Ya=o1;function s1(n,e,r){var i=e(n);return Ve(n)?i:ii(i,r(n))}var ai=s1;function a1(n){return ai(n,At,It)}var Ka=a1;function l1(n){return ai(n,Tt,si)}var Za=l1;var f1=ae(Z,"DataView"),li=f1;var u1=ae(Z,"Promise"),fi=u1;var c1=ae(Z,"Set"),ui=c1;var Xa="[object Map]",d1="[object Object]",el="[object Promise]",tl="[object Set]",rl="[object WeakMap]",il="[object DataView]",p1=Ce(li),_1=Ce(Ke),m1=Ce(fi),h1=Ce(ui),g1=Ce(Hr),pt=be;(li&&pt(new li(new ArrayBuffer(1)))!=il||Ke&&pt(new Ke)!=Xa||fi&&pt(fi.resolve())!=el||ui&&pt(new ui)!=tl||Hr&&pt(new Hr)!=rl)&&(pt=function(n){var e=be(n),r=e==d1?n.constructor:void 0,i=r?Ce(r):"";if(i)switch(i){case p1:return il;case _1:return Xa;case m1:return el;case h1:return tl;case g1:return rl}return e});var Gt=pt;var y1=Object.prototype,b1=y1.hasOwnProperty;function x1(n){var e=n.length,r=new n.constructor(e);return e&&typeof n[0]=="string"&&b1.call(n,"index")&&(r.index=n.index,r.input=n.input),r}var nl=x1;var w1=Z.Uint8Array,$n=w1;function k1(n){var e=new n.constructor(n.byteLength);return new $n(e).set(new $n(n)),e}var Ot=k1;function v1(n,e){var r=e?Ot(n.buffer):n.buffer;return new n.constructor(r,n.byteOffset,n.byteLength)}var ol=v1;var F1=/\w*$/;function S1(n){var e=new n.constructor(n.source,F1.exec(n));return e.lastIndex=n.lastIndex,e}var sl=S1;var al=ue?ue.prototype:void 0,ll=al?al.valueOf:void 0;function E1(n){return ll?Object(ll.call(n)):{}}var fl=E1;function U1(n,e){var r=e?Ot(n.buffer):n.buffer;return new n.constructor(r,n.byteOffset,n.length)}var ul=U1;var B1="[object Boolean]",A1="[object Date]",T1="[object Map]",C1="[object Number]",D1="[object RegExp]",R1="[object Set]",Q1="[object String]",I1="[object Symbol]",G1="[object ArrayBuffer]",O1="[object DataView]",L1="[object Float32Array]",M1="[object Float64Array]",W1="[object Int8Array]",$1="[object Int16Array]",N1="[object Int32Array]",P1="[object Uint8Array]",j1="[object Uint8ClampedArray]",z1="[object Uint16Array]",q1="[object Uint32Array]";function V1(n,e,r){var i=n.constructor;switch(e){case G1:return Ot(n);case B1:case A1:return new i(+n);case O1:return ol(n,r);case L1:case M1:case W1:case $1:case N1:case P1:case j1:case z1:case q1:return ul(n,r);case T1:return new i;case C1:case Q1:return new i(n);case D1:return sl(n);case R1:return new i;case I1:return fl(n)}}var cl=V1;function H1(n){return typeof n.constructor=="function"&&!Ut(n)?Ys(ni(n)):{}}var dl=H1;var J1="[object Map]";function Y1(n){return ce(n)&&Gt(n)==J1}var pl=Y1;var _l=De&&De.isMap,K1=_l?Bt(_l):pl,ml=K1;var Z1="[object Set]";function X1(n){return ce(n)&&Gt(n)==Z1}var hl=X1;var gl=De&&De.isSet,em=gl?Bt(gl):hl,yl=em;var tm=1,rm=2,im=4,bl="[object Arguments]",nm="[object Array]",om="[object Boolean]",sm="[object Date]",am="[object Error]",xl="[object Function]",lm="[object GeneratorFunction]",fm="[object Map]",um="[object Number]",wl="[object Object]",cm="[object RegExp]",dm="[object Set]",pm="[object String]",_m="[object Symbol]",mm="[object WeakMap]",hm="[object ArrayBuffer]",gm="[object DataView]",ym="[object Float32Array]",bm="[object Float64Array]",xm="[object Int8Array]",wm="[object Int16Array]",km="[object Int32Array]",vm="[object Uint8Array]",Fm="[object Uint8ClampedArray]",Sm="[object Uint16Array]",Em="[object Uint32Array]",H={};H[bl]=H[nm]=H[hm]=H[gm]=H[om]=H[sm]=H[ym]=H[bm]=H[xm]=H[wm]=H[km]=H[fm]=H[um]=H[wl]=H[cm]=H[dm]=H[pm]=H[_m]=H[vm]=H[Fm]=H[Sm]=H[Em]=!0;H[am]=H[xl]=H[mm]=!1;function ci(n,e,r,i,a,u){var c,d=e&tm,y=e&rm,x=e&im;if(r&&(c=a?r(n,i,a,u):r(n)),c!==void 0)return c;if(!ne(n))return n;var b=Ve(n);if(b){if(c=nl(n),!d)return Ks(n,c)}else{var F=Gt(n),U=F==xl||F==lm;if(ei(n))return qa(n,d);if(F==wl||F==bl||U&&!a){if(c=y||U?{}:dl(n),!d)return y?Ya(n,$a(c,n)):Ja(n,Wa(c,n))}else{if(!H[F])return a?n:{};c=cl(n,F,d)}}u||(u=new Ma);var C=u.get(n);if(C)return C;u.set(n,c),yl(n)?n.forEach(function(W){c.add(ci(W,e,r,W,n,u))}):ml(n)&&n.forEach(function(W,I){c.set(I,ci(W,e,r,I,n,u))});var M=x?y?Za:Ka:y?Tt:At,z=b?void 0:M(n);return Zs(z||n,function(W,I){z&&(I=W,W=n[I]),Kr(c,I,ci(W,e,r,I,n,u))}),c}var kl=ci;var Um=1,Bm=4;function Am(n){return kl(n,Um|Bm)}var mr=Am;var Tm=function(){return Z.Date.now()},di=Tm;var Cm="Expected a function",Dm=Math.max,Rm=Math.min;function Qm(n,e,r){var i,a,u,c,d,y,x=0,b=!1,F=!1,U=!0;if(typeof n!="function")throw new TypeError(Cm);e=Gn(e)||0,ne(r)&&(b=!!r.leading,F="maxWait"in r,u=F?Dm(Gn(r.maxWait)||0,e):u,U="trailing"in r?!!r.trailing:U);function C(j){var oe=i,me=a;return i=a=void 0,x=j,c=n.apply(me,oe),c}function M(j){return x=j,d=setTimeout(I,e),b?C(j):c}function z(j){var oe=j-y,me=j-x,We=e-oe;return F?Rm(We,u-me):We}function W(j){var oe=j-y,me=j-x;return y===void 0||oe>=e||oe<0||F&&me>=u}function I(){var j=di();if(W(j))return Oe(j);d=setTimeout(I,z(j))}function Oe(j){return d=void 0,U&&i?C(j):(i=a=void 0,c)}function Le(){d!==void 0&&clearTimeout(d),x=0,i=y=a=d=void 0}function Me(){return d===void 0?c:Oe(di())}function _e(){var j=di(),oe=W(j);if(i=arguments,a=this,y=j,oe){if(d===void 0)return M(y);if(F)return clearTimeout(d),d=setTimeout(I,e),C(y)}return d===void 0&&(d=setTimeout(I,e)),c}return _e.cancel=Le,_e.flush=Me,_e}var Qe=Qm;var Im="Expected a function";function Gm(n,e,r){var i=!0,a=!0;if(typeof n!="function")throw new TypeError(Im);return ne(r)&&(i="leading"in r?!!r.leading:i,a="trailing"in r?!!r.trailing:a),Qe(n,e,{leading:i,maxWait:e,trailing:a})}var pi=Gm;var Om={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"},Lm=Ra(Om),vl=Lm;var Fl=/&(?:amp|lt|gt|quot|#39);/g,Mm=RegExp(Fl.source);function Wm(n){return n=Da(n),n&&Mm.test(n)?n.replace(Fl,vl):n}var Nn=Wm;var le=class extends DataView{constructor(e,r,i){e instanceof Uint8Array?super(e.buffer,e.byteOffset,e.byteLength):super(e,r,i)}getFourCC(e){return String.fromCharCode(this.getUint8(e),this.getUint8(e+1),this.getUint8(e+2),this.getUint8(e+3))}getUint8Subarray(e,r){return new Uint8Array(this.buffer,this.byteOffset+(e||0),r)}setFourCC(e,r){this.setUint8(e,r.charCodeAt(0)),this.setUint8(e+1,r.charCodeAt(1)),this.setUint8(e+2,r.charCodeAt(2)),this.setUint8(e+3,r.charCodeAt(3))}setUint8Array(e,r){this.getUint8Subarray(e,r.length).set(r)}};function Sl(n){let e=new Uint8Array(n.length*4),r=new DataView(e.buffer);for(let i=0;i<n.length;i++)r.setUint32(i*4,n[i]);return e}function El(n){let e=new DataView(n.buffer,n.byteOffset,n.length),r=new Uint32Array(n.length/4);for(let i=0;i<n.length;i+=4)r[i/4]=e.getUint32(i);return r}function _t(){return visualViewport?visualViewport.scale-1>.001:!1}function Lt(n){return n.BYTES_PER_ELEMENT===4}var Mt=new TextDecoder,Ul=new TextEncoder;var hr=class{constructor(){this.type="";this.chunks=[]}parse(e){let r=new le(e);if(r.getFourCC(0)!=="FORM")throw new Error("Not an IFF file");this.type=r.getFourCC(8);let i=12,a=e.length;for(;i<a;){let u=r.getUint32(i+4);if(u<0||u+i>a)throw new Error("IFF chunk out of range");this.chunks.push({data:r.getUint8Subarray(i+8,u),offset:i,type:r.getFourCC(i)}),i+=8+u,i%2&&i++}}write(){let e=12;for(let a of this.chunks)e+=8+a.data.length,e%2&&e++;let r=new le(new ArrayBuffer(e));r.setFourCC(0,"FORM"),r.setUint32(4,e-8),r.setFourCC(8,this.type);let i=12;for(let a of this.chunks)r.setFourCC(i,a.type),r.setUint32(i+4,a.data.length),r.setUint8Array(i+8,a.data),i+=8+a.data.length,i%2&&i++;return r.getUint8Subarray()}};var Bl={Data:"data",Exec:"exec",Pict:"pict","Snd ":"sound"},Al="????",Wt=class{constructor(e){this.classname="Blorb";this.chunks={};this.is_inited=!1;this.metadata={};e&&this.init(e)}init(e,r){if(!this.is_inited){if(e instanceof Uint8Array){let i=new hr;if(i.parse(e),i.type!=="IFRS")throw new Error("Not a Blorb file");if(i.chunks[0].type!=="RIdx")throw new Error("Malformed blorb: chunk 1 is not RIdx");for(let a of i.chunks)switch(a.type){case"Dbug":{this.debugdata=a.data;break}case"Fspc":{let u=new le(a.data);this.coverimagenum=u.getUint32(0);break}case"IFmd":{let u=Mt.decode(a.data),c=/<bibliographic>(.+)<\/bibliographic>/is.exec(u),d=/<(\w+)>(.+)<\/\1>/gi,y=/<br\/>/g,x=/\s+/g;if(c){let b;for(;b=d.exec(c[1]);){let F=b[1].toLowerCase(),U=b[2].replace(x," ");F==="description"&&(U=U.replace(y,`
`)),this.metadata[F]=Nn(U)}}break}case"RDes":{let u=new le(a.data),c=4;for(;c<u.byteLength;){let d=Bl[u.getFourCC(c)],y=u.getUint32(c+4),x=u.getUint32(c+8),b=this.chunks[`${d}:${y}`];b&&(b.alttext=Mt.decode(u.getUint8Subarray(c+12,x))),c+=12+x}break}case"RIdx":{let u=new le(a.data),c=4;for(;c<u.byteLength;){let d=u.getFourCC(c),y=u.getUint32(c+4),x=u.getUint32(c+8);c+=12;let b=i.chunks.filter(C=>C.offset===x)[0];if(!b)throw new Error(`No Blorb chunk at offset ${x}`);let F=b.type,U={blorbtype:F,content:F==="FORM"?e.subarray(b.offset,b.offset+8+b.data.length):b.data,usage:Bl[d]};d==="Pict"&&(F==="JPEG"?U.type="jpeg":F==="PNG "?U.type="png":U.type=Al),d==="Data"&&(U.binary=F==="BINA"||F==="FORM"),this.chunks[`${U.usage}:${y}`]=U}break}}}else if(r?.format==="infomap")for(let i in e){if(!Number.isInteger(+i))continue;let a=Object.assign({},e[i]);delete a.image,a.height&&a.width&&(a.imagesize={height:a.height,width:a.width},delete a.height,delete a.width),a.type=a.url.endsWith(".png")?"png":"jpeg",a.usage="pict",this.chunks[`pict:${i}`]=a}else if(!(Array.isArray(e)&&e.length===0))throw new Error("Unsupported Blorb.init data format");this.is_inited=!0}}getlibrary(){return null}get_chunk(e,r){return this.chunks[`${e}:${r}`]||null}get_cover_pict(){return this.coverimagenum??null}get_data_chunk(e){let r=this.chunks[`data:${e}`];return r?.content?{binary:r.binary,data:r.content}:null}get_debug_info(){return this.debugdata}get_exec_data(e){let r=this.chunks["exec:0"];return!r?.content||e&&r.blorbtype!==e?null:r.content}get_image_info(e){let r=this.chunks[`pict:${e}`];if(!r)return null;!r.imagesize&&r.content&&(r.type==="jpeg"?r.imagesize=$m(r.content):r.type==="png"&&(r.imagesize=Nm(r.content)));let i=Object.assign({image:e},r);return i.imagesize&&(i.height=i.imagesize.height,i.width=i.imagesize.width),i}get_image_url(e){let r=this.chunks[`pict:${e}`];return r?r.url?r.url:r.type!==Al&&r.content?(r.url=URL.createObjectURL(new Blob([r.content],{type:`image/${r.type}`})),r.url):null:null}get_metadata(e){return this.metadata[e]}inited(){return this.is_inited}};function $m(n){let e=new le(n),r=0;for(;r<e.byteLength;){if(e.getUint8(r)!==255)return;for(;e.getUint8(r)===255;)r++;let i=e.getUint8(r++);if(i===1||i>=208&&i<=217)continue;let a=e.getUint16(r);if(i>=192&&i<=207&&i!==200)return a<7?void 0:{height:e.getUint16(r+3),width:e.getUint16(r+5)};r+=a}}function Nm(n){let e=new le(n);if(e.getFourCC(0)!=="\x89PNG")return;let r=8;for(;r<e.byteLength;){let i=e.getUint32(r),a=e.getFourCC(r+4);if(r+=8,a==="IHDR")return{height:e.getInt32(r+4),width:e.getInt32(r)};r+=i+4}}var gr={buffercharheight:1,buffercharwidth:1,buffermarginx:0,buffermarginy:0,graphicsmarginx:0,graphicsmarginy:0,gridcharheight:1,gridcharwidth:1,gridmarginx:0,gridmarginy:0,height:50,inspacingx:0,inspacingy:0,outspacingx:0,outspacingy:0,width:80},Pn={8:"delete",9:"tab",13:"return",27:"escape",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",112:"func1",113:"func2",114:"func3",115:"func4",116:"func5",117:"func6",118:"func7",119:"func8",120:"func9",121:"func10",122:"func11",123:"func12"},jn=40,zn=13,qn=38,_i="\xA0";var Tl="-10000px",mi="0.1.0";function Vn(n){switch(n){case"command":case"transcript":return".txt";case"save":return".glksave";default:return".glkdata"}}var Yo={};Nc(Yo,{evtype_Arrange:()=>Co,evtype_CharInput:()=>Bo,evtype_Hyperlink:()=>Ro,evtype_LineInput:()=>Ao,evtype_MouseInput:()=>To,evtype_None:()=>Ei,evtype_Redraw:()=>Do,evtype_SoundNotify:()=>Ym,evtype_Timer:()=>Ui,evtype_VolumeNotify:()=>Km,filemode_Read:()=>re,filemode_ReadWrite:()=>Ee,filemode_Write:()=>xe,filemode_WriteAppend:()=>Ci,fileusage_BinaryMode:()=>dh,fileusage_Data:()=>fh,fileusage_InputRecord:()=>ch,fileusage_SavedGame:()=>Ti,fileusage_TextMode:()=>Oo,fileusage_Transcript:()=>uh,fileusage_TypeMask:()=>Ht,gestalt_CharInput:()=>Jn,gestalt_CharOutput:()=>Kn,gestalt_CharOutput_ApproxPrint:()=>jm,gestalt_CharOutput_CannotPrint:()=>Pm,gestalt_CharOutput_ExactPrint:()=>Zn,gestalt_DateTime:()=>co,gestalt_DrawImage:()=>ro,gestalt_GarglkText:()=>mo,gestalt_Graphics:()=>to,gestalt_GraphicsCharInput:()=>_o,gestalt_GraphicsTransparency:()=>oo,gestalt_HyperlinkInput:()=>no,gestalt_Hyperlinks:()=>io,gestalt_LineInput:()=>Yn,gestalt_LineInputEcho:()=>lo,gestalt_LineTerminatorKey:()=>uo,gestalt_LineTerminators:()=>fo,gestalt_MouseInput:()=>Xn,gestalt_ResourceStream:()=>po,gestalt_Sound:()=>zm,gestalt_Sound2:()=>Jm,gestalt_SoundMusic:()=>Hm,gestalt_SoundNotify:()=>Vm,gestalt_SoundVolume:()=>qm,gestalt_Timer:()=>eo,gestalt_Unicode:()=>so,gestalt_UnicodeNorm:()=>ao,gestalt_Version:()=>Hn,imagealign_InlineCenter:()=>bh,imagealign_InlineDown:()=>yh,imagealign_InlineUp:()=>gh,imagealign_MarginLeft:()=>xh,imagealign_MarginRight:()=>wh,keycode_Delete:()=>wo,keycode_Down:()=>bo,keycode_End:()=>Eo,keycode_Escape:()=>$t,keycode_Func1:()=>Nt,keycode_Func10:()=>Fi,keycode_Func11:()=>Si,keycode_Func12:()=>mt,keycode_Func2:()=>hi,keycode_Func3:()=>gi,keycode_Func4:()=>yi,keycode_Func5:()=>bi,keycode_Func6:()=>xi,keycode_Func7:()=>wi,keycode_Func8:()=>ki,keycode_Func9:()=>vi,keycode_Home:()=>So,keycode_Left:()=>yr,keycode_MAXVAL:()=>Uo,keycode_PageDown:()=>Fo,keycode_PageUp:()=>vo,keycode_Return:()=>xo,keycode_Right:()=>go,keycode_Tab:()=>ko,keycode_Unknown:()=>ho,keycode_Up:()=>yo,seekmode_Current:()=>Mo,seekmode_End:()=>gt,seekmode_Start:()=>Lo,style_Alert:()=>ih,style_BlockQuote:()=>oh,style_Emphasized:()=>Xm,style_Header:()=>th,style_Input:()=>sh,style_NUMSTYLES:()=>Bi,style_Normal:()=>Zm,style_Note:()=>nh,style_Preformatted:()=>eh,style_Subheader:()=>rh,style_User1:()=>ah,style_User2:()=>lh,stylehint_BackColor:()=>Vo,stylehint_Indentation:()=>Wo,stylehint_Justification:()=>wr,stylehint_NUMHINTS:()=>Jo,stylehint_Oblique:()=>jo,stylehint_ParaIndentation:()=>$o,stylehint_Proportional:()=>zo,stylehint_ReverseColor:()=>Ho,stylehint_Size:()=>No,stylehint_TextColor:()=>qo,stylehint_Weight:()=>Po,stylehint_just_Centered:()=>mh,stylehint_just_LeftFlush:()=>ph,stylehint_just_LeftRight:()=>_h,stylehint_just_RightFlush:()=>hh,winmethod_Above:()=>zt,winmethod_Below:()=>Qo,winmethod_Border:()=>Io,winmethod_BorderMask:()=>ht,winmethod_DirMask:()=>qt,winmethod_DivisionMask:()=>Vt,winmethod_Fixed:()=>tt,winmethod_Left:()=>et,winmethod_NoBorder:()=>Go,winmethod_Proportional:()=>Ai,winmethod_Right:()=>jt,wintype_AllTypes:()=>br,wintype_Blank:()=>Pt,wintype_Graphics:()=>Xe,wintype_Pair:()=>xr,wintype_TextBuffer:()=>Se,wintype_TextGrid:()=>Ie,zcolor_Current:()=>Ri,zcolor_Default:()=>Di});var Hn=0,Jn=1,Yn=2,Kn=3,Pm=0,jm=1,Zn=2,Xn=4,eo=5,to=6,ro=7,zm=8,qm=9,Vm=10,io=11,no=12,Hm=13,oo=14,so=15,ao=16,lo=17,fo=18,uo=19,co=20,Jm=21,po=22,_o=23,mo=4352,ho=4294967295,yr=4294967294,go=4294967293,yo=4294967292,bo=4294967291,xo=4294967290,wo=4294967289,$t=4294967288,ko=4294967287,vo=4294967286,Fo=4294967285,So=4294967284,Eo=4294967283,Nt=4294967279,hi=4294967278,gi=4294967277,yi=4294967276,bi=4294967275,xi=4294967274,wi=4294967273,ki=4294967272,vi=4294967271,Fi=4294967270,Si=4294967269,mt=4294967268,Uo=28,Ei=0,Ui=1,Bo=2,Ao=3,To=4,Co=5,Do=6,Ym=7,Ro=8,Km=9,Zm=0,Xm=1,eh=2,th=3,rh=4,ih=5,nh=6,oh=7,sh=8,ah=9,lh=10,Bi=11,br=0,xr=1,Pt=2,Se=3,Ie=4,Xe=5,et=0,jt=1,zt=2,Qo=3,qt=15,tt=16,Ai=32,Vt=240,Io=0,Go=256,ht=256,fh=0,Ti=1,uh=2,ch=3,Ht=15,Oo=256,dh=0,xe=1,re=2,Ee=3,Ci=5,Lo=0,Mo=1,gt=2,Wo=0,$o=1,wr=2,No=3,Po=4,jo=5,zo=6,qo=7,Vo=8,Ho=9,Jo=10,ph=0,_h=1,mh=2,hh=3,gh=1,yh=2,bh=3,xh=4,wh=5,Di=-1,Ri=-2;var Qi=class{constructor(e,r,i){this.binary=r,this.buf=e,this.fref=i,this.uni=Lt(e)}convert(){if(this.uni){if(this.binary)return Sl(this.buf);{let e=String.fromCodePoint(...this.buf);return Ul.encode(e)}}else return this.buf.slice()}},Ii=class{constructor(e){this.async=!1;this.cache={};this.classname="CachingDialogWrapper";this.streaming=!1;this.write=Qe(()=>{for(let e in this.cache){let r=this.cache[e];if(this.Dialog.streaming){let i=this.Dialog.file_fopen(1,r.fref);i.fwrite(r.convert()),i.fclose()}else this.Dialog.file_write(r.fref,r.convert())}this.cache={}},0);this.Dialog=e}init(e){}file_ref_exists(e){return!!this.cache[e.filename]||this.Dialog.file_ref_exists(e)}file_read(e){if(this.cache[e.filename])return this.cache[e.filename].convert();if(this.Dialog.streaming){let r=this.Dialog.file_fopen(2,e);if(!r)return null;r.fseek(0,2);let i=r.ftell(),a=new Uint8Array(i);return r.fseek(0,0),r.fread(a),r.fclose(),a}else return this.Dialog.file_read(e)}file_remove_ref(e){this.cache[e.filename]&&delete this.cache[e.filename],this.Dialog.file_remove_ref(e)}file_write(e,r){throw new Error("CachingDialogWrapper.write_file should be called instead")}inited(){return!0}write_file(e,r){return this.cache[e.filename]=r,this.write(),!0}autosave_read(e){return this.Dialog.autosave_read(e)}autosave_write(e,r){this.Dialog.autosave_write(e,r)}file_clean_fixed_name(e,r){return this.Dialog.file_clean_fixed_name(e,r)}file_construct_ref(e,r,i){return this.Dialog.file_construct_ref(e,r,i)}file_construct_temp_ref(e){return this.Dialog.file_construct_temp_ref(e)}getlibrary(e){return this.Dialog.getlibrary(e)}open(e,r,i,a){this.Dialog.open(e,r,i,a)}};function kr(n,e,r){let i=Math.min(r,e.length);for(let a=0;a<i;a++)e[a]=n[a]}var Gi=class{constructor(e,r,i,a,u){this.next=null;this.prev=null;this.binary=!(u&256),this.Dialog=e,this.filename=r,this.dfref=i,this.rock=a}delete_file(){this.Dialog.file_remove_ref(this.dfref)}exists(){return this.Dialog.file_ref_exists(this.dfref)}read(){return this.Dialog.file_read(this.dfref)}write(e){let r=new Qi(e,this.binary,this.dfref);this.Dialog.write_file(this.dfref,r)}};var vr={dummy:"Glk call has not yet returned"};var Dl=0,rt=255,it=63,Ko=["margin-left","text-indent","text-align","font-size","font-weight","font-style","monospace","color","background-color","reverse"],Rl={1:"write",2:"read",3:"readwrite",5:"writeappend"},Oi={0:"data",1:"save",2:"transcript",3:"command"},Ql={1:"inlineup",2:"inlinedown",3:"inlinecenter",4:"marginleft",5:"marginright"},Il={delete:4294967289,down:4294967291,end:4294967283,escape:4294967288,func1:4294967279,func2:4294967278,func3:4294967277,func4:4294967276,func5:4294967275,func6:4294967274,func7:4294967273,func8:4294967272,func9:4294967271,func10:4294967270,func11:4294967269,func12:4294967268,home:4294967284,left:4294967294,pagedown:4294967285,pageup:4294967286,return:4294967290,right:4294967293,tab:4294967287,up:4294967292},Li={0:"normal",1:"emphasized",2:"preformatted",3:"header",4:"subheader",5:"alert",6:"note",7:"blockquote",8:"input",9:"user1",10:"user2"},Zo={4294967288:"escape",4294967279:"func1",4294967278:"func2",4294967277:"func3",4294967276:"func4",4294967275:"func5",4294967274:"func6",4294967273:"func7",4294967272:"func8",4294967271:"func9",4294967270:"func10",4294967269:"func11",4294967268:"func12"},Gl={escape:4294967288,func1:4294967279,func2:4294967278,func3:4294967277,func4:4294967276,func5:4294967275,func6:4294967274,func7:4294967273,func8:4294967272,func9:4294967271,func10:4294967270,func11:4294967269,func12:4294967268};var Fr=class{constructor(e,r){this.next=null;this.prev=null;this.write_count=0;this.fmode=e,this.rock=r}close(e){e&&(e.set_field(0,0),e.set_field(1,this.write_count))}get_buffer(e){return 0}get_char(e){return-1}get_line(e){return 0}get_position(){return 0}set_position(e,r){}},nt=class extends Fr{constructor(r,i,a,u){super(i,a);this.pos=0;this.read_count=0;this.type="array";this.buf=r,this.close_cb=u,this.expandable=i===1,this.len=i===1?0:r.length,this.uni=Lt(r)}close(r){this.close_cb?.(),this.write(),r&&(r.set_field(0,this.read_count),r.set_field(1,this.write_count))}expand(r){this.len=Math.min(this.pos+r,this.buf.length),this.len===this.buf.length&&(this.expandable=!1)}get_buffer(r){let i=Math.min(r.length,this.len-this.pos);if(!Lt(r)&&this.uni)for(let a=0;a<i;a++){let u=this.buf[this.pos+a];r[a]=u>rt?it:u}else r.set(this.buf.subarray(this.pos,this.pos+i));return this.pos+=i,this.read_count+=i,i}get_char(r){if(this.pos<this.len){this.read_count++;let i=this.buf[this.pos++];return!r&&i>rt?it:i}return-1}get_line(r){let i=Math.min(r.length-1,this.len-this.pos);if(i<0)return 0;let a=!Lt(r)&&this.uni,u=0;for(;u<i;){let c=this.buf[this.pos++];if(r[u++]=a&&c>rt?it:c,c===10)break}return r[u]=Dl,this.read_count+=u,u}get_position(){return this.pos}put_buffer(r,i){let a=r.length;this.write_count+=a,this.pos+a>this.len&&this.expandable&&this.expand(a);let u=Math.min(a,this.len-this.pos);if(u!==0){if(i&&!this.uni)for(let c=0;c<u;c++){let d=r[c];this.buf[this.pos+c]=d>rt?it:d}else Array.isArray(r)&&(r=(i?Uint32Array:Uint8Array).from(r)),this.buf.set(r.subarray(0,u),this.pos);this.pos+=u,this.write()}}put_char(r){this.write_count++,this.pos===this.len&&this.expandable&&this.expand(1),this.pos<this.len&&(this.buf[this.pos++]=!this.uni&&r>rt?it:r,this.write())}put_string(r){this.put_buffer(Uint32Array.from(r,i=>i.codePointAt(0)),!0)}set_position(r,i){r===1?this.pos+=i:r===2?this.pos=this.len+i:this.pos=i,this.pos<0&&(this.pos=0),this.pos>this.len&&(this.pos=this.len)}write(){}},Mi=class extends nt{constructor(e,r,i,a){super(r,i,a),this.expandable=!0,this.fref=e}expand(e){let r=this.pos+e;this.len=r;let i=this.buf.length;if(r>i){i+=Math.max(r-i,100);let a=this.buf;this.buf=new(this.uni?Uint32Array:Uint8Array)(i),this.buf.set(a)}}write(){this.fref.write(this.buf.subarray(0,this.len))}},Wi=class extends Fr{constructor(){super(...arguments);this.type="null"}put_buffer(r,i){this.write_count+=r.length}put_char(r){this.write_count++}put_string(r,i){this.write_count+=[...r].length}},$i=class extends Fr{constructor(r){super(1,0);this.type="window";this.win=r}put_buffer(r,i){if(this.win.input.type==="line")throw new Error("Window has pending line request");this.write_count+=r.length,this.win.put_string(String.fromCodePoint(...r)),this.win.echostr?.put_buffer(r,i)}put_char(r){if(this.win.input.type==="line")throw new Error("Window has pending line request");this.write_count++,this.win.put_string(String.fromCodePoint(r)),this.win.echostr?.put_char(r)}put_string(r,i){if(this.win.input.type==="line")throw new Error("Window has pending line request");this.write_count+=[...r].length,this.win.put_string(r,i),this.win.echostr?.put_string(r,i)}set_css(r,i){this.win.set_css(r,i),this.win.echostr?.type==="window"&&this.win.echostr.set_css(r,i)}set_hyperlink(r){this.win.set_hyperlink(r),this.win.echostr?.type==="window"&&this.win.echostr.set_hyperlink(r)}set_style(r){this.win.set_style(r),this.win.echostr?.type==="window"&&this.win.echostr.set_style(r)}};var Yt=class{constructor(e){this.box={bottom:0,left:0,right:0,top:0};this.disprock=0;this.echostr=null;this.input={id:0};this.next=null;this.parent=null;this.prev=null;this.rock=e,this.str=new $i(this)}clear(){}put_string(e,r){}set_css(e,r){}set_hyperlink(e){}set_style(e){}update(){if(this.type==="blank"||this.type==="pair")return{content:null,input:null,size:null};let e={id:this.input.id};Jt(this.input,e,"hyperlink"),Jt(this.input,e,"mouse");let r=this.box,i=r.bottom-r.top,a=r.right-r.left;return{content:null,input:e,size:{height:i,hidden:i===0||a===0,id:this.disprock,left:r.left,rock:this.rock,top:r.top,type:this.type,width:a}}}},Ni=class extends Yt{constructor(){super(...arguments);this.type="blank";this.typenum=2}},Pi=class extends Yt{constructor(r,i){super(r);this.cleared=!0;this.request_echo_line_input=!0;this.stylehints=mr(i)}update(){let r=super.update();Object.keys(this.stylehints).length&&(r.size.styles=this.stylehints);let i=this.input,a=r.input;return i.type&&(Jt(i,a,"gen"),Jt(i,a,"type"),i.type==="line"&&(a.maxlen=this.line_input_buf.length,Jt(i,a,"initial"),Jt(i,a,"terminators"))),delete i.initial,r}},ji=class extends Pi{constructor(r,i){super(r,i);this.echo_line_input=!0;this.last_textrun=fe(Hi,!0);this.type="buffer";this.typenum=3;this.last_textrun=fe(Hi,!0),this.content=[{content:[this.last_textrun]}],this.last_par=this.content[0]}clear(){this.cleared=!0,this.clear_content()}clear_content(){this.last_textrun=fe(this.last_textrun,!1),this.content=[{append:!0,content:[this.last_textrun]}],this.last_par=this.content[0]}clone_textrun(r,i){(i||this.last_textrun.text!=="")&&(this.last_textrun=fe(this.last_textrun,r),this.last_par.content.push(this.last_textrun))}put_image(r){r.hyperlink=this.last_textrun.hyperlink,this.last_par.content.push(r),this.clone_textrun(!1,!0)}put_string(r,i){let a=this.last_textrun.style;i&&this.set_style(i);for(let[u,c]of r.split(`
`).entries())u!==0&&(this.last_textrun=fe(this.last_textrun,!1),this.last_par={content:[this.last_textrun]},this.content.push(this.last_par)),this.last_textrun.text+=c;i&&this.set_style(a)}set_css(r,i){this.last_textrun.css_styles[r]!==i&&(this.clone_textrun(!0),i===void 0?delete this.last_textrun.css_styles[r]:this.last_textrun.css_styles[r]=i)}set_flow_break(){this.last_par.flowbreak=!0}set_hyperlink(r){r===0&&(r=void 0),r!==this.last_textrun.hyperlink&&(this.clone_textrun(!1),r?this.last_textrun.hyperlink=r:delete this.last_textrun.hyperlink)}set_style(r){r!==this.last_textrun.style&&(this.clone_textrun(!1),this.last_textrun.style=r)}update(){let r=super.update();this.last_textrun=fe(this.last_textrun,!1);let i=this.content;for(let a of i)a.content=Ol(a.content.filter(u=>"special"in u||u.text));return(this.cleared||i.length>1||i[0].content.length)&&(r.content={id:this.disprock,text:i.map(a=>a.append||a.flowbreak||a.content.length?a:{})},this.cleared&&(r.content.clear=!0,this.cleared=!1)),this.clear_content(),r}},zi=class extends Yt{constructor(){super(...arguments);this.draw=[];this.height=0;this.type="graphics";this.typenum=5;this.width=0}clear(){this.draw=this.draw.filter(r=>r.special==="setcolor").slice(-1),this.draw.push({special:"fill"})}update(){let r=super.update();return this.draw.length&&(r.content={draw:this.draw,id:this.disprock},this.draw=[]),r.size.graphheight=this.height,r.size.graphwidth=this.width,r}},qi=class extends Pi{constructor(){super(...arguments);this.current_styles=fe(Hi,!0);this.height=0;this.lines=[];this.type="grid";this.typenum=4;this.width=0;this.x=0;this.y=0}clear(){this.cleared=!0;let r=this.height;this.update_size(0,this.width),this.update_size(r,this.width),this.x=this.y=0}fit_cursor(){if(this.x>=this.width&&(this.x=0,this.y++),this.y>=this.height)return!0}put_string(r,i){let a=this.current_styles.style;i&&this.set_style(i);for(let u of r){if(this.fit_cursor())break;if(u===`
`){this.x=0,this.y++;continue}let c=this.lines[this.y];c.changed=!0,c.content[this.x++]=fe(this.current_styles,!1,u)}i&&this.set_style(a)}set_css(r,i){this.current_styles.css_styles[r]!==i&&(this.current_styles=fe(this.current_styles,!0),i===void 0?delete this.current_styles.css_styles[r]:this.current_styles.css_styles[r]=i)}set_hyperlink(r){r?this.current_styles.hyperlink=r:delete this.current_styles.hyperlink}set_style(r){this.current_styles.style=r}update_size(r,i){let a=this.height,u=this.width;this.height=r,this.width=i;let c=fe(Hi,!0," ");if(a>r)this.lines.length=r;else if(r>a)for(let y=a;y<r;y++){let x=[];for(let b=0;b<i;b++)x.push(fe(c,!1," "));this.lines[y]={changed:!0,content:x}}let d=Math.min(r,a);if(d&&i!==u)for(let y=0;y<d;y++){let x=this.lines[y];if(i<u)x.changed=!0,x.content.length=i;else{x.changed=!0;for(let b=u;b<i;b++)x.content.push(fe(c,!1," "))}}}update(){let r=super.update();if(this.lines.find(i=>i.changed)&&(r.content={id:this.disprock,lines:this.lines.flatMap((i,a)=>i.changed?(i.changed=!1,{content:Ol(i.content.reduce((u,c)=>{if(!u.length)return[fe(c,!1,c.text)];let d=u[u.length-1];return c.css_styles===d.css_styles&&c.hyperlink===d.hyperlink&&c.style===d.style?d.text+=c.text:u.push(fe(c,!1,c.text)),u},[])),line:a}):[])},this.cleared&&(r.content.clear=!0,this.cleared=!1)),this.input.type){let i=r.input;this.fit_cursor()?(i.xpos=this.width-1,i.ypos=this.height-1):(i.xpos=this.x,i.ypos=this.y)}return r.size.gridheight=this.height,r.size.gridwidth=this.width,r}},Vi=class extends Yt{constructor(r,i,a){super(0);this.child1=null;this.child2=null;this.type="pair";this.typenum=1;this.border=(i&256)===256,this.dir=i&15,this.fixed=(i&240)===16,this.key=r,this.size=a,this.backward=this.dir===0||this.dir===2,this.vertical=this.dir===0||this.dir===1}},Hi={css_styles:{},style:"normal",text:""};function Ol(n){return n.map(e=>("special"in e||Object.keys(e.css_styles).length||delete e.css_styles,e))}function fe(n,e,r=""){return Object.assign({},n,{css_styles:e?Object.assign({},n.css_styles):n.css_styles,text:r})}function Jt(n,e,r){n[r]&&(e[r]=n[r])}var Ki=class{constructor(){this.value=0}get_value(){return this.value}set_value(e){this.value=e}},Zi=class{constructor(){this.fields=[]}get_field(e){return this.fields[e]}get_fields(){return this.fields}push_field(e){this.fields.push(e)}set_field(e,r){this.fields[e]=r}},Ur=class{constructor(){this.Dialog=null;this.GlkOte=null;this.VM=null;this.disprock_counter=1;this.do_autosave=!1;this.exited=!1;this.first_fref=null;this.gen=0;this.metrics=gr;this.current_stream=null;this.first_stream=null;this.stylehints={buffer:{},grid:{}};this.support=[];this.timer={interval:0,last_interval:0,started:0};this.version=mi;this.first_window=null;this.root_window=null;this.windows_changed=!1;this.Const=Yo;this.DidNotReturn=vr;this.RefBox=Ki;this.RefStruct=Zi}init(e){if(this.before_select_hook=e.before_select_hook,this.Blorb=e.Blorb,e.Dialog&&!e.Dialog.async)this.Dialog=new Ii(e.Dialog);else throw new Error("No reference to Dialog");if(this.do_autosave=!!e.do_vm_autosave,this.GiDispa=e.GiDispa,this.gestalt_hook=e.glk_gestalt_hook,e.GlkOte)this.GlkOte=e.GlkOte;else throw new Error("No reference to GlkOte");if(e.vm)this.VM=e.vm;else throw new Error("No reference to VM");this.before_select_hook?.(),this.GiDispa?.init({io:this,vm:this.VM});let r=e;r.accept=this.accept.bind(this),this.GlkOte.init(r)}call_may_not_return(e){return e===1||e===192||e===98}fatal_error(e){if(this.exited=!0,!this.GlkOte){console.error("Fatal error: "+e);return}this.GlkOte.error(e),this.GlkOte.update({type:"update",disable:!0,gen:this.gen})}getlibrary(e){switch(e){case"Blorb":return this.Blorb||null;case"Dialog":return this.Dialog;case"GiDispa":return this.GiDispa||null;case"GlkOte":return this.GlkOte;case"VM":return this.VM;default:return null}}inited(){return!!(this.GlkOte&&this.VM)}restore_allstate(e){throw new Error("Autosaves not yet supported")}save_allstate(){throw new Error("Autosaves not yet supported")}update(){let e={gen:this.gen,type:"update"};this.exited&&(e.disable=!0);let r=[],i=[],a=[];for(let c=this.first_window;c;c=c.next){let d=c.update();if(d.content&&r.push(d.content),d.input){let y=d.input;(y.hyperlink||y.mouse||y.type)&&i.push(y)}this.windows_changed&&d.size&&a.push(d.size)}r.length&&(e.content=r),i.length&&(e.input=i),a.length&&(e.windows=a),this.windows_changed=!1,this.special&&(e.specialinput=this.special,delete this.special);let u=this.timer;u.last_interval!==u.interval&&(e.timer=u.interval,u.last_interval=u.interval),this.GlkOte.update(mr(e)),this.before_select_hook?.()}byte_array_to_string(e){return String.fromCodePoint(...e)}glk_put_jstring(e,r){this.glk_put_jstring_stream(this.current_stream,e)}glk_put_jstring_stream(e,r,i){if(!e)throw new Error("Invalid Stream");e.put_string(r)}uni_array_to_string(e){return String.fromCodePoint(...e)}glk_buffer_canon_decompose_uni(e,r){return Sr(e,r,i=>i.normalize("NFD"))}glk_buffer_canon_normalize_uni(e,r){return Sr(e,r,i=>i.normalize("NFC"))}glk_buffer_to_lower_case_uni(e,r){return Sr(e,r,i=>i.toLowerCase())}glk_buffer_to_title_case_uni(e,r,i){return Sr(e,r,a=>a.reduce((u,c,d)=>{let y={\u00DF:"Ss",\u01C4:"\u01C5",\u01C5:"\u01C5",\u01C6:"\u01C5",\u01C7:"\u01C8",\u01C8:"\u01C8",\u01C9:"\u01C8",\u01CA:"\u01CB",\u01CB:"\u01CB",\u01CC:"\u01CB",\u01F1:"\u01F2",\u01F2:"\u01F2",\u01F3:"\u01F2",\u0587:"\u0535\u0582",\u1FB2:"\u1FBA\u0345",\u1FB3:"\u1FBC",\u1FB4:"\u0386\u0345",\u1FB7:"\u0391\u0342\u0345",\u1FBC:"\u1FBC",\u1FC2:"\u1FCA\u0345",\u1FC3:"\u1FCC",\u1FC4:"\u0389\u0345",\u1FC7:"\u0397\u0342\u0345",\u1FCC:"\u1FCC",\u1FF2:"\u1FFA\u0345",\u1FF3:"\u1FFC",\u1FF4:"\u038F\u0345",\u1FF7:"\u03A9\u0342\u0345",\u1FFC:"\u1FFC",\uFB00:"Ff",\uFB01:"Fi",\uFB02:"Fl",\uFB03:"Ffi",\uFB04:"Ffl",\uFB05:"St",\uFB06:"St",\uFB13:"\u0544\u0576",\uFB14:"\u0544\u0565",\uFB15:"\u0544\u056B",\uFB16:"\u054E\u0576",\uFB17:"\u0544\u056D"},x=["\u1F88\u1F89\u1F8A\u1F8B\u1F8C\u1F8D\u1F8E\u1F8F","\u1F98\u1F99\u1F9A\u1F9B\u1F9C\u1F9D\u1F9E\u1F9F","\u1FA8\u1FA9\u1FAA\u1FAB\u1FAC\u1FAD\u1FAE\u1FAF"],b=String.fromCodePoint(c);return d===0?y[b]?b=y[b]:c>=8064&&c<8112?b=x[(c-8064)/16|0][c%8]:b=b.toUpperCase():i&&(b=b.toLowerCase()),u+b},""),!0)}glk_buffer_to_upper_case_uni(e,r){return Sr(e,r,i=>i.toUpperCase())}glk_cancel_char_event(e){if(!e)throw new Error("Invalid Window");delete e.input.type}glk_cancel_hyperlink_event(e){if(!e)throw new Error("Invalid Window");(e.type==="buffer"||e.type==="grid")&&delete e.input.hyperlink}glk_cancel_line_event(e,r){if(!e)throw new Error("Invalid Window");if(e.input.type!=="line"){r&&Ji(r);return}this.handle_line_input(e,this.partial_inputs?.[e.disprock]??"",r)}glk_cancel_mouse_event(e){if(!e)throw new Error("Invalid Window");(e.type==="graphics"||e.type==="grid")&&delete e.input.mouse}glk_char_to_lower(e){return e>=65&&e<=90||e>=192&&e<=222&&e!==215?e+32:e}glk_char_to_upper(e){return e>=97&&e<=122||e>=224&&e<=254&&e!==247?e-32:e}glk_current_simple_time(e){return Math.floor(Date.now()/(e*1e3))}glk_current_time(e){Xo(Date.now(),e)}glk_date_to_simple_time_local(e,r){return Math.floor(Ml(e)/(r*1e3))}glk_date_to_simple_time_utc(e,r){return Math.floor(Wl(e)/(r*1e3))}glk_date_to_time_local(e,r){Xo(Ml(e),r)}glk_date_to_time_utc(e,r){Xo(Wl(e),r)}glk_exit(){return this.exited=!0,vr}glk_fileref_create_by_name(e,r,i){let a=this.Dialog.file_clean_fixed_name(r,e&15);return this.create_fileref(a,i,e)}glk_fileref_create_by_prompt(e,r,i){let a=Rl[r]??"read",u=e&15,c=Oi[u]??"data";return this.special={filemode:a,filetype:c,type:"fileref_prompt"},u===1&&(this.special.gameid=this.VM.get_signature()),this.special_data={rock:i,usage:e},vr}glk_fileref_create_from_fileref(e,r,i){if(!r)throw new Error("Invalid Fileref");return this.create_fileref(r.filename,i,e)}glk_fileref_create_temp(e,r){let i=Oi[e&15],a=this.Dialog.file_construct_temp_ref(i);return this.create_fileref(a.filename,r,e,a)}glk_fileref_delete_file(e){if(!e)throw new Error("Invalid Fileref");e.delete_file()}glk_fileref_destroy(e){if(!e)throw new Error("Invalid Fileref");this.GiDispa?.class_unregister("fileref",e);let r=e.prev,i=e.next;e.prev=null,e.next=null,r?r.next=i:this.first_fref=i,i&&(i.prev=r)}glk_fileref_does_file_exist(e){if(!e)throw new Error("Invalid Fileref");return e.exists()}glk_fileref_get_rock(e){if(!e)throw new Error("Invalid Fileref");return e.rock}glk_fileref_iterate(e,r){let i=e?e.next:this.first_fref;return r&&r.set_value(i?i.rock:0),i}glk_gestalt(e,r){return this.glk_gestalt_ext(e,r,null)}glk_gestalt_ext(e,r,i){let a=this.gestalt_hook?.(e,r,i);if(a)return a;switch(e){case 0:return 1797;case 1:return r<=4294967294&&r>=4294967268?1:r>=4294967296-28||r>1114111||r>=0&&r<32||r>=127&&r<160?0:1;case 2:return r>1114111||r>=0&&r<32||r>=127&&r<160?0:1;case 3:return i&&(i[0]=1),2;case 19:return+(r===4294967288||r>=4294967268&&r<=4294967279);case 7:return+((r===5||r===3)&&this.support.includes("graphics"));case 4352:return+this.support.includes("garglktext");case 6:case 23:case 14:return+this.support.includes("graphics");case 11:return+this.support.includes("hyperlinks");case 12:return+((r===3||r===4)&&this.support.includes("hyperlinks"));case 4:return+((r===5||r===4)&&this.support.includes("graphics"));case 5:return+this.support.includes("timer");case 20:case 17:case 18:case 22:case 15:case 16:return 1;default:return 0}}glk_get_buffer_stream(e,r){if(!e)throw new Error("Invalid Stream");if(e.fmode!==2&&e.fmode!==3)throw new Error("Cannot read from write-only stream");return Array.isArray(r)?Yi(r,Uint8Array,i=>e.get_buffer(i)):e.get_buffer(r)}glk_get_buffer_stream_uni(e,r){if(!e)throw new Error("Invalid Stream");if(e.fmode!==2&&e.fmode!==3)throw new Error("Cannot read from write-only stream");return Array.isArray(r)?Yi(r,Uint32Array,i=>e.get_buffer(i)):e.get_buffer(r)}glk_get_char_stream(e){if(!e)throw new Error("Invalid Stream");if(e.fmode!==2&&e.fmode!==3)throw new Error("Cannot read from write-only stream");return e.get_char(!1)}glk_get_char_stream_uni(e){if(!e)throw new Error("Invalid Stream");if(e.fmode!==2&&e.fmode!==3)throw new Error("Cannot read from write-only stream");return e.get_char(!0)}glk_get_line_stream(e,r){if(!e)throw new Error("Invalid Stream");if(e.fmode!==2&&e.fmode!==3)throw new Error("Cannot read from write-only stream");return Array.isArray(r)?Yi(r,Uint8Array,i=>e.get_line(i)+1)-1:e.get_line(r)}glk_get_line_stream_uni(e,r){if(!e)throw new Error("Invalid Stream");if(e.fmode!==2&&e.fmode!==3)throw new Error("Cannot read from write-only stream");return Array.isArray(r)?Yi(r,Uint32Array,i=>e.get_line(i)+1)-1:e.get_line(r)}glk_image_draw(e,r,i,a){let u=this.Blorb?.get_image_info(r);return u?(this.draw_image(e,u,u.height||0,i,a,u.width||0),1):0}glk_image_draw_scaled(e,r,i,a,u,c){let d=this.Blorb?.get_image_info(r);return d?(this.draw_image(e,d,c||0,i,a,u||0),1):0}glk_image_get_info(e,r,i){let a=this.Blorb?.get_image_info(e);return i&&i.set_value(a?.height||0),r&&r.set_value(a?.width||0),a?1:0}glk_put_buffer(e){this.glk_put_buffer_stream(this.current_stream,e)}glk_put_buffer_stream(e,r){if(!e)throw new Error("Invalid Stream");if(e.fmode===2)throw new Error("Cannot write to read-only stream");e.put_buffer(r,!1)}glk_put_buffer_stream_uni(e,r){if(!e)throw new Error("Invalid Stream");if(e.fmode===2)throw new Error("Cannot write to read-only stream");e.put_buffer(r,!0)}glk_put_buffer_uni(e){this.glk_put_buffer_stream_uni(this.current_stream,e)}glk_put_char(e){this.glk_put_char_stream(this.current_stream,e)}glk_put_char_stream(e,r){if(!e)throw new Error("Invalid Stream");if(e.fmode===2)throw new Error("Cannot write to read-only stream");e.put_char(r)}glk_put_char_stream_uni(e,r){this.glk_put_char_stream(e,r)}glk_put_char_uni(e){this.glk_put_char_stream(this.current_stream,e)}glk_put_string(e){this.glk_put_string_stream(this.current_stream,e)}glk_put_string_stream(e,r){if(!e)throw new Error("Invalid Stream");if(e.fmode===2)throw new Error("Cannot write to read-only stream");e.put_string(r)}glk_put_string_stream_uni(e,r){this.glk_put_string_stream(e,r)}glk_put_string_uni(e){this.glk_put_string_stream(this.current_stream,e)}glk_request_char_event(e){this.request_char_event(e,!1)}glk_request_char_event_uni(e){this.request_char_event(e,!0)}glk_request_hyperlink_event(e){if(!e)throw new Error("Invalid Window");(e.type==="buffer"||e.type==="grid")&&(e.input.hyperlink=!0)}glk_request_line_event(e,r,i){this.request_line_event(e,r,!1,i)}glk_request_line_event_uni(e,r,i){this.request_line_event(e,r,!0,i)}glk_request_mouse_event(e){if(!e)throw new Error("Invalid Window");(e.type==="graphics"||e.type==="grid")&&(e.input.mouse=!0)}glk_request_timer_events(e){this.timer.interval=e,this.timer.started=e?Date.now():0}glk_schannel_create(e){return null}glk_schannel_create_ext(e,r){return null}glk_schannel_destroy(e){throw new Error("Invalid Schannel")}glk_schannel_get_rock(e){throw new Error("Invalid Schannel")}glk_schannel_iterate(e,r){return r&&r.set_value(0),null}glk_schannel_pause(e){throw new Error("Invalid Schannel")}glk_schannel_play(e,r){throw new Error("Invalid Schannel")}glk_schannel_play_ext(e,r,i,a){throw new Error("Invalid Schannel")}glk_schannel_play_multi(e,r,i){throw new Error("Invalid Schannel")}glk_schannel_set_volume(e,r){throw new Error("Invalid Schannel")}glk_schannel_set_volume_ext(e,r,i,a){throw new Error("Invalid Schannel")}glk_schannel_stop(e){throw new Error("Invalid Schannel")}glk_schannel_unpause(e){throw new Error("Invalid Schannel")}glk_select(e){return this.selectref=e,vr}glk_select_poll(e){Ji(e);let r=this.timer;if(r.interval){let i=Date.now();i-r.started>r.interval&&(r.last_interval=0,r.started=i,e.set_field(0,1))}}glk_set_echo_line_event(e,r){if(!e)throw new Error("Invalid Window");e.type==="buffer"&&(e.echo_line_input=!!r)}glk_set_hyperlink(e){this.glk_set_hyperlink_stream(this.current_stream,e)}glk_set_hyperlink_stream(e,r){if(!e)throw new Error("Invalid Stream");e.type==="window"&&e.set_hyperlink(r)}glk_set_style(e){this.glk_set_style_stream(this.current_stream,e)}glk_set_style_stream(e,r){if(!e)throw new Error("Invalid Stream");e.type==="window"&&((r<0||r>11)&&(r=0),e.set_style(Li[r]))}glk_set_terminators_line_event(e,r){if(!e)throw new Error("Invalid Window");let i=[];if(r)for(let a of r)Zo[a]&&i.push(Zo[a]);i.length?e.input.terminators=i:delete e.input.terminators}glk_set_window(e){this.current_stream=e?e.str:null}glk_sound_load_hint(e,r){}glk_stream_close(e,r){if(!e)throw new Error("Invalid Stream");e.close(r),this.unregister_stream(e)}glk_stream_get_current(){return this.current_stream}glk_stream_get_position(e){if(!e)throw new Error("Invalid Stream");return e.get_position()}glk_stream_get_rock(e){if(!e)throw new Error("Invalid Stream");return e.rock}glk_stream_iterate(e,r){let i=e?e.next:this.first_stream;return r&&r.set_value(i?i.rock:0),i}glk_stream_open_file(e,r,i){return this.create_file_stream(e,r,i,!1)}glk_stream_open_file_uni(e,r,i){return this.create_file_stream(e,r,i,!0)}glk_stream_open_memory(e,r,i){return this.create_memory_stream(e,r,i,Uint8Array)}glk_stream_open_memory_uni(e,r,i){return this.create_memory_stream(e,r,i,Uint32Array)}glk_stream_open_resource(e,r){return this.create_resource_stream(e,r,!1)}glk_stream_open_resource_uni(e,r){return this.create_resource_stream(e,r,!0)}glk_stream_set_current(e){this.current_stream=e}glk_stream_set_position(e,r,i){if(!e)throw new Error("Invalid Stream");e.set_position(i,r)}glk_style_distinguish(e,r,i){return 0}glk_style_measure(e,r,i,a){return a&&a.set_value(0),0}glk_stylehint_clear(e,r,i){let a=`.Style_${Li[r]}${i<=2?"_par":""}`;function u(c){c[a]&&(delete c[a][Ko[i]],Object.keys(c[a]).length||delete c[a])}(e===0||e===3)&&u(this.stylehints.buffer),(e===0||e===4)&&u(this.stylehints.grid)}glk_stylehint_set(e,r,i,a){if(r<0||r>=11||i<0||i>=10)return;if(e===0){this.glk_stylehint_set(3,r,i,a),this.glk_stylehint_set(4,r,i,a);return}if(e===2||e===5||e===1)return;let u=e===3?this.stylehints.buffer:this.stylehints.grid,c=`.Style_${Li[r]}${i<=2?"_par":""}`,d=["left","justify","center","right"],y=["lighter","normal","bold"],x;(i===0||i===1)&&(x=a+"em"),i===2&&(x=d[a]),i===3&&(x=1+a*.1+"em"),i===4&&(x=y[a+1]),i===5&&(x=a?"italic":"normal"),i===6&&(x=a?0:1),(i===7||i===8)&&(x=Er(a)),i===9&&(x=a),x!==void 0&&(u[c]||(u[c]={}),u[c][Ko[i]]=x)}glk_tick(){}glk_simple_time_to_date_local(e,r,i){Nl(e*1e3*r,i)}glk_simple_time_to_date_utc(e,r,i){Pl(e*1e3*r,i)}glk_time_to_date_local(e,r){Nl(jl(e),r)}glk_time_to_date_utc(e,r){Pl(jl(e),r)}glk_window_clear(e){if(!e)throw new Error("Invalid Window");if(e.input.type==="line")throw new Error("Window has pending line input");e.clear()}glk_window_close(e,r){if(!e)throw new Error("Invalid Window");if(e.str.close(r),e===this.root_window)this.root_window=null,this.remove_window(e,!0);else{let i=e.parent,a=i.child1===e?i.child2:i.child1,u=i.parent;u?(u.child1===i?u.child1=a:u.child2=a,a.parent=u):(this.root_window=a,a.parent=null),this.remove_window(e,!0),this.remove_window(i,!1),this.rearrange_window(a,i.box)}}glk_window_erase_rect(e,r,i,a,u){if(!e)throw new Error("Invalid Window");if(e.type!=="graphics")throw new Error("Invalid Window: not a graphics window");e.draw.push({height:u,special:"fill",width:a,x:r,y:i})}glk_window_fill_rect(e,r,i,a,u,c){if(!e)throw new Error("Invalid Window");if(e.type!=="graphics")throw new Error("Invalid Window: not a graphics window");e.draw.push({color:Er(r),height:c,special:"fill",width:u,x:i,y:a})}glk_window_flow_break(e){if(!e)throw new Error("Invalid Window");e.type==="buffer"&&e.set_flow_break()}glk_window_get_arrangement(e,r,i,a){if(!e)throw new Error("Invalid Window");if(e.type!=="pair")throw new Error("Invalid Window: not a pair window");a&&a?.set_value(e.key),r&&r?.set_value(e.dir|(e.fixed?16:32)|(e.border?0:256)),i&&i?.set_value(e.size)}glk_window_get_echo_stream(e){if(!e)throw new Error("Invalid Window");return e.echostr}glk_window_get_parent(e){if(!e)throw new Error("Invalid Window");return e.parent}glk_window_get_rock(e){if(!e)throw new Error("Invalid Window");return e.rock}glk_window_get_root(){return this.root_window}glk_window_get_sibling(e){if(!e)throw new Error("Invalid Window");let r=e.parent;return r?r.child1===e?r.child2:r.child1:null}glk_window_get_size(e,r,i){if(!e)throw new Error("Invalid Window");let a=this.metrics,u=0,c=0;switch(e.type){case"buffer":u=Kt((e.box.bottom-e.box.top-a.buffermarginy)/a.buffercharheight),c=Kt((e.box.right-e.box.left-a.buffermarginx)/a.buffercharwidth);break;case"graphics":case"grid":u=e.height,c=e.width;break}i&&i?.set_value(u),r&&r?.set_value(c)}glk_window_get_stream(e){if(!e)throw new Error("Invalid Window");return e.str}glk_window_get_type(e){if(!e)throw new Error("Invalid Window");return e.typenum}glk_window_iterate(e,r){let i=e?e.next:this.first_window;return r&&r?.set_value(i?i.rock:0),i}glk_window_move_cursor(e,r,i){if(!e)throw new Error("Invalid Window");if(e.type!=="grid")throw new Error("Invalid Window: not a grid window");e.x=Math.max(0,r),e.y=Math.max(0,i)}glk_window_open(e,r,i,a,u){if(this.root_window){if(!e)throw new Error("Invalid splitwin");if(e.type==="pair")throw new Error("Invalid splitwin: must not be a pair window");let d=r&240,y=r&15;if(d!==16&&d!==32)throw new Error("Invalid method: must be fixed or proportional");if(d===16&&e.type==="blank")throw new Error("Invalid method: blank windows cannot be only be split proportionally");if(y!==2&&y!==3&&y!==0&&y!==1)throw new Error("Invalid method: bad direction")}else if(e)throw new Error("Invalid splitwin: must be null for first window");let c;switch(a){case 2:c=new Ni(u);break;case 5:c=new zi(u);break;case 3:c=new ji(u,this.stylehints.buffer);break;case 4:c=new qi(u,this.stylehints.grid);break;default:throw new Error("Invalid wintype")}if(this.register_window(c),e){let d=new Vi(c,r,i);this.register_window(d),d.child1=e,d.child2=c;let y=e.parent;e.parent=d,c.parent=d,d.parent=y,y?y.child1===e?y.child1=d:y.child2=d:this.root_window=d,this.rearrange_window(d,e.box)}else this.root_window=c,this.rearrange_window(c,{bottom:this.metrics.height,left:0,right:this.metrics.width,top:0});return c}glk_window_set_arrangement(e,r,i,a){if(!e)throw new Error("Invalid Window");if(e.type!=="pair")throw new Error("Invalid Window: not a pair window");if(a){if(a.type==="pair")throw new Error("Invalid keywin: cannot be a pair window");let x=a;for(;(x=x?.parent)&&x!==e;);if(!x)throw new Error("keywin must be a descendent")}let u=r&15,c=u===0||u===1;if(a||(a=e.key),c&&!e.vertical)throw new Error("Invalid method: split must stay horizontal");if(!c&&e.vertical)throw new Error("Invalid method: split must stay vertical");let d=(r&240)===16;if(a.type==="blank"&&d)throw new Error("Invalid method: blank windows cannot be only be split proportionally");let y=u===0||u===2;if(y!==e.backward){let x=e.child1;e.child1=e.child2,e.child2=x}e.backward=y,e.border=(r&256)===256,e.dir=u,e.fixed=d,e.key=a,e.size=i,e.vertical=c,this.rearrange_window(e,e.box)}glk_window_set_background_color(e,r){if(!e)throw new Error("Invalid Window");if(e.type!=="graphics")throw new Error("Invalid Window: not a graphics window");e.draw.push({color:Er(r),special:"setcolor"})}glk_window_set_echo_stream(e,r){if(!e)throw new Error("Invalid Window");e.echostr=r}garglk_set_reversevideo(e){this.garglk_set_reversevideo_stream(this.current_stream,e)}garglk_set_reversevideo_stream(e,r){if(!e)throw new Error("Invalid Stream");e.type==="window"&&e.set_css("reverse",r?1:void 0)}garglk_set_zcolors(e,r){this.garglk_set_zcolors_stream(this.current_stream,e,r)}garglk_set_zcolors_stream(e,r,i){if(!e)throw new Error("Invalid Stream");e.type==="window"&&(r!==-2&&e.set_css("color",r===-1?void 0:Er(r)),i!==-2&&e.set_css("background-color",i===-1?void 0:Er(i)))}accept(e){if(this.exited)return this.GlkOte.log("GlkApi has exited");if(e.gen!==this.gen)return this.GlkOte.log(`Input event has wrong generation number: expected ${this.gen}, received ${e.gen}`);if(this.gen++,!this.selectref&&e.type!=="init"&&e.type!=="specialresponse")return;this.partial_inputs=e.partial;let r=0,i=null,a=0,u=0,c;if("window"in e)for(i=this.first_window;i&&i.disprock!==e.window;i=i.next);switch(e.type){case"init":this.metrics=$l(e.metrics),this.support=e.support,this.VM.start();return;case"arrange":this.metrics=$l(e.metrics),this.root_window&&this.rearrange_window(this.root_window,{bottom:this.metrics.height,left:0,right:this.metrics.width,top:0}),r=5;break;case"char":if(i?.input.type!=="char")return;delete i.input.type,r=2,e.value.length===1?(a=e.value.codePointAt(0),!i.uni_input&&a>rt&&(a=it)):a=Il[e.value]??4294967295;break;case"hyperlink":if(!i?.input.hyperlink)return;delete i.input.hyperlink,r=8,a=e.value;break;case"line":if(i?.input.type!=="line")return;this.handle_line_input(i,e.value,this.selectref,e.terminator),this.GiDispa?.prepare_resume(this.selectref),delete this.selectref;break;case"mouse":if(!i?.input.mouse)return;delete i.input.mouse,r=4,a=e.x,u=e.y;break;case"redraw":r=6;break;case"specialresponse":{if(e.response!=="fileref_prompt")throw new Error("Unknown type of specialresponse event");let d=e.value;if(typeof d=="string")throw new Error("AsyncGlk no longer supports bare-string filenames from Dialog");d&&(c=this.create_fileref(d.filename,this.special_data.rock,this.special_data.usage,d));break}case"timer":r=1,this.timer.started=Date.now();break;default:throw new Error(`Event type ${e.type} not supported by AsyncGlk`)}this.selectref&&(Ji(this.selectref,r,i,a,u),this.GiDispa?.prepare_resume(this.selectref),delete this.selectref),this.VM.resume(c)}create_fileref(e,r,i,a){if(!a){let c=i&15,d=c===1?this.VM.get_signature():void 0;a=this.Dialog.file_construct_ref(e,Oi[c]??"xxx",d)}let u=new Gi(this.Dialog,e,a,r,i);return u.next=this.first_fref,this.first_fref=u,u.next&&(u.next.prev=u),this.GiDispa?.class_register("fileref",u),u}create_file_stream(e,r,i,a){if(!e)throw new Error("Invalid Fileref");if(r!==1&&r!==2&&r!==3&&r!==5)throw new Error("Invalid filemode");if(r===2&&!e.exists())return null;let u=null;r!==1&&(u=e.read()),u||(u=new Uint8Array(0),e.write(u));let c=Ll(u,e.binary,r,i,a,e);return r===5&&c.set_position(2,0),this.register_stream(c),c}create_memory_stream(e,r,i,a){if(r!==2&&r!==1&&r!==3)throw new Error("Illegal filemode");let u;if(e){let c=()=>this.GiDispa?.unretain_array(e);if(Array.isArray(e)){let d=a.from(e);r===2?u=new nt(d,r,i,c):u=new nt(d,r,i,()=>{kr(d,e,e.length),c()})}else u=new nt(e,r,i,c);this.GiDispa?.retain_array(e)}else u=new Wi(r,i);return this.register_stream(u),u}create_resource_stream(e,r,i){if(!this.Blorb)return null;let a=this.Blorb.get_data_chunk(e);if(!a)return null;let u=Ll(a.data,a.binary,2,r,i);return this.register_stream(u),u}draw_image(e,r,i,a,u,c){let d={alttext:r.alttext,height:i,image:r.image,special:"image",url:r.url,width:c};switch(e.type){case"buffer":return d.alignment=Ql[a]??"inlineup",e.put_image(d),1;case"graphics":return d.x=a,d.y=u,e.draw.push(d),1}return 0}handle_line_input(e,r,i,a){e.request_echo_line_input&&(e.put_string(r+`
`,"input"),e.echostr&&e.echostr.put_string(r+`
`,"input")),r.length>e.line_input_buf.length&&(r=r.slice(0,e.line_input_buf.length)),e.uni_input||(r=r.replace(/[^\x00-\xff]/g,"?"));let u=Uint32Array.from(r,d=>d.codePointAt(0));Array.isArray(e.line_input_buf)?kr(u,e.line_input_buf,r.length):e.line_input_buf?.set(u);let c=Gl[a]??0;i&&Ji(i,3,e,r.length,c),this.GiDispa?.unretain_array(e.line_input_buf),delete e.input.type,delete e.line_input_buf}rearrange_window(e,r){let i=this.metrics;this.windows_changed=!0,e.box=r;let a=r.bottom-r.top,u=r.right-r.left;switch(e.type){case"graphics":{e.height=Kt(a-i.graphicsmarginy),e.width=Kt(u-i.graphicsmarginx);break}case"grid":{let c=Kt((a-i.gridmarginy)/i.gridcharheight),d=Kt((u-i.gridmarginx)/i.gridcharwidth);e.update_size(c,d);break}case"pair":{let c,d,y;e.vertical?(c=r.left,d=r.right,y=i.inspacingx):(c=r.top,d=r.bottom,y=i.inspacingy),e.border||(y=0);let x=d-c,b=0;if(e.fixed){switch(e.key.type){case"buffer":e.vertical?b=e.size?e.size*i.buffercharwidth+i.buffermarginx:0:b=e.size?e.size*i.buffercharheight+i.buffermarginy:0;break;case"graphics":b=e.size?e.size+(e.vertical?i.graphicsmarginx:i.graphicsmarginy):0;break;case"grid":e.vertical?b=e.size?e.size*i.gridcharwidth+i.gridmarginx:0:b=e.size?e.size*i.gridcharheight+i.gridmarginy:0;break}b=Math.ceil(b)}else b=Math.floor(x*e.size/100);e.backward?b=c+b:b=d-b-y,c>=d?b=c:b=Math.min(Math.max(b,c),d-y);let F,U;e.vertical?(F={bottom:r.bottom,left:r.left,right:b,top:r.top},U={bottom:r.bottom,left:b+y,right:r.right,top:r.top}):(F={bottom:b,left:r.left,right:r.right,top:r.top},U={bottom:r.bottom,left:r.left,right:r.right,top:b+y}),this.rearrange_window(e.child1,e.backward?U:F),this.rearrange_window(e.child2,e.backward?F:U);break}}}register_stream(e){e.next=this.first_stream,this.first_stream=e,e.next&&(e.next.prev=e),this.GiDispa?.class_register("stream",e)}register_window(e){this.windows_changed=!0,e.next=this.first_window,this.first_window=e,e.next&&(e.next.prev=e),this.GiDispa?this.GiDispa?.class_register("window",e):e.disprock=this.disprock_counter++,e.input.id=e.disprock,this.register_stream(e.str)}remove_window(e,r){this.windows_changed=!0,this.GiDispa&&"line_input_buf"in e&&e.line_input_buf&&(this.GiDispa.unretain_array(e.line_input_buf),delete e.line_input_buf),e.type==="pair"&&(r&&(this.remove_window(e.child1,!0),this.remove_window(e.child2,!0)),e.child1=null,e.child2=null,e.key=null),this.unregister_stream(e.str),e.echostr=null,e.parent=null,this.GiDispa?.class_unregister("window",e);let i=e.prev,a=e.next;e.prev=null,e.next=null,i?i.next=a:this.first_window=a,a&&(a.prev=i)}request_char_event(e,r){if(!e)throw new Error("Invalid Window");if(e.input.type)throw new Error("Window already has keyboard request");if(e.type==="blank"||e.type==="pair")throw new Error("Window does not support character input");e.input.gen=this.gen,e.input.type="char",e.uni_input=r}request_line_event(e,r,i,a){if(!e)throw new Error("Invalid Window");if(e.input.type)throw new Error("Window already has keyboard request");if(e.type!=="buffer"&&e.type!=="grid")throw new Error("Window does not support line input");e.input.gen=this.gen,a&&(e.input.initial=String.fromCodePoint(...r.slice(0,a))),e.input.type="line",e.line_input_buf=r,e.type==="buffer"&&(e.request_echo_line_input=e.echo_line_input),e.uni_input=i,this.GiDispa?.retain_array(r)}unregister_stream(e){this.current_stream===e&&(this.current_stream=null),this.GiDispa?.class_unregister("stream",e);let r=e.prev,i=e.next;e.prev=null,e.next=null,r?r.next=i:this.first_stream=i,i&&(i.prev=r)}};function Sr(n,e,r,i){let a=Array.isArray(n)?n.slice(0,e):n.subarray(0,e),u=i?a:a.reduce((x,b)=>x+String.fromCodePoint(b),""),c=r(u),d=Uint32Array.from(c,x=>x.codePointAt(0)),y=d.length;return Array.isArray(n)?kr(d,n,y):n.set(d.subarray(0,Math.min(n.length,y))),y}function Er(n){return"#"+(n&16777215).toString(16).toUpperCase().padStart(6,"0")}function Ll(n,e,r,i,a,u){let c;if(a)if(e)c=El(n);else{let d=Mt.decode(n);c=Uint32Array.from(d,y=>y.codePointAt(0))}else c=n;return r===2?new nt(c,r,i):new Mi(u,c,r,i)}function Ml(n){return new Date(n.get_field(0),n.get_field(1)-1,n.get_field(2),n.get_field(4),n.get_field(5),n.get_field(6),n.get_field(7)/1e3).getTime()}function Wl(n){let e=new Date(0);return e.setUTCFullYear(n.get_field(0)),e.setUTCMonth(n.get_field(1)-1),e.setUTCDate(n.get_field(2)),e.setUTCHours(n.get_field(4)),e.setUTCMinutes(n.get_field(5)),e.setUTCSeconds(n.get_field(6)),e.setUTCMilliseconds(n.get_field(7)/1e3),e.getTime()}function $l(n){let e=Object.assign({},gr),r;if(r=n.charheight,r!==void 0&&(e.buffercharheight=r,e.gridcharheight=r),r=n.charwidth,r!==void 0&&(e.buffercharwidth=r,e.gridcharwidth=r),r=n.margin,r!==void 0&&(e.buffermarginx=r,e.buffermarginy=r,e.graphicsmarginx=r,e.graphicsmarginy=r,e.gridmarginx=r,e.gridmarginy=r),r=n.buffermargin,r!==void 0&&(e.buffermarginx=r,e.buffermarginy=r),r=n.graphicsmargin,r!==void 0&&(e.graphicsmarginx=r,e.graphicsmarginy=r),r=n.gridmargin,r!==void 0&&(e.gridmarginx=r,e.gridmarginy=r),r=n.marginx,r!==void 0&&(e.buffermarginx=r,e.graphicsmarginx=r,e.gridmarginx=r),r=n.marginy,r!==void 0&&(e.buffermarginy=r,e.graphicsmarginy=r,e.gridmarginy=r),r=n.spacing,r!==void 0&&(e.inspacingx=r,e.inspacingy=r),r=n.inspacing,r!==void 0&&(e.inspacingx=r,e.inspacingy=r),r=n.spacingx,r!==void 0&&(e.inspacingx=r),r=n.spacingy,r!==void 0&&(e.inspacingy=r),Object.assign(e,n),n.outspacing||e.outspacingx||e.outspacingy)throw new Error("AsyncGlk requires that outspacing metrics be 0");return e}function Kt(n){return Math.max(0,Math.floor(n))}function Ji(n,e=0,r=null,i=0,a=0){n.set_field(0,e),n.set_field(1,r),n.set_field(2,i),n.set_field(3,a)}function Nl(n,e){let r=new Date(n);e.set_field(0,r.getFullYear()),e.set_field(1,r.getMonth()+1),e.set_field(2,r.getDate()),e.set_field(3,r.getDay()),e.set_field(4,r.getHours()),e.set_field(5,r.getMinutes()),e.set_field(6,r.getSeconds()),e.set_field(7,r.getMilliseconds()*1e3)}function Pl(n,e){let r=new Date(n);e.set_field(0,r.getUTCFullYear()),e.set_field(1,r.getUTCMonth()+1),e.set_field(2,r.getUTCDate()),e.set_field(3,r.getUTCDay()),e.set_field(4,r.getUTCHours()),e.set_field(5,r.getUTCMinutes()),e.set_field(6,r.getUTCSeconds()),e.set_field(7,r.getUTCMilliseconds()*1e3)}function Xo(n,e){e.set_field(0,Math.floor(n/4294967296e3)),e.set_field(1,Math.floor(n/1e3)>>>0);let r=Math.floor(n%1e3*1e3);r<0&&(r+=1e6),e.set_field(2,r)}function jl(n){return n.get_field(0)*4294967296e3+n.get_field(1)*1e3+n.get_field(2)/1e3}function Yi(n,e,r){let i=new e(n.length),a=r(i);return kr(i,n,a),a}var Br=class{constructor(){this.classname="GlkOte";this.version=mi;this.accept_func=()=>{};this.autorestoring=!1;this.current_metrics=Object.assign({},gr);this.disabled=!1;this.generation=0;this.is_inited=!1;this.options={};this.timer=null;this.waiting_for_update=!1}async init(e){if(!e)return this.error("no options provided");if(!e.accept)return this.error("an accept function was not given to GlkOte");this.options=e,this.accept_func=e.accept,e.Blorb&&(this.Blorb=e.Blorb),e.Dialog&&(this.Dialog=e.Dialog),this.is_inited=!0,this.send_event({type:"init"})}error(e){throw typeof e=="string"?new Error(e):e}extevent(e){this.send_event({type:"external",value:e})}getdomcontext(){throw new Error("getdomcontext is not applicable to this GlkOte library")}getdomid(e){throw new Error("getdomid is not applicable to this GlkOte library")}getinterface(){return this.options}getlibrary(e){switch(e){case"Blorb":return this.Blorb;case"Dialog":return this.Dialog;default:return null}}inited(){return this.is_inited}log(e){console.log(e)}setdomcontext(e){throw new Error("setdomcontext is not applicable to this GlkOte library")}update(e){try{if(this.autorestoring=!1,this.waiting_for_update=!1,e.type==="error")return this.error(e.message);if(e.type==="pass")return;if(e.type==="retry"){setTimeout(()=>this.send_event({type:"refresh"}),2e3);return}if(e.type!=="update")return this.error(`Unknown update type: ${e.type}`);if(e.gen===this.generation){this.log(`Ignoring repeated generation number: ${e.gen}`);return}this.generation=e.gen,this.disabled&&this.disable(!1),e.input&&this.cancel_inputs(e.input),e.windows&&this.update_windows(e.windows),e.content&&this.update_content(e.content),e.input&&this.update_inputs(e.input),e.timer!==void 0&&(this.timer&&(clearInterval(this.timer),this.timer=null),e.timer&&(this.timer=setInterval(()=>this.ontimer(),e.timer))),e.specialinput&&this.handle_specialinput(e.specialinput),this.disabled=!1,(e.disable||e.specialinput)&&this.disable(!0),e.autorestore&&(this.autorestoring=!0,this.autorestore(e.autorestore)),typeof e.page_margin_bg<"u"&&this.options.set_body_to_page_bg&&this.set_page_bg(e.page_margin_bg),e.disable&&this.exit()}catch(r){this.error(r)}}warning(e){console.warn(e)}autorestore(e){}capabilities(){return["timer"]}exit(){}handle_specialinput(e){if(e.type==="fileref_prompt"){let r=i=>this.send_event({type:"specialresponse",response:"fileref_prompt",value:i});try{this.Dialog?this.Dialog.async?this.Dialog.prompt(Vn(e.filetype),e.filemode!=="read").then(i=>{r(i?{filename:i}:null)}):this.Dialog.open(e.filemode!=="read",e.filetype,e.gameid,r):setTimeout(()=>r(null),0)}catch(i){this.log(`Unable to open file dialog: ${i}`),setTimeout(()=>r(null),0)}}else this.error(`Request for unknown special input type: ${e.type}`)}ontimer(){!this.disabled&&this.timer&&this.send_event({type:"timer"})}save_allstate(){}send_event(e){if(!(this.disabled&&e.type!=="specialresponse")){if(this.waiting_for_update){console.log("Trying to send event when waiting for input",e);return}switch(this.waiting_for_update=!0,e.gen=this.generation,e.type){case"arrange":e.metrics=this.current_metrics;break;case"init":e.metrics=this.current_metrics,e.support=this.capabilities();break;case"specialresponse":e.response="fileref_prompt";break}this.accept_func(e)}}set_page_bg(e){}};var t7=jc(zl(),1);function Ue(n){if(typeof n!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(n))}function ql(n,e){for(var r="",i=0,a=-1,u=0,c,d=0;d<=n.length;++d){if(d<n.length)c=n.charCodeAt(d);else{if(c===47)break;c=47}if(c===47){if(!(a===d-1||u===1))if(a!==d-1&&u===2){if(r.length<2||i!==2||r.charCodeAt(r.length-1)!==46||r.charCodeAt(r.length-2)!==46){if(r.length>2){var y=r.lastIndexOf("/");if(y!==r.length-1){y===-1?(r="",i=0):(r=r.slice(0,y),i=r.length-1-r.lastIndexOf("/")),a=d,u=0;continue}}else if(r.length===2||r.length===1){r="",i=0,a=d,u=0;continue}}e&&(r.length>0?r+="/..":r="..",i=2)}else r.length>0?r+="/"+n.slice(a+1,d):r=n.slice(a+1,d),i=d-a-1;a=d,u=0}else c===46&&u!==-1?++u:u=-1}return r}function Sh(n,e){var r=e.dir||e.root,i=e.base||(e.name||"")+(e.ext||"");return r?r===e.root?r+i:r+n+i:i}var de={process_cwd:"",setCWD:function(e){de.process_cwd=e},resolve:function(){for(var e="",r=!1,i,a=arguments.length-1;a>=-1&&!r;a--){var u;a>=0?u=arguments[a]:(i===void 0&&(i=de.process_cwd),u=i),Ue(u),u.length!==0&&u+"/"!==e&&(e=u+"/"+e,r=u.charCodeAt(0)===47)}return e=ql(e,!r),r?e.length>0?"/"+e:"/":e.length>0?e:"."},normalize:function(e){if(Ue(e),e.length===0)return".";var r=e.charCodeAt(0)===47,i=e.charCodeAt(e.length-1)===47;return e=ql(e,!r),e.length===0&&!r&&(e="."),e.length>0&&i&&(e+="/"),r?"/"+e:e},isAbsolute:function(e){return Ue(e),e.length>0&&e.charCodeAt(0)===47},join:function(){if(arguments.length===0)return".";for(var e,r=0;r<arguments.length;++r){var i=arguments[r];Ue(i),i.length>0&&(e===void 0?e=i:e+="/"+i)}return e===void 0?".":de.normalize(e)},relative:function(e,r){if(Ue(e),Ue(r),e===r)return"";let i=e.replaceAll("\\","/"),a=r.replaceAll("\\","/");if(i!=e&&a!=r)return de.relative(i,a).replaceAll("/","\\");if(i!=e)return de.relative(i,r).replaceAll("/","\\");if(a!=r)return de.relative(e,a);if(e=de.resolve(e),r=de.resolve(r),e===r)return"";for(var u=1;u<e.length&&e.charCodeAt(u)===47;++u);for(var c=e.length,d=c-u,y=1;y<r.length&&r.charCodeAt(y)===47;++y);for(var x=r.length,b=x-y,F=d<b?d:b,U=-1,C=0;C<=F;++C){if(C===F){if(b>F){if(r.charCodeAt(y+C)===47)return r.slice(y+C+1);if(C===0)return r.slice(y+C)}else d>F&&(e.charCodeAt(u+C)===47?U=C:C===0&&(U=0));break}var M=e.charCodeAt(u+C),z=r.charCodeAt(y+C);if(M!==z)break;M===47&&(U=C)}var W="";for(C=u+U+1;C<=c;++C)(C===c||e.charCodeAt(C)===47)&&(W.length===0?W+="..":W+="/..");return W.length>0?W+r.slice(y+U):(y+=U,r.charCodeAt(y)===47&&++y,r.slice(y))},_makeLong:function(e){return e},dirname:function(e){if(Ue(e),e.length===0)return".";for(var r=e.charCodeAt(0),i=r===47,a=-1,u=!0,c=e.length-1;c>=1;--c)if(r=e.charCodeAt(c),r===47){if(!u){a=c;break}}else u=!1;return a===-1?i?"/":".":i&&a===1?"//":e.slice(0,a)},basename:function(e,r){if(r!==void 0&&typeof r!="string")throw new TypeError('"ext" argument must be a string');Ue(e);var i=0,a=-1,u=!0,c;if(r!==void 0&&r.length>0&&r.length<=e.length){if(r.length===e.length&&r===e)return"";var d=r.length-1,y=-1;for(c=e.length-1;c>=0;--c){var x=e.charCodeAt(c);if(x===47){if(!u){i=c+1;break}}else y===-1&&(u=!1,y=c+1),d>=0&&(x===r.charCodeAt(d)?--d===-1&&(a=c):(d=-1,a=y))}return i===a?a=y:a===-1&&(a=e.length),e.slice(i,a)}else{for(c=e.length-1;c>=0;--c)if(e.charCodeAt(c)===47){if(!u){i=c+1;break}}else a===-1&&(u=!1,a=c+1);return a===-1?"":e.slice(i,a)}},extname:function(e){Ue(e);for(var r=-1,i=0,a=-1,u=!0,c=0,d=e.length-1;d>=0;--d){var y=e.charCodeAt(d);if(y===47){if(!u){i=d+1;break}continue}a===-1&&(u=!1,a=d+1),y===46?r===-1?r=d:c!==1&&(c=1):r!==-1&&(c=-1)}return r===-1||a===-1||c===0||c===1&&r===a-1&&r===i+1?"":e.slice(r,a)},format:function(e){if(e===null||typeof e!="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof e);return Sh("/",e)},parse:function(e){Ue(e);var r={root:"",dir:"",base:"",ext:"",name:""};if(e.length===0)return r;var i=e.charCodeAt(0),a=i===47,u;a?(r.root="/",u=1):u=0;for(var c=-1,d=0,y=-1,x=!0,b=e.length-1,F=0;b>=u;--b){if(i=e.charCodeAt(b),i===47){if(!x){d=b+1;break}continue}y===-1&&(x=!1,y=b+1),i===46?c===-1?c=b:F!==1&&(F=1):c!==-1&&(F=-1)}return c===-1||y===-1||F===0||F===1&&c===y-1&&c===d+1?y!==-1&&(d===0&&a?r.base=r.name=e.slice(1,y):r.base=r.name=e.slice(d,y)):(d===0&&a?(r.name=e.slice(1,c),r.base=e.slice(1,y)):(r.name=e.slice(d,c),r.base=e.slice(d,y)),r.ext=e.slice(c,y)),d>0?r.dir=e.slice(0,d-1):a&&(r.dir="/"),r},sep:"/",delimiter:":",win32:null,posix:null};de.posix=de;var rs=typeof window<"u"?window:typeof globalThis<"u"?globalThis:global;var Xi=class n{_listeners="WeakMap"in rs?new WeakMap:void 0;_observer=void 0;options;constructor(e){this.options=e}observe(e,r){return this._listeners.set(e,r),this._getObserver().observe(e,this.options),()=>{this._listeners.delete(e),this._observer.unobserve(e)}}_getObserver(){return this._observer??(this._observer=new ResizeObserver(e=>{for(let r of e)n.entries.set(r.target,r),this._listeners.get(r.target)?.(r)}))}};Xi.entries="WeakMap"in rs?new WeakMap:void 0;function ot(n,e,r){n.insertBefore(e,r||null)}function Ge(n){n.parentNode&&n.parentNode.removeChild(n)}function bt(n){return document.createElement(n)}function st(n,e,r){r==null?n.removeAttribute(e):n.getAttribute(e)!==r&&n.setAttribute(e,r)}function Vl(n){let e={};return n.childNodes.forEach(r=>{e[r.slot||"default"]=!0}),e}var Oh=["allowfullscreen","allowpaymentrequest","async","autofocus","autoplay","checked","controls","default","defer","disabled","formnovalidate","hidden","inert","ismap","loop","multiple","muted","nomodule","novalidate","open","playsinline","readonly","required","reversed","selected"],Lh=new Set([...Oh]);var $h;typeof HTMLElement=="function"&&($h=class extends HTMLElement{$$ctor;$$s;$$c;$$cn=!1;$$d={};$$r=!1;$$p_d={};$$l={};$$l_u=new Map;constructor(n,e,r){super(),this.$$ctor=n,this.$$s=e,r&&this.attachShadow({mode:"open"})}addEventListener(n,e,r){if(this.$$l[n]=this.$$l[n]||[],this.$$l[n].push(e),this.$$c){let i=this.$$c.$on(n,e);this.$$l_u.set(e,i)}super.addEventListener(n,e,r)}removeEventListener(n,e,r){if(super.removeEventListener(n,e,r),this.$$c){let i=this.$$l_u.get(e);i&&(i(),this.$$l_u.delete(e))}}async connectedCallback(){if(this.$$cn=!0,!this.$$c){let n=function(a){return()=>{let u;return{c:function(){u=bt("slot"),a!=="default"&&st(u,"name",a)},m:function(y,x){ot(y,u,x)},d:function(y){y&&Ge(u)}}}};if(await Promise.resolve(),!this.$$cn||this.$$c)return;let e={},r=Vl(this);for(let a of this.$$s)a in r&&(e[a]=[n(a)]);for(let a of this.attributes){let u=this.$$g_p(a.name);u in this.$$d||(this.$$d[u]=os(u,a.value,this.$$p_d,"toProp"))}for(let a in this.$$p_d)!(a in this.$$d)&&this[a]!==void 0&&(this.$$d[a]=this[a],delete this[a]);this.$$c=new this.$$ctor({target:this.shadowRoot||this,props:{...this.$$d,$$slots:e,$$scope:{ctx:[]}}});let i=()=>{this.$$r=!0;for(let a in this.$$p_d)if(this.$$d[a]=this.$$c.$$.ctx[this.$$c.$$.props[a]],this.$$p_d[a].reflect){let u=os(a,this.$$d[a],this.$$p_d,"toAttribute");u==null?this.removeAttribute(this.$$p_d[a].attribute||a):this.setAttribute(this.$$p_d[a].attribute||a,u)}this.$$r=!1};this.$$c.$$.after_update.push(i),i();for(let a in this.$$l)for(let u of this.$$l[a]){let c=this.$$c.$on(a,u);this.$$l_u.set(u,c)}this.$$l={}}}attributeChangedCallback(n,e,r){this.$$r||(n=this.$$g_p(n),this.$$d[n]=os(n,r,this.$$p_d,"toProp"),this.$$c?.$set({[n]:this.$$d[n]}))}disconnectedCallback(){this.$$cn=!1,Promise.resolve().then(()=>{!this.$$cn&&this.$$c&&(this.$$c.$destroy(),this.$$c=void 0)})}$$g_p(n){return Object.keys(this.$$p_d).find(e=>this.$$p_d[e].attribute===n||!this.$$p_d[e].attribute&&e.toLowerCase()===n)||n}});function os(n,e,r,i){let a=r[n]?.type;if(e=a==="Boolean"&&typeof e!="boolean"?e!=null:e,!i||!r[n])return e;if(i==="toAttribute")switch(a){case"Object":case"Array":return e==null?null:JSON.stringify(e);case"Boolean":return e?"":null;case"Number":return e??null;default:return e}else switch(a){case"Object":case"Array":return e&&JSON.parse(e);case"Boolean":return e;case"Number":return e!=null?+e:e;default:return e}}var Kl="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(Kl);var Kh=["\u04A0\u04BF\u0500\u051F\u0680\u06BF\u0760\u079F\u07C0\u07DF\u1000\u101F\u10A0\u10BF\u1100\u115F\u1180\u119F\u11E0\u123F\u1260\u127F\u12E0\u12FF\u1320\u133F\u13A0\u13DF\u1420\u165F\u16A0\u16DF\u1780\u179F\u1820\u185F\u18C0\u18DF\u1980\u199F\u19E0\u19FF\u1A20\u1A3F\u1BC0\u1BDF\u1C00\u1C1F\u1D00\u1D1F\u21E0\u21FF\u22C0\u22DF\u2340\u23DF\u2400\u241F\u2500\u275F\u2780\u27BF\u2800\u297F\u29A0\u29BF\u2A20\u2A5F\u2A80\u2ABF\u2AE0\u2B5F\u2C00\u2C1F\u2C80\u2CDF\u2D00\u2D1F\u2D40\u2D5F\u2EA0\u2EDF\u31C0\u31DF\u3400\u4D9F\u4DC0\u9FBF\uA000\uA47F\uA4A0\uA4BF\uA500\uA5FF\uA640\uA65F\uA6A0\uA6DF\uA700\uA75F\uA780\uA79F\uA840\uA85F","\u0180\u019F\u0240\u029F"],an={},ss={};Kh.forEach((n,e)=>{let r=[];n.match(/../gu).forEach(a=>{let u=a.codePointAt(0),c=a.codePointAt(1);for(let d=u;d<=c;d++)r.push(String.fromCodePoint(d))});let i=15-8*e;an[i]=r,r.forEach((a,u)=>{ss[a]=[i,u]})});var Be=n=>{let e=n.length,r="",i=0,a=0;for(let u=0;u<e;u++){let c=n[u];for(let d=7;d>=0;d--){let y=c>>d&1;i=(i<<1)+y,a++,a===15&&(r+=an[a][i],i=0,a=0)}}if(a!==0){for(;!(a in an);)i=(i<<1)+1,a++;r+=an[a][i]}return r},Rr=n=>{let e=n.length,r=new Uint8Array(Math.floor(e*15/8)),i=0,a=0,u=0;for(let c=0;c<e;c++){let d=n.charAt(c);if(!(d in ss))throw new Error(`Unrecognised Base32768 character: ${d}`);let[y,x]=ss[d];if(y!==15&&c!==e-1)throw new Error("Secondary character found before end of input at position "+String(c));for(let b=y-1;b>=0;b--){let F=x>>b&1;a=(a<<1)+F,u++,u===8&&(r[i]=a,i++,a=0,u=0)}}if(a!==(1<<u)-1)throw new Error("Padding mismatch");return new Uint8Array(r.buffer,0,i)};function pe(n,e){return $(`<${n}>`,{class:e})}var ln=class{constructor(e){this.context_element=e.context_element,this.errorcontent_id=e.errorcontent_id,this.errorpane_id=e.errorpane_id,this.gameport_id=e.gameport_id,this.loadingpane_id=e.loadingpane_id,this.prefix=e.prefix,this.windowport_id=e.windowport_id}create(e,r,i){return i??={},typeof i=="string"&&(i={class:i}),i.id=this.prefix+r,$(`<${e}>`,i)}gameport(){return $(`#${this.gameport_id}`,this.context_element)}id(e){return $(`#${this.prefix}${e}`,this.context_element)}windowport(){return $(`#${this.windowport_id}`,this.context_element)}};function fn(){let n=document.activeElement?.tagName;return n==="INPUT"||n==="TEXTAREA"}var we=/iPad|iPhone|iPod/.test(navigator.platform)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1;function Ae(n){return{height:n.outerHeight(),width:n.outerWidth()}}function r7(n,e){return e.buffercharheight!==n.buffercharheight||e.buffercharwidth!==n.buffercharwidth||e.gridcharheight!==n.gridcharheight||e.gridcharwidth!==n.gridcharwidth||e.height!==n.height||e.width!==n.width}var Qr=class{constructor(e){this.height_with_keyboard=(visualViewport?.height||window.innerHeight)/2;this.on_gameport_resize=pi(async()=>{if(this.glkote.disabled||!this.glkote.inited()){this.on_gameport_resize();return}let e=Object.assign({},this.metrics);await this.measure(),r7(this.metrics,e)&&this.glkote.send_event({type:"arrange"})},200,{leading:!1});this.on_visualViewport_resize=()=>{let e=visualViewport.height;fn()&&(this.height_with_keyboard=e),this.set_gameport_height(e)};this.glkote=e,this.metrics=e.current_metrics,document.readyState==="complete"?this.loaded=Promise.resolve():this.loaded=new Promise(r=>{window.addEventListener("load",r,{once:!0})}),window.ResizeObserver?(this.observer=new ResizeObserver(this.on_gameport_resize),this.observer.observe(this.glkote.dom.gameport()[0])):$(window).on("resize",this.on_gameport_resize),we&&(this.on_visualViewport_resize=pi(this.on_visualViewport_resize,700)),visualViewport&&$(visualViewport).on("resize",this.on_visualViewport_resize)}destroy(){this.observer?this.observer.disconnect():$(window).off("resize",this.on_gameport_resize),visualViewport&&$(visualViewport).off("resize",this.on_visualViewport_resize)}async measure(){let e=this.glkote.dom,r=e.gameport();if(!r.length)throw new Error(`Cannot find gameport element #${e.gameport_id}`);e.id("layouttestpane").remove();let i=e.create("div","layout_test_pane");i.text("This should not be visible");let a=$("<div>");pe("span","Style_normal").text("12345678").appendTo(a);let u=pe("div","WindowFrame BufferWindow"),c=pe("div","BufferWindowInner").appendTo(u),d=a.clone().addClass("BufferLine").appendTo(c),y=a.clone().addClass("BufferLine").appendTo(c);pe("span","InvisibleCursor").appendTo(y);let x=d.children("span");i.append(u);let b=pe("div","WindowFrame GraphicsWindow"),F=$("<canvas>",{height:32,width:64}).appendTo(b);i.append(b);let U=pe("div","WindowFrame GridWindow"),C=a.clone().addClass("GridLine").appendTo(U),M=a.clone().addClass("GridLine").appendTo(U),z=C.children("span");i.append(U),r.append(i),await this.loaded;let W=getComputedStyle(U[0]).getPropertyValue("--glkote-grid-mono-family").split(",")[0].replace(/"/g,"");await document.fonts.load(`14px ${W}`),this.metrics.height=r.height(),this.metrics.width=r.width();let I=Ae(u),Oe=Ae(x),Le=Ae(d),Me=Ae(y);this.metrics.buffercharheight=Math.max(1,y.position().top-d.position().top),this.metrics.buffercharwidth=Math.max(1,x.width()/8),this.metrics.buffermarginx=I.width-Oe.width,this.metrics.buffermarginy=I.height-(Le.height+Me.height);let _e=Ae(b),j=Ae(F);this.metrics.graphicsmarginx=_e.width-j.width,this.metrics.graphicsmarginy=_e.height-j.height;let oe=Ae(U),me=Ae(z),We=Ae(C),he=Ae(M);this.metrics.gridcharheight=Math.max(1,M.position().top-C.position().top),this.metrics.gridcharwidth=Math.max(1,z.width()/8),this.metrics.gridmarginx=oe.width-me.width,this.metrics.gridmarginy=oe.height-(We.height+he.height),i.remove()}set_gameport_height(e){_t()||(e||(e=this.height_with_keyboard),this.glkote.dom.gameport().outerHeight(e,!0),window.scrollTo(0,0),this.on_gameport_resize())}};function i7(n){if(Array.isArray(n)){for(var e=0,r=Array(n.length);e<n.length;e++)r[e]=n[e];return r}else return Array.from(n)}var ls=!1;typeof window<"u"&&(as={get passive(){ls=!0}},window.addEventListener("testPassive",null,as),window.removeEventListener("testPassive",null,as));var as,un=typeof window<"u"&&window.navigator&&window.navigator.platform&&(/iP(ad|hone|od)/.test(window.navigator.platform)||window.navigator.platform==="MacIntel"&&window.navigator.maxTouchPoints>1),wt=[],cn=!1,Xl=-1,Ir=void 0,xt=void 0,Gr=void 0,ef=function(e){return wt.some(function(r){return!!(r.options.allowTouchMove&&r.options.allowTouchMove(e))})},dn=function(e){var r=e||window.event;return ef(r.target)||r.touches.length>1?!0:(r.preventDefault&&r.preventDefault(),!1)},n7=function(e){if(Gr===void 0){var r=!!e&&e.reserveScrollBarGap===!0,i=window.innerWidth-document.documentElement.clientWidth;if(r&&i>0){var a=parseInt(window.getComputedStyle(document.body).getPropertyValue("padding-right"),10);Gr=document.body.style.paddingRight,document.body.style.paddingRight=a+i+"px"}}Ir===void 0&&(Ir=document.body.style.overflow,document.body.style.overflow="hidden")},o7=function(){Gr!==void 0&&(document.body.style.paddingRight=Gr,Gr=void 0),Ir!==void 0&&(document.body.style.overflow=Ir,Ir=void 0)},s7=function(){return window.requestAnimationFrame(function(){if(xt===void 0){xt={position:document.body.style.position,top:document.body.style.top,left:document.body.style.left};var e=window,r=e.scrollY,i=e.scrollX,a=e.innerHeight;document.body.style.position="fixed",document.body.style.top=-r,document.body.style.left=-i,setTimeout(function(){return window.requestAnimationFrame(function(){var u=a-window.innerHeight;u&&r>=a&&(document.body.style.top=-(r+u))})},300)}})},a7=function(){if(xt!==void 0){var e=-parseInt(document.body.style.top,10),r=-parseInt(document.body.style.left,10);document.body.style.position=xt.position,document.body.style.top=xt.top,document.body.style.left=xt.left,window.scrollTo(r,e),xt=void 0}},l7=function(e){return e?e.scrollHeight-e.scrollTop<=e.clientHeight:!1},f7=function(e,r){var i=e.targetTouches[0].clientY-Xl;return ef(e.target)?!1:r&&r.scrollTop===0&&i>0||l7(r)&&i<0?dn(e):(e.stopPropagation(),!0)},tf=function(e,r){if(!e){console.error("disableBodyScroll unsuccessful - targetElement must be provided when calling disableBodyScroll on IOS devices.");return}if(!wt.some(function(a){return a.targetElement===e})){var i={targetElement:e,options:r||{}};wt=[].concat(i7(wt),[i]),un?s7():n7(r),un&&(e.ontouchstart=function(a){a.targetTouches.length===1&&(Xl=a.targetTouches[0].clientY)},e.ontouchmove=function(a){a.targetTouches.length===1&&f7(a,e)},cn||(document.addEventListener("touchmove",dn,ls?{passive:!1}:void 0),cn=!0))}};var rf=function(e){if(!e){console.error("enableBodyScroll unsuccessful - targetElement must be provided when calling enableBodyScroll on IOS devices.");return}wt=wt.filter(function(r){return r.targetElement!==e}),un&&(e.ontouchstart=null,e.ontouchmove=null,cn&&wt.length===0&&(document.removeEventListener("touchmove",dn,ls?{passive:!1}:void 0),cn=!1)),un?a7():o7()};var nf=25,pn=class{constructor(e){this.history_index=0;this.is_line=!1;this.refocused=!1;this.set_gameport_height=Qe(e=>{this.window.manager.glkote.metrics_calculator.set_gameport_height(e?window.innerHeight:0)},50);this.window=e,this.el=$("<textarea>",{"aria-hidden":"true",autocapitalize:"off",class:"Input",data:{window:e},on:{blur:()=>this.onblur(),focus:()=>this.onfocus(),input:r=>this.oninput(r),keydown:r=>this.onkeydown(r),keypress:r=>this.onkeypress(r)},rows:1}).prop("disabled",!0).appendTo(e.frameel)}destroy(){this.el.remove()}onblur(){we&&!fn()&&this.set_gameport_height(!0)}onfocus(){this.window.type==="buffer"&&!_t()&&this.window.scroll_to_bottom(),we&&this.set_gameport_height(!1)}oninput(e){if(!this.window.inputs?.type)return this.el.trigger("blur"),!1;if(this.window.inputs.type==="char"){let r=e.target.value[0];return this.submit_char(r),r===" "&&this.el.trigger("blur").trigger("focus"),!1}}onkeydown(e){if(!this.window.inputs?.type)return this.el.trigger("blur"),!1;let r=e.which;if(r){if(this.is_line){if(r===jn||r===qn){let i=this.window.manager.history,a;return r===jn&&this.history_index>0?(this.history_index--,a=1):r===qn&&this.history_index<i.length&&(this.history_index++,a=1),a&&this.el.val(this.history_index===0?"":i[this.history_index-1]),!1}else if(this.window.inputs.terminators){let i=Pn[r];if(this.window.inputs.terminators.includes(i))return this.submit_line(e.target.value,i),!1}}else{let i=Pn[r];if(i)return this.submit_char(i),!1}e.stopPropagation()}}onkeypress(e){if(!this.window.inputs?.type)return this.el.trigger("blur"),!1;let r=e.which;if(r)if(this.is_line){if(r===zn)return this.submit_line(e.target.value),!1}else{let i=r===zn?"return":String.fromCharCode(r);return this.submit_char(i),!1}}refocus(){if(!(this.refocused||document.activeElement===this.el[0])){if(this.refocused=!0,this.window.type==="buffer"&&this.window.innerel.outerHeight()-this.window.updatescrolltop>this.window.height_above_keyboard){we&&this.set_gameport_height(!0);return}this.el[0].focus({preventScroll:!0})}}reset(){this.history_index=0,this.refocused=!1,this.el.attr({"aria-hidden":"true",class:"Input"}).css({"background-color":"",color:"",left:Tl,top:"",width:""}).val("");let e=this.window.type==="buffer"?this.window.innerel:this.window.frameel;this.el.parent().is(e)||this.el.appendTo(e)}submit_char(e){this.window.send_text_event({type:"char",value:e})}submit_line(e,r){let i=this.window.manager.history;e&&e!==i[0]&&(i.unshift(e),i.length>nf&&(i.length=nf)),this.window.send_text_event({type:"line",terminator:r,value:e})}update(){this.reset();let e=this.window.inputs;if(!(e.type!=="char"&&e.type!=="line")){if(this.is_line=e.type==="line",this.el.attr({"aria-hidden":"false",maxlength:this.is_line?e.maxlen:1}).prop("disabled",!1).val(e.initial||""),this.is_line){if(this.window.type==="graphics")throw new Error(`Cannot request line input in graphics window ${this.window.id}`);this.el.addClass("LineInput")}switch(this.window.type){case"buffer":(this.window.lastline||this.window.innerel).append(this.el);break;case"grid":{let r=this.window.metrics;this.el.css({left:e.xpos*r.gridcharwidth+r.gridmarginx/2,top:e.ypos*r.gridcharheight+r.gridmarginy/2,width:(e.maxlen||1)*r.gridcharwidth});break}}if(this.window.type!=="graphics"){let r=this.window.last_run_styles;if(r){let i=!!r.reverse;this.el.toggleClass("reverse",i),fs(r,i,this.el)}}}}};function hn(){return window.getSelection()+""==""}var _n=class{constructor(e){this.desired=!0;this.blorb=e.blorb,this.dom=e.dom,this.id=e.id,this.manager=e.manager,this.metrics=e.metrics,this.type=e.type,this.frameel=this.dom.create("div",`window${e.id}`,{class:`WindowFrame ${p7[this.type]} WindowRock_${e.rock}`,click:r=>this.onclick(r)}).appendTo(this.dom.windowport()),this.textinput=new pn(this)}destroy(e){this.textinput.destroy(),e?this.frameel.remove():this.inputs=void 0}measure_height(){}onclick(e){if(this.inputs?.type&&hn())return this.textinput.el.trigger("focus"),!1}send_text_event(e){this.measure_height(),this.textinput.reset(),this.inputs.type=void 0,this.manager.active_window=this,e.window=this.id,this.manager.send_event(e)}};function fs(n,e,r){let i=Object.assign({},n);if(e){let a=i["background-color"],u=i.color;a?i.color=a:delete i.color,u?i["background-color"]=u:delete i["background-color"],delete i.reverse}r.css(i)}function u7(n){let e=[""],r=/\s/,i=!1;for(let a of n){let u=r.test(a);!u&&i&&e.unshift(""),e[0]+=a,i=u}return e.reverse(),e}var mn=class extends _n{constructor(e){super(e);let r=i=>this.onlink(i);this.frameel.on("click","a",function(){r(this)}),e.styles&&(this.styles=e.styles,this.add_stylehints())}add_stylehints(){let e=`#window${this.id}`,r={};if(this.styles){for(let[c,d]of Object.entries(this.styles)){let y=`${e} ${c}`.trim(),x=r[y]=Object.assign({},d);if(c){let b=x["background-color"],F=x.color;if(b||F){let U=r[`${y}.reverse`]={};b&&(U.color=b),F&&(U["background-color"]=F)}delete x.monospace,x.reverse&&(delete x["background-color"],delete x.color),delete x.reverse,Object.keys(x).length===0&&delete r[y]}}r[`${e} .Style_input`]&&(r[`${e} .LineInput`]=r[`${e} .Style_input`])}let i=r[`${e} .Style_normal`],a=this.bg||i?.["background-color"],u=this.fg||i?.color;(a||u)&&(r[e]||(r[e]={}),r[e]["background-color"]=a||`var(--glkote-${this.type}-bg)`,r[`${e}.reverse`]={"background-color":u||`var(--glkote-${this.type}-reverse-bg)`}),Object.keys(r).length&&(this.frameel.children("style").remove(),this.frameel.prepend(`<style>${Object.entries(r).map(c=>{let[d,y]=c;return`${d} {${Object.entries(y).map(x=>{let[b,F]=x;return`${b}: ${F}`}).join("; ")}}`}).join(`
`)}</style>`))}create_text_run(e,r){let i=e.style,a=e.css_styles?.monospace??this.styles?.[`.Style_${i}`]?.monospace,u="";typeof a<"u"&&(i==="preformatted"?a||(u=" proportional"):a&&(u=" monospace"));let c=e.css_styles?.reverse??this.styles?.[`.Style_${i}`]?.reverse,d=pe("span",`Style_${i}${c?" reverse":""}${u}`);e.css_styles&&fs(e.css_styles,!!c,d),typeof r>"u"&&(r=!!a||i==="preformatted");let y=r?$(u7(e.text).map(x=>d.clone().text(x)[0])):d.text(e.text);return e.hyperlink?$("<a>",{data:{glklink:e.hyperlink},href:"#"}).append(y):y}onlink(e){let r=$(e).data("glklink");if(r)return this.inputs?.hyperlink&&this.manager.send_event({type:"hyperlink",value:r,window:this.id}),!1}refresh_styles(e,r){let i;typeof e<"u"&&e!==this.bg&&(this.bg=e,i=1),typeof r<"u"&&r!==this.fg&&(this.fg=r,i=1),i&&this.add_stylehints()}},c7={inlinecenter:"ImageInlineCenter",inlinedown:"ImageInlineDown",inlineup:"ImageInlineUp",marginleft:"ImageMarginLeft",marginright:"ImageMarginRight"},us=class extends mn{constructor(r){super(r);this.type="buffer";this.is_scrolled_down=!0;this.updatescrolltop=0;this.onscroll=()=>{let r=this.frameel[0];this.is_scrolled_down=r.scrollHeight-r.scrollTop-r.clientHeight<1};this.frameel.attr({"aria-live":"polite",role:"log",tabindex:-1}).on("scroll",this.onscroll),we&&tf(this.frameel[0]),this.innerel=pe("div","BufferWindowInner").append(this.textinput.el).appendTo(this.frameel),this.height_above_keyboard=this.frameel.height()}destroy(r){we&&rf(this.frameel[0]),super.destroy(r)}measure_height(){this.height_above_keyboard=this.frameel.height()}onclick(r){if(this.inputs?.type&&hn()){if(this.lastline&&this.height_above_keyboard){let i=this.lastline[0].getBoundingClientRect();if(i.bottom<0||i.top>document.documentElement.clientHeight)return!1}return this.textinput.el.trigger("focus"),!1}}scroll_to_bottom(r){(!r||this.is_scrolled_down)&&(this.frameel.scrollTop(this.innerel.height()),this.is_scrolled_down=!0)}update(r){if(r.clear&&(this.textinput.reset(),this.innerel.children(".BufferLine").remove(),this.is_scrolled_down=!0,this.lastline=void 0,this.last_run_styles=void 0,this.refresh_styles(r.bg,r.fg)),!r.text)return;this.frameel.attr("aria-busy","true"),this.updatescrolltop=Math.max(0,(this.lastline?.position().top||0)-20);let i=0;for(;i<r.text.length;){let a=r.text[i++],u=a.content,c,d;if(a.append&&this.lastline)c=this.lastline,d=1;else if(c=pe("div","BufferLine"),this.innerel.append(c),this.lastline=c,!u?.length){c.addClass("BlankPara"),c.append(pe("span","BlankLineSpace").text(_i));continue}if(a.flowbreak&&c.addClass("FlowBreak"),!!u?.length)for(let y=0;y<u.length;y++){let x,b=u[y];if(typeof b=="string")x={style:u[y++],text:u[y]};else if("special"in b&&b.special==="image"){let F=$("<img>",{alt:b.alttext||`Image ${b.image}`,class:c7[b.alignment||"inlineup"],height:b.height,src:this.blorb&&this.blorb.get_image_url(b.image)||b.url,width:b.width});if(b.hyperlink){$("<a>",{data:{glklink:b.hyperlink},href:"#"}).append(F).appendTo(c);continue}c.append(F);continue}else x=b;d||(d=1,c.addClass(`Style_${x.style}_par`)),c.append(this.create_text_run(x,i===r.text.length?!0:void 0)),this.last_run_styles=x.css_styles}}_t()||this.frameel.scrollTop(this.updatescrolltop),this.frameel.attr("aria-busy","false")}},cs=class extends _n{constructor(r){super(r);this.type="graphics";this.fillcolour="";this.framequeue=[];this.height=0;this.image_cache=new Map;this.width=0;this.clear_cache=Qe(()=>{this.image_cache.clear()},5e3);this.canvas=this.dom.create("canvas",`win${r.id}_canvas`,{data:{window:this}}),this.frameel.append(this.canvas),this.manager.canvasResizeObserver?.observe(this.canvas[0]),this.buffer=this.dom.create("canvas",`win${r.id}_buffer`)}decode_image(r,i){let a=new Image;return a.src=i,a.decode().then(()=>{this.image_cache.set(r,a)}).catch(()=>{})}destroy(r){this.manager.canvasResizeObserver?.unobserve(this.canvas[0]),super.destroy(r)}onclick(r){return this.inputs?.mouse&&r.button===0?(this.inputs.mouse=!1,this.manager.send_event({type:"mouse",window:this.id,x:Math.floor(r.offsetX-this.metrics.graphicsmarginx/2),y:Math.floor(r.offsetY-this.metrics.graphicsmarginy/2)}),!1):super.onclick(r)}set_dimensions(r,i){this.canvas.css({height:r,width:i}),this.height=r,this.width=i;let a=devicePixelRatio;r=r*a,i=i*a,this.buffer.attr({height:r,width:i}),this.canvas.attr({height:r,width:i})}async update(){let r=this.buffer[0].getContext("2d");for(let i=0;i<this.framequeue.length;i++){let a=this.framequeue[i];if(!this.height||!this.width)break;if(!a.length)continue;let u=[];for(let d of a)if(d.special==="image"){let y=d.url||d.image;if(this.image_cache.has(y))continue;let x=d.url||this.blorb&&this.blorb.get_image_url(d.image);x&&u.push(this.decode_image(y,x))}await Promise.all(u);let c=devicePixelRatio;for(let d of a)switch(d.special){case"fill":r.fillStyle=d.color||this.fillcolour,Number.isFinite(d.x)?r.fillRect(d.x*c,d.y*c,d.width*c,d.height*c):r.fillRect(0,0,parseInt(this.buffer.attr("width")),parseInt(this.buffer.attr("height")));break;case"image":{let y=this.image_cache.get(d.url||d.image);y&&r.drawImage(y,d.x*c,d.y*c,d.width*c,d.height*c);break}case"setcolor":this.fillcolour=d.color;break}}this.height&&this.width&&this.canvas[0].getContext("2d").drawImage(this.buffer[0],0,0),this.framequeue.length=0,this.clear_cache()}},ds=class extends mn{constructor(r){super(r);this.type="grid";this.height=0;this.lines=[];this.width=0;this.frameel.attr({"aria-atomic":"true","aria-live":"off",role:"status"})}onclick(r){return this.inputs?.mouse&&r.button===0&&hn()?(this.inputs.mouse=!1,this.manager.send_event({type:"mouse",window:this.id,x:Math.floor((r.offsetX-this.metrics.gridmarginx/2)/this.metrics.gridcharwidth),y:Math.floor((r.offsetY-this.metrics.gridmarginy/2)/this.metrics.gridcharheight)}),!1):super.onclick(r)}update(r){r.clear&&(this.last_run_styles=void 0,this.refresh_styles(r.bg,r.fg)),this.frameel.attr("aria-busy","true");for(let i of r.lines){let a=this.lines[i.line];if(!a.length)throw new Error(`Got content for nonexistent line ${i.line} of window ${this.id}`);let u=i.content;if(!u||!u.length)a.text(_i);else{a.empty();for(let c=0;c<u.length;c++){let d;typeof u[c]=="string"?d={style:u[c++],text:u[c]}:d=u[c],a.append(this.create_text_run(d,!1)),this.last_run_styles=d.css_styles}}}this.frameel.toggleClass("reverse",$(`#window${this.id} span:not(.reverse)`).length===0).attr({"aria-busy":"false","aria-live":this.lines.length>3?"polite":"off"})}},d7={buffer:us,graphics:cs,grid:ds},p7={buffer:"BufferWindow",graphics:"GraphicsWindow",grid:"GridWindow"},Or=class extends Map{constructor(r){super();this.history=[];this.onkeydown=r=>{if(!this.glkote.disabled&&r.target.nodeName!=="input"&&!(r.target.nodeName==="div"&&$(r.target).is(".BufferWindow:focus"))){let i=[...this.values()],a=i.filter(u=>u.inputs?.type)[0]||i.filter(u=>u.type==="buffer")[0];a&&(a.frameel.trigger("click"),a.textinput.el.is(":focus")?a.textinput.el.trigger(r):a.type==="buffer"&&a.frameel.trigger("focus"))}};if(this.dom=r.dom,this.glkote=r,this.metrics=r.current_metrics,window.ResizeObserver){let i=new ResizeObserver(a=>{typeof a?.[0].devicePixelContentBoxSize?.[0].blockSize<"u"&&(this.canvasResizeObserver=new ResizeObserver(u=>this.oncanvasresize(u))),i.disconnect()});i.observe(document.body)}this.send_event=i=>r.send_event(i),$(document).on("keydown",this.onkeydown),this.dom.gameport().on("click",()=>this.onclick())}destroy(){for(let r of this.values())r.destroy(!1),this.delete(r.id);$(document).off("keydown",this.onkeydown)}cancel_inputs(r){let i={};for(let a of r)i[a.id]=a;for(let a of this.values())!i[a.id]&&a.inputs&&(a.textinput.el.is(":focus")&&(this.active_window=a),a.textinput.el.prop("disabled",!0),delete a.inputs)}oncanvasresize(r){for(let i of r){let a=i.devicePixelContentBoxSize[0],u=a.blockSize,c=a.inlineSize,d=$(i.target).data("window");d.buffer.attr({height:u,width:c}),d.canvas.attr({height:u,width:c})}this.send_event({type:"redraw"})}onclick(){if(!this.glkote.disabled&&hn()){for(let r of this.values())if(r.inputs?.type){r.frameel.trigger("click");break}}}update(r){for(let a of this.values())a.desired=!1;for(let a of r){let u=a.id,c=a.type,d=this.get(u);if(!d)d=new d7[c]({blorb:this.blorb,dom:this.dom,id:u,manager:this,metrics:this.metrics,rock:a.rock,styles:a.styles,type:c}),this.set(u,d);else if(d.type!==c)throw new Error(`Window ${u} was created with type ${d.type}, but now is described as type ${c}`);if(d.desired=!0,d.type==="graphics"&&(d.height!==a.graphheight||d.width!==a.graphwidth)&&d.set_dimensions(a.graphheight,a.graphwidth),d.type==="grid"){if(a.gridheight>d.height)for(let y=d.height;y<a.gridheight;y++){let x=this.dom.create("div",`win${d.id}_ln${y}`,"GridLine");x.append(_i),d.frameel.append(x),d.lines[y]=x}if(a.gridheight<d.height)for(let y=a.gridheight;y<d.height;y++)this.dom.id(`win${d.id}_ln${y}`).remove();d.height=a.gridheight,d.lines.length=d.height,d.width=a.gridwidth}d.frameel.css({height:a.height,left:a.left,top:a.top,width:a.width}).toggleClass("hidden",!!a.hidden),d.type==="buffer"&&d.scroll_to_bottom(!0)}let i=[];for(let a of this.values())a.desired||i.push(a);for(let a of i)a.destroy(!0),this.delete(a.id)}update_content(r){for(let i of r){let a=this.get(i.id);if(!a)throw new Error(`Got content update for window ${i.id}, which does not exist`);switch(a.type){case"buffer":a.update(i);break;case"graphics":a.framequeue.push(i.draw),a.framequeue.length===1&&a.update();break;case"grid":a.update(i);break}}}update_inputs(r){for(let i of r){let a=this.get(i.id);if(!a)throw new Error(`Got input update for window ${i.id}, which does not exist`);let u=a.inputs?.gen;a.inputs=i,i.type&&i.gen!==u&&a.textinput.update()}this.active_window&&(this.has(this.active_window.id)&&this.active_window.inputs?.type?this.active_window.textinput.refocus():[...this.values()].filter(i=>i.inputs?.type)[0]?.textinput.refocus())}};var Lr=class{constructor(e,r){this.enabled=!1;this.handler=e=>this.web_handler(e);this.label="";this.session=Date.now()+Math.ceil(Math.random()*1e4).toString(16);this.url="";this.windows=r,e.recording_handler&&(this.enabled=!0,this.handler=e.recording_handler,this.url="(custom handler)"),e.recording_url&&(this.enabled=!0,this.url=e.recording_url),this.label=e.recording_label??"",this.enabled&&console.log(`Transcript recording active: session ${this.session} "${this.label}", destination ${this.url}`)}record_event(e){this.event=e,this.timestamp=Date.now()}record_update(e){if(!e.content)return;let r=this.event,i=r.type,a="";if(i==="char"||i==="line")a=r.value;else if(!(!i||i==="external"||i==="init"||i==="specialresponse"))return;let u="";for(let c of e.content){let d=this.windows.get(c.id);if(!d||d.type!=="buffer")continue;let y=c.text||[];for(let x of y){x.append||(u+=`
`);let b=x.content;if(b?.length)for(let F=0;F<b.length;F++){let U=b[F];typeof U=="string"?u+=b[++F]:"text"in U&&(u+=U.text)}}}this.handler({format:"simple",input:a,label:this.label,output:u,outtimestamp:Date.now(),sessionId:this.session,timestamp:this.timestamp})}async web_handler(e){try{let r=await fetch(this.url,{body:JSON.stringify(e),headers:{"Content-Type":"application/json"},method:"POST"});if(!r.ok)throw new Error(`Could not submit transcript update, got ${r.status}`)}catch(r){this.enabled=!1,console.log(`Transcript recording failed; disabling. Error: ${r}`)}}};var Zt=class extends Br{constructor(){super();this.dom=new ln({context_element:void 0,errorcontent_id:"errorcontent",errorpane_id:"errorpane",gameport_id:"gameport",loadingpane_id:"loadingpane",prefix:"",windowport_id:"windowport"});this.showing_error=!1;this.showing_loading=!0;this.metrics_calculator=new Qr(this),this.windows=new Or(this)}async init(r){try{if(!r)throw new Error("no options provided");if(typeof jQuery>"u")throw new Error("jQuery is not loaded");r.dom_prefix&&(this.dom.prefix=r.dom_prefix),r.errorcontent&&(this.dom.errorcontent_id=r.errorcontent),r.errorpane&&(this.dom.errorpane_id=r.errorpane),r.gameport&&(this.dom.gameport_id=r.gameport),r.loadingpane&&(this.dom.loadingpane_id=r.loadingpane),r.windowport&&(this.dom.windowport_id=r.windowport),r.Blorb&&(this.windows.blorb=r.Blorb);let i=this.dom.windowport();if(!i.length)throw new Error(`Cannot find windowport element #${this.dom.windowport_id}`);i.empty();let a="initial-scale=1,interactive-widget=resizes-content,minimum-scale=1,width=device-width";if(we&&(a+=",maximum-scale=1"),document.head.querySelector('meta[name="viewport"]').content=a,await this.metrics_calculator.measure(),r.recording_url||r.recording_handler)if(r.recording_format&&r.recording_format!=="simple")console.warn('GlkOte: only the "simple" recording_format is supported');else{let u=new URLSearchParams(document.location.search).get("feedback"),c=r.recording_cookie||"transcript_recording_opt_out";u&&u!=="1"||document.cookie.includes(`${c}=1`)?console.log("User has opted out of transcript recording."):this.transcript_recorder=new Lr(r,this.windows)}return super.init(r)}catch(i){this.error(i)}}autorestore(r){Array.isArray(r.history)&&(this.windows.history=r.history);for(let i of this.windows.values())i.type==="buffer"&&i.scroll_to_bottom();if(r.graphics_bg)for(let[i,a]of r.graphics_bg)this.windows.get(i).fillcolour=a;r.transcript_recorder_session&&this.transcript_recorder&&(this.transcript_recorder.session=r.transcript_recorder_session,console.log(`Resuming autosaved transcript recording session: ${r.transcript_recorder_session}`)),setTimeout(()=>this.send_event({type:"arrange"}),0)}cancel_inputs(r){this.windows.cancel_inputs(r)}capabilities(){return["garglktext","graphics","graphicswin","hyperlinks","timer"]}disable(r){for(let i of this.windows.values())i.textinput.el.prop("disabled",r||!i.inputs?.type);this.disabled=r}embellish_error(){if(typeof $>"u")return;let r=$(`#${this.dom.errorpane_id}`);if(r.find("#errorclose").length||$("<button>",{"aria-label":"Close",click:()=>(r.hide(),!1),id:"errorclose",text:"\u2716",type:"button"}).appendTo(r),this.autorestoring&&!this.Dialog?.async&&this.Dialog?.autosave_clear){let i=$("<a>",{click:async()=>{this.Dialog.async||await this.Dialog.autosave_clear(),location.reload()},text:"Clear autosave and restart"});$("<div>").append(i).appendTo(r)}}error(r){r??="???";let i;typeof r=="string"?(i=r,r=new Error(r)):i=r.toString();let a=document.getElementById(this.dom.errorcontent_id);if(!a)throw new Error(i);a.innerHTML=i;let u=document.getElementById(this.dom.errorpane_id);u.className==="WarningPane"&&(u.className=""),this.embellish_error(),u.style.display="",this.showing_error=!0,this.hide_loading(),console.error(r)}exit(){this.metrics_calculator.destroy(),this.windows.destroy()}getdomcontext(){return this.dom.context_element}getdomid(r){switch(r){case"errorcontent":return this.dom.errorcontent_id;case"errorpane":return this.dom.errorpane_id;case"gameport":return this.dom.gameport_id;case"loadingpane":return this.dom.loadingpane_id;case"windowport":return this.dom.windowport_id;default:return r}}hide_loading(){if(!this.showing_loading)return;this.showing_loading=!1;let r=document.getElementById(this.dom.loadingpane_id);r&&(r.style.display="none")}save_allstate(){let r=[];for(let i of this.windows.values())i.type==="graphics"&&r.push([i.id,i.fillcolour]);return{graphics_bg:r,history:this.windows.history,transcript_recorder_session:this.transcript_recorder?.session}}send_event(r){if(r.type!=="init"&&r.type!=="refresh"&&r.type!=="specialresponse"){for(let i of this.windows.values())if(i.inputs?.type){let a=i.textinput.el.val();a&&(r.partial||(r.partial={}),r.partial[i.id]=a)}}this.transcript_recorder?.enabled&&this.transcript_recorder.record_event(r),super.send_event(r)}setdomcontext(r){this.dom.context_element=r}set_page_bg(r){$("body").css("background-color",r)}update(r){this.showing_loading&&this.hide_loading(),super.update(r),this.transcript_recorder?.enabled&&r.type==="update"&&!r.autorestore&&this.transcript_recorder.record_update(r)}update_content(r){this.windows.update_content(r)}update_inputs(r){this.windows.update_inputs(r)}update_windows(r){this.windows.update(r)}warning(r){if(this.showing_error)return;let i=$(`#${this.dom.errorpane_id}`);if(!r){i.hide();return}let a=document.getElementById(this.dom.errorcontent_id);if(!a){console.warn(r);return}a.innerHTML=r,this.embellish_error(),i.addClass("WarningPane"),i.show(),this.hide_loading()}};var _7=new TextDecoder;async function _s(n,e,r){let i=new URL(e,document.URL),a=i.hostname,u=i.protocol===document.location.protocol,c=a===document.location.hostname,d=`${n.proxy_url}?url=${i}`,y;if(i.protocol==="embedded:"){let F=document.getElementById(i.pathname).text;return ps(F)}let x=u&&c||i.protocol==="data:";if(!x){for(let F of n.direct_domains)if(a.endsWith(F)){i.protocol="https:",x=!0;break}}if(x)try{y=await fetch(""+i)}catch{throw new Error("Failed to fetch storyfile (possible CORS error)")}else if(n.use_proxy)y=await fetch(d);else throw new Error("Storyfile not in list of direct domains and proxy disabled");if(!y.ok)throw new Error(`Could not fetch storyfile, got ${y.status}`);let b=await lf(y,r);if(e.endsWith(".js")){let F=_7.decode(b),U=/processBase64Zcode\(['"]([a-zA-Z0-9+/=]+)['"]\)/.exec(F);if(!U)throw new Error("Abnormal JSified story");return ps(U[1])}return b}async function sf(n,e,r){if(n.single_file){let u=document.getElementById(e).text;if(e.endsWith(".js"))return import(`data:text/javascript,${encodeURIComponent(u)}`);if(!e.endsWith(".wasm"))throw new Error(`Can't load ${e} in single file mode`);return ps(u)}if(e.endsWith(".js"))return import(e);let i;try{i=new URL(e,n.lib_path)}catch{i=n.lib_path+e}let a=await fetch(i);return lf(a,r)}async function ps(n){if(n.length<3e7)return of(n);let r=[],i=0;for(;i<n.length;)r.push(await of(n.substring(i,i+=3e7)));let a=new Blob(r);return new Uint8Array(await a.arrayBuffer())}async function of(n){let e=await fetch(`data:application/octet-stream;base64,${n}`);if(!e.ok)throw new Error(`Could not parse base64: ${e.status}`);return new Uint8Array(await e.arrayBuffer())}function af(n){return new Promise((e,r)=>{let i=new FileReader;i.onerror=()=>r(i.error),i.onload=()=>e(new Uint8Array(i.result)),i.readAsArrayBuffer(n)})}async function lf(n,e){if(!n.ok)throw new Error(`Could not fetch ${n.url}, got ${n.status}`);if(!e)return new Uint8Array(await n.arrayBuffer());let r=[],i=0,a=n.body.getReader();for(;;){let{done:c,value:d}=await a.read();if(c)break;r.push([i,d]),e(d.length),i+=d.length}let u=new Uint8Array(i);for(let[c,d]of r)u.set(d,c);return u}async function Xt(n,e){let[r,i,a]=e,u=Object.assign({},n,{wasmBinary:a.buffer}),c=new i.default;c.init(r,u),await c.start()}var m7=[{id:"blorb",extensions:/\.(blb|blorb)/i},{id:"adrift4",extensions:/\.taf/i,engines:[{id:"scare",load:["./scare.js","./scare-core.wasm"],start:Xt}]},{id:"hugo",extensions:/\.hex/i,engines:[{id:"hugo",load:["./hugo.js","./hugo-core.wasm"],start:Xt}]},{id:"glulx",extensions:/\.(gblorb|glb|ulx)/i,engines:[{id:"quixe",load:["./quixe.js"],start:(n,e)=>{let[r,i]=e,a=r,u=Object.assign({},n,{blorb_gamechunk_type:"GLUL",GiDispa:new i.GiDispa,GiLoad:i.GiLoad,image_info_map:"StaticImageInfo",io:n.Glk,set_page_title:0,spacing:0,use_query_story:0,vm:i.Quixe});i.GiLoad.load_run(u,a,"array")}},{id:"glulxe",load:["./glulxe.js","./glulxe-core.wasm"],start:Xt},{id:"git",load:["./git.js","./git-core.wasm"],start:Xt}]},{id:"tads",extensions:/\.(gam|t3)/i,engines:[{id:"tads",load:["./tads.js","./tads-core.wasm"],start:Xt}]},{id:"zcode",extensions:/\.(zblorb|zlb|z3|z4|z5|z8)/i,engines:[{id:"zvm",load:["./zvm.js"],start:(n,e)=>{let[r,i]=e,a=new i.ZVM,u=Object.assign({},n,{vm:a,GiDispa:new i.ZVMDispatch});a.prepare(r,u),u.Glk.init(u)}},{id:"bocfel",load:["./bocfel.js","./bocfel-core.wasm"],start:Xt}]}];function ms(n,e){for(let r of m7)if(r.id===n||e&&r.extensions.test(e))return r;throw new Error("Unknown storyfile format")}function ff(n){let e={GLUL:"glulx",ZCOD:"zcode"},r=n.get_chunk("exec",0)?.blorbtype;if(r&&e[r])return ms(e[r]);throw new Error("Unknown storyfile format in Blorb")}var h7=new TextDecoder,gn=new TextEncoder;function g7(n){return Uint8Array.from(n,e=>e.charCodeAt(0))}var y7=function(){var n="dialog",e=!1,r=null,i,a,u,c,d,y,x,b;function F(){try{let w=parseInt(localStorage.getItem("dialog_storage_version"),10);if(w>1)throw new Error("dialog_storage_version is newer than this library supports");if(!w){console.log("Dialog: updating storage version");for(let[k,v]of Object.entries(localStorage))if(k.startsWith("content:")&&v!==""&&localStorage.setItem(k,Be(/\[[,\d]*\]/.test(v)?JSON.parse(v):g7(v))),k.startsWith("autosave:")){localStorage.removeItem(k);let S=JSON.parse(v);S.ram&&(localStorage.setItem(k+".ram",Be(S.ram)),delete S.ram),localStorage.setItem(k,Be(gn.encode(JSON.stringify(S)))),localStorage.setItem(k+".meta",Be(gn.encode(JSON.stringify({modified:Date.now()}))))}localStorage.setItem("dialog_storage_version","1")}}catch{}}function U(w,k,v,S){if(e)throw new Error("Dialog: dialog box is already open.");if(!G)throw new Error("Dialog: no storage API is available.");r=S,i=w,a=!1,u=!1,c=null,d=k,x=v,y=z(d);var Q="windowport",q=window.Game;window.GlkOte&&(q=window.GlkOte.getinterface()),q&&q.windowport&&(Q=q.windowport);var L=$("#"+Q);if(!L.length)throw new Error("Dialog: unable to find root element #"+Q+".");var T=$("#"+n+"_screen");T.length||(T=$("<div>",{id:n+"_screen"}),L.append(T));var N=$("#"+n+"_frame");N.length||(N=$("<div>",{id:n+"_frame"}),L.append(N));var V=$("#"+n);V.length&&V.remove(),V=$("<div>",{id:n});var O,A,D;O=$("<form>"),O.on("submit",i?_e:Me),V.append(O),D=$("<div>",{class:"DiaButtonsFloat"}),A=$("<button>",{id:n+"_edit",type:"button"}),A.append("Edit"),A.on("click",j),D.append(A),O.append(D),D=$("<div>",{id:n+"_cap",class:"DiaCaption"}),D.append("XXX"),O.append(D),i&&(D=$("<div>",{id:n+"_input",class:"DiaInput"}),O.append(D),A=$("<input>",{id:n+"_infield",type:"text",name:"filename"}),D.append(A),D=$("<div>",{id:n+"_warning",class:"DiaWarning"}),D.text("Warning: data may be erased by clearing cookies or browser privacy policies."),O.append(D)),D=$("<div>",{id:n+"_body",class:"DiaBody"}),O.append(D),D=$("<div>",{id:n+"_cap2",class:"DiaCaption"}),D.hide(),O.append(D),D=$("<div>",{id:n+"_buttonrow",class:"DiaButtons"}),A=$("<button>",{id:n+"_cancel",type:"button"}),A.append("Cancel"),A.on("click",We),D.append(A),A=$("<button>",{id:n+"_delete",type:"button"}),A.append("Delete"),A.on("click",oe),A.hide(),D.append(A),A=$("<button>",{id:n+"_display",type:"button"}),A.append("Display"),A.on("click",me),A.hide(),D.append(A),A=$("<button>",{id:n+"_accept",type:"submit"}),A.append(i?"Save":"Load"),A.on("click",i?_e:Me),D.append(A),O.append(D),N.append(V),e=!0,he();var K;i?K=function(){var ie=$("#"+n+"_infield");ie.length&&ie.focus()}:K=function(){var ie=$("#"+n+"_select");ie.length&&ie.focus()},I(K)}function C(){var w=$("#"+n);w.length&&w.remove();var k=$("#"+n+"_frame");k.length&&k.remove();var v=$("#"+n+"_screen");v.length&&v.remove(),e=!1,r=null,b=null,u=!1,c=null}function M(w,k){var v=k?n+"_cap":n+"_cap2",S=$("#"+v);S.length&&(w?(S.text(w),S.show()):S.hide())}function z(w){switch(w){case"data":return"data file";case"save":return"save file";case"transcript":return"transcript";case"command":return"command script";default:return"file"}}function W(w){return w=="transcript"||w=="command"}function I(w){return window.setTimeout(w,.01*1e3)}function Oe(){if(!e||a)return!1;var w=$("#"+n+"_select");if(!w.length)return!1;var k=w.prop("selectedIndex");if(!b||k<0||k>=b.length)return!1;var v=b[k],S=$("#"+n+"_infield");return S.length&&S.val(v.dirent.filename),!1}function Le(){if(!e||!u||c)return!1;var w=$("#"+n+"_delete");w.prop("disabled",!0),w=$("#"+n+"_display"),w.prop("disabled",!0);var k=$("#"+n+"_select");if(!k.length)return!1;var v=k.prop("selectedIndex");if(!b||v<0||v>=b.length)return!1;var S=b[v];if(!S||!S.dirent||!_(S.dirent))return!1;w=$("#"+n+"_delete"),w.prop("disabled",!1),w=$("#"+n+"_display"),w.prop("disabled",!1)}function Me(w){if(w.preventDefault(),!e||u)return!1;var k=$("#"+n+"_select");if(!k.length)return!1;var v=k.prop("selectedIndex");if(!b||v<0||v>=b.length)return!1;var S=b[v];if(!S||!S.dirent||!_(S.dirent))return!1;var Q=r;return C(),Q&&Q(S.dirent),!1}function _e(w){if(w.preventDefault(),!e||u)return!1;var k=$("#"+n+"_infield");if(!k.length)return!1;var v=k.val();if(v=jQuery.trim(v),!v.length)return!1;var S=er(v,d,x);if(_(S)&&!a){a=!0,M("You already have a "+y+' "'+S.filename+'". Do you want to replace it?',!1),k.prop("disabled",!0);var Q=$("#"+n+"_accept");return Q.text("Replace"),!1}var q=r;return C(),q&&q(S),!1}function j(w){if(w.preventDefault(),!e)return!1;if(u){if(c)return u=!0,c=null,$("#"+n+"_buttonrow").show(),$("#"+n+"_edit").text("Done"),he(),!1;{u=!1,c=null;let k=$("#"+n+"_input");k.length&&k.show();let v=$("#"+n+"_edit");return v.text("Edit"),v=$("#"+n+"_delete"),v.hide(),v=$("#"+n+"_display"),v.hide(),v=$("#"+n+"_accept"),v.show(),he(),!1}}else{if(u=!0,c=null,a){a=!1,M(null,!1),$("#"+n+"_infield").prop("disabled",!1);let Q=$("#"+n+"_accept");Q.prop("disabled",!1),Q.text("Save")}let k=$("#"+n+"_input");k.length&&k.hide();let v=$("#"+n+"_edit");return v.text("Done"),v=$("#"+n+"_delete"),v.show(),v=$("#"+n+"_display"),v.show(),v=$("#"+n+"_accept"),v.hide(),he(),!1}}function oe(w){if(w.preventDefault(),!e||!u||c)return!1;var k=$("#"+n+"_select");if(!k.length)return!1;var v=k.prop("selectedIndex");if(!b||v<0||v>=b.length)return!1;var S=b[v];return!S||!S.dirent||($e(S.dirent),he()),!1}function me(w){if(w.preventDefault(),!e||!u||c)return!1;var k=$("#"+n+"_select");if(!k.length)return!1;var v=k.prop("selectedIndex");if(!b||v<0||v>=b.length)return!1;var S=b[v];if(!S||!S.dirent||!_(S.dirent))return!1;$("#"+n+"_buttonrow").hide();var Q=$("#"+n+"_edit");return Q.text("Close"),c=S.dirent,he(),!1}function We(w){if(w.preventDefault(),!e)return!1;if(a){a=!1,M(null,!1);var k=$("#"+n+"_infield");k.prop("disabled",!1);var v=$("#"+n+"_accept");return v.prop("disabled",!1),v.text("Save"),!1}var S=r;return C(),S&&S(null),!1}function he(){if(!e)return!1;var w,k;let v=$("#"+n+"_body");if(!v.length)return!1;if(u&&c&&(_(c)||(c=null,$("#"+n+"_buttonrow").show(),w=$("#"+n+"_edit"),w.text("Done"))),u&&c){v.empty();let T=vt(c);if(T=String.fromCharCode.apply(this,T),W(c.usage)){var S=$("<pre>",{class:"DiaDisplayText"});S.text(T),v.append(S),M("Displaying file contents...",!0)}else{var Q=window.btoa(T),q=$("<a>",{href:"data:application/octet-stream;base64,"+Q,target:"_blank",download:"data"});q.text(c.filename),v.append(q),M('Use "Save As" option in your browser to download this link.',!0)}return!1}if(u){let T=lt(null,x);if(x!=""&&(T=T.concat(lt(null,""))),T.sort(function(A,D){return A.dirent.usage<D.dirent.usage?-1:A.dirent.usage>D.dirent.usage?1:D.modified.getTime()-A.modified.getTime()}),T.length==0)return v.empty(),w=$("#"+n+"_delete"),w.prop("disabled",!0),w=$("#"+n+"_display"),w.prop("disabled",!0),M("You have no stored files. Press Done to continue.",!0),!1;b=[];let N="";for(let A=0;A<T.length;A++){let D=T[A];D.dirent.usage!=N&&(N=D.dirent.usage,b.push({label:N})),b.push(D)}T=b,v.empty();let V=$("<select>",{id:n+"_select",name:"files"});V.prop("size","5");let O=!1;for(let A=0;A<T.length;A++){let D=T[A];if(!D.dirent){k=$("<option>",{name:"f"+A}),k.prop("disabled",!0),k.text("-- "+z(D.label)+"s --"),V.append(k);continue}k=$("<option>",{name:"f"+A}),O||(O=!0,k.selected=!0);let K=nr(D.modified);k.text(D.dirent.filename+" -- "+K),V.append(k)}return v.append(V),V.on("change",Le),Le(),M("All stored files are now visible. You may delete them, and display files containing text. Press Done when finished.",!0),!1}let L=lt(d,x);if(L.sort(function(T,N){return N.modified.getTime()-T.modified.getTime()}),b=L,L.length==0)v.empty();else{v.empty();let T=$("<select>",{id:n+"_select",name:"files"});T.prop("size","5");let N,V;for(let O=0;O<L.length;O++)N=L[O],k=$("<option>",{name:"f"+O}),O==0&&(k.selected=!0),V=nr(N.modified),k.text(N.dirent.filename+" -- "+V),T.append(k);v.append(T),i&&T.on("change",Oe)}i?(M("Name this "+y+".",!0),k=$("#"+n+"_accept"),k.prop("disabled",!1)):L.length==0?(M("You have no "+y+"s for this game.",!0),k=$("#"+n+"_accept"),k.prop("disabled",!0)):(M("Select a "+y+" to load.",!0),k=$("#"+n+"_accept"),k.prop("disabled",!1))}function yn(w){return w}function er(w,k,v){w||(w=""),k||(k=""),v||(v="");var S=k+":"+v+":"+w,Q={dirent:"dirent:"+S,content:"content:"+S,filename:w,usage:k,gameid:v};return Q}function bn(w){var k=new Date().getTime(),v="_temp_"+k+"_"+Math.random();return v=v.replace(".",""),er(v,w)}function Mr(w){if(w.slice(0,7)!="dirent:")return null;var k=7,v=w.indexOf(":",k);if(v<0)return null;var S=w.slice(k,v);if(k=v+1,v=w.indexOf(":",k),v<0)return null;var Q=w.slice(k,v);k=v+1;var q=w.slice(k),L="cont"+w.slice(3),T={dirent:w,content:L,filename:q,usage:S,gameid:Q};return T}function tr(w){if(typeof w!="object"&&(w=Mr(w),!w))return null;var k=G.getItem(w.dirent);if(!k)return null;var v={dirent:w},S,Q,q,L,T=k.toString().split(",");for(S=0;S<T.length;S++)if(L=T[S],Q=L.indexOf(":"),!(Q<0))switch(q=L.slice(0,Q),L=L.slice(Q+1),q){case"created":v.created=new Date(Number(L));break;case"modified":v.modified=new Date(Number(L));break}return v}function _(w){var k=G.getItem(w.dirent);return!!k}function $e(w){G.removeItem(w.dirent),G.removeItem(w.content)}function kt(w,k,v){if(v&&k!=="")throw new Error("Dialog raw mode is no longer supported");var S,Q,q,L,T=tr(w);return T||(T={dirent:w,created:new Date}),T.modified=new Date,k=Be(k),Q=[],T.created&&Q.push("created:"+T.created.getTime()),T.modified&&Q.push("modified:"+T.modified.getTime()),S=Q.join(","),q=G.setItem(T.dirent.dirent,S),L=G.setItem(T.dirent.content,k),!(q||L)}function vt(w,k){if(k)throw new Error("Dialog raw mode is no longer supported");var v=tr(w);if(!v)return null;var S=G.getItem(w.content);return S==null?null:Rr(S)}function rr(){throw new Error("streaming function not implemented in Dialog")}function ir(w,k,v){return!(k!=null&&w.usage!=k||v!=null&&w.gameid!=v)}function lt(w,k){var v,S=[];if(!G)return S;var Q=G.getKeys();for(v=0;v<Q.length;v++){var q=Q[v];if(q){var L=Mr(q.toString());if(L&&ir(L,w,k)){var T=tr(L);S.push(T)}}}return S}function nr(w){if(!w)return"???";var k=w.getMonth()+1+"/"+w.getDate(),v=w.getHours()+":"+(w.getMinutes()<10?"0":"")+w.getMinutes();return k+" "+v}function or(w,k){let v="autosave:"+w,S=v+".meta",Q=v+".ram";k?(k.ram&&(G.setItem(Q,Be(k.ram)),delete k.ram),G.setItem(v,Be(gn.encode(JSON.stringify(k)))),G.setItem(S,Be(gn.encode(JSON.stringify({modified:Date.now()}))))):(G.removeItem(v),G.removeItem(S),G.removeItem(Q))}let ke;function xn(w){ke=w;let k="autosave:"+w,v=k+".ram",S=G.getItem(k);if(S)try{let Q=JSON.parse(h7.decode(Rr(S))),q=G.getItem(v);return q&&(Q.ram=Rr(q)),Q}catch{return null}return null}async function wn(){if(!ke)throw new Error("Dialog.autosave_clear must be called after Dialog.autosave_read");or(ke,null)}var G=null;try{var se=null;if(window.localStorage!=null?se=window.localStorage:window.globalStorage!=null&&(se=window.globalStorage[location.hostname]),se)try{if(se.setItem("_dialogtest","xyzzy"),se.getItem("_dialogtest")!="xyzzy")throw new Error("localStorage test did not match");se.removeItem("_dialogtest"),G={getItem:function(w){try{return se.getItem(w)}catch{return null}},removeItem:function(w){try{se.removeItem(w)}catch{return null}},setItem:function(w,k){try{se.setItem(w,k)}catch{return!0}},getKeys:function(){for(var w=[],k=0;k<se.length;k++)w.push(se.key(k));return w}}}catch{}}catch{}return G==null&&(G={data:{},keys:[],getItem:function(w){return G.data[w]},setItem:function(w,k){G.keys.indexOf(w)<0&&G.keys.push(w),G.data[w]=k},removeItem:function(w){var k=G.keys.indexOf(w);k>=0&&(G.keys.splice(k,1),delete G.data[w])},getKeys:function(){return G.keys.slice(0)}}),$(window).on("storage",he),{streaming:!1,init:F,open:U,file_clean_fixed_name:yn,file_construct_ref:er,file_construct_temp_ref:bn,file_ref_exists:_,file_remove_ref:$e,file_write:kt,file_read:vt,file_fopen:rr,autosave_clear:wn,autosave_write:or,autosave_read:xn}}(),uf=y7;var b7=function(){var n=null;let e=null,r=null,i=null,a=null,u={};var c,d,y,x,b,F=!1,U=!1,C=null,M=null,z=0,W=null,I=null;function Oe(t){if(t.Dialog)r=t.Dialog;else throw new Error("No reference to Dialog");if(t.GiDispa&&(i=t.GiDispa),t.Blorb&&(e=t.Blorb),t.GlkOte)a=t.GlkOte;else throw new Error("No reference to GlkOte");n=t.vm,i&&(i.set_vm?i.set_vm(n):i.init({io:this,vm:n})),t.accept=Le,a.init(t),c=t.exit_warning,d=t.do_vm_autosave,y=t.before_select_hook,x=t.extevent_hook,b=t.glk_gestalt_hook,y&&y()}function Le(t){var s;if(U){S("### ui is disabled, ignoring event");return}if(t.gen!=z){a.log("Input event had wrong generation number: got "+t.gen+", currently at "+z);return}switch(z+=1,W=t.partial,t.type){case"init":R=t.metrics,t.support&&t.support.forEach(o=>u[o]=1),n.start();break;case"external":{let o=null;x&&(o=x(t.value)),!o&&t.value=="timer"&&(Ft=Date.now(),o={type:_.evtype_Timer}),o&&o.type&&j(o);break}case"timer":{Ft=Date.now();let o={type:_.evtype_Timer};j(o);break}case"hyperlink":oe(t.window,t.value);break;case"mouse":me(t.window,t.x,t.y);break;case"char":We(t.window,t.value);break;case"line":he(t.window,t.value,t.terminator);break;case"arrange":R=t.metrics,s={left:R.outspacingx,top:R.outspacingy,right:R.width-R.outspacingx,bottom:R.height-R.outspacingy},ie&&je(ie,s),Me();break;case"redraw":_e();break;case"specialresponse":t.response=="fileref_prompt"&&eu(t);break}}function Me(){B&&(B.set_field(0,_.evtype_Arrange),B.set_field(1,null),B.set_field(2,0),B.set_field(3,0),i&&i.prepare_resume(B),B=null,n.resume())}function _e(){B&&(B.set_field(0,_.evtype_Redraw),B.set_field(1,null),B.set_field(2,0),B.set_field(3,0),i&&i.prepare_resume(B),B=null,n.resume())}function j(t){if(B){var s=0,o=0;t.val1&&(s=t.val1),t.val2&&(o=t.val2),B.set_field(0,t.type),B.set_field(1,null),B.set_field(2,s),B.set_field(3,o),i&&i.prepare_resume(B),B=null,n.resume()}}function oe(t,s){if(B){var o=null;for(o=K;o&&o.disprock!=t;o=o.next);!o||!o.hyperlink_request||(B.set_field(0,_.evtype_Hyperlink),B.set_field(1,o),B.set_field(2,s),B.set_field(3,0),o.hyperlink_request=!1,i&&i.prepare_resume(B),B=null,n.resume())}}function me(t,s,o){if(B){var l=null;for(l=K;l&&l.disprock!=t;l=l.next);!l||!l.mouse_request||(B.set_field(0,_.evtype_MouseInput),B.set_field(1,l),B.set_field(2,s),B.set_field(3,o),l.mouse_request=!1,i&&i.prepare_resume(B),B=null,n.resume())}}function We(t,s){var o;if(B){var l=null;for(l=K;l&&l.disprock!=t;l=l.next);!l||!l.char_request||(s.length==1?(o=s.charCodeAt(0),l.char_request_uni||(o=o&255)):(o=$e[s],o||(o=_.keycode_Unknown)),B.set_field(0,_.evtype_CharInput),B.set_field(1,l),B.set_field(2,o),B.set_field(3,0),l.char_request=!1,l.char_request_uni=!1,l.input_generation=null,i&&i.prepare_resume(B),B=null,n.resume())}}function he(t,s,o){var l;if(B){var f=null;for(f=K;f&&f.disprock!=t;f=f.next);if(!(!f||!f.line_request)){for(s.length>f.linebuf.length&&(s=s.slice(0,f.linebuf.length)),f.request_echo_line_input&&(l=f.style,ct(f.str,_.style_Input),ft(f,s),f.echostr&&ge(f.echostr,s),ct(f.str,l),ft(f,`
`),f.echostr&&ge(f.echostr,`
`)),l=0;l<s.length;l++)f.linebuf[l]=s.charCodeAt(l);var p=0;o&&$e[o]&&(p=$e[o]),B.set_field(0,_.evtype_LineInput),B.set_field(1,f),B.set_field(2,s.length),B.set_field(3,p),i&&i.unretain_array(f.linebuf),f.line_request=!1,f.line_request_uni=!1,f.request_echo_line_input=null,f.input_generation=null,f.linebuf=null,i&&i.prepare_resume(B),B=null,n.resume()}}}function yn(){var t={type:"update",gen:z},s=null,o=null,l=null,f,p,g,h,m,E,X,J,P,te,ye;if(sr){for(sr=!1,s=[],f=K;f;f=f.next)if(f.type!=_.wintype_Pair){switch(p={id:f.disprock,rock:f.rock},s.push(p),f.type){case _.wintype_TextBuffer:p.type="buffer",p.styles=$r(f.stylehints);break;case _.wintype_TextGrid:p.type="grid",p.gridwidth=f.gridwidth,p.gridheight=f.gridheight,p.styles=$r(f.stylehints);break;case _.wintype_Graphics:p.type="graphics",p.graphwidth=f.graphwidth,p.graphheight=f.graphheight;break}p.left=f.bbox.left,p.top=f.bbox.top,p.width=f.bbox.right-f.bbox.left,p.height=f.bbox.bottom-f.bbox.top}}for(f=K;f;f=f.next){switch(h=!1,p={id:f.disprock},o==null&&(o=[]),f.type){case _.wintype_TextBuffer:if(Fn(f),f.content.length&&(p.text=f.content.slice(0),f.content.length=0,h=!0),f.clearcontent&&(p.clear=!0,p.bg=f.cleared_bg,p.fg=f.cleared_fg,f.clearcontent=!1,h=!0,p.text||(p.text=[]),f.reserve.length=0),p.text&&p.text.length)for(J=0;J<p.text.length;J++)f.reserve.push(p.text[J]);f.reserve.length>100&&f.reserve.splice(0,f.reserve.length-100);break;case _.wintype_TextGrid:if(f.gridwidth==0||f.gridheight==0)break;for(p.lines=[],J=0;J<f.gridheight;J++)if(m=f.lines[J],!!m.dirty){for(m.dirty=!1,E=[],ye=0,P=0;P<f.gridwidth;){let qe=m.styles[P],Et=m.hyperlinks[P],ur=m.fgs[P],cr=m.bgs[P],dr=m.reverses[P];for(;P<f.gridwidth&&m.styles[P]===qe&&m.hyperlinks[P]===Et&&m.fgs[P]===ur&&m.bgs[P]===cr&&m.reverses[P]===dr;P++);ye<P&&(!Et&&ur==null&&cr==null&&!dr?(E.push(vt[qe]),E.push(m.chars.slice(ye,P).join(""))):(g={style:vt[qe],text:m.chars.slice(ye,P).join(""),hyperlink:Et},(cr||ur||dr)&&(g.css_styles={},cr&&(g.css_styles["background-color"]=cr),ur&&(g.css_styles.color=ur),dr&&(g.css_styles.reverse=dr)),E.push(g)),ye=P)}p.lines.push({line:J,content:E})}f.clearcontent&&(p.clear=!0,p.bg=f.cleared_bg,p.fg=f.cleared_fg,f.clearcontent=!1),h=p.lines.length;break;case _.wintype_Graphics:f.content.length&&(p.draw=f.content.slice(0),f.content.length=0,h=!0);var ze=-1;if(p.draw&&p.draw.length)for(J=0;J<p.draw.length;J++){var Fe=p.draw[J];Fe.special=="fill"&&Fe.x===void 0&&Fe.y===void 0&&Fe.width===void 0&&Fe.height===void 0&&(ze=f.reserve.length),f.reserve.push(Fe)}if(ze>=0){var dt=null;for(let qe=0;qe<f.reserve.length&&qe<ze;qe++){let Et=f.reserve[qe];Et.special=="setcolor"&&(dt=Et)}f.reserve.splice(0,ze),dt&&f.reserve.unshift(dt)}break}h&&o.push(p)}for(l=[],f=K;f;f=f.next)p=null,f.char_request&&(p={id:f.disprock,type:"char",gen:f.input_generation},f.type==_.wintype_TextGrid&&(ys(f)?(p.xpos=f.gridwidth,p.ypos=f.gridheight-1):(p.xpos=f.cursorx,p.ypos=f.cursory))),f.line_request&&(te="",I&&(X=I[f.disprock],X&&(te=X)),p={id:f.disprock,type:"line",gen:f.input_generation,maxlen:f.linebuf.length,initial:te},f.line_input_terminators.length&&(p.terminators=f.line_input_terminators),f.type==_.wintype_TextGrid&&(ys(f)?(p.xpos=f.gridwidth,p.ypos=f.gridheight-1):(p.xpos=f.cursorx,p.ypos=f.cursory))),f.hyperlink_request&&(p||(p={id:f.disprock}),p.hyperlink=!0),f.mouse_request&&(p||(p={id:f.disprock}),p.mouse=!0),p&&l.push(p);t.windows=s,t.content=o,t.input=l,kn!=Te&&(t.timer=Te,kn=Te),C&&(t.specialinput=C),U&&(t.disable=!0);let Dn=ve.buffer[".Style_normal"]?.["background-color"];if(Fs!=Dn&&(Fs=Dn,t.page_margin_bg=Dn||""),I=null,D&&(t.autorestore=D),D=null,a.update(t,D),y&&y(),d){if(F)n.do_autosave(-1);else if(i){var Ts=i.check_autosave();Ts&&n.do_autosave(Ts)}}}function er(t){switch(t){case"VM":return n;case"GlkOte":return a;case"GiDispa":return i;case"Blorb":return e;case"Dialog":return a.getlibrary("Dialog")}return null}function bn(){var t={};ie&&(t.rootwin=ie.disprock),ee&&(t.currentstr=ee.disprock),Te&&(t.timer_interval=Te),t.windows=[];for(var s=K;s;s=s.next){var o={type:s.type,rock:s.rock,disprock:s.disprock,style:s.style,hyperlink:s.hyperlink,bg:s.bg,fg:s.fg,reverse:s.reverse,cleared_bg:s.cleared_bg,cleared_fg:s.cleared_fg};if(s.parent&&(o.parent=s.parent.disprock),o.str=s.str.disprock,s.echostr&&(o.echostr=s.echostr.disprock),o.bbox={left:s.bbox.left,right:s.bbox.right,top:s.bbox.top,bottom:s.bbox.bottom},s.linebuf!==null){var l=i.get_retained_array(s.linebuf);o.linebuf={addr:l.addr,len:l.len,arr:l.arr.slice(0),arg:l.arg.serialize()}}switch(o.char_request=s.char_request,o.line_request=s.line_request,o.char_request_uni=s.char_request_uni,o.line_request_uni=s.line_request_uni,o.hyperlink_request=s.hyperlink_request,o.mouse_request=s.mouse_request,o.echo_line_input=s.echo_line_input,o.request_echo_line_input=s.request_echo_line_input,o.line_input_terminators=s.line_input_terminators.slice(0),s.type){case _.wintype_TextBuffer:o.reserve=s.reserve.slice(0),o.stylehints=s.stylehints;break;case _.wintype_TextGrid:o.gridwidth=s.gridwidth,o.gridheight=s.gridheight,o.lines=[];for(var f=0;f<s.lines.length;f++){var p=s.lines[f];o.lines.push({chars:p.chars.slice(0),styles:p.styles.slice(0),hyperlinks:p.hyperlinks.slice(0),fgs:p.fgs.slice(0),bgs:p.bgs.slice(0),reverses:p.reverses.slice(0)})}o.cursorx=s.cursorx,o.cursory=s.cursory,o.stylehints=s.stylehints;break;case _.wintype_Graphics:o.graphwidth=s.graphwidth,o.graphheight=s.graphheight,o.reserve=s.reserve.slice(0);break;case _.wintype_Pair:o.pair_dir=s.pair_dir,o.pair_division=s.pair_division,o.pair_key=s.pair_key.disprock,o.pair_keydamage=!1,o.pair_size=s.pair_size,o.pair_hasborder=s.pair_hasborder,o.pair_vertical=s.pair_vertical,o.pair_backward=s.pair_backward,o.child1=s.child1.disprock,o.child2=s.child2.disprock;break}t.windows.push(o)}t.streams=[];for(let g=Ne;g;g=g.next){let h={type:g.type,rock:g.rock,disprock:g.disprock,unicode:g.unicode,isbinary:g.isbinary,readcount:g.readcount,writecount:g.writecount,readable:g.readable,writable:g.writable,streaming:g.streaming};switch(g.type){case V:g.win&&(h.win=g.win.disprock);break;case O:if(g.buf!==null){let m=i.get_retained_array(g.buf);h.buf={addr:m.addr,len:m.len,arr:m.arr.slice(0),arg:m.arg.serialize()}}h.buflen=g.buflen,h.bufpos=g.bufpos,h.bufeof=g.bufeof;break;case A:h.resfilenum=g.resfilenum,h.buflen=g.buflen,h.bufpos=g.bufpos,h.bufeof=g.bufeof;break;case N:h.origfmode=g.origfmode,r.streaming?(g.fstream.fflush(),h.ref=g.ref,h.filepos=g.fstream.ftell()):(h.ref=g.ref,xs(g),h.buflen=g.buflen,h.bufpos=g.bufpos,h.bufeof=g.bufeof);break}t.streams.push(h)}t.filerefs=[];for(let g=Pe;g;g=g.next){let h={type:g.type,rock:g.rock,disprock:g.disprock,filename:g.filename,textmode:g.textmode,filetype:g.filetype,filetypename:g.filetypename};h.ref=g.ref,t.filerefs.push(h)}return t.stylehints=ve,t.glkote=a.save_allstate(),t}function Mr(t){if(K||Ne||Pe)throw"restore_allstate: glkapi module has already been launched";for(let g=t.windows.length-1;g>=0;g--){let h=t.windows[g],m={type:h.type,rock:h.rock,disprock:h.disprock,style:h.style,hyperlink:h.hyperlink,bg:h.bg,fg:h.fg,reverse:h.reverse,cleared_bg:h.cleared_bg,cleared_fg:h.cleared_fg};i.class_register("window",m,m.disprock),m.prev=null,m.next=K,K=m,m.next&&(m.next.prev=m)}for(let g=t.streams.length-1;g>=0;g--){let h=t.streams[g],m={type:h.type,rock:h.rock,disprock:h.disprock,unicode:h.unicode,isbinary:h.isbinary,readcount:h.readcount,writecount:h.writecount,readable:h.readable,writable:h.writable,streaming:h.streaming};i.class_register("stream",m,m.disprock),m.prev=null,m.next=Ne,Ne=m,m.next&&(m.next.prev=m)}for(let g=t.filerefs.length-1;g>=0;g--){let h=t.filerefs[g],m={type:h.type,rock:h.rock,disprock:h.disprock,filename:h.filename,textmode:h.textmode,filetype:h.filetype,filetypename:h.filetypename};i.class_register("fileref",m,m.disprock),m.prev=null,m.next=Pe,Pe=m,m.next&&(m.next.prev=m)}for(let g=0;g<t.windows.length;g++){let h=t.windows[g],m=i.class_obj_from_id("window",h.disprock);switch(m.parent=i.class_obj_from_id("window",h.parent),m.str=i.class_obj_from_id("stream",h.str),m.echostr=i.class_obj_from_id("stream",h.echostr),m.bbox={left:h.bbox.left,right:h.bbox.right,top:h.bbox.top,bottom:h.bbox.bottom},m.input_generation=null,(h.char_request||h.line_request)&&(m.input_generation=z),m.linebuf=null,h.linebuf!==void 0&&(m.linebuf=h.linebuf.arr,i.retain_array(m.linebuf,h.linebuf)),m.char_request=h.char_request,m.line_request=h.line_request,m.char_request_uni=h.char_request_uni,m.line_request_uni=h.line_request_uni,m.hyperlink_request=h.hyperlink_request,m.mouse_request=h.mouse_request,m.echo_line_input=h.echo_line_input,m.request_echo_line_input=h.request_echo_line_input,m.line_input_terminators=h.line_input_terminators.slice(0),m.type){case _.wintype_TextBuffer:m.accum=[],m.accumstyle=m.style,m.accumhyperlink=m.hyperlink,m.accum_fg=m.fg,m.accum_bg=m.bg,m.accum_reverse=m.reverse,m.content=h.reserve.slice(0),m.clearcontent=!0,m.reserve=[],m.stylehints=Nr(h.stylehints);break;case _.wintype_TextGrid:m.gridwidth=h.gridwidth,m.gridheight=h.gridheight,m.lines=[];for(var s=0;s<h.lines.length;s++){var o=h.lines[s];m.lines.push({dirty:!0,chars:o.chars.slice(0),styles:o.styles.slice(0),hyperlinks:o.hyperlinks.slice(0),fgs:o.fgs.slice(0),bgs:o.bgs.slice(0),reverses:o.reverses.slice(0)})}m.cursorx=h.cursorx,m.cursory=h.cursory,m.clearcontent=!0,m.stylehints=Nr(h.stylehints);break;case _.wintype_Graphics:m.graphwidth=h.graphwidth,m.graphheight=h.graphheight,m.content=h.reserve.slice(0),m.reserve=[];break;case _.wintype_Pair:m.pair_dir=h.pair_dir,m.pair_division=h.pair_division,m.pair_key=i.class_obj_from_id("window",h.pair_key),m.pair_keydamage=!1,m.pair_size=h.pair_size,m.pair_hasborder=h.pair_hasborder,m.pair_vertical=h.pair_vertical,m.pair_backward=h.pair_backward,m.child1=i.class_obj_from_id("window",h.child1),m.child2=i.class_obj_from_id("window",h.child2);break}}for(let g=0;g<t.streams.length;g++){let h=t.streams[g],m=i.class_obj_from_id("stream",h.disprock);switch(m.win=null,m.ref=null,m.file=null,m.buf=null,m.bufpos=0,m.buflen=0,m.bufeof=0,m.timer_id=null,m.flush_func=null,m.fstream=null,m.type){case V:m.win=i.class_obj_from_id("window",h.win);break;case O:h.buf!==void 0&&(m.buf=h.buf.arr,i.retain_array(m.buf,h.buf)),m.buflen=h.buflen,m.bufpos=h.bufpos,m.bufeof=h.bufeof;break;case A:m.resfilenum=h.resfilenum;var l=e.find_data_chunk(m.resfilenum);l&&(m.buf=l.data),m.buflen=h.buflen,m.bufpos=h.bufpos,m.bufeof=h.bufeof;break;case N:if(m.origfmode=h.origfmode,r.streaming){if(m.ref=h.ref,m.fstream=r.file_fopen(m.origfmode,m.ref),!m.fstream){var p=r.file_construct_temp_ref(m.ref.usage);if(m.fstream=r.file_fopen(m.origfmode,p),!m.fstream)throw"restore_allstate: could not reopen even a temp stream for: "+m.ref.filename}m.origfmode!=_.filemode_WriteAppend&&m.fstream.fseek(h.filepos,_.seekmode_Start),m.buffer4=m.fstream.BufferClass.alloc(4)}else{m.ref=h.ref,m.buflen=h.buflen,m.bufpos=h.bufpos,m.bufeof=h.bufeof;var f=r.file_read(m.ref);f==null&&(f=[],r.file_write(m.ref,"",!0)),m.buf=f,m.bufeof=f.length,m.bufpos>m.bufeof&&(m.bufpos=m.bufeof)}break}}for(let g=0;g<t.filerefs.length;g++){let h=t.filerefs[g],m=i.class_obj_from_id("fileref",h.disprock);m.ref=h.ref}ie=i.class_obj_from_id("window",t.rootwin),ee=i.class_obj_from_id("stream",t.currentstr),t.timer_interval&&Us(t.timer_interval),ve.buffer=Nr(t.stylehints.buffer),ve.grid=Nr(t.stylehints.grid),D=t.glkote}function tr(t){if(F=!0,U=!0,!a){console.log("Fatal error:",t);return}a.error(t);var s={type:"update",gen:z,disable:!0};s.input=[],a.update(s)}var _={gestalt_Version:0,gestalt_CharInput:1,gestalt_LineInput:2,gestalt_CharOutput:3,gestalt_CharOutput_CannotPrint:0,gestalt_CharOutput_ApproxPrint:1,gestalt_CharOutput_ExactPrint:2,gestalt_MouseInput:4,gestalt_Timer:5,gestalt_Graphics:6,gestalt_DrawImage:7,gestalt_Sound:8,gestalt_SoundVolume:9,gestalt_SoundNotify:10,gestalt_Hyperlinks:11,gestalt_HyperlinkInput:12,gestalt_SoundMusic:13,gestalt_GraphicsTransparency:14,gestalt_Unicode:15,gestalt_UnicodeNorm:16,gestalt_LineInputEcho:17,gestalt_LineTerminators:18,gestalt_LineTerminatorKey:19,gestalt_DateTime:20,gestalt_Sound2:21,gestalt_ResourceStream:22,gestalt_GraphicsCharInput:23,gestalt_GarglkText:4352,keycode_Unknown:4294967295,keycode_Left:4294967294,keycode_Right:4294967293,keycode_Up:4294967292,keycode_Down:4294967291,keycode_Return:4294967290,keycode_Delete:4294967289,keycode_Escape:4294967288,keycode_Tab:4294967287,keycode_PageUp:4294967286,keycode_PageDown:4294967285,keycode_Home:4294967284,keycode_End:4294967283,keycode_Func1:4294967279,keycode_Func2:4294967278,keycode_Func3:4294967277,keycode_Func4:4294967276,keycode_Func5:4294967275,keycode_Func6:4294967274,keycode_Func7:4294967273,keycode_Func8:4294967272,keycode_Func9:4294967271,keycode_Func10:4294967270,keycode_Func11:4294967269,keycode_Func12:4294967268,keycode_MAXVAL:28,evtype_None:0,evtype_Timer:1,evtype_CharInput:2,evtype_LineInput:3,evtype_MouseInput:4,evtype_Arrange:5,evtype_Redraw:6,evtype_SoundNotify:7,evtype_Hyperlink:8,evtype_VolumeNotify:9,style_Normal:0,style_Emphasized:1,style_Preformatted:2,style_Header:3,style_Subheader:4,style_Alert:5,style_Note:6,style_BlockQuote:7,style_Input:8,style_User1:9,style_User2:10,style_NUMSTYLES:11,wintype_AllTypes:0,wintype_Pair:1,wintype_Blank:2,wintype_TextBuffer:3,wintype_TextGrid:4,wintype_Graphics:5,winmethod_Left:0,winmethod_Right:1,winmethod_Above:2,winmethod_Below:3,winmethod_DirMask:15,winmethod_Fixed:16,winmethod_Proportional:32,winmethod_DivisionMask:240,winmethod_Border:0,winmethod_NoBorder:256,winmethod_BorderMask:256,fileusage_Data:0,fileusage_SavedGame:1,fileusage_Transcript:2,fileusage_InputRecord:3,fileusage_TypeMask:15,fileusage_TextMode:256,fileusage_BinaryMode:0,filemode_Write:1,filemode_Read:2,filemode_ReadWrite:3,filemode_WriteAppend:5,seekmode_Start:0,seekmode_Current:1,seekmode_End:2,stylehint_Indentation:0,stylehint_ParaIndentation:1,stylehint_Justification:2,stylehint_Size:3,stylehint_Weight:4,stylehint_Oblique:5,stylehint_Proportional:6,stylehint_TextColor:7,stylehint_BackColor:8,stylehint_ReverseColor:9,stylehint_NUMHINTS:10,stylehint_just_LeftFlush:0,stylehint_just_LeftRight:1,stylehint_just_Centered:2,stylehint_just_RightFlush:3,imagealign_InlineUp:1,imagealign_InlineDown:2,imagealign_InlineCenter:3,imagealign_MarginLeft:4,imagealign_MarginRight:5,zcolor_Default:-1,zcolor_Current:-2},$e={left:_.keycode_Left,right:_.keycode_Right,up:_.keycode_Up,down:_.keycode_Down,return:_.keycode_Return,delete:_.keycode_Delete,escape:_.keycode_Escape,tab:_.keycode_Tab,pageup:_.keycode_PageUp,pagedown:_.keycode_PageDown,home:_.keycode_Home,end:_.keycode_End,func1:_.keycode_Func1,func2:_.keycode_Func2,func3:_.keycode_Func3,func4:_.keycode_Func4,func5:_.keycode_Func5,func6:_.keycode_Func6,func7:_.keycode_Func7,func8:_.keycode_Func8,func9:_.keycode_Func9,func10:_.keycode_Func10,func11:_.keycode_Func11,func12:_.keycode_Func12},kt=null,vt={0:"normal",1:"emphasized",2:"preformatted",3:"header",4:"subheader",5:"alert",6:"note",7:"blockquote",8:"input",9:"user1",10:"user2"},rr={0:"data",1:"save",2:"transcript",3:"command"},ir={181:924,223:[83,83],255:376,305:73,329:[700,78],383:83,405:502,414:544,447:503,454:452,457:455,460:458,477:398,496:[74,780],499:497,595:385,596:390,598:393,599:394,601:399,603:400,608:403,611:404,616:407,617:406,623:412,626:413,629:415,640:422,643:425,648:430,650:433,651:434,658:439,837:921,912:[921,776,769],940:902,941:904,942:905,943:906,944:[933,776,769],962:931,972:908,973:910,974:911,976:914,977:920,981:934,982:928,1008:922,1010:1017,1013:917,1415:[1333,1362],7830:[72,817],7831:[84,776],7832:[87,778],7833:[89,778],7834:[65,702],7835:7776,8016:[933,787],8018:[933,787,768],8020:[933,787,769],8022:[933,787,834],8048:8122,8049:8123,8050:8136,8051:8137,8052:8138,8053:8139,8054:8154,8055:8155,8056:8184,8057:8185,8058:8170,8059:8171,8060:8186,8061:8187,8064:[7944,921],8065:[7945,921],8066:[7946,921],8067:[7947,921],8068:[7948,921],8069:[7949,921],8070:[7950,921],8071:[7951,921],8072:[7944,921],8073:[7945,921],8074:[7946,921],8075:[7947,921],8076:[7948,921],8077:[7949,921],8078:[7950,921],8079:[7951,921],8080:[7976,921],8081:[7977,921],8082:[7978,921],8083:[7979,921],8084:[7980,921],8085:[7981,921],8086:[7982,921],8087:[7983,921],8088:[7976,921],8089:[7977,921],8090:[7978,921],8091:[7979,921],8092:[7980,921],8093:[7981,921],8094:[7982,921],8095:[7983,921],8096:[8040,921],8097:[8041,921],8098:[8042,921],8099:[8043,921],8100:[8044,921],8101:[8045,921],8102:[8046,921],8103:[8047,921],8104:[8040,921],8105:[8041,921],8106:[8042,921],8107:[8043,921],8108:[8044,921],8109:[8045,921],8110:[8046,921],8111:[8047,921],8114:[8122,921],8115:[913,921],8116:[902,921],8118:[913,834],8119:[913,834,921],8124:[913,921],8126:921,8130:[8138,921],8131:[919,921],8132:[905,921],8134:[919,834],8135:[919,834,921],8140:[919,921],8146:[921,776,768],8147:[921,776,769],8150:[921,834],8151:[921,776,834],8162:[933,776,768],8163:[933,776,769],8164:[929,787],8165:8172,8166:[933,834],8167:[933,776,834],8178:[8186,921],8179:[937,921],8180:[911,921],8182:[937,834],8183:[937,834,921],8188:[937,921],64256:[70,70],64257:[70,73],64258:[70,76],64259:[70,70,73],64260:[70,70,76],64261:[83,84],64262:[83,84],64275:[1348,1350],64276:[1348,1333],64277:[1348,1339],64278:[1358,1350],64279:[1348,1341]};(function(){var t,s,o,l=ir;for(t=[7936,7937,7938,7939,7940,7941,7942,7943,7952,7953,7954,7955,7956,7957,7968,7969,7970,7971,7972,7973,7974,7975,7984,7985,7986,7987,7988,7989,7990,7991,8e3,8001,8002,8003,8004,8005,8017,8019,8021,8023,8032,8033,8034,8035,8036,8037,8038,8039,8112,8113,8144,8145,8160,8161],s=0;s<54;s++)o=t[s],l[o]=o+8;for(o=257;o<=303;o+=2)l[o]=o-1;for(o=331;o<=375;o+=2)l[o]=o-1;for(o=505;o<=543;o+=2)l[o]=o-1;for(o=1121;o<=1153;o+=2)l[o]=o-1;for(o=1163;o<=1215;o+=2)l[o]=o-1;for(o=1233;o<=1269;o+=2)l[o]=o-1;for(o=7681;o<=7829;o+=2)l[o]=o-1;for(o=7841;o<=7929;o+=2)l[o]=o-1;for(t=[307,309,311,314,316,318,320,322,324,326,328,378,380,382,387,389,392,396,402,409,417,419,421,424,429,432,436,438,441,445,453,456,459,462,464,466,468,470,472,474,476,479,481,483,485,487,489,491,493,495,498,501,547,549,551,553,555,557,559,561,563,985,987,989,991,993,995,997,999,1001,1003,1005,1007,1016,1019,1218,1220,1222,1224,1226,1228,1230,1273,1281,1283,1285,1287,1289,1291,1293,1295],s=0;s<91;s++)o=t[s],l[o]=o-1;for(o=8560;o<=8575;o+=1)l[o]=o-16;for(o=9424;o<=9449;o+=1)l[o]=o-26;for(o=97;o<=122;o+=1)l[o]=o-32;for(o=224;o<=246;o+=1)l[o]=o-32;for(o=945;o<=961;o+=1)l[o]=o-32;for(o=1072;o<=1103;o+=1)l[o]=o-32;for(o=65345;o<=65370;o+=1)l[o]=o-32;for(t=[248,249,250,251,252,253,254,963,964,965,966,967,968,969,970,971],s=0;s<16;s++)o=t[s],l[o]=o-32;for(o=66600;o<=66639;o+=1)l[o]=o-40;for(o=1377;o<=1414;o+=1)l[o]=o-48;for(o=1104;o<=1119;o+=1)l[o]=o-80;l[1009]=929})();var lt={304:[105,775],376:255,385:595,390:596,393:598,394:599,398:477,399:601,400:603,403:608,404:611,406:617,407:616,412:623,413:626,415:629,422:640,425:643,430:648,433:650,434:651,439:658,452:454,455:457,458:460,497:499,502:405,503:447,544:414,902:940,904:941,905:942,906:943,908:972,910:973,911:974,1012:952,1017:1010,8122:8048,8123:8049,8124:8115,8136:8050,8137:8051,8138:8052,8139:8053,8140:8131,8154:8054,8155:8055,8170:8058,8171:8059,8172:8165,8184:8056,8185:8057,8186:8060,8187:8061,8188:8179,8486:969,8490:107,8491:229};(function(){var t,s,o,l=lt;for(o=1024;o<=1039;o+=1)l[o]=o+80;for(o=1329;o<=1366;o+=1)l[o]=o+48;for(o=66560;o<=66599;o+=1)l[o]=o+40;for(o=65;o<=90;o+=1)l[o]=o+32;for(o=192;o<=214;o+=1)l[o]=o+32;for(o=913;o<=929;o+=1)l[o]=o+32;for(o=1040;o<=1071;o+=1)l[o]=o+32;for(o=65313;o<=65338;o+=1)l[o]=o+32;for(t=[216,217,218,219,220,221,222,931,932,933,934,935,936,937,938,939],s=0;s<16;s++)o=t[s],l[o]=o+32;for(o=9398;o<=9423;o+=1)l[o]=o+26;for(o=8544;o<=8559;o+=1)l[o]=o+16;for(o=256;o<=302;o+=2)l[o]=o+1;for(o=330;o<=374;o+=2)l[o]=o+1;for(o=504;o<=542;o+=2)l[o]=o+1;for(o=1120;o<=1152;o+=2)l[o]=o+1;for(o=1162;o<=1214;o+=2)l[o]=o+1;for(o=1232;o<=1268;o+=2)l[o]=o+1;for(o=7680;o<=7828;o+=2)l[o]=o+1;for(o=7840;o<=7928;o+=2)l[o]=o+1;for(t=[306,308,310,313,315,317,319,321,323,325,327,377,379,381,386,388,391,395,401,408,416,418,420,423,428,431,435,437,440,444,453,456,459,461,463,465,467,469,471,473,475,478,480,482,484,486,488,490,492,494,498,500,546,548,550,552,554,556,558,560,562,984,986,988,990,992,994,996,998,1e3,1002,1004,1006,1015,1018,1217,1219,1221,1223,1225,1227,1229,1272,1280,1282,1284,1286,1288,1290,1292,1294],s=0;s<91;s++)o=t[s],l[o]=o+1;for(t=[7944,7945,7946,7947,7948,7949,7950,7951,7960,7961,7962,7963,7964,7965,7976,7977,7978,7979,7980,7981,7982,7983,7992,7993,7994,7995,7996,7997,7998,7999,8008,8009,8010,8011,8012,8013,8025,8027,8029,8031,8040,8041,8042,8043,8044,8045,8046,8047,8072,8073,8074,8075,8076,8077,8078,8079,8088,8089,8090,8091,8092,8093,8094,8095,8104,8105,8106,8107,8108,8109,8110,8111,8120,8121,8152,8153,8168,8169],s=0;s<78;s++)o=t[s],l[o]=o-8})();var nr={223:[83,115],452:453,453:453,454:453,455:456,456:456,457:456,458:459,459:459,460:459,497:498,498:498,499:498,1415:[1333,1410],8114:[8122,837],8115:8124,8116:[902,837],8119:[913,834,837],8124:8124,8130:[8138,837],8131:8140,8132:[905,837],8135:[919,834,837],8140:8140,8178:[8186,837],8179:8188,8180:[911,837],8183:[937,834,837],8188:8188,64256:[70,102],64257:[70,105],64258:[70,108],64259:[70,102,105],64260:[70,102,108],64261:[83,116],64262:[83,116],64275:[1348,1398],64276:[1348,1381],64277:[1348,1387],64278:[1358,1398],64279:[1348,1389]};(function(){var t,s,o,l=nr;for(t=[8072,8073,8074,8075,8076,8077,8078,8079,8072,8073,8074,8075,8076,8077,8078,8079,8088,8089,8090,8091,8092,8093,8094,8095,8088,8089,8090,8091,8092,8093,8094,8095,8104,8105,8106,8107,8108,8109,8110,8111,8104,8105,8106,8107,8108,8109,8110,8111],s=0;s<48;s++)o=t[s],l[s+8064]=o})();var or={192:[65,768],193:[65,769],194:[65,770],195:[65,771],196:[65,776],197:[65,778],199:[67,807],200:[69,768],201:[69,769],202:[69,770],203:[69,776],204:[73,768],205:[73,769],206:[73,770],207:[73,776],209:[78,771],210:[79,768],211:[79,769],212:[79,770],213:[79,771],214:[79,776],217:[85,768],218:[85,769],219:[85,770],220:[85,776],221:[89,769],224:[97,768],225:[97,769],226:[97,770],227:[97,771],228:[97,776],229:[97,778],231:[99,807],232:[101,768],233:[101,769],234:[101,770],235:[101,776],236:[105,768],237:[105,769],238:[105,770],239:[105,776],241:[110,771],242:[111,768],243:[111,769],244:[111,770],245:[111,771],246:[111,776],249:[117,768],250:[117,769],251:[117,770],252:[117,776],253:[121,769],296:[73,771],297:[105,771],298:[73,772],299:[105,772],300:[73,774],301:[105,774],302:[73,808],303:[105,808],304:[73,775],308:[74,770],309:[106,770],310:[75,807],311:[107,807],313:[76,769],314:[108,769],315:[76,807],316:[108,807],317:[76,780],318:[108,780],323:[78,769],324:[110,769],325:[78,807],326:[110,807],327:[78,780],328:[110,780],332:[79,772],333:[111,772],334:[79,774],335:[111,774],336:[79,779],337:[111,779],416:[79,795],417:[111,795],431:[85,795],432:[117,795],478:[65,776,772],479:[97,776,772],480:[65,775,772],481:[97,775,772],482:[198,772],483:[230,772],486:[71,780],487:[103,780],488:[75,780],489:[107,780],490:[79,808],491:[111,808],492:[79,808,772],493:[111,808,772],494:[439,780],495:[658,780],496:[106,780],500:[71,769],501:[103,769],542:[72,780],543:[104,780],550:[65,775],551:[97,775],552:[69,807],553:[101,807],554:[79,776,772],555:[111,776,772],556:[79,771,772],557:[111,771,772],558:[79,775],559:[111,775],560:[79,775,772],561:[111,775,772],562:[89,772],563:[121,772],832:768,833:769,835:787,836:[776,769],884:697,894:59,901:[168,769],902:[913,769],903:183,904:[917,769],905:[919,769],906:[921,769],908:[927,769],910:[933,769],911:[937,769],912:[953,776,769],938:[921,776],939:[933,776],940:[945,769],941:[949,769],942:[951,769],943:[953,769],944:[965,776,769],970:[953,776],971:[965,776],972:[959,769],973:[965,769],974:[969,769],979:[978,769],980:[978,776],1024:[1045,768],1025:[1045,776],1027:[1043,769],1031:[1030,776],1036:[1050,769],1037:[1048,768],1038:[1059,774],1049:[1048,774],1081:[1080,774],1104:[1077,768],1105:[1077,776],1107:[1075,769],1111:[1110,776],1116:[1082,769],1117:[1080,768],1118:[1091,774],1142:[1140,783],1143:[1141,783],1217:[1046,774],1218:[1078,774],1232:[1040,774],1233:[1072,774],1234:[1040,776],1235:[1072,776],1238:[1045,774],1239:[1077,774],1242:[1240,776],1243:[1241,776],1244:[1046,776],1245:[1078,776],1246:[1047,776],1247:[1079,776],1250:[1048,772],1251:[1080,772],1252:[1048,776],1253:[1080,776],1254:[1054,776],1255:[1086,776],1258:[1256,776],1259:[1257,776],1260:[1069,776],1261:[1101,776],1262:[1059,772],1263:[1091,772],1264:[1059,776],1265:[1091,776],1266:[1059,779],1267:[1091,779],1268:[1063,776],1269:[1095,776],1272:[1067,776],1273:[1099,776],1570:[1575,1619],1571:[1575,1620],1572:[1608,1620],1573:[1575,1621],1574:[1610,1620],1728:[1749,1620],1730:[1729,1620],1747:[1746,1620],2345:[2344,2364],2353:[2352,2364],2356:[2355,2364],2392:[2325,2364],2393:[2326,2364],2394:[2327,2364],2395:[2332,2364],2396:[2337,2364],2397:[2338,2364],2398:[2347,2364],2399:[2351,2364],2507:[2503,2494],2508:[2503,2519],2524:[2465,2492],2525:[2466,2492],2527:[2479,2492],2611:[2610,2620],2614:[2616,2620],2649:[2582,2620],2650:[2583,2620],2651:[2588,2620],2654:[2603,2620],2888:[2887,2902],2891:[2887,2878],2892:[2887,2903],2908:[2849,2876],2909:[2850,2876],2964:[2962,3031],3018:[3014,3006],3019:[3015,3006],3020:[3014,3031],3144:[3142,3158],3264:[3263,3285],3271:[3270,3285],3272:[3270,3286],3274:[3270,3266],3275:[3270,3266,3285],3402:[3398,3390],3403:[3399,3390],3404:[3398,3415],3546:[3545,3530],3548:[3545,3535],3549:[3545,3535,3530],3550:[3545,3551],3907:[3906,4023],3917:[3916,4023],3922:[3921,4023],3927:[3926,4023],3932:[3931,4023],3945:[3904,4021],3955:[3953,3954],3957:[3953,3956],3958:[4018,3968],3960:[4019,3968],3969:[3953,3968],3987:[3986,4023],3997:[3996,4023],4002:[4001,4023],4007:[4006,4023],4012:[4011,4023],4025:[3984,4021],4134:[4133,4142],7835:[383,775],7960:[917,787],7961:[917,788],7962:[917,787,768],7963:[917,788,768],7964:[917,787,769],7965:[917,788,769],8008:[927,787],8009:[927,788],8010:[927,787,768],8011:[927,788,768],8012:[927,787,769],8013:[927,788,769],8016:[965,787],8017:[965,788],8018:[965,787,768],8019:[965,788,768],8020:[965,787,769],8021:[965,788,769],8022:[965,787,834],8023:[965,788,834],8025:[933,788],8027:[933,788,768],8029:[933,788,769],8118:[945,834],8119:[945,834,837],8120:[913,774],8121:[913,772],8122:[913,768],8123:[913,769],8124:[913,837],8126:953,8129:[168,834],8130:[951,768,837],8131:[951,837],8132:[951,769,837],8134:[951,834],8135:[951,834,837],8136:[917,768],8137:[917,769],8138:[919,768],8139:[919,769],8140:[919,837],8141:[8127,768],8142:[8127,769],8143:[8127,834],8144:[953,774],8145:[953,772],8146:[953,776,768],8147:[953,776,769],8150:[953,834],8151:[953,776,834],8152:[921,774],8153:[921,772],8154:[921,768],8155:[921,769],8178:[969,768,837],8179:[969,837],8180:[969,769,837],8182:[969,834],8183:[969,834,837],8184:[927,768],8185:[927,769],8186:[937,768],8187:[937,769],8188:[937,837],8189:180,8192:8194,8193:8195,8486:937,8490:75,8491:[65,778],8602:[8592,824],8603:[8594,824],8622:[8596,824],8653:[8656,824],8654:[8660,824],8655:[8658,824],8708:[8707,824],8713:[8712,824],8716:[8715,824],8740:[8739,824],8742:[8741,824],8769:[8764,824],8772:[8771,824],8775:[8773,824],8777:[8776,824],8800:[61,824],8802:[8801,824],8813:[8781,824],8814:[60,824],8815:[62,824],8816:[8804,824],8817:[8805,824],8820:[8818,824],8821:[8819,824],8824:[8822,824],8825:[8823,824],8832:[8826,824],8833:[8827,824],8836:[8834,824],8837:[8835,824],8840:[8838,824],8841:[8839,824],8876:[8866,824],8877:[8872,824],8878:[8873,824],8879:[8875,824],8928:[8828,824],8929:[8829,824],8930:[8849,824],8931:[8850,824],8938:[8882,824],8939:[8883,824],8940:[8884,824],8941:[8885,824],9001:12296,9002:12297,10972:[10973,824],12364:[12363,12441],12366:[12365,12441],12368:[12367,12441],12370:[12369,12441],12372:[12371,12441],12374:[12373,12441],12376:[12375,12441],12378:[12377,12441],12380:[12379,12441],12382:[12381,12441],12384:[12383,12441],12386:[12385,12441],12389:[12388,12441],12391:[12390,12441],12393:[12392,12441],12400:[12399,12441],12401:[12399,12442],12403:[12402,12441],12404:[12402,12442],12406:[12405,12441],12407:[12405,12442],12409:[12408,12441],12410:[12408,12442],12412:[12411,12441],12413:[12411,12442],12436:[12358,12441],12446:[12445,12441],12460:[12459,12441],12462:[12461,12441],12464:[12463,12441],12466:[12465,12441],12468:[12467,12441],12470:[12469,12441],12472:[12471,12441],12474:[12473,12441],12476:[12475,12441],12478:[12477,12441],12480:[12479,12441],12482:[12481,12441],12485:[12484,12441],12487:[12486,12441],12489:[12488,12441],12496:[12495,12441],12497:[12495,12442],12499:[12498,12441],12500:[12498,12442],12502:[12501,12441],12503:[12501,12442],12505:[12504,12441],12506:[12504,12442],12508:[12507,12441],12509:[12507,12442],12532:[12454,12441],12535:[12527,12441],12536:[12528,12441],12537:[12529,12441],12538:[12530,12441],12542:[12541,12441],64016:22618,64018:26228,64021:20958,64022:29482,64023:30410,64024:31036,64025:31070,64026:31077,64027:31119,64028:38742,64029:31934,64030:32701,64032:34322,64034:35576,64037:36920,64038:37117,64042:39151,64043:39164,64044:39208,64045:40372,64285:[1497,1460],64287:[1522,1463],64298:[1513,1473],64299:[1513,1474],64300:[1513,1468,1473],64301:[1513,1468,1474],64302:[1488,1463],64303:[1488,1464],64304:[1488,1468],64305:[1489,1468],64306:[1490,1468],64307:[1491,1468],64308:[1492,1468],64309:[1493,1468],64310:[1494,1468],64312:[1496,1468],64313:[1497,1468],64314:[1498,1468],64315:[1499,1468],64316:[1500,1468],64318:[1502,1468],64320:[1504,1468],64321:[1505,1468],64323:[1507,1468],64324:[1508,1468],64326:[1510,1468],64327:[1511,1468],64328:[1512,1468],64329:[1513,1468],64330:[1514,1468],64331:[1493,1465],64332:[1489,1471],64333:[1499,1471],64334:[1508,1471],119134:[119127,119141],119135:[119128,119141],119136:[119128,119141,119150],119137:[119128,119141,119151],119138:[119128,119141,119152],119139:[119128,119141,119153],119140:[119128,119141,119154],119227:[119225,119141],119228:[119226,119141],119229:[119225,119141,119150],119230:[119226,119141,119150],119231:[119225,119141,119151],119232:[119226,119141,119151]};(function(){var t,s,o,l=or;for(t=[[121,776],[65,772],[97,772],[65,774],[97,774],[65,808],[97,808],[67,769],[99,769],[67,770],[99,770],[67,775],[99,775],[67,780],[99,780],[68,780],[100,780]],s=0;s<17;s++)o=t[s],l[s+255]=o;for(t=[[69,772],[101,772],[69,774],[101,774],[69,775],[101,775],[69,808],[101,808],[69,780],[101,780],[71,770],[103,770],[71,774],[103,774],[71,775],[103,775],[71,807],[103,807],[72,770],[104,770]],s=0;s<20;s++)o=t[s],l[s+274]=o;for(t=[[82,769],[114,769],[82,807],[114,807],[82,780],[114,780],[83,769],[115,769],[83,770],[115,770],[83,807],[115,807],[83,780],[115,780],[84,807],[116,807],[84,780],[116,780]],s=0;s<18;s++)o=t[s],l[s+340]=o;for(t=[[85,771],[117,771],[85,772],[117,772],[85,774],[117,774],[85,778],[117,778],[85,779],[117,779],[85,808],[117,808],[87,770],[119,770],[89,770],[121,770],[89,776],[90,769],[122,769],[90,775],[122,775],[90,780],[122,780]],s=0;s<23;s++)o=t[s],l[s+360]=o;for(t=[[65,780],[97,780],[73,780],[105,780],[79,780],[111,780],[85,780],[117,780],[85,776,772],[117,776,772],[85,776,769],[117,776,769],[85,776,780],[117,776,780],[85,776,768],[117,776,768]],s=0;s<16;s++)o=t[s],l[s+461]=o;for(t=[[78,768],[110,768],[65,778,769],[97,778,769],[198,769],[230,769],[216,769],[248,769],[65,783],[97,783],[65,785],[97,785],[69,783],[101,783],[69,785],[101,785],[73,783],[105,783],[73,785],[105,785],[79,783],[111,783],[79,785],[111,785],[82,783],[114,783],[82,785],[114,785],[85,783],[117,783],[85,785],[117,785],[83,806],[115,806],[84,806],[116,806]],s=0;s<36;s++)o=t[s],l[s+504]=o;for(t=[[65,805],[97,805],[66,775],[98,775],[66,803],[98,803],[66,817],[98,817],[67,807,769],[99,807,769],[68,775],[100,775],[68,803],[100,803],[68,817],[100,817],[68,807],[100,807],[68,813],[100,813],[69,772,768],[101,772,768],[69,772,769],[101,772,769],[69,813],[101,813],[69,816],[101,816],[69,807,774],[101,807,774],[70,775],[102,775],[71,772],[103,772],[72,775],[104,775],[72,803],[104,803],[72,776],[104,776],[72,807],[104,807],[72,814],[104,814],[73,816],[105,816],[73,776,769],[105,776,769],[75,769],[107,769],[75,803],[107,803],[75,817],[107,817],[76,803],[108,803],[76,803,772],[108,803,772],[76,817],[108,817],[76,813],[108,813],[77,769],[109,769],[77,775],[109,775],[77,803],[109,803],[78,775],[110,775],[78,803],[110,803],[78,817],[110,817],[78,813],[110,813],[79,771,769],[111,771,769],[79,771,776],[111,771,776],[79,772,768],[111,772,768],[79,772,769],[111,772,769],[80,769],[112,769],[80,775],[112,775],[82,775],[114,775],[82,803],[114,803],[82,803,772],[114,803,772],[82,817],[114,817],[83,775],[115,775],[83,803],[115,803],[83,769,775],[115,769,775],[83,780,775],[115,780,775],[83,803,775],[115,803,775],[84,775],[116,775],[84,803],[116,803],[84,817],[116,817],[84,813],[116,813],[85,804],[117,804],[85,816],[117,816],[85,813],[117,813],[85,771,769],[117,771,769],[85,772,776],[117,772,776],[86,771],[118,771],[86,803],[118,803],[87,768],[119,768],[87,769],[119,769],[87,776],[119,776],[87,775],[119,775],[87,803],[119,803],[88,775],[120,775],[88,776],[120,776],[89,775],[121,775],[90,770],[122,770],[90,803],[122,803],[90,817],[122,817],[104,817],[116,776],[119,778],[121,778]],s=0;s<154;s++)o=t[s],l[s+7680]=o;for(t=[[65,803],[97,803],[65,777],[97,777],[65,770,769],[97,770,769],[65,770,768],[97,770,768],[65,770,777],[97,770,777],[65,770,771],[97,770,771],[65,803,770],[97,803,770],[65,774,769],[97,774,769],[65,774,768],[97,774,768],[65,774,777],[97,774,777],[65,774,771],[97,774,771],[65,803,774],[97,803,774],[69,803],[101,803],[69,777],[101,777],[69,771],[101,771],[69,770,769],[101,770,769],[69,770,768],[101,770,768],[69,770,777],[101,770,777],[69,770,771],[101,770,771],[69,803,770],[101,803,770],[73,777],[105,777],[73,803],[105,803],[79,803],[111,803],[79,777],[111,777],[79,770,769],[111,770,769],[79,770,768],[111,770,768],[79,770,777],[111,770,777],[79,770,771],[111,770,771],[79,803,770],[111,803,770],[79,795,769],[111,795,769],[79,795,768],[111,795,768],[79,795,777],[111,795,777],[79,795,771],[111,795,771],[79,795,803],[111,795,803],[85,803],[117,803],[85,777],[117,777],[85,795,769],[117,795,769],[85,795,768],[117,795,768],[85,795,777],[117,795,777],[85,795,771],[117,795,771],[85,795,803],[117,795,803],[89,768],[121,768],[89,803],[121,803],[89,777],[121,777],[89,771],[121,771]],s=0;s<90;s++)o=t[s],l[s+7840]=o;for(t=[[945,787],[945,788],[945,787,768],[945,788,768],[945,787,769],[945,788,769],[945,787,834],[945,788,834],[913,787],[913,788],[913,787,768],[913,788,768],[913,787,769],[913,788,769],[913,787,834],[913,788,834],[949,787],[949,788],[949,787,768],[949,788,768],[949,787,769],[949,788,769]],s=0;s<22;s++)o=t[s],l[s+7936]=o;for(t=[[951,787],[951,788],[951,787,768],[951,788,768],[951,787,769],[951,788,769],[951,787,834],[951,788,834],[919,787],[919,788],[919,787,768],[919,788,768],[919,787,769],[919,788,769],[919,787,834],[919,788,834],[953,787],[953,788],[953,787,768],[953,788,768],[953,787,769],[953,788,769],[953,787,834],[953,788,834],[921,787],[921,788],[921,787,768],[921,788,768],[921,787,769],[921,788,769],[921,787,834],[921,788,834],[959,787],[959,788],[959,787,768],[959,788,768],[959,787,769],[959,788,769]],s=0;s<38;s++)o=t[s],l[s+7968]=o;for(t=[[933,788,834],[969,787],[969,788],[969,787,768],[969,788,768],[969,787,769],[969,788,769],[969,787,834],[969,788,834],[937,787],[937,788],[937,787,768],[937,788,768],[937,787,769],[937,788,769],[937,787,834],[937,788,834],[945,768],[945,769],[949,768],[949,769],[951,768],[951,769],[953,768],[953,769],[959,768],[959,769],[965,768],[965,769],[969,768],[969,769]],s=0;s<31;s++)o=t[s],l[s+8031]=o;for(t=[[945,787,837],[945,788,837],[945,787,768,837],[945,788,768,837],[945,787,769,837],[945,788,769,837],[945,787,834,837],[945,788,834,837],[913,787,837],[913,788,837],[913,787,768,837],[913,788,768,837],[913,787,769,837],[913,788,769,837],[913,787,834,837],[913,788,834,837],[951,787,837],[951,788,837],[951,787,768,837],[951,788,768,837],[951,787,769,837],[951,788,769,837],[951,787,834,837],[951,788,834,837],[919,787,837],[919,788,837],[919,787,768,837],[919,788,768,837],[919,787,769,837],[919,788,769,837],[919,787,834,837],[919,788,834,837],[969,787,837],[969,788,837],[969,787,768,837],[969,788,768,837],[969,787,769,837],[969,788,769,837],[969,787,834,837],[969,788,834,837],[937,787,837],[937,788,837],[937,787,768,837],[937,788,768,837],[937,787,769,837],[937,788,769,837],[937,787,834,837],[937,788,834,837],[945,774],[945,772],[945,768,837],[945,837],[945,769,837]],s=0;s<53;s++)o=t[s],l[s+8064]=o;for(t=[[8190,768],[8190,769],[8190,834],[965,774],[965,772],[965,776,768],[965,776,769],[961,787],[961,788],[965,834],[965,776,834],[933,774],[933,772],[933,768],[933,769],[929,788],[168,768],[168,769],96],s=0;s<19;s++)o=t[s],l[s+8157]=o;for(t=[35912,26356,36554,36040,28369,20018,21477,40860,40860,22865,37329,21895,22856,25078,30313,32645,34367,34746,35064,37007,27138,27931,28889,29662,33853,37226,39409,20098,21365,27396,29211,34349,40478,23888,28651,34253,35172,25289,33240,34847,24266,26391,28010,29436,37070,20358,20919,21214,25796,27347,29200,30439,32769,34310,34396,36335,38706,39791,40442,30860,31103,32160,33737,37636,40575,35542,22751,24324,31840,32894,29282,30922,36034,38647,22744,23650,27155,28122,28431,32047,32311,38475,21202,32907,20956,20940,31260,32190,33777,38517,35712,25295,27138,35582,20025,23527,24594,29575,30064,21271,30971,20415,24489,19981,27852,25976,32034,21443,22622,30465,33865,35498,27578,36784,27784,25342,33509,25504,30053,20142,20841,20937,26753,31975,33391,35538,37327,21237,21570,22899,24300,26053,28670,31018,38317,39530,40599,40654,21147,26310,27511,36706,24180,24976,25088,25754,28451,29001,29833,31178,32244,32879,36646,34030,36899,37706,21015,21155,21693,28872,35010,35498,24265,24565,25467,27566,31806,29557,20196,22265,23527,23994,24604,29618,29801,32666,32838,37428,38646,38728,38936,20363,31150,37300,38584,24801,20102,20698,23534,23615,26009,27138,29134,30274,34044,36988,40845,26248,38446,21129,26491,26611,27969,28316,29705,30041,30827,32016,39006,20845,25134,38520,20523,23833,28138,36650,24459,24900,26647,29575,38534,21033,21519,23653,26131,26446,26792,27877,29702,30178,32633,35023,35041,37324,38626,21311,28346,21533,29136,29848,34298,38563,40023,40607,26519,28107,33256,31435,31520,31890,29376,28825,35672,20160,33590,21050,20999,24230,25299,31958,23429,27934,26292,36667,34892,38477,35211,24275,20800,21952],s=0;s<270;s++)o=t[s],l[s+63744]=o;for(t=[20398,20711,20813,21193,21220,21329,21917,22022,22120,22592,22696,23652,23662,24724,24936,24974,25074,25935,26082,26257,26757,28023,28186,28450,29038,29227,29730,30865,31038,31049,31048,31056,31062,31069,31117,31118,31296,31361,31680,32244,32265,32321,32626,32773,33261,33401,33401,33879,35088,35222,35585,35641,36051,36104,36790,36920,38627,38911,38971],s=0;s<59;s++)o=t[s],l[s+64048]=o;for(t=[20029,20024,20033,131362,20320,20398,20411,20482,20602,20633,20711,20687,13470,132666,20813,20820,20836,20855,132380,13497,20839,20877,132427,20887,20900,20172,20908,20917,168415,20981,20995,13535,21051,21062,21106,21111,13589,21191,21193,21220,21242,21253,21254,21271,21321,21329,21338,21363,21373,21375,21375,21375,133676,28784,21450,21471,133987,21483,21489,21510,21662,21560,21576,21608,21666,21750,21776,21843,21859,21892,21892,21913,21931,21939,21954,22294,22022,22295,22097,22132,20999,22766,22478,22516,22541,22411,22578,22577,22700,136420,22770,22775,22790,22810,22818,22882,136872,136938,23020,23067,23079,23e3,23142,14062,14076,23304,23358,23358,137672,23491,23512,23527,23539,138008,23551,23558,24403,23586,14209,23648,23662,23744,23693,138724,23875,138726,23918,23915,23932,24033,24034,14383,24061,24104,24125,24169,14434,139651,14460,24240,24243,24246,24266,172946,24318,140081,140081,33281,24354,24354,14535,144056,156122,24418,24427,14563,24474,24525,24535,24569,24705,14650,14620,24724,141012,24775,24904,24908,24910,24908,24954,24974,25010,24996,25007,25054,25074,25078,25104,25115,25181,25265,25300,25424,142092,25405,25340,25448,25475,25572,142321,25634,25541,25513,14894,25705,25726,25757,25719,14956,25935,25964,143370,26083,26360,26185,15129,26257,15112,15076,20882,20885,26368,26268,32941,17369,26391,26395,26401,26462,26451,144323,15177,26618,26501,26706,26757,144493,26766,26655,26900,15261,26946,27043,27114,27304,145059,27355,15384,27425,145575,27476,15438,27506,27551,27578,27579,146061,138507,146170,27726,146620,27839,27853,27751,27926,27966,28023,27969,28009,28024,28037,146718,27956,28207,28270,15667,28363,28359,147153,28153,28526,147294,147342,28614,28729,28702,28699,15766,28746,28797,28791,28845,132389,28997,148067,29084,148395,29224,29237,29264,149e3,29312,29333,149301,149524,29562,29579,16044,29605,16056,16056,29767,29788,29809,29829,29898,16155,29988,150582,30014,150674,30064,139679,30224,151457,151480,151620,16380,16392,30452,151795,151794,151833,151859,30494,30495,30495,30538,16441,30603,16454,16534,152605,30798,30860,30924,16611,153126,31062,153242,153285,31119,31211,16687,31296,31306,31311,153980,154279,154279,31470,16898,154539,31686,31689,16935,154752,31954,17056,31976,31971,32e3,155526,32099,17153,32199,32258,32325,17204,156200,156231,17241,156377,32634,156478,32661,32762,32773,156890,156963,32864,157096,32880,144223,17365,32946,33027,17419,33086,23221,157607,157621,144275,144284,33281,33284,36766,17515,33425,33419,33437,21171,33457,33459,33469,33510,158524,33509,33565,33635,33709,33571,33725,33767,33879,33619,33738,33740,33756,158774,159083,158933,17707,34033,34035,34070,160714,34148,159532,17757,17761,159665,159954,17771,34384,34396,34407,34409,34473,34440,34574,34530,34681,34600,34667,34694,17879,34785,34817,17913,34912,34915,161383,35031,35038,17973,35066,13499,161966,162150,18110,18119,35488,35565,35722,35925,162984,36011,36033,36123,36215,163631,133124,36299,36284,36336,133342,36564,36664,165330,165357,37012,37105,37137,165678,37147,37432,37591,37592,37500,37881,37909,166906,38283,18837,38327,167287,18918,38595,23986,38691,168261,168474,19054,19062,38880,168970,19122,169110,38923,38923,38953,169398,39138,19251,39209,39335,39362,39422,19406,170800,39698,4e4,40189,19662,19693,40295,172238,19704,172293,172558,172689,40635,19798,40697,40702,40709,40719,40726,40763,173568],s=0;s<542;s++)o=t[s],l[s+194560]=o})();var ke={768:230,769:230,770:230,771:230,772:230,773:230,774:230,775:230,776:230,777:230,778:230,779:230,780:230,781:230,782:230,783:230,784:230,785:230,786:230,787:230,788:230,789:232,790:220,791:220,792:220,793:220,794:232,795:216,796:220,797:220,798:220,799:220,800:220,801:202,802:202,803:220,804:220,805:220,806:220,807:202,808:202,809:220,810:220,811:220,812:220,813:220,814:220,815:220,816:220,817:220,818:220,819:220,820:1,821:1,822:1,823:1,824:1,825:220,826:220,827:220,828:220,829:230,830:230,831:230,832:230,833:230,834:230,835:230,836:230,837:240,838:230,839:220,840:220,841:220,842:230,843:230,844:230,845:220,846:220,848:230,849:230,850:230,851:220,852:220,853:220,854:220,855:230,861:234,862:234,863:233,864:234,865:234,866:233,867:230,868:230,869:230,870:230,871:230,872:230,873:230,874:230,875:230,876:230,877:230,878:230,879:230,1155:230,1156:230,1157:230,1158:230,1425:220,1426:230,1427:230,1428:230,1429:230,1430:220,1431:230,1432:230,1433:230,1434:222,1435:220,1436:230,1437:230,1438:230,1439:230,1440:230,1441:230,1443:220,1444:220,1445:220,1446:220,1447:220,1448:230,1449:230,1450:220,1451:230,1452:230,1453:222,1454:228,1455:230,1456:10,1457:11,1458:12,1459:13,1460:14,1461:15,1462:16,1463:17,1464:18,1465:19,1467:20,1468:21,1469:22,1471:23,1473:24,1474:25,1476:230,1552:230,1553:230,1554:230,1555:230,1556:230,1557:230,1611:27,1612:28,1613:29,1614:30,1615:31,1616:32,1617:33,1618:34,1619:230,1620:230,1621:220,1622:220,1623:230,1624:230,1648:35,1750:230,1751:230,1752:230,1753:230,1754:230,1755:230,1756:230,1759:230,1760:230,1761:230,1762:230,1763:220,1764:230,1767:230,1768:230,1770:220,1771:230,1772:230,1773:220,1809:36,1840:230,1841:220,1842:230,1843:230,1844:220,1845:230,1846:230,1847:220,1848:220,1849:220,1850:230,1851:220,1852:220,1853:230,1854:220,1855:230,1856:230,1857:230,1858:220,1859:230,1860:220,1861:230,1862:220,1863:230,1864:220,1865:230,1866:230,2364:7,2381:9,2385:230,2386:220,2387:230,2388:230,2492:7,2509:9,2620:7,2637:9,2748:7,2765:9,2876:7,2893:9,3021:9,3149:9,3157:84,3158:91,3260:7,3277:9,3405:9,3530:9,3640:103,3641:103,3642:9,3656:107,3657:107,3658:107,3659:107,3768:118,3769:118,3784:122,3785:122,3786:122,3787:122,3864:220,3865:220,3893:220,3895:220,3897:216,3953:129,3954:130,3956:132,3962:130,3963:130,3964:130,3965:130,3968:130,3970:230,3971:230,3972:9,3974:230,3975:230,4038:220,4151:7,4153:9,5908:9,5940:9,6098:9,6109:230,6313:228,6457:222,6458:230,6459:220,8400:230,8401:230,8402:1,8403:1,8404:230,8405:230,8406:230,8407:230,8408:1,8409:1,8410:1,8411:230,8412:230,8417:230,8421:1,8422:1,8423:230,8424:220,8425:230,8426:1,12330:218,12331:228,12332:232,12333:222,12334:224,12335:224,12441:8,12442:8,64286:26,65056:230,65057:230,65058:230,65059:230,119141:216,119142:216,119143:1,119144:1,119145:1,119149:226,119150:216,119151:216,119152:216,119153:216,119154:216,119163:220,119164:220,119165:220,119166:220,119167:220,119168:220,119169:220,119170:220,119173:230,119174:230,119175:230,119176:230,119177:230,119178:220,119179:220,119210:230,119211:230,119212:230,119213:230},xn={60:{824:8814},61:{824:8800},62:{824:8815},65:{768:192,769:193,770:194,771:195,772:256,774:258,775:550,776:196,777:7842,778:197,780:461,783:512,785:514,803:7840,805:7680,808:260},66:{775:7682,803:7684,817:7686},67:{769:262,770:264,775:266,780:268,807:199},68:{775:7690,780:270,803:7692,807:7696,813:7698,817:7694},69:{768:200,769:201,770:202,771:7868,772:274,774:276,775:278,776:203,777:7866,780:282,783:516,785:518,803:7864,807:552,808:280,813:7704,816:7706},70:{775:7710},71:{769:500,770:284,772:7712,774:286,775:288,780:486,807:290},72:{770:292,775:7714,776:7718,780:542,803:7716,807:7720,814:7722},73:{768:204,769:205,770:206,771:296,772:298,774:300,775:304,776:207,777:7880,780:463,783:520,785:522,803:7882,808:302,816:7724},74:{770:308},75:{769:7728,780:488,803:7730,807:310,817:7732},76:{769:313,780:317,803:7734,807:315,813:7740,817:7738},77:{769:7742,775:7744,803:7746},78:{768:504,769:323,771:209,775:7748,780:327,803:7750,807:325,813:7754,817:7752},79:{768:210,769:211,770:212,771:213,772:332,774:334,775:558,776:214,777:7886,779:336,780:465,783:524,785:526,795:416,803:7884,808:490},80:{769:7764,775:7766},82:{769:340,775:7768,780:344,783:528,785:530,803:7770,807:342,817:7774},83:{769:346,770:348,775:7776,780:352,803:7778,806:536,807:350},84:{775:7786,780:356,803:7788,806:538,807:354,813:7792,817:7790},85:{768:217,769:218,770:219,771:360,772:362,774:364,776:220,777:7910,778:366,779:368,780:467,783:532,785:534,795:431,803:7908,804:7794,808:370,813:7798,816:7796},86:{771:7804,803:7806},87:{768:7808,769:7810,770:372,775:7814,776:7812,803:7816},88:{775:7818,776:7820},89:{768:7922,769:221,770:374,771:7928,772:562,775:7822,776:376,777:7926,803:7924},90:{769:377,770:7824,775:379,780:381,803:7826,817:7828},97:{768:224,769:225,770:226,771:227,772:257,774:259,775:551,776:228,777:7843,778:229,780:462,783:513,785:515,803:7841,805:7681,808:261},98:{775:7683,803:7685,817:7687},99:{769:263,770:265,775:267,780:269,807:231},100:{775:7691,780:271,803:7693,807:7697,813:7699,817:7695},101:{768:232,769:233,770:234,771:7869,772:275,774:277,775:279,776:235,777:7867,780:283,783:517,785:519,803:7865,807:553,808:281,813:7705,816:7707},102:{775:7711},103:{769:501,770:285,772:7713,774:287,775:289,780:487,807:291},104:{770:293,775:7715,776:7719,780:543,803:7717,807:7721,814:7723,817:7830},105:{768:236,769:237,770:238,771:297,772:299,774:301,776:239,777:7881,780:464,783:521,785:523,803:7883,808:303,816:7725},106:{770:309,780:496},107:{769:7729,780:489,803:7731,807:311,817:7733},108:{769:314,780:318,803:7735,807:316,813:7741,817:7739},109:{769:7743,775:7745,803:7747},110:{768:505,769:324,771:241,775:7749,780:328,803:7751,807:326,813:7755,817:7753},111:{768:242,769:243,770:244,771:245,772:333,774:335,775:559,776:246,777:7887,779:337,780:466,783:525,785:527,795:417,803:7885,808:491},112:{769:7765,775:7767},114:{769:341,775:7769,780:345,783:529,785:531,803:7771,807:343,817:7775},115:{769:347,770:349,775:7777,780:353,803:7779,806:537,807:351},116:{775:7787,776:7831,780:357,803:7789,806:539,807:355,813:7793,817:7791},117:{768:249,769:250,770:251,771:361,772:363,774:365,776:252,777:7911,778:367,779:369,780:468,783:533,785:535,795:432,803:7909,804:7795,808:371,813:7799,816:7797},118:{771:7805,803:7807},119:{768:7809,769:7811,770:373,775:7815,776:7813,778:7832,803:7817},120:{775:7819,776:7821},121:{768:7923,769:253,770:375,771:7929,772:563,775:7823,776:255,777:7927,778:7833,803:7925},122:{769:378,770:7825,775:380,780:382,803:7827,817:7829},168:{768:8173,769:901,834:8129},194:{768:7846,769:7844,771:7850,777:7848},196:{772:478},197:{769:506},198:{769:508,772:482},199:{769:7688},202:{768:7872,769:7870,771:7876,777:7874},207:{769:7726},212:{768:7890,769:7888,771:7894,777:7892},213:{769:7756,772:556,776:7758},214:{772:554},216:{769:510},220:{768:475,769:471,772:469,780:473},226:{768:7847,769:7845,771:7851,777:7849},228:{772:479},229:{769:507},230:{769:509,772:483},231:{769:7689},234:{768:7873,769:7871,771:7877,777:7875},239:{769:7727},244:{768:7891,769:7889,771:7895,777:7893},245:{769:7757,772:557,776:7759},246:{772:555},248:{769:511},252:{768:476,769:472,772:470,780:474},258:{768:7856,769:7854,771:7860,777:7858},259:{768:7857,769:7855,771:7861,777:7859},274:{768:7700,769:7702},275:{768:7701,769:7703},332:{768:7760,769:7762},333:{768:7761,769:7763},346:{775:7780},347:{775:7781},352:{775:7782},353:{775:7783},360:{769:7800},361:{769:7801},362:{776:7802},363:{776:7803},383:{775:7835},416:{768:7900,769:7898,771:7904,777:7902,803:7906},417:{768:7901,769:7899,771:7905,777:7903,803:7907},431:{768:7914,769:7912,771:7918,777:7916,803:7920},432:{768:7915,769:7913,771:7919,777:7917,803:7921},439:{780:494},490:{772:492},491:{772:493},550:{772:480},551:{772:481},552:{774:7708},553:{774:7709},558:{772:560},559:{772:561},658:{780:495},776:{769:836},913:{768:8122,769:902,772:8121,774:8120,787:7944,788:7945,837:8124},917:{768:8136,769:904,787:7960,788:7961},919:{768:8138,769:905,787:7976,788:7977,837:8140},921:{768:8154,769:906,772:8153,774:8152,776:938,787:7992,788:7993},927:{768:8184,769:908,787:8008,788:8009},929:{788:8172},933:{768:8170,769:910,772:8169,774:8168,776:939,788:8025},937:{768:8186,769:911,787:8040,788:8041,837:8188},940:{837:8116},942:{837:8132},945:{768:8048,769:940,772:8113,774:8112,787:7936,788:7937,834:8118,837:8115},949:{768:8050,769:941,787:7952,788:7953},951:{768:8052,769:942,787:7968,788:7969,834:8134,837:8131},953:{768:8054,769:943,772:8145,774:8144,776:970,787:7984,788:7985,834:8150},959:{768:8056,769:972,787:8e3,788:8001},961:{787:8164,788:8165},965:{768:8058,769:973,772:8161,774:8160,776:971,787:8016,788:8017,834:8166},969:{768:8060,769:974,787:8032,788:8033,834:8182,837:8179},970:{768:8146,769:912,834:8151},971:{768:8162,769:944,834:8167},974:{837:8180},978:{769:979,776:980},1030:{776:1031},1040:{774:1232,776:1234},1043:{769:1027},1045:{768:1024,774:1238,776:1025},1046:{774:1217,776:1244},1047:{776:1246},1048:{768:1037,772:1250,774:1049,776:1252},1050:{769:1036},1054:{776:1254},1059:{772:1262,774:1038,776:1264,779:1266},1063:{776:1268},1067:{776:1272},1069:{776:1260},1072:{774:1233,776:1235},1075:{769:1107},1077:{768:1104,774:1239,776:1105},1078:{774:1218,776:1245},1079:{776:1247},1080:{768:1117,772:1251,774:1081,776:1253},1082:{769:1116},1086:{776:1255},1091:{772:1263,774:1118,776:1265,779:1267},1095:{776:1269},1099:{776:1273},1101:{776:1261},1110:{776:1111},1140:{783:1142},1141:{783:1143},1240:{776:1242},1241:{776:1243},1256:{776:1258},1257:{776:1259},1488:{1463:64302,1464:64303,1468:64304},1489:{1468:64305,1471:64332},1490:{1468:64306},1491:{1468:64307},1492:{1468:64308},1493:{1465:64331,1468:64309},1494:{1468:64310},1496:{1468:64312},1497:{1460:64285,1468:64313},1498:{1468:64314},1499:{1468:64315,1471:64333},1500:{1468:64316},1502:{1468:64318},1504:{1468:64320},1505:{1468:64321},1507:{1468:64323},1508:{1468:64324,1471:64334},1510:{1468:64326},1511:{1468:64327},1512:{1468:64328},1513:{1468:64329,1473:64298,1474:64299},1514:{1468:64330},1522:{1463:64287},1575:{1619:1570,1620:1571,1621:1573},1608:{1620:1572},1610:{1620:1574},1729:{1620:1730},1746:{1620:1747},1749:{1620:1728},2325:{2364:2392},2326:{2364:2393},2327:{2364:2394},2332:{2364:2395},2337:{2364:2396},2338:{2364:2397},2344:{2364:2345},2347:{2364:2398},2351:{2364:2399},2352:{2364:2353},2355:{2364:2356},2465:{2492:2524},2466:{2492:2525},2479:{2492:2527},2503:{2494:2507,2519:2508},2582:{2620:2649},2583:{2620:2650},2588:{2620:2651},2603:{2620:2654},2610:{2620:2611},2616:{2620:2614},2849:{2876:2908},2850:{2876:2909},2887:{2878:2891,2902:2888,2903:2892},2962:{3031:2964},3014:{3006:3018,3031:3020},3015:{3006:3019},3142:{3158:3144},3263:{3285:3264},3270:{3266:3274,3285:3271,3286:3272},3274:{3285:3275},3398:{3390:3402,3415:3404},3399:{3390:3403},3545:{3530:3546,3535:3548,3551:3550},3548:{3530:3549},3904:{4021:3945},3906:{4023:3907},3916:{4023:3917},3921:{4023:3922},3926:{4023:3927},3931:{4023:3932},3953:{3954:3955,3956:3957,3968:3969},3984:{4021:4025},3986:{4023:3987},3996:{4023:3997},4001:{4023:4002},4006:{4023:4007},4011:{4023:4012},4018:{3968:3958},4019:{3968:3960},4133:{4142:4134},7734:{772:7736},7735:{772:7737},7770:{772:7772},7771:{772:7773},7778:{775:7784},7779:{775:7785},7840:{770:7852,774:7862},7841:{770:7853,774:7863},7864:{770:7878},7865:{770:7879},7884:{770:7896},7885:{770:7897},7936:{768:7938,769:7940,834:7942,837:8064},7937:{768:7939,769:7941,834:7943,837:8065},7938:{837:8066},7939:{837:8067},7940:{837:8068},7941:{837:8069},7942:{837:8070},7943:{837:8071},7944:{768:7946,769:7948,834:7950,837:8072},7945:{768:7947,769:7949,834:7951,837:8073},7946:{837:8074},7947:{837:8075},7948:{837:8076},7949:{837:8077},7950:{837:8078},7951:{837:8079},7952:{768:7954,769:7956},7953:{768:7955,769:7957},7960:{768:7962,769:7964},7961:{768:7963,769:7965},7968:{768:7970,769:7972,834:7974,837:8080},7969:{768:7971,769:7973,834:7975,837:8081},7970:{837:8082},7971:{837:8083},7972:{837:8084},7973:{837:8085},7974:{837:8086},7975:{837:8087},7976:{768:7978,769:7980,834:7982,837:8088},7977:{768:7979,769:7981,834:7983,837:8089},7978:{837:8090},7979:{837:8091},7980:{837:8092},7981:{837:8093},7982:{837:8094},7983:{837:8095},7984:{768:7986,769:7988,834:7990},7985:{768:7987,769:7989,834:7991},7992:{768:7994,769:7996,834:7998},7993:{768:7995,769:7997,834:7999},8e3:{768:8002,769:8004},8001:{768:8003,769:8005},8008:{768:8010,769:8012},8009:{768:8011,769:8013},8016:{768:8018,769:8020,834:8022},8017:{768:8019,769:8021,834:8023},8025:{768:8027,769:8029,834:8031},8032:{768:8034,769:8036,834:8038,837:8096},8033:{768:8035,769:8037,834:8039,837:8097},8034:{837:8098},8035:{837:8099},8036:{837:8100},8037:{837:8101},8038:{837:8102},8039:{837:8103},8040:{768:8042,769:8044,834:8046,837:8104},8041:{768:8043,769:8045,834:8047,837:8105},8042:{837:8106},8043:{837:8107},8044:{837:8108},8045:{837:8109},8046:{837:8110},8047:{837:8111},8048:{837:8114},8052:{837:8130},8060:{837:8178},8118:{837:8119},8127:{768:8141,769:8142,834:8143},8134:{837:8135},8182:{837:8183},8190:{768:8157,769:8158,834:8159},8592:{824:8602},8594:{824:8603},8596:{824:8622},8656:{824:8653},8658:{824:8655},8660:{824:8654},8707:{824:8708},8712:{824:8713},8715:{824:8716},8739:{824:8740},8741:{824:8742},8764:{824:8769},8771:{824:8772},8773:{824:8775},8776:{824:8777},8781:{824:8813},8801:{824:8802},8804:{824:8816},8805:{824:8817},8818:{824:8820},8819:{824:8821},8822:{824:8824},8823:{824:8825},8826:{824:8832},8827:{824:8833},8828:{824:8928},8829:{824:8929},8834:{824:8836},8835:{824:8837},8838:{824:8840},8839:{824:8841},8849:{824:8930},8850:{824:8931},8866:{824:8876},8872:{824:8877},8873:{824:8878},8875:{824:8879},8882:{824:8938},8883:{824:8939},8884:{824:8940},8885:{824:8941},10973:{824:10972},12358:{12441:12436},12363:{12441:12364},12365:{12441:12366},12367:{12441:12368},12369:{12441:12370},12371:{12441:12372},12373:{12441:12374},12375:{12441:12376},12377:{12441:12378},12379:{12441:12380},12381:{12441:12382},12383:{12441:12384},12385:{12441:12386},12388:{12441:12389},12390:{12441:12391},12392:{12441:12393},12399:{12441:12400,12442:12401},12402:{12441:12403,12442:12404},12405:{12441:12406,12442:12407},12408:{12441:12409,12442:12410},12411:{12441:12412,12442:12413},12445:{12441:12446},12454:{12441:12532},12459:{12441:12460},12461:{12441:12462},12463:{12441:12464},12465:{12441:12466},12467:{12441:12468},12469:{12441:12470},12471:{12441:12472},12473:{12441:12474},12475:{12441:12476},12477:{12441:12478},12479:{12441:12480},12481:{12441:12482},12484:{12441:12485},12486:{12441:12487},12488:{12441:12489},12495:{12441:12496,12442:12497},12498:{12441:12499,12442:12500},12501:{12441:12502,12442:12503},12504:{12441:12505,12442:12506},12507:{12441:12508,12442:12509},12527:{12441:12535},12528:{12441:12536},12529:{12441:12537},12530:{12441:12538},12541:{12441:12542},64329:{1473:64300,1474:64301},119127:{119141:119134},119128:{119141:119135},119135:{119150:119136,119151:119137,119152:119138,119153:119139,119154:119140},119225:{119141:119227},119226:{119141:119228},119227:{119150:119229,119151:119231},119228:{119150:119230,119151:119232}};function wn(t){return t<65536?String.fromCharCode(t):(t-=65536,String.fromCharCode(55296+(t>>10),56320+(t&1023)))}function G(t){var s,o,l=t.length;for(s=0;s<l&&!(t[s]<0||t[s]>=256);s++);if(s==l)return t;for(o=Array(l),s=0;s<l;s++)t[s]<0||t[s]>=256?o[s]=63:o[s]=t[s];return o}function se(t){var s,o,l=t.length;if(l==0)return"";for(s=0;s<l&&!(t[s]<0||t[s]>=256);s++);if(s==l)return String.fromCharCode.apply(this,t);for(o=Array(l),s=0;s<l;s++)o[s]=String.fromCharCode(t[s]&255);return o.join("")}function w(t){var s,o,l,f=t.length;if(f==0)return"";for(s=0;s<f&&!(t[s]>=65536);s++);if(s==f)return String.fromCharCode.apply(this,t);for(l=Array(f),s=0;s<f;s++)o=t[s],o<65536?l[s]=String.fromCharCode(o):(o-=65536,l[s]=String.fromCharCode(55296+(o>>10),56320+(o&1023)));return l.join("")}function k(t){var s=0;for(let l=0;l<t.length;l++){let f=t[l];f<128?s+=1:f<2048?s+=2:f<65536?s+=3:f<2097152?s+=4:s+=1}if(s==t.length)return t;let o=[];for(let l=0;l<t.length;l++){let f=t[l];f<128?o.push(f):f<2048?(o.push(192|(f&1984)>>6),o.push(128|f&63)):f<65536?(o.push(224|(f&61440)>>12),o.push(128|(f&4032)>>6),o.push(128|f&63)):f<2097152?(o.push(240|(f&1835008)>>18),o.push(128|(f&258048)>>12),o.push(128|(f&4032)>>6),o.push(128|f&63)):o.push(63)}return o}function v(t){for(var s=new Array(4*t.length),o=0;o<t.length;o++){var l=t[o];s[4*o]=l>>24&255,s[4*o+1]=l>>16&255,s[4*o+2]=l>>8&255,s[4*o+3]=l&255}return s}function S(t){window.console&&console.log&&console.log(t)}function Q(){this.value=void 0,this.set_value=function(t){this.value=t},this.get_value=function(){return this.value}}function q(){this.fields=[],this.push_field=function(t){this.fields.push(t)},this.set_field=function(t,s){this.fields[t]=s},this.get_field=function(t){return this.fields[t]},this.get_fields=function(){return this.fields}}var L={dummy:"Glk call has not yet returned"};function T(t){return t==1||t==192||t==98}var N=1,V=2,O=3,A=4,D=null,K=null,ie=null,sr=!0,R=null,Ne=null,Pe=null,_f=null,ee=null,B=null,mf=1,Te=null,Ft=null,kn=null;function gs(t,s){var o={};return o.type=t,o.rock=s,o.disprock=void 0,o.parent=null,o.str=gf(o),o.echostr=null,o.style=_.style_Normal,o.hyperlink=0,o.input_generation=null,o.linebuf=null,o.char_request=!1,o.line_request=!1,o.char_request_uni=!1,o.line_request_uni=!1,o.hyperlink_request=!1,o.mouse_request=!1,o.echo_line_input=!0,o.line_input_terminators=[],o.request_echo_line_input=null,o.prev=null,o.next=K,K=o,o.next&&(o.next.prev=o),i?i.class_register("window",o):o.disprock=mf++,sr=!0,o}function vn(t){var s,o;i&&i.class_unregister("window",t),sr=!0,t.echostr=null,t.str&&(bs(t.str),t.str=null),s=t.prev,o=t.next,t.prev=null,t.next=null,s?s.next=o:K=o,o&&(o.prev=s),t.parent=null,t.rock=null,t.disprock=null}function hf(t){var s;for(s=K;s;s=s.next)s.echostr===t&&(s.echostr=null)}function ft(t,s){var o,l;switch(t.type){case _.wintype_TextBuffer:(t.style!=t.accumstyle||t.hyperlink!=t.accumhyperlink||t.fg!=t.accum_fg||t.bg!=t.accum_bg||t.reverse!=t.accum_reverse)&&Fn(t),t.accum.push(s);break;case _.wintype_TextGrid:for(o=0;o<s.length;o++){if(l=s.charAt(o),t.cursorx<0?t.cursorx=0:t.cursorx>=t.gridwidth&&(t.cursorx=0,t.cursory++),t.cursory<0)t.cursory=0;else if(t.cursory>=t.gridheight)break;if(l==`
`){t.cursory++,t.cursorx=0;continue}var f=t.lines[t.cursory];f.dirty=!0,f.chars[t.cursorx]=l,f.styles[t.cursorx]=t.style,f.hyperlinks[t.cursorx]=t.hyperlink,f.fgs[t.cursorx]=t.fg,f.bgs[t.cursorx]=t.bg,f.reverses[t.cursorx]=t.reverse,t.cursorx++}break}}function ys(t){if(t.cursorx<0?t.cursorx=0:t.cursorx>=t.gridwidth&&(t.cursorx=0,t.cursory++),t.cursory<0)t.cursory=0;else if(t.cursory>=t.gridheight)return!0;return!1}function Fn(t){var s=t.content,o=vt[t.accumstyle],l,f,p,g,h;if(t.accum.length){for(l=t.accum.join(""),f=l.split(`
`),p=0;p<f.length;p++)if(h=void 0,p==0?f[p]&&(s.length==0?(h=[],s.push({content:h,append:!0})):(g=s[s.length-1],g.content?h=g.content:(h=[],g.content=h))):f[p]?(h=[],s.push({content:h})):s.push({}),h!==void 0)if(!t.accumhyperlink&&!t.accum_fg&&!t.accum_bg&&!t.accum_reverse)h.push(o),h.push(f[p]);else{let m={style:o,text:f[p]};t.accumhyperlink&&(m.hyperlink=t.accumhyperlink),t.accum_fg&&(m.css_styles||(m.css_styles={}),m.css_styles.color=t.accum_fg),t.accum_bg&&(m.css_styles||(m.css_styles={}),m.css_styles["background-color"]=t.accum_bg),t.accum_reverse&&(m.css_styles||(m.css_styles={}),m.css_styles.reverse=1),h.push(m)}}t.accum.length=0,t.accumstyle=t.style,t.accumhyperlink=t.hyperlink,t.accum_fg=t.fg,t.accum_bg=t.bg,t.accum_reverse=t.reverse}function Sn(t,s,o){Fn(t);var l=t.content,f=void 0,p;l.length==0?(f=[],p={content:f,append:!0},o&&(p.flowbreak=!0),l.push(p)):(p=l[l.length-1],o&&(p.flowbreak=!0),p.content?f=p.content:(f=[],p.content=f)),f!==void 0&&s!==void 0&&f.push(s)}function ar(t,s){var o;for(o=t.parent;o;o=o.parent)o.type==_.wintype_Pair&&o.pair_key===t&&(o.pair_key=null,o.pair_keydamage=!0);switch(i&&t.linebuf&&(i.unretain_array(t.linebuf),t.linebuf=null),t.type){case _.wintype_Pair:s&&(t.child1&&ar(t.child1,!0),t.child2&&ar(t.child2,!0)),t.child1=null,t.child2=null,t.pair_key=null;break;case _.wintype_TextBuffer:t.accum=null,t.content=null,t.reserve=null;break;case _.wintype_TextGrid:t.lines=null;break;case _.wintype_Graphics:t.content=null,t.reserve=null;break}vn(t)}function je(t,s){var o,l,f,p,g,h,m,E,X,J,P,te,ye,ze,Fe,dt;switch(sr=!0,t.bbox=s,t.type){case _.wintype_TextGrid:if(o=s.right-s.left,l=s.bottom-s.top,p=t.gridheight,t.gridwidth=Math.max(0,Math.floor((o-R.gridmarginx)/R.gridcharwidth)),t.gridheight=Math.max(0,Math.floor((l-R.gridmarginy)/R.gridcharheight)),p>t.gridheight)t.lines.length=t.gridheight;else if(p<t.gridheight)for(J=p;J<t.gridheight;J++)t.lines[J]={chars:[],styles:[],hyperlinks:[],fgs:[],bgs:[],reverses:[],dirty:!0};for(J=0;J<t.gridheight;J++)if(te=t.lines[J],f=te.chars.length,f>t.gridwidth)te.dirty=!0,te.chars.length=t.gridwidth,te.styles.length=t.gridwidth,te.hyperlinks.length=t.gridwidth,te.fgs.length=t.gridwidth,te.bgs.length=t.gridwidth,te.reverses.length=t.gridwidth;else if(f<t.gridwidth)for(te.dirty=!0,P=f;P<t.gridwidth;P++)te.chars[P]=" ",te.styles[P]=_.style_Normal,te.hyperlinks[P]=0,te.fgs[P]=null,te.bgs[P]=null,te.reverses[P]=0;break;case _.wintype_Graphics:o=s.right-s.left,l=s.bottom-s.top,t.graphwidth=Math.max(0,o-R.graphicsmarginx),t.graphheight=Math.max(0,l-R.graphicsmarginy);break;case _.wintype_Pair:t.pair_vertical?(g=t.bbox.left,h=t.bbox.right,X=R.inspacingx):(g=t.bbox.top,h=t.bbox.bottom,X=R.inspacingy),t.pair_hasborder||(X=0),m=h-g,t.pair_division==_.winmethod_Proportional?E=Math.floor(m*t.pair_size/100):t.pair_division==_.winmethod_Fixed?(E=0,t.pair_key&&t.pair_key.type==_.wintype_TextBuffer&&(t.pair_vertical?E=t.pair_size*R.buffercharwidth+R.buffermarginx:E=t.pair_size*R.buffercharheight+R.buffermarginy),t.pair_key&&t.pair_key.type==_.wintype_TextGrid&&(t.pair_vertical?E=t.pair_size*R.gridcharwidth+R.gridmarginx:E=t.pair_size*R.gridcharheight+R.gridmarginy),t.pair_key&&t.pair_key.type==_.wintype_Graphics&&(t.pair_vertical?E=t.pair_size+R.graphicsmarginx:E=t.pair_size+R.graphicsmarginy),E=Math.ceil(E)):E=Math.floor(m/2),t.pair_backward?E=g+E:E=h-E-X,g>=h?E=g:E=Math.min(Math.max(E,g),h-X),t.pair_splitpos=E,t.pair_splitwidth=X,t.pair_vertical?(ye={left:t.bbox.left,right:t.pair_splitpos,top:t.bbox.top,bottom:t.bbox.bottom},ze={left:ye.right+t.pair_splitwidth,right:t.bbox.right,top:t.bbox.top,bottom:t.bbox.bottom}):(ye={top:t.bbox.top,bottom:t.pair_splitpos,left:t.bbox.left,right:t.bbox.right},ze={top:ye.bottom+t.pair_splitwidth,bottom:t.bbox.bottom,left:t.bbox.left,right:t.bbox.right}),t.pair_backward?(Fe=t.child2,dt=t.child1):(Fe=t.child1,dt=t.child2),je(Fe,ye),je(dt,ze);break}}function ut(t,s,o,l){var f={};return f.type=t,f.rock=l,f.disprock=void 0,f.unicode=!1,f.isbinary=!1,f.streaming=!1,f.ref=null,f.win=null,f.file=null,f.buf=null,f.bufpos=0,f.buflen=0,f.bufeof=0,f.timer_id=null,f.flush_func=null,f.fstream=null,f.readcount=0,f.writecount=0,f.readable=s,f.writable=o,f.prev=null,f.next=Ne,Ne=f,f.next&&(f.next.prev=f),i&&i.class_register("stream",f),f}function bs(t){var s,o;t===ee&&(ee=null),hf(t),t.type==O?i&&i.unretain_array(t.buf):t.type==N&&t.fstream&&(t.fstream.fclose(),t.fstream=null),i&&i.class_unregister("stream",t),s=t.prev,o=t.next,t.prev=null,t.next=null,s?s.next=o:Ne=o,o&&(o.prev=s),t.fstream=null,t.buf=null,t.readable=!1,t.writable=!1,t.ref=null,t.win=null,t.file=null,t.rock=null,t.disprock=null}function gf(t){var s;return s=ut(V,!1,!0,0),s.unicode=!0,s.win=t,s}function En(t){t.streaming&&a.log("### gli_stream_dirty_file called for streaming file!"),t.timer_id===null&&(t.flush_func===null&&(t.flush_func=function(){xs(t)}),t.timer_id=setTimeout(t.flush_func,1e4))}function xs(t){t.streaming&&a.log("### gli_stream_flush_file called for streaming file!"),t.timer_id!==null&&clearTimeout(t.timer_id),t.timer_id=null,r.file_write(t.ref,t.buf)}function Wr(t,s,o,l){var f={};if(f.filename=t,f.rock=o,f.disprock=void 0,f.textmode=(s&_.fileusage_TextMode)!=0,f.filetype=s&_.fileusage_TypeMask,f.filetypename=rr[f.filetype],f.filetypename||(f.filetypename="xxx"),!l){var p="";f.filetype==_.fileusage_SavedGame&&(p=n.get_signature()),l=r.file_construct_ref(f.filename,f.filetypename,p)}return f.ref=l,f.prev=null,f.next=Pe,Pe=f,f.next&&(f.next.prev=f),i&&i.class_register("fileref",f),f}function yf(t){var s,o;i&&i.class_unregister("fileref",t),s=t.prev,o=t.next,t.prev=null,t.next=null,s?s.next=o:Pe=o,o&&(o.prev=s),t.filename=null,t.ref=null,t.rock=null,t.disprock=null}function lr(t,s){if(!t||!t.writable)throw"gli_put_char: invalid stream";switch(t.unicode||(s<0||s>=256)&&(s=63),t.writecount+=1,t.type){case N:if(t.streaming)if(!t.unicode)t.buffer4[0]=s,t.fstream.fwrite(t.buffer4,1);else if(t.isbinary)t.buffer4.writeUInt32BE(s,0,!0),t.fstream.fwrite(t.buffer4,4);else{var o;if(s<65536)o=t.buffer4.write(String.fromCharCode(s)),t.fstream.fwrite(t.buffer4,o);else{var l=k([s]),f=t.fstream.BufferClass.from(l);t.fstream.fwrite(f)}}else if(En(t),!t.unicode||s<128&&!t.isbinary)t.bufpos<t.buflen&&(t.buf[t.bufpos]=s,t.bufpos+=1,t.bufpos>t.bufeof&&(t.bufeof=t.bufpos));else{let p;t.isbinary?p=v([s]):p=k([s]);let g=p.length;g>t.buflen-t.bufpos&&(g=t.buflen-t.bufpos);for(let h=0;h<g;h++)t.buf[t.bufpos+h]=p[h];t.bufpos+=g,t.bufpos>t.bufeof&&(t.bufeof=t.bufpos)}break;case O:t.bufpos<t.buflen&&(t.buf[t.bufpos]=s,t.bufpos+=1,t.bufpos>t.bufeof&&(t.bufeof=t.bufpos));break;case V:if(t.win.line_request)throw"gli_put_char: window has pending line request";ft(t.win,wn(s)),t.win.echostr&&lr(t.win.echostr,s);break}}function fr(t,s,o){var l,f;if(!t||!t.writable)throw"gli_put_array: invalid stream";switch(!t.unicode&&!o&&(s=G(s),o=!0),t.writecount+=s.length,t.type){case N:if(t.streaming)if(t.unicode)if(t.isbinary){let g=t.fstream.BufferClass.alloc(4*s.length);for(let h=0;h<s.length;h++)g.writeUInt32BE(s[h],4*h,!0);t.fstream.fwrite(g)}else{let g=k(s),h=t.fstream.BufferClass.from(g);t.fstream.fwrite(h)}else{let g=t.fstream.BufferClass.from(s);t.fstream.fwrite(g)}else{En(t);var p;t.unicode?t.isbinary?p=v(s):p=k(s):p=s;let g=p.length;g>t.buflen-t.bufpos&&(g=t.buflen-t.bufpos);for(let h=0;h<g;h++)t.buf[t.bufpos+h]=p[h];t.bufpos+=g,t.bufpos>t.bufeof&&(t.bufeof=t.bufpos)}break;case O:l=s.length,l>t.buflen-t.bufpos&&(l=t.buflen-t.bufpos);for(let g=0;g<l;g++)t.buf[t.bufpos+g]=s[g];t.bufpos+=l,t.bufpos>t.bufeof&&(t.bufeof=t.bufpos);break;case V:if(t.win.line_request)throw"gli_put_array: window has pending line request";o?f=String.fromCharCode.apply(this,s):f=w(s),ft(t.win,f),t.win.echostr&&fr(t.win.echostr,s,o);break}}function St(t,s){var o;if(!t||!t.readable)return-1;switch(t.type){case N:if(t.streaming)if(t.unicode){if(t.isbinary){if(t.fstream.fread(t.buffer4,4)<4)return-1;o=t.buffer4[0]<<24,o|=t.buffer4[1]<<16,o|=t.buffer4[2]<<8,o|=t.buffer4[3]}else{let l,f,p,g;if(!t.fstream.fread(t.buffer4,1))return-1;if(l=t.buffer4[0],l<128)o=l;else{if(!t.fstream.fread(t.buffer4,1)||(f=t.buffer4[0],(f&192)!=128))return-1;if((l&224)==192)o=(l&31)<<6,o|=f&63;else{if(!t.fstream.fread(t.buffer4,1)||(p=t.buffer4[0],(p&192)!=128))return-1;if((l&240)==224)o=(l&15)<<12&61440,o|=(f&63)<<6&4032,o|=p&63&63;else if((l&240)==240){if(!t.fstream.fread(t.buffer4,1)||(g=t.buffer4[0],(g&192)!=128))return-1;o=(l&7)<<18&1835008,o|=(f&63)<<12&258048,o|=(p&63)<<6&4032,o|=g&63&63}else return-1}}}return t.readcount++,o>>>=0,!s&&o>=256?63:o}else return t.fstream.fread(t.buffer4,1)?(t.readcount++,t.buffer4[0]):-1;case A:if(t.unicode){if(t.isbinary){if(t.bufpos>=t.bufeof||(o=t.buf[t.bufpos],t.bufpos++,t.bufpos>=t.bufeof)||(o=o<<8|t.buf[t.bufpos]&255,t.bufpos++,t.bufpos>=t.bufeof)||(o=o<<8|t.buf[t.bufpos]&255,t.bufpos++,t.bufpos>=t.bufeof))return-1;o=o<<8|t.buf[t.bufpos]&255,t.bufpos++}else{let l,f,p,g;if(t.bufpos>=t.bufeof)return-1;if(l=t.buf[t.bufpos],t.bufpos++,l<128)o=l;else{if(t.bufpos>=t.bufeof||(f=t.buf[t.bufpos],t.bufpos++,(f&192)!=128))return-1;if((l&224)==192)o=(l&31)<<6,o|=f&63;else{if(t.bufpos>=t.bufeof||(p=t.buf[t.bufpos],t.bufpos++,(p&192)!=128))return-1;if((l&240)==224)o=(l&15)<<12&61440,o|=(f&63)<<6&4032,o|=p&63&63;else if((l&240)==240){if(t.bufpos>=t.bufeof||(g=t.buf[t.bufpos],t.bufpos++,(g&192)!=128))return-1;o=(l&7)<<18&1835008,o|=(f&63)<<12&258048,o|=(p&63)<<6&4032,o|=g&63&63}else return-1}}}return t.readcount++,o>>>=0,!s&&o>=256?63:o}case O:return t.bufpos<t.bufeof?(o=t.buf[t.bufpos],t.bufpos++,t.readcount++,!s&&o>=256?63:o):-1;default:return-1}}function ws(t,s,o){if(!t||!t.readable)return 0;var l=s.length,f,p,g;switch(t.type){case N:if(t.streaming){if(l==0)return 0;for(l-=1,g=!1,f=0;f<l&&!g&&(p=St(t,o),p!=-1);f++)s[f]=p,g=p==10;return f}case A:if(t.unicode){if(l==0)return 0;for(l-=1,g=!1,f=0;f<l&&!g&&(p=St(t,o),p!=-1);f++)s[f]=p,g=p==10;return f}case O:if(l==0)return 0;if(l-=1,t.bufpos>=t.bufeof?l=0:t.bufpos+l>t.bufeof&&(l=t.bufeof-t.bufpos),g=!1,o)for(f=0;f<l&&!g;f++)p=t.buf[t.bufpos++],s[f]=p,g=p==10;else for(f=0;f<l&&!g;f++)p=t.buf[t.bufpos++],!o&&p>=256&&(p=63),s[f]=p,g=p==10;return t.readcount+=f,f;default:return 0}}function ks(t,s,o){if(!t||!t.readable)return 0;var l=s.length,f,p;switch(t.type){case N:if(t.streaming){for(f=0;f<l&&(p=St(t,o),p!=-1);f++)s[f]=p;return f}case A:if(t.unicode){for(f=0;f<l&&(p=St(t,o),p!=-1);f++)s[f]=p;return f}case O:if(t.bufpos>=t.bufeof?l=0:t.bufpos+l>t.bufeof&&(l=t.bufeof-t.bufpos),o)for(f=0;f<l;f++)s[f]=t.buf[t.bufpos++];else for(f=0;f<l;f++)p=t.buf[t.bufpos++],!o&&p>=256&&(p=63),s[f]=p;return t.readcount+=l,l;default:return 0}}function Un(t,s){s&&(s.set_field(0,t.readcount),s.set_field(1,t.writecount))}function bf(t,s){ge(ee,t,s)}function ge(t,s,o){var l;if(!t||!t.writable)throw"glk_put_jstring: invalid stream";switch(t.writecount+=s.length,t.type){case N:if(t.streaming)if(t.unicode)if(t.isbinary){let p=t.fstream.BufferClass.alloc(4*s.length);for(let g=0;g<s.length;g++)p.writeUInt32BE(s.charCodeAt(g),4*g,!0);t.fstream.fwrite(p)}else{let p=t.fstream.BufferClass.from(s);t.fstream.fwrite(p)}else{let p=t.fstream.BufferClass.from(s,"binary");t.fstream.fwrite(p)}else{En(t);let p=[];for(let m=0;m<s.length;m++)p.push(s.charCodeAt(m));let g;t.unicode?t.isbinary?g=v(p):g=k(p):g=p;let h=g.length;h>t.buflen-t.bufpos&&(h=t.buflen-t.bufpos);for(let m=0;m<h;m++)t.buf[t.bufpos+m]=g[m];t.bufpos+=h,t.bufpos>t.bufeof&&(t.bufeof=t.bufpos)}break;case O:if(l=s.length,l>t.buflen-t.bufpos&&(l=t.buflen-t.bufpos),t.unicode||o)for(let p=0;p<l;p++)t.buf[t.bufpos+p]=s.charCodeAt(p);else for(let p=0;p<l;p++){var f=s.charCodeAt(p);(f<0||f>=256)&&(f=63),t.buf[t.bufpos+p]=f}t.bufpos+=l,t.bufpos>t.bufeof&&(t.bufeof=t.bufpos);break;case V:if(t.win.line_request)throw"glk_put_jstring: window has pending line request";ft(t.win,s),t.win.echostr&&ge(t.win.echostr,s,o);break}}function ct(t,s){if(!t||!t.writable)throw"gli_set_style: invalid stream";s>=_.style_NUMSTYLES&&(s=0),t.type==V&&(t.win.style=s,t.win.echostr&&ct(t.win.echostr,s))}function Bn(t,s){if(!t||!t.writable)throw"gli_set_hyperlink: invalid stream";t.type==V&&(t.win.hyperlink=s,t.win.echostr&&Bn(t.win.echostr,s))}function xf(){return F=!0,U=!0,B=null,c&&a.warning(c),L}function wf(){}function kf(t,s){return vs(t,s,null)}function vs(t,s,o){switch(t){case 0:return 1796;case 1:return s<=_.keycode_Left&&s>=_.keycode_End?1:s>=4294967296-_.keycode_MAXVAL||s>1114111||s>=0&&s<32||s>=127&&s<160?0:1;case 2:return s>1114111||s>=0&&s<32||s>=127&&s<160?0:1;case 3:return s>1114111||s>=0&&s<32||s>=127&&s<160?(o&&(o[0]=1),0):(o&&(o[0]=1),2);case 4:return s==_.wintype_TextGrid||u.graphics&&s==_.wintype_Graphics?1:0;case 5:return u.timer||0;case 6:return u.graphics||0;case 7:return u.graphics&&(s===_.wintype_TextBuffer||s===_.wintype_Graphics)?1:0;case 8:return 0;case 9:return 0;case 10:return 0;case 11:return u.hyperlinks||0;case 12:return u.hyperlinks&&(s===_.wintype_TextBuffer||s===_.wintype_TextGrid)?1:0;case 13:return 0;case 14:return u.graphics||0;case 15:return 1;case 16:return 1;case 17:return 1;case 18:return 1;case 19:return s==_.keycode_Escape||s>=_.keycode_Func12&&s<=_.keycode_Func1?1:0;case 20:return 1;case 21:return 0;case 22:return 1;case 23:return 0;case 4352:return u.garglktext||0}if(b){var l=b(t,s,o);if(l!==void 0)return l}return 0}function vf(t,s){return t?t=t.next:t=K,t?(s&&s.set_value(t.rock),t):(s&&s.set_value(0),null)}function Ff(t){if(!t)throw"glk_window_get_rock: invalid window";return t.rock}function Sf(){return ie}function Ef(t,s,o,l,f){var p,g,h,m,E;if(ie){if(!t)throw"glk_window_open: splitwin must not be null";if(h=s&_.winmethod_DivisionMask,h!=_.winmethod_Fixed&&h!=_.winmethod_Proportional)throw"glk_window_open: invalid method (not fixed or proportional)";if(h=s&_.winmethod_DirMask,h!=_.winmethod_Above&&h!=_.winmethod_Below&&h!=_.winmethod_Left&&h!=_.winmethod_Right)throw"glk_window_open: invalid method (bad direction)";if(g=t.bbox,p=t.parent,p&&p.type!=_.wintype_Pair)throw"glk_window_open: parent window is not Pair"}else{if(t)throw"glk_window_open: splitwin must be null for first window";p=null,g={left:R.outspacingx,top:R.outspacingy,right:R.width-R.outspacingx,bottom:R.height-R.outspacingy}}switch(E=gs(l,f),E.type){case _.wintype_TextBuffer:E.accum=[],E.accumstyle=null,E.accumhyperlink=0,E.accum_fg=null,E.accum_bg=null,E.accum_reverse=null,E.content=[],E.clearcontent=!1,E.reserve=[],E.stylehints=$r(ve.buffer);break;case _.wintype_TextGrid:E.gridwidth=0,E.gridheight=0,E.lines=[],E.cursorx=0,E.cursory=0,E.clearcontent=!1,E.stylehints=$r(ve.grid);break;case _.wintype_Graphics:if(!u.graphics)return vn(E),null;E.content=[],E.reserve=[];break;case _.wintype_Blank:break;case _.wintype_Pair:throw"glk_window_open: cannot open pair window directly";default:return vn(E),null}return t?(m=gs(_.wintype_Pair,0),m.pair_dir=s&_.winmethod_DirMask,m.pair_division=s&_.winmethod_DivisionMask,m.pair_key=E,m.pair_keydamage=!1,m.pair_size=o,m.pair_hasborder=(s&_.winmethod_BorderMask)==_.winmethod_Border,m.pair_vertical=m.pair_dir==_.winmethod_Left||m.pair_dir==_.winmethod_Right,m.pair_backward=m.pair_dir==_.winmethod_Left||m.pair_dir==_.winmethod_Above,m.child1=t,m.child2=E,t.parent=m,E.parent=m,m.parent=p,p?p.child1==t?p.child1=m:p.child2=m:ie=m,je(m,g)):(ie=E,je(E,g)),E}function Uf(t,s){if(!t)throw"glk_window_close: invalid window";if(t===ie||!t.parent)ie=null,Un(t.str,s),ar(t,!0);else{var o,l,f,p,g,h;if(o=t.parent,t===o.child1)f=o.child2;else if(t===o.child2)f=o.child1;else throw"glk_window_close: window tree is corrupted";for(p=o.bbox,l=o.parent,l?(l.child1===o?l.child1=f:l.child2=f,f.parent=l):(ie=f,f.parent=null),Un(t.str,s),ar(t,!0),t===o.child1?o.child1=null:t===o.child2&&(o.child2=null),ar(o,!1),h=!1,g=f;g;g=g.parent)g.type==_.wintype_Pair&&g.pair_keydamage&&(h=!0,g.pair_keydamage=!1);je(h?ie:f,p)}}function Bf(t,s,o){if(!t)throw"glk_window_get_size: invalid window";var l=0,f=0,p,g;switch(t.type){case _.wintype_TextGrid:p=t.bbox.right-t.bbox.left,g=t.bbox.bottom-t.bbox.top,l=Math.max(0,Math.floor((p-R.gridmarginx)/R.gridcharwidth)),f=Math.max(0,Math.floor((g-R.gridmarginy)/R.gridcharheight));break;case _.wintype_TextBuffer:p=t.bbox.right-t.bbox.left,g=t.bbox.bottom-t.bbox.top,l=Math.max(0,Math.floor((p-R.buffermarginx)/R.buffercharwidth)),f=Math.max(0,Math.floor((g-R.buffermarginy)/R.buffercharheight));break;case _.wintype_Graphics:p=t.bbox.right-t.bbox.left,g=t.bbox.bottom-t.bbox.top,l=p-R.graphicsmarginx,f=g-R.graphicsmarginy;break}s&&s.set_value(l),o&&o.set_value(f)}function Af(t,s,o,l){var f,p,g,h;if(!t)throw"glk_window_set_arrangement: invalid window";if(t.type!=_.wintype_Pair)throw"glk_window_set_arrangement: not a pair window";if(l){if(l.type==_.wintype_Pair)throw"glk_window_set_arrangement: keywin cannot be a pair window";for(f=l;f&&f!=t;f=f.parent);if(!f)throw"glk_window_set_arrangement: keywin must be a descendant"}if(p=s&_.winmethod_DirMask,g=p==_.winmethod_Left||p==_.winmethod_Right,h=p==_.winmethod_Left||p==_.winmethod_Above,l||(l=t.pair_key),g&&!t.pair_vertical)throw"glk_window_set_arrangement: split must stay horizontal";if(!g&&t.pair_vertical)throw"glk_window_set_arrangement: split must stay vertical";if(l&&l.type==_.wintype_Blank&&(s&_.winmethod_DivisionMask)==_.winmethod_Fixed)throw"glk_window_set_arrangement: a blank window cannot have a fixed size";(h&&!t.pair_backward||!h&&t.pair_backward)&&(f=t.child1,t.child1=t.child2,t.child2=f),t.pair_dir=p,t.pair_division=s&_.winmethod_DivisionMask,t.pair_key=l,t.pair_size=o,t.pair_hasborder=(s&_.winmethod_BorderMask)==_.winmethod_Border,t.pair_vertical=t.pair_dir==_.winmethod_Left||t.pair_dir==_.winmethod_Right,t.pair_backward=t.pair_dir==_.winmethod_Left||t.pair_dir==_.winmethod_Above,je(t,t.bbox)}function Tf(t,s,o,l){if(!t)throw"glk_window_get_arrangement: invalid window";if(t.type!=_.wintype_Pair)throw"glk_window_get_arrangement: not a pair window";o&&o.set_value(t.pair_size),l&&l.set_value(t.pair_key),s&&s.set_value(t.pair_dir|t.pair_division|(t.pair_hasborder?_.winmethod_Border:_.winmethod_NoBorder))}function Cf(t){if(!t)throw"glk_window_get_type: invalid window";return t.type}function Df(t){if(!t)throw"glk_window_get_parent: invalid window";return t.parent}function Rf(t){if(!t)throw"glk_window_clear: invalid window";if(t.line_request)throw"glk_window_clear: window has pending line request";let s=null;switch(t.type){case _.wintype_TextBuffer:t.accum.length=0,t.accumstyle=null,t.accumhyperlink=0,t.accum_fg=null,t.accum_bg=null,t.accum_reverse=null,t.content.length=0,t.clearcontent=!0,t.cleared_bg=t.bg,t.cleared_fg=t.fg;break;case _.wintype_TextGrid:t.cursorx=0,t.cursory=0;for(let o=0;o<t.gridheight;o++){let l=t.lines[o];l.dirty=!0;for(let f=0;f<t.gridwidth;f++)l.chars[f]=" ",l.styles[f]=_.style_Normal,l.hyperlinks[f]=0,l.fgs[f]=t.fg,l.bgs[f]=t.bg,l.reverses[f]=t.reverse}t.clearcontent=!0,t.cleared_bg=t.bg,t.cleared_fg=t.fg;break;case _.wintype_Graphics:for(let o=0;o<t.content.length;o++)t.content[o].special=="setcolor"&&(s=t.content[o]);t.content.length=0,s!==null&&t.content.push(s),t.content.push({special:"fill"});break}}function Qf(t,s,o){if(!t)throw"glk_window_move_cursor: invalid window";if(t.type==_.wintype_TextGrid)t.cursorx=s,t.cursory=o;else throw"glk_window_move_cursor: not a grid window"}function If(t){if(!t)throw"glk_window_get_stream: invalid window";return t.str}function Gf(t,s){if(!t)throw"glk_window_set_echo_stream: invalid window";t.echostr=s}function Of(t){if(!t)throw"glk_window_get_echo_stream: invalid window";return t.echostr}function Lf(t){t?ee=t.str:ee=null}function Mf(t){if(!t)throw"glk_window_get_sibling: invalid window";let s=t.parent;if(!s)return null;if(t===s.child1)return s.child2;if(t===s.child2)return s.child1;throw"glk_window_get_sibling: window tree is corrupted"}function Wf(t,s){return t?t=t.next:t=Ne,t?(s&&s.set_value(t.rock),t):(s&&s.set_value(0),null)}function $f(t){if(!t)throw"glk_stream_get_rock: invalid stream";return t.rock}function Nf(t,s,o){if(!t)throw"glk_stream_open_file: invalid fileref";var l,f;if(s!=_.filemode_Read&&s!=_.filemode_Write&&s!=_.filemode_ReadWrite&&s!=_.filemode_WriteAppend)throw"glk_stream_open_file: illegal filemode";if(s==_.filemode_Read&&!r.file_ref_exists(t.ref))return null;if(r.streaming){if(f=r.file_fopen(s,t.ref),!f)return null}else{var p=null;if(s!=_.filemode_Write&&(p=r.file_read(t.ref)),p==null&&(p=[],s!=_.filemode_Read&&r.file_write(t.ref,"",!0)),p.length==null)throw"glk_stream_open_file: data read had no length"}return l=ut(N,s!=_.filemode_Write,s!=_.filemode_Read,o),l.unicode=!1,l.isbinary=!t.textmode,l.ref=t.ref,l.origfmode=s,r.streaming?(l.streaming=!0,l.fstream=f,l.buffer4=f.BufferClass.alloc(4)):(l.streaming=!1,l.buf=p,l.buflen=4294967295,s==_.filemode_Write?l.bufeof=0:l.bufeof=p.length,s==_.filemode_WriteAppend?l.bufpos=l.bufeof:l.bufpos=0),l}function Pf(t,s,o){var l;if(s!=_.filemode_Read&&s!=_.filemode_Write&&s!=_.filemode_ReadWrite)throw"glk_stream_open_memory: illegal filemode";return l=ut(O,s!=_.filemode_Write,s!=_.filemode_Read,o),l.unicode=!1,t&&(l.buf=t,l.buflen=t.length,l.bufpos=0,s==_.filemode_Write?l.bufeof=0:l.bufeof=l.buflen,i&&i.retain_array(t)),l}function jf(t,s){var o;if(!e||!e.find_data_chunk)return null;var l=e.find_data_chunk(t);if(!l)return null;var f=l.data,p=l.type=="BINA";return o=ut(A,!0,!1,s),o.unicode=!1,o.isbinary=p,o.resfilenum=t,o.streaming=!1,f&&(o.buf=f,o.buflen=f.length,o.bufpos=0,o.bufeof=o.buflen),o}function zf(t,s){var o;if(!e||!e.find_data_chunk)return null;var l=e.find_data_chunk(t);if(!l)return null;var f=l.data,p=l.type=="BINA";return o=ut(A,!0,!1,s),o.unicode=!0,o.isbinary=p,o.resfilenum=t,o.streaming=!1,f&&(o.buf=f,o.buflen=f.length,o.bufpos=0,o.bufeof=o.buflen),o}function qf(t,s){if(!t)throw"glk_stream_close: invalid stream";if(t.type==V)throw"glk_stream_close: cannot close window stream";t.type==N&&t.writable&&(t.streaming||(t.timer_id!==null&&(clearTimeout(t.timer_id),t.timer_id=null),r.file_write(t.ref,t.buf))),Un(t,s),bs(t)}function Vf(t,s,o){if(!t)throw"glk_stream_set_position: invalid stream";switch(t.type){case N:if(t.streaming){t.fstream.fseek(s,o);break}case A:case O:o==_.seekmode_Current?s=t.bufpos+s:o==_.seekmode_End&&(s=t.bufeof+s),s<0&&(s=0),s>t.bufeof&&(s=t.bufeof),t.bufpos=s}}function Hf(t){if(!t)throw"glk_stream_get_position: invalid stream";switch(t.type){case N:if(t.streaming)return t.fstream.ftell();case A:case O:return t.bufpos;default:return 0}}function Jf(t){ee=t}function Yf(){return ee}function Kf(t,s){var o=t&_.fileusage_TypeMask,l=rr[o],f=r.file_construct_temp_ref(l),p=Wr(f.filename,t,s,f);return p}function Zf(t,s,o){s=r.file_clean_fixed_name(s,t&_.fileusage_TypeMask);var l=Wr(s,t,o,null);return l}function Xf(t,s,o){var l,f=t&_.fileusage_TypeMask,p=rr[f];switch(p||(p="xxx"),s){case _.filemode_Write:l="write";break;case _.filemode_ReadWrite:l="readwrite";break;case _.filemode_WriteAppend:l="writeappend";break;case _.filemode_Read:default:l="read";break}var g={type:"fileref_prompt",filetype:p,filemode:l},h={usage:t,rock:o};return f==_.fileusage_SavedGame&&(g.gameid=n.get_signature()),C=g,M=h,B=null,L}function eu(t){var s=t.value,o=M.usage,l=M.rock,f=null;s&&(f=Wr(s.filename,o,l,s)),C=null,M=null,i&&i.prepare_resume(f),n.resume(f)}function tu(t){if(!t)throw"glk_fileref_destroy: invalid fileref";yf(t)}function ru(t,s){return t?t=t.next:t=Pe,t?(s&&s.set_value(t.rock),t):(s&&s.set_value(0),null)}function iu(t){if(!t)throw"glk_fileref_get_rock: invalid fileref";return t.rock}function nu(t){if(!t)throw"glk_fileref_delete_file: invalid fileref";r.file_remove_ref(t.ref)}function ou(t){if(!t)throw"glk_fileref_does_file_exist: invalid fileref";return r.file_ref_exists(t.ref)?1:0}function su(t,s,o){if(!s)throw"glk_fileref_create_from_fileref: invalid fileref";var l=Wr(s.filename,t,o,null);return l}function au(t){lr(ee,t&255)}function lu(t,s){lr(t,s&255)}function fu(t){ge(ee,t,!0)}function uu(t,s){ge(t,s,!0)}function cu(t){t=G(t),fr(ee,t,!0)}function du(t,s){s=G(s),fr(t,s,!0)}function pu(t){ct(ee,t)}function _u(t,s){ct(t,s)}function mu(t){if(!t)throw"glk_get_char_stream: invalid stream";return St(t,!1)}function hu(t,s){if(!t)throw"glk_get_line_stream: invalid stream";return ws(t,s,!1)}function gu(t,s){if(!t)throw"glk_get_buffer_stream: invalid stream";return ks(t,s,!1)}function yu(t){return t>=65&&t<=90||t>=192&&t<=222&&t!=215?t+32:t}function bu(t){return t>=97&&t<=122||t>=224&&t<=254&&t!=247?t-32:t}var Fs=null,ve={buffer:{},grid:{}};function $r(t){let s={};for(let[o,l]of Object.entries(t))s[o]=Object.assign({},l);return s}let An=["normal","emphasized","preformatted","header","subheader","alert","note","blockquote","input","user1","user2"],Ss=["margin-left","text-indent","text-align","font-size","font-weight","font-style","monospace","color","background-color","reverse"];function Nr(t){if(Array.isArray(t)){let s={};for(let[o,l]of t.entries())for(let[f,p]of Object.entries(l)){let g=`.Style_${An[o]}${["margin-left","text-indent","text-align"].includes(f)?"_par":""}`;s[g]||(s[g]={}),s[g][f]=p}return s}return t}function xu(t,s,o,l){(t===_.wintype_AllTypes||t===_.wintype_TextBuffer)&&Es(ve.buffer,s,o,l),(t===_.wintype_AllTypes||t===_.wintype_TextGrid)&&o!==_.stylehint_Proportional&&Es(ve.grid,s,o,l)}function Es(t,s,o,l){let f=`.Style_${An[s]}${o<=_.stylehint_Justification?"_par":""}`;var p,g=["left","justify","center","right"],h=["lighter","normal","bold"];o===_.stylehint_Indentation&&(p=l+"em"),o===_.stylehint_ParaIndentation&&(p=l+"em"),o===_.stylehint_Justification&&(p=g[l]),o===_.stylehint_Size&&(p=1+l*.1+"em"),o===_.stylehint_Weight&&(p=h[l+1]),o===_.stylehint_Oblique&&(p=l?"italic":"normal"),o===_.stylehint_Proportional&&(p=l?0:1),o===_.stylehint_TextColor&&(p="#"+("000000"+l.toString(16)).slice(-6)),o===_.stylehint_BackColor&&(p="#"+("000000"+l.toString(16)).slice(-6)),o===_.stylehint_ReverseColor&&(p=l),t[f]||(t[f]={}),t[f][Ss[o]]=p}function wu(t,s,o){let l=`.Style_${An[s]}${o<=_.stylehint_Justification?"_par":""}`;function f(p){p[l]&&(delete p[l][Ss[o]],Object.keys(p[l]).length||delete p[l])}(t===_.wintype_AllTypes||t===_.wintype_TextBuffer)&&f(ve.buffer),(t===_.wintype_AllTypes||t===_.wintype_TextGrid)&&f(ve.grid)}function ku(){return 0}function vu(t,s,o,l){return l&&l.set_value(0),0}function Fu(t,s){Tn(ee,t,s)}function Tn(t,s,o){if(!t||!t.writable)throw"garglk_set_zcolors: invalid stream";s=s>>0,o=o>>0,t.type==V&&(s!==-2&&(t.win.fg=s===-1?null:"#"+("000000"+s.toString(16)).slice(-6)),o!==-2&&(t.win.bg=o===-1?null:"#"+("000000"+o.toString(16)).slice(-6)),t.win.echostr&&Tn(t.win.echostr,s,o))}function Su(t){Cn(ee,t)}function Cn(t,s){if(!t||!t.writable)throw"garglk_set_reversevideo: invalid stream";t.type==V&&(t.win.reverse=s||null,t.win.echostr&&Cn(t.win.echostr,s))}function Eu(t){return B=t,L}function Uu(t){if(t.set_field(0,_.evtype_None),t.set_field(1,null),t.set_field(2,0),t.set_field(3,0),Te){var s=Date.now();s-Ft>Te&&(Ft=Date.now(),kn=null,t.set_field(0,_.evtype_Timer))}}function Bu(t,s,o){if(!t)throw"glk_request_line_event: invalid window";if(t.char_request||t.line_request)throw"glk_request_line_event: window already has keyboard request";if(t.type==_.wintype_TextBuffer||t.type==_.wintype_TextGrid){if(o){var l=s.slice(0,o);I||(I={}),I[t.disprock]=se(l)}t.line_request=!0,t.line_request_uni=!1,t.type==_.wintype_TextBuffer?t.request_echo_line_input=t.echo_line_input:t.request_echo_line_input=!0,t.input_generation=z,t.linebuf=s,i&&i.retain_array(s)}else throw"glk_request_line_event: window does not support keyboard input"}function Au(t,s){if(!t)throw"glk_cancel_line_event: invalid window";if(!t.line_request){s&&(s.set_field(0,_.evtype_None),s.set_field(1,null),s.set_field(2,0),s.set_field(3,0));return}var o="",l,f;for(W&&(f=W[t.disprock],f&&(o=f)),o.length>t.linebuf.length&&(o=o.slice(0,t.linebuf.length)),t.request_echo_line_input&&(l=t.style,ct(t.str,_.style_Input),ft(t,o),t.echostr&&ge(t.echostr,o),ct(t.str,l),ft(t,`
`),t.echostr&&ge(t.echostr,`
`)),l=0;l<o.length;l++)t.linebuf[l]=o.charCodeAt(l);s&&(s.set_field(0,_.evtype_LineInput),s.set_field(1,t),s.set_field(2,o.length),s.set_field(3,0)),i&&i.unretain_array(t.linebuf),t.line_request=!1,t.line_request_uni=!1,t.request_echo_line_input=null,t.input_generation=null,t.linebuf=null}function Tu(t){if(!t)throw"glk_request_char_event: invalid window";if(t.char_request||t.line_request)throw"glk_request_char_event: window already has keyboard request";if(t.type==_.wintype_TextBuffer||t.type==_.wintype_TextGrid)t.char_request=!0,t.char_request_uni=!1,t.input_generation=z;else throw"glk_request_char_event: window does not support keyboard input"}function Cu(t){if(!t)throw"glk_cancel_char_event: invalid window";t.char_request=!1,t.char_request_uni=!1}function Du(t,s){if(!t)throw"glk_set_echo_line_event: invalid window";t.echo_line_input=s!=0}function Ru(t,s){if(!t)throw"glk_set_terminators_line_event: invalid window";if(kt===null){kt={};for(let l in $e)kt[$e[l]]=l}let o=[];if(s)for(let l=0;l<s.length;l++){let f=kt[s[l]];f&&o.push(f)}t.line_input_terminators=o}function Qu(t){if(!t)throw"glk_request_mouse_event: invalid window";(t.type==_.wintype_TextGrid||t.type==_.wintype_Graphics)&&(t.mouse_request=!0)}function Iu(t){if(!t)throw"glk_cancel_mouse_event: invalid window";t.mouse_request=!1}function Us(t){t?(Te=t,Ft=Date.now()):(Te=null,Ft=null)}function Gu(t,s,o){if(!e||!e.get_image_info)return null;var l=e.get_image_info(t);return l?(s&&s.set_value(l.width),o&&o.set_value(l.height),1):(s&&s.set_value(0),o&&o.set_value(0),0)}function Ou(t,s,o,l){if(!t)throw"glk_image_draw: invalid window";if(!e||!e.get_image_info)return 0;var f=e.get_image_info(s);if(!f)return 0;var p={special:"image",image:s,url:f.url,alttext:f.alttext,width:f.width,height:f.height};switch(t.type){case _.wintype_TextBuffer:var g="inlineup";switch(o){case _.imagealign_InlineUp:g="inlineup";break;case _.imagealign_InlineDown:g="inlinedown";break;case _.imagealign_InlineCenter:g="inlinecenter";break;case _.imagealign_MarginLeft:g="marginleft";break;case _.imagealign_MarginRight:g="marginright";break}return p.alignment=g,t.hyperlink&&(p.hyperlink=t.hyperlink),Sn(t,p),1;case _.wintype_Graphics:return p.x=o,p.y=l,t.content.push(p),1}return 0}function Lu(t,s,o,l,f,p){if(!t)throw"glk_image_draw_scaled: invalid window";if(!e||!e.get_image_info)return 0;var g=e.get_image_info(s);if(!g)return 0;var h={special:"image",image:s,url:g.url,alttext:g.alttext,width:f,height:p};switch(t.type){case _.wintype_TextBuffer:var m="inlineup";switch(o){case _.imagealign_InlineUp:m="inlineup";break;case _.imagealign_InlineDown:m="inlinedown";break;case _.imagealign_InlineCenter:m="inlinecenter";break;case _.imagealign_MarginLeft:m="marginleft";break;case _.imagealign_MarginRight:m="marginright";break}return h.alignment=m,t.hyperlink&&(h.hyperlink=t.hyperlink),Sn(t,h),1;case _.wintype_Graphics:return h.x=o,h.y=l,t.content.push(h),1}return 0}function Mu(t){if(!t)throw"glk_window_flow_break: invalid window";t.type==_.wintype_TextBuffer&&Sn(t,void 0,!0)}function Wu(t,s,o,l,f){if(!t)throw"glk_window_erase_rect: invalid window";if(t.type!=_.wintype_Graphics)throw"glk_window_erase_rect: not a graphics window";t.content.push({special:"fill",x:s,y:o,width:l,height:f})}function $u(t,s,o,l,f,p){if(!t)throw"glk_window_fill_rect: invalid window";if(t.type!=_.wintype_Graphics)throw"glk_window_fill_rect: not a graphics window";var g=Bs(s);t.content.push({special:"fill",color:g,x:o,y:l,width:f,height:p})}function Nu(t,s){if(!t)throw"glk_window_set_background_color: invalid window";if(t.type!=_.wintype_Graphics)throw"glk_window_set_background_color: not a graphics window";var o=Bs(s);t.content.push({special:"setcolor",color:o})}function Bs(t){for(var s=(t&16777215).toString(16);s.length<6;)s="0"+s;return"#"+s.toUpperCase()}function Pu(t,s){return t?t=t.next:t=_f,t?(s&&s.set_value(t.rock),t):(s&&s.set_value(0),null)}function ju(t){if(!t)throw"glk_schannel_get_rock: invalid schannel";return t.rock}function zu(){return null}function qu(){throw"glk_schannel_destroy: invalid schannel"}function Vu(){throw"glk_schannel_play: invalid schannel"}function Hu(){throw"glk_schannel_play_ext: invalid schannel"}function Ju(){throw"glk_schannel_stop: invalid schannel"}function Yu(){throw"glk_schannel_set_volume: invalid schannel"}function Ku(){}function Zu(){return null}function Xu(){throw"glk_schannel_play_multi: invalid schannel"}function ec(){throw"glk_schannel_pause: invalid schannel"}function tc(){throw"glk_schannel_unpause: invalid schannel"}function rc(){throw"glk_schannel_set_volume_ext: invalid schannel"}function ic(t){Bn(ee,t)}function nc(t,s){Bn(t,s)}function oc(t){if(!t)throw"glk_request_hyperlink_event: invalid window";(t.type==_.wintype_TextBuffer||t.type==_.wintype_TextGrid)&&(t.hyperlink_request=!0)}function sc(t){if(!t)throw"glk_cancel_hyperlink_event: invalid window";(t.type==_.wintype_TextBuffer||t.type==_.wintype_TextGrid)&&(t.hyperlink_request=!1)}function ac(t,s){var o,l,f,p,g,h=t.length,m=t.slice(0,s);if(h<s)throw"buffer_to_lower_case_uni: numchars exceeds array length";for(f=0,o=0;o<s;o++)if(g=m[o],p=lt[g],p===void 0)t[f]=g,f++;else if(!(p instanceof Array))t[f]=p,f++;else for(l=0;l<p.length;l++)t[f]=p[l],f++;return t.length=h,f}function lc(t,s){var o,l,f,p,g,h=t.length,m=t.slice(0,s);if(h<s)throw"buffer_to_upper_case_uni: numchars exceeds array length";for(f=0,o=0;o<s;o++)if(g=m[o],p=ir[g],p===void 0)t[f]=g,f++;else if(!(p instanceof Array))t[f]=p,f++;else for(l=0;l<p.length;l++)t[f]=p[l],f++;return t.length=h,f}function fc(t,s,o){var l,f,p,g,h,m=t.length,E=t.slice(0,s);if(m<s)throw"buffer_to_title_case_uni: numchars exceeds array length";if(p=0,s==0)return 0;if(l=0,h=E[l],g=nr[h],g===void 0&&(g=ir[h]),g===void 0)t[p]=h,p++;else if(!(g instanceof Array))t[p]=g,p++;else for(f=0;f<g.length;f++)t[p]=g[f],p++;if(o)for(l=1;l<s;l++)if(h=E[l],g=lt[h],g===void 0)t[p]=h,p++;else if(!(g instanceof Array))t[p]=g,p++;else for(f=0;f<g.length;f++)t[p]=g[f],p++;else for(l=1;l<s;l++)h=E[l],t[p]=h,p++;return t.length=m,p}function As(t,s){var o=t.slice(0,s),l,f,p,g,h,m,E,X,J;for(l=0,f=0;f<s;f++)if(g=o[f],h=or[g],h===void 0)t[l]=g,l++;else if(!(h instanceof Array))t[l]=h,l++;else for(p=0;p<h.length;p++)t[l]=h[p],l++;for(f=0;f<l;){if(!ke[t[f]]){f++;continue}if(f>=l)break;for(m=f;f<l&&ke[t[f]];)f++;if(E=f,E-m>=2)for(p=E-1;p>m;p--)for(X=m;X<p;X++)ke[t[X]]>ke[t[X+1]]&&(J=t[X],t[X]=t[X+1],t[X+1]=J)}return l}function uc(t,s){var o,l,f,p,g,h,m,E;if(s==0)return 0;for(E=0,f=t[0],g=ke[f],g&&(g=999),o=1,l=o;;){if(l>=s){t[E]=f,E=o;break}p=t[l],h=ke[p],m=xn[f],m!==void 0&&m[p]!==void 0&&(!g||h&&g<h)?(f=m[p],t[E]=f):(h||(E=o,f=p),g=h,t[o]=p,o++),l++}return E}function cc(t,s){var o=t.length,l;return l=As(t,s),t.length=o,l}function dc(t,s){var o=t.length,l;return l=As(t,s),l=uc(t,l),t.length=o,l}function pc(t){lr(ee,t)}function _c(t){ge(ee,t,!1)}function mc(t){fr(ee,t,!1)}function hc(t,s){lr(t,s)}function gc(t,s){ge(t,s,!1)}function yc(t,s){fr(t,s,!1)}function bc(t){if(!t)throw"glk_get_char_stream_uni: invalid stream";return St(t,!0)}function xc(t,s){if(!t)throw"glk_get_buffer_stream_uni: invalid stream";return ks(t,s,!0)}function wc(t,s){if(!t)throw"glk_get_line_stream_uni: invalid stream";return ws(t,s,!0)}function kc(t,s,o){if(!t)throw"glk_stream_open_file_uni: invalid fileref";var l,f;if(s!=_.filemode_Read&&s!=_.filemode_Write&&s!=_.filemode_ReadWrite&&s!=_.filemode_WriteAppend)throw"glk_stream_open_file_uni: illegal filemode";if(s==_.filemode_Read&&!r.file_ref_exists(t.ref))return null;if(r.streaming){if(f=r.file_fopen(s,t.ref),!f)return null}else{var p=null;if(s!=_.filemode_Write&&(p=r.file_read(t.ref)),p==null&&(p=[],s!=_.filemode_Read&&r.file_write(t.ref,"",!0)),p.length==null)throw"glk_stream_open_file_uni: data read had no length"}return l=ut(N,s!=_.filemode_Write,s!=_.filemode_Read,o),l.unicode=!0,l.isbinary=!t.textmode,l.ref=t.ref,l.origfmode=s,r.streaming?(l.streaming=!0,l.fstream=f,l.buffer4=f.BufferClass.alloc(4)):(l.streaming=!1,l.buf=p,l.buflen=4294967295,s==_.filemode_Write?l.bufeof=0:l.bufeof=p.length,s==_.filemode_WriteAppend?l.bufpos=l.bufeof:l.bufpos=0),l}function vc(t,s,o){var l;if(s!=_.filemode_Read&&s!=_.filemode_Write&&s!=_.filemode_ReadWrite)throw"glk_stream_open_memory: illegal filemode";return l=ut(O,s!=_.filemode_Write,s!=_.filemode_Read,o),l.unicode=!0,t&&(l.buf=t,l.buflen=t.length,l.bufpos=0,s==_.filemode_Write?l.bufeof=0:l.bufeof=l.buflen,i&&i.retain_array(t)),l}function Fc(t){if(!t)throw"glk_request_char_event: invalid window";if(t.char_request||t.line_request)throw"glk_request_char_event: window already has keyboard request";if(t.type==_.wintype_TextBuffer||t.type==_.wintype_TextGrid)t.char_request=!0,t.char_request_uni=!0,t.input_generation=z;else throw"glk_request_char_event: window does not support keyboard input"}function Sc(t,s,o){if(!t)throw"glk_request_line_event: invalid window";if(t.char_request||t.line_request)throw"glk_request_line_event: window already has keyboard request";if(t.type==_.wintype_TextBuffer||t.type==_.wintype_TextGrid){if(o){var l=s.slice(0,o);I||(I={}),I[t.disprock]=w(l)}t.line_request=!0,t.line_request_uni=!0,t.type==_.wintype_TextBuffer?t.request_echo_line_input=t.echo_line_input:t.request_echo_line_input=!0,t.input_generation=z,t.linebuf=s,i&&i.retain_array(s)}else throw"glk_request_line_event: window does not support keyboard input"}function Ec(t){var s=new Date().getTime(),o;t.set_field(0,Math.floor(s/4294967296e3)),t.set_field(1,Math.floor(s/1e3)>>>0),o=Math.floor(s%1e3*1e3),o<0&&(o=1e6+o),t.set_field(2,o)}function Uc(t){var s=new Date().getTime();return Math.floor(s/(t*1e3))}function Bc(t,s){var o=t.get_field(0)*4294967296e3+t.get_field(1)*1e3+t.get_field(2)/1e3,l=new Date(o);s.set_field(0,l.getUTCFullYear()),s.set_field(1,1+l.getUTCMonth()),s.set_field(2,l.getUTCDate()),s.set_field(3,l.getUTCDay()),s.set_field(4,l.getUTCHours()),s.set_field(5,l.getUTCMinutes()),s.set_field(6,l.getUTCSeconds()),s.set_field(7,1e3*l.getUTCMilliseconds())}function Ac(t,s){var o=t.get_field(0)*4294967296e3+t.get_field(1)*1e3+t.get_field(2)/1e3,l=new Date(o);s.set_field(0,l.getFullYear()),s.set_field(1,1+l.getMonth()),s.set_field(2,l.getDate()),s.set_field(3,l.getDay()),s.set_field(4,l.getHours()),s.set_field(5,l.getMinutes()),s.set_field(6,l.getSeconds()),s.set_field(7,1e3*l.getMilliseconds())}function Tc(t,s,o){var l=t*(1e3*s),f=new Date(l);o.set_field(0,f.getUTCFullYear()),o.set_field(1,1+f.getUTCMonth()),o.set_field(2,f.getUTCDate()),o.set_field(3,f.getUTCDay()),o.set_field(4,f.getUTCHours()),o.set_field(5,f.getUTCMinutes()),o.set_field(6,f.getUTCSeconds()),o.set_field(7,1e3*f.getUTCMilliseconds())}function Cc(t,s,o){var l=t*(1e3*s),f=new Date(l);o.set_field(0,f.getFullYear()),o.set_field(1,1+f.getMonth()),o.set_field(2,f.getDate()),o.set_field(3,f.getDay()),o.set_field(4,f.getHours()),o.set_field(5,f.getMinutes()),o.set_field(6,f.getSeconds()),o.set_field(7,1e3*f.getMilliseconds())}function Dc(t,s){var o=new Date(0);o.setUTCFullYear(t.get_field(0)),o.setUTCMonth(t.get_field(1)-1),o.setUTCDate(t.get_field(2)),o.setUTCHours(t.get_field(4)),o.setUTCMinutes(t.get_field(5)),o.setUTCSeconds(t.get_field(6)),o.setUTCMilliseconds(t.get_field(7)/1e3);var l=o.getTime(),f;s.set_field(0,Math.floor(l/4294967296e3)),s.set_field(1,Math.floor(l/1e3)>>>0),f=Math.floor(l%1e3*1e3),f<0&&(f=1e6+f),s.set_field(2,f)}function Rc(t,s){var o=new Date(t.get_field(0),t.get_field(1)-1,t.get_field(2),t.get_field(4),t.get_field(5),t.get_field(6),t.get_field(7)/1e3),l=o.getTime(),f;s.set_field(0,Math.floor(l/4294967296e3)),s.set_field(1,Math.floor(l/1e3)>>>0),f=Math.floor(l%1e3*1e3),f<0&&(f=1e6+f),s.set_field(2,f)}function Qc(t,s){var o=new Date(0);o.setUTCFullYear(t.get_field(0)),o.setUTCMonth(t.get_field(1)-1),o.setUTCDate(t.get_field(2)),o.setUTCHours(t.get_field(4)),o.setUTCMinutes(t.get_field(5)),o.setUTCSeconds(t.get_field(6)),o.setUTCMilliseconds(t.get_field(7)/1e3);var l=o.getTime();return Math.floor(l/(s*1e3))}function Ic(t,s){var o=new Date(t.get_field(0),t.get_field(1)-1,t.get_field(2),t.get_field(4),t.get_field(5),t.get_field(6),t.get_field(7)/1e3),l=o.getTime();return Math.floor(l/(s*1e3))}return{version:"2.2.5",init:Oe,update:yn,getlibrary:er,save_allstate:bn,restore_allstate:Mr,fatal_error:tr,byte_array_to_string:se,uni_array_to_string:w,Const:_,RefBox:Q,RefStruct:q,DidNotReturn:L,call_may_not_return:T,glk_put_jstring:bf,glk_put_jstring_stream:ge,glk_exit:xf,glk_tick:wf,glk_gestalt:kf,glk_gestalt_ext:vs,glk_window_iterate:vf,glk_window_get_rock:Ff,glk_window_get_root:Sf,glk_window_open:Ef,glk_window_close:Uf,glk_window_get_size:Bf,glk_window_set_arrangement:Af,glk_window_get_arrangement:Tf,glk_window_get_type:Cf,glk_window_get_parent:Df,glk_window_clear:Rf,glk_window_move_cursor:Qf,glk_window_get_stream:If,glk_window_set_echo_stream:Gf,glk_window_get_echo_stream:Of,glk_set_window:Lf,glk_window_get_sibling:Mf,glk_stream_iterate:Wf,glk_stream_get_rock:$f,glk_stream_open_file:Nf,glk_stream_open_memory:Pf,glk_stream_close:qf,glk_stream_set_position:Vf,glk_stream_get_position:Hf,glk_stream_set_current:Jf,glk_stream_get_current:Yf,glk_fileref_create_temp:Kf,glk_fileref_create_by_name:Zf,glk_fileref_create_by_prompt:Xf,glk_fileref_destroy:tu,glk_fileref_iterate:ru,glk_fileref_get_rock:iu,glk_fileref_delete_file:nu,glk_fileref_does_file_exist:ou,glk_fileref_create_from_fileref:su,glk_put_char:au,glk_put_char_stream:lu,glk_put_string:fu,glk_put_string_stream:uu,glk_put_buffer:cu,glk_put_buffer_stream:du,glk_set_style:pu,glk_set_style_stream:_u,glk_get_char_stream:mu,glk_get_line_stream:hu,glk_get_buffer_stream:gu,glk_char_to_lower:yu,glk_char_to_upper:bu,glk_stylehint_set:xu,glk_stylehint_clear:wu,glk_style_distinguish:ku,glk_style_measure:vu,glk_select:Eu,glk_select_poll:Uu,glk_request_line_event:Bu,glk_cancel_line_event:Au,glk_request_char_event:Tu,glk_cancel_char_event:Cu,glk_request_mouse_event:Qu,glk_cancel_mouse_event:Iu,glk_request_timer_events:Us,glk_image_get_info:Gu,glk_image_draw:Ou,glk_image_draw_scaled:Lu,glk_window_flow_break:Mu,glk_window_erase_rect:Wu,glk_window_fill_rect:$u,glk_window_set_background_color:Nu,glk_schannel_iterate:Pu,glk_schannel_get_rock:ju,glk_schannel_create:zu,glk_schannel_destroy:qu,glk_schannel_play:Vu,glk_schannel_play_ext:Hu,glk_schannel_stop:Ju,glk_schannel_set_volume:Yu,glk_schannel_create_ext:Zu,glk_schannel_play_multi:Xu,glk_schannel_pause:ec,glk_schannel_unpause:tc,glk_schannel_set_volume_ext:rc,glk_sound_load_hint:Ku,glk_set_hyperlink:ic,glk_set_hyperlink_stream:nc,glk_request_hyperlink_event:oc,glk_cancel_hyperlink_event:sc,glk_buffer_to_lower_case_uni:ac,glk_buffer_to_upper_case_uni:lc,glk_buffer_to_title_case_uni:fc,glk_buffer_canon_decompose_uni:cc,glk_buffer_canon_normalize_uni:dc,glk_put_char_uni:pc,glk_put_string_uni:_c,glk_put_buffer_uni:mc,glk_put_char_stream_uni:hc,glk_put_string_stream_uni:gc,glk_put_buffer_stream_uni:yc,glk_get_char_stream_uni:bc,glk_get_buffer_stream_uni:xc,glk_get_line_stream_uni:wc,glk_stream_open_file_uni:kc,glk_stream_open_memory_uni:vc,glk_request_char_event_uni:Fc,glk_request_line_event_uni:Sc,glk_set_echo_line_event:Du,glk_set_terminators_line_event:Ru,glk_current_time:Ec,glk_current_simple_time:Uc,glk_time_to_date_utc:Bc,glk_time_to_date_local:Ac,glk_simple_time_to_date_utc:Tc,glk_simple_time_to_date_local:Cc,glk_date_to_time_utc:Dc,glk_date_to_time_local:Rc,glk_date_to_simple_time_utc:Qc,glk_date_to_simple_time_local:Ic,glk_stream_open_resource:jf,glk_stream_open_resource_uni:zf,garglk_set_zcolors:Fu,garglk_set_zcolors_stream:Tn,garglk_set_reversevideo:Su,garglk_set_reversevideo_stream:Cn}}(),cf=b7;function df(){return{auto_launch:1,Dialog:uf,direct_domains:["ifarchive.org","mirror.ifarchive.org","unbox.ifarchive.org","www.ifarchive.org"],do_vm_autosave:1,Glk:cf,GlkOte:new Zt,lib_path:import.meta.url,proxy_url:"https://iplayif.com/proxy/",set_body_to_page_bg:1,theme_cookie:"parchment_theme",use_proxy:1}}function pf(n){let e=new URLSearchParams(document.location.search),r={};for(let i of n)e.has(i)&&(r[i]=e.get(i));return r}var hs=class{options;constructor(e){let r=["do_vm_autosave","use_asyncglk"];e?.story||r.push("story"),this.options=Object.assign({},df(),e,pf(r)),this.options.use_asyncglk&&(this.options.Glk=new Ur)}get_storyfile_path(){return this.options.story?typeof this.options.story=="string"?{url:this.options.story}:this.options.story:this.options.default_story?{url:this.options.default_story?.[0]}:null}launch(){try{this.options.Dialog.init();let e=this.options.theme||Cs.get(this.options.theme_cookie)||(matchMedia("(prefers-color-scheme: dark)").matches?"dark":"");e&&document.documentElement.setAttribute("data-theme",e);let r=this.get_storyfile_path();if(!r){$("#custom-file-upload").show().on("keydown",i=>{(i.keyCode===32||i.keyCode===13)&&i.target.click()}),$("#file-upload").on("change",()=>{let i=$("#file-upload")[0]?.files?.[0];i&&this.load_uploaded_file(i)}),$("#play-url").show(),$("#play-url-button").on("click",()=>this.load_url()),$("#play-url-input").on("keydown",i=>{i.keyCode===13&&this.load_url()});return}this.load(r)}catch(e){throw this.options.GlkOte.error(e),e}}async load(e){try{if($("#about").remove(),$("#loadingpane").show(),!e.url){if(!e.data)throw new Error("Needs story data or URL");if(!e.format)throw new Error("Cannot identify storyfile format without path")}let r=ms(e.format,e.url),i=0,a=$("#loading_progress"),u;a.length&&(u=F=>{i+=F,a.val(i)},e.filesize_gz&&$("#loading_size").text(In(e.filesize_gz,{maximumFractionDigits:1,minimumFractionDigits:1})));let c;r.id==="blorb"&&(e.data||(e.data=await _s(this.options,e.url,u)),c=new Wt(e.data),r=ff(c));let d=r.engines[0],y=await Promise.all([e.data||_s(this.options,e.url,u),...d.load.map(F=>sf(this.options,F))]);e.data=y[0];let x=Object.assign({},this.options),b=new le(e.data);b.getFourCC(0)==="FORM"&&b.getFourCC(8)==="IFRS"&&(x.Blorb=c||new Wt(e.data)),await d.start(x,y)}catch(r){throw this.options.GlkOte.error(r),r}}async load_uploaded_file(e){try{this.load({data:await af(e),url:e.name})}catch(r){throw this.options.GlkOte.error(r),r}}load_url(){let e=$("#play-url-input").val();if(!e)return;try{new URL(e)}catch{$("#play-url-error").text("Please enter a valid URL");return}let r=new URL(window.location+"");r.searchParams.set("story",e),window.location=r+""}};$(()=>{let n=new hs(window.parchment_options);window.parchment=n,n.options.auto_launch&&n.launch()});
/*! Bundled license information:

js-cookie/dist/js.cookie.mjs:
  (*! js-cookie v3.0.5 | MIT *)

lodash-es/lodash.js:
  (**
   * @license
   * Lodash (Custom Build) <https://lodash.com/>
   * Build: `lodash modularize exports="es" -o ./`
   * Copyright OpenJS Foundation and other contributors <https://openjsf.org/>
   * Released under MIT license <https://lodash.com/license>
   * Based on Underscore.js 1.8.3 <http://underscorejs.org/LICENSE>
   * Copyright Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
   *)
*/
//# sourceMappingURL=main.js.map
