var e={},n=function(){var e={};function n(e){if("string"==typeof e)return e;var n=e.toString();return e.message&&(n=n+" "+e.message),e.fileName&&(n=n+" "+e.fileName),e.lineNumber&&(n=n+" line:"+e.lineNumber),e.name&&(n=n+" "+e.name),e.number&&(n=n+" "+e.number),n}function r(e){window.console&&console.log?console.log(e):window.opera&&opera.postError&&opera.postError(e)}function s(){if(xe&&xe.length){var e,n,s,t,a=[];for(e=0;e<xe.length;e++)(t=xe[e]).vmfunc.funcaddr?(n="0x"+t.vmfunc.funcaddr.toString(16),(s=cn.functionmap[t.vmfunc.funcaddr])&&(n=n+' "'+s.name+'"'),a.push(n)):a.push("(anonymous)");r("VM stack dump: "+a.join(", "))}}void 0===Math.imul&&(r("Polyfilling Math.imul()."),Math.imul=function(e,n){var r=65535&e,s=65535&n;return r*s+((e>>>16&65535)*s+r*(n>>>16&65535)<<16>>>0)|0});var t=Array(256),a=Array(256);function o(e,n){return 16777216*e[n]+65536*e[n+1]+256*e[n+2]+e[n+3]}function l(e,n){return 256*e[n]+e[n+1]}function i(e,n){return e[n]}function c(e){return ye[e]}function f(e){return 256*ye[e]+ye[e+1]}function u(e){return 16777216*ye[e]+65536*ye[e+1]+256*ye[e+2]+ye[e+3]}function d(e,n){return ye.slice(e,e+n)}function p(e,n){ye[e]=255&n}function h(e,n){ye[e]=n>>8&255,ye[e+1]=255&n}function m(e,n){ye[e]=n>>24&255,ye[e+1]=n>>16&255,ye[e+2]=n>>8&255,ye[e+3]=255&n}function _(e,n){for(var r=0;r<n.length;r++)e.push(n.charCodeAt(r))}function g(e,n){e.push(n>>24&255),e.push(n>>16&255),e.push(n>>8&255),e.push(255&n)}function v(e,n){e.push(n>>8&255),e.push(255&n)}function w(e,n){e.push(255&n)}function k(e,n,r){return String.fromCharCode.apply(this,e.slice(n,n+r))}function b(e){return ye[e]>=128?"0xffffff"+t[ye[e]]:"0x"+t[ye[e]]}function y(e){return ye[e]>=128?"0xffff"+t[ye[e]]+t[ye[e+1]]:ye[e]?"0x"+t[ye[e]]+t[ye[e+1]]:"0x"+t[ye[e+1]]}function x(e){return ye[e]?"0x"+t[ye[e]]+t[ye[e+1]]+t[ye[e+2]]+t[ye[e+3]]:ye[e+1]?"0x"+t[ye[e+1]]+t[ye[e+2]]+t[ye[e+3]]:ye[e+2]?"0x"+t[ye[e+2]]+t[ye[e+3]]:"0x"+t[ye[e+3]]}function M(e){return e<65536?String.fromCharCode(e):(e-=65536,String.fromCharCode(55296+(e>>10),56320+(1023&e)))}function G(e){return function(e){if(e<256)return a[e];if(e<65536){for(e=e.toString(16);e.length<4;)e="0"+e;return"\\u"+e}var n;return n=55296+((e-=65536)>>10),e=56320+(1023&e),"\\u"+n.toString(16)+"\\u"+e.toString(16)}(e.charCodeAt(0))}e.Mem1=c,e.Mem2=f,e.Mem4=u,e.MemSlice=d,e.MemW1=p,e.MemW2=h,e.MemW4=m;var z=/[^a-zA-Z0-9 .,;:?!=_+()-]/g;function S(e){return'"'+(e=e.replace(z,G))+'"'}function C(e){var n,s;if(arguments.length>1){for(e+=" (",n=1;n<arguments.length;n++)1!=n&&(e+=" "),e+=s="number"==typeof(s=arguments[n])?s.toString(16):""+s;e+=")"}throw r(e),new Error(e)}function j(e,n,r,s){return void 0===r?new Function("self",e):void 0===s?new Function("self",r,e):new Function("self",r,s,e)}function N(e,n,r,s){var t,a;e?(this.funcaddr=e,this.startpc=n,this.functype=c(e)):(this.funcaddr=null,this.startpc=null,this.functype=null),this.pathaddrs={},this[0]={},this[1]={},this[2]={},this.locallen=null,this.localsformat=r,this.rawformat=s,this.localsindex=[];var o=0;for(t=0;t<this.localsformat.length;t++){var l=this.localsformat[t];if(4==l.size)for(;3&o;)o++;else if(2==l.size)for(;1&o;)o++;for(a=0;a<l.count;a++)this.localsindex.push({size:l.size,pos:o}),o+=l.size}for(;3&o;)o++;this.locallen=o}function L(e){var n;for(this.vmfunc=e,this.depth=null,this.framestart=null,this.framelen=null,this.valstack=[],this.localspos=null,this.localsindex=e.localsindex,this.locals=[],n=0;n<this.localsindex.length;n++){var r=this.localsindex[n];this.locals[r.pos]=0}this.framelen=8+e.rawformat.length+e.locallen}function F(e,n){g(n,e.framelen);var r=e.vmfunc.rawformat;g(n,8+r.length);for(var s=0;s<r.length;s++)n.push(r[s]);for(s=0;s<e.vmfunc.localsindex.length;s++){var t=e.vmfunc.localsindex[s];if(4==t.size){for(;3&n.length;)n.push(0);g(n,e.locals[t.pos])}else if(2==t.size){for(;1&n.length;)n.push(0);v(n,e.locals[t.pos])}else w(n,e.locals[t.pos])}for(;3&n.length;)n.push(0);for(s=0;s<e.valstack.length;s++)g(n,e.valstack[s])}function E(e){var n=o(e,e.length-4);if(!(n<0||n>=e.length)){for(var s=o(e=e.splice(n,e.length),0),t=o(e,4),a=e.slice(8,t),c=[],f=8;;){var u=i(e,f),d=i(e,++f);if(f++,0==u)break;1!=u&&2!=u&&4!=u&&C("Invalid local variable size in function header.",u),c.push({size:u,count:d})}var p=new L(new N(null,null,c,a));p.framestart=n;for(var h=0;h<p.vmfunc.localsindex.length;h++){var m=p.vmfunc.localsindex[h];4==m.size?p.locals[m.pos]=o(e,t+m.pos):2==m.size?p.locals[m.pos]=l(e,t+m.pos):p.locals[m.pos]=i(e,t+m.pos)}for(var _=s;_<e.length;_+=4)p.valstack.push(o(e,_));return p}r("Bad frameptr in serialized stack frame")}function A(e,n){0==e&&C("Tried to create a VMTextEnv for address zero."),this.addr=e,this.cacheable=void 0!==n,this.decoding_tree=n,this.vmstring_tables=[],this.cacheable&&(this.vmstring_tables[0]={},this.vmstring_tables[1]={},this.vmstring_tables[2]={})}e.fatal_error=C;var W=null;function q(e,n,r){var s;switch(n.mode){case 8:if(4==n.argsize){if("0"===(t=r[0]))return e.offstack.push(r),void e.code.push("// push to offstack: "+r);if("_"===t)return function(e,n){e.offstack.push(n);var r=e.holduse[n];r&&!0!==r?r++:r=1;e.holduse[n]=r}(e,r),void e.code.push("// re-push to offstack: "+r)}return s=O(e,!0),e.offstack.push(s),void(4==n.argsize?e.code.push(s+"=("+r+");"):2==n.argsize?e.code.push(s+"=0xffff&("+r+");"):e.code.push(s+"=0xff&("+r+");"));case 0:return void e.code.push("("+r+");");case 11:if(4==n.argsize){var t;if("0"===(t=r[0]))return P(e,n.addr,r,!1),void e.code.push("// store to offloc["+n.addr+"]: "+r);if("_"===t)return P(e,n.addr,r,!0),void e.code.push("// re-store to offloc["+n.addr+"]: "+r)}return P(e,n.addr,void 0),void(4==n.argsize?e.code.push("self.frame.locals["+n.addr+"]=("+r+");"):2==n.argsize?e.code.push("self.frame.locals["+n.addr+"]=(0xffff &"+r+");"):e.code.push("self.frame.locals["+n.addr+"]=(0xff &"+r+");"));case 15:return void(4==n.argsize?e.code.push("self.MemW4("+n.addr+","+r+");"):2==n.argsize?e.code.push("self.MemW2("+n.addr+","+r+");"):e.code.push("self.MemW1("+n.addr+","+r+");"));default:C("Unknown addressing mode in store func operand.")}}function B(e,n,r){void 0===r&&(r=e.cp),e.code.push("self.frame.valstack.push("+n+","+r+",self.frame.framestart);")}function D(e){e.code.push("if (!substring) { substring=true;"),e.code.push("self.frame.valstack.push(0x11,0,nextcp,self.frame.framestart);"),e.code.push("}")}function V(e,n){var r;if(e.code.push("// unload offstate: "+e.offstack.length+" stack"+(e.offloc.length?", plus locs":"")+(n?" (conditional)":"")),e.offstack.length&&e.code.push("self.frame.valstack.push("+e.offstack.join(",")+");"),e.offloc.length)for(r=0;r<e.offloc.length;r++)void 0!==e.offloc[r]&&e.offlocdirty[r]&&e.code.push("self.frame.locals["+r+"]="+e.offloc[r]+";");if(!n){var s;for(r=0;r<e.offloc.length;r++)void 0!==(s=e.offloc[r])&&void 0!==e.holduse[s]&&(e.holduse[s]=!1);for(e.offloc.length=0,e.offlocdirty.length=0;e.offstack.length;)s=e.offstack.pop(),void 0!==e.holduse[s]&&(e.holduse[s]=!1)}}function T(e){if(0!=e.buffer.length){var n=e.buffer.join("");e.buffer.length=0,e.code.push("self.Glk.glk_put_jstring("+S(n)+");")}}function I(e,n,r){var s;if(H(n))return 2147483648&(s=Number(n))?""+(s-4294967296):n;if(s="("+n+"&0xffffffff)",r){var t=O(e);return e.code.push(t+"="+s+";"),t}return s}function U(e,n,r){var s;if(H(n))return 2147483648==(s=Number(n))?"-0":""+ke(s);if(s="self.decode_float("+n+")",r){var t=O(e);return e.code.push(t+"="+s+";"),t}return s}function R(e,n,r){if(H(n)){var s=Number(n);if(0==s||1==s)r?(e.code.push("// quashing offstack for unconditional return: "+e.offstack.length),e.offstack.length=0,e.offloc.length=0,e.offlocdirty.length=0):e.code.push("// ignoring offstack for conditional return: "+e.offstack.length),e.code.push("if (self.leave_function()) return self.VMStopped;"),e.code.push("self.pop_callstub("+s+");");else{V(e,!r);var t=e.cp+s-2>>>0;e.code.push("self.pc = "+t+";"),e.vmfunc.pathaddrs[t]=!0}}else V(e,!r),e.code.push("if (("+n+")==0 || ("+n+")==1) {"),e.code.push("if (self.leave_function()) return self.VMStopped;"),e.code.push("self.pop_callstub("+n+");"),e.code.push("}"),e.code.push("else {"),e.code.push("self.pc = ("+e.cp+"+("+n+")-2) >>>0;"),e.code.push("}");e.code.push("return;")}e.funcop_cache={};var Q={0:function(e,n){},16:function(e,n){e.code.push(n[2]+"(("+n[0]+")+("+n[1]+")) >>>0);")},17:function(e,n){e.code.push(n[2]+"(("+n[0]+")-("+n[1]+")) >>>0);")},18:function(e,n){var r=I(e,n[0]),s=I(e,n[1]);e.code.push(n[2]+"(Math.imul(("+r+"),("+s+"))) >>>0);")},19:function(e,n){var r=I(e,n[0]),s=I(e,n[1]),t=O(e);e.code.push(t+"=(("+r+")/("+s+"));"),e.code.push("if (!isFinite("+t+")) self.fatal_error('Division by zero.');"),e.code.push(n[2]+"("+t+">=0)?Math.floor("+t+"):(-Math.floor(-"+t+") >>>0));")},20:function(e,n){var r=I(e,n[0]),s=I(e,n[1]),t=O(e);e.code.push(t+"=(("+r+")%("+s+"));"),e.code.push("if (!isFinite("+t+")) self.fatal_error('Modulo division by zero.');"),e.code.push(n[2]+t+" >>>0);")},21:function(e,n){e.code.push(n[1]+"(-("+n[0]+")) >>>0);")},24:function(e,n){e.code.push(n[2]+"(("+n[0]+")&("+n[1]+")) >>>0);")},25:function(e,n){e.code.push(n[2]+"(("+n[0]+")|("+n[1]+")) >>>0);")},26:function(e,n){e.code.push(n[2]+"(("+n[0]+")^("+n[1]+")) >>>0);")},27:function(e,n){e.code.push(n[1]+"(~("+n[0]+")) >>>0);")},28:function(e,n){if(H(n[1])){var r=Number(n[1]);r<32?e.code.push(n[2]+"(("+n[0]+")<<"+r+") >>>0);"):e.code.push(n[2]+"0);")}else e.code.push(n[2]+"("+n[1]+"<32) ? (("+n[0]+"<<"+n[1]+") >>>0) : 0);")},29:function(e,n){if(H(n[1])){var r=Number(n[1]);r<32?e.code.push(n[2]+"(("+n[0]+")>>"+r+") >>>0);"):e.code.push(n[2]+"(("+n[0]+")&0x80000000) ? 0xffffffff : 0);")}else e.code.push("if ("+n[0]+" & 0x80000000) {"),e.code.push(n[2]+"("+n[1]+"<32) ? (("+n[0]+">>"+n[1]+") >>>0) : 0xffffffff);"),e.code.push("} else {"),e.code.push(n[2]+"("+n[1]+"<32) ? (("+n[0]+">>"+n[1]+") >>>0) : 0);"),e.code.push("}")},30:function(e,n){if(H(n[1])){var r=Number(n[1]);r<32?e.code.push(n[2]+"("+n[0]+")>>>"+r+");"):e.code.push(n[2]+"0);")}else e.code.push(n[2]+"("+n[1]+"<32) ? ("+n[0]+">>>"+n[1]+") : 0);")},32:function(e,n){R(e,n[0],!0),e.path_ends=!0},260:function(e,n){if(H(n[0])){var r=Number(n[0]);e.code.push("self.pc = "+r+";"),e.vmfunc.pathaddrs[r]=!0}else e.code.push("self.pc = "+n[0]+";");V(e),e.code.push("return;"),e.path_ends=!0},34:function(e,n){e.code.push("if (("+n[0]+")==0) {"),R(e,n[1]),e.code.push("}")},35:function(e,n){e.code.push("if (("+n[0]+")!=0) {"),R(e,n[1]),e.code.push("}")},36:function(e,n){e.code.push("if (("+n[0]+")==("+n[1]+")) {"),R(e,n[2]),e.code.push("}")},37:function(e,n){e.code.push("if (("+n[0]+")!=("+n[1]+")) {"),R(e,n[2]),e.code.push("}")},38:function(e,n){var r=I(e,n[0]),s=I(e,n[1]);e.code.push("if (("+r+")<("+s+")) {"),R(e,n[2]),e.code.push("}")},39:function(e,n){var r=I(e,n[0]),s=I(e,n[1]);e.code.push("if (("+r+")>=("+s+")) {"),R(e,n[2]),e.code.push("}")},40:function(e,n){var r=I(e,n[0]),s=I(e,n[1]);e.code.push("if (("+r+")>("+s+")) {"),R(e,n[2]),e.code.push("}")},41:function(e,n){var r=I(e,n[0]),s=I(e,n[1]);e.code.push("if (("+r+")<=("+s+")) {"),R(e,n[2]),e.code.push("}")},42:function(e,n){e.code.push("if (("+n[0]+")<("+n[1]+")) {"),R(e,n[2]),e.code.push("}")},43:function(e,n){e.code.push("if (("+n[0]+")>=("+n[1]+")) {"),R(e,n[2]),e.code.push("}")},44:function(e,n){e.code.push("if (("+n[0]+")>("+n[1]+")) {"),R(e,n[2]),e.code.push("}")},45:function(e,n){e.code.push("if (("+n[0]+")<=("+n[1]+")) {"),R(e,n[2]),e.code.push("}")},48:function(e,n){if(H(n[1])){var r,s=Number(n[1]);for(r=0;r<s;r++)if(e.offstack.length){var t=Z(e);e.code.push("self.tempcallargs["+r+"]="+t+";")}else e.code.push("self.tempcallargs["+r+"]=self.frame.valstack.pop();");V(e)}else e.varsused.ix=!0,V(e),e.code.push("for (ix=0; ix<"+n[1]+"; ix++) { self.tempcallargs[ix]=self.frame.valstack.pop(); }");B(e,n[2]),e.code.push("self.enter_function("+n[0]+", "+n[1]+");"),e.code.push("return;"),e.path_ends=!0},52:function(e,n){if(H(n[1])){var r,s=Number(n[1]);for(r=0;r<s;r++)if(e.offstack.length){var t=Z(e);e.code.push("self.tempcallargs["+r+"]="+t+";")}else e.code.push("self.tempcallargs["+r+"]=self.frame.valstack.pop();");V(e)}else e.varsused.ix=!0,V(e),e.code.push("for (ix=0; ix<"+n[1]+"; ix++) { self.tempcallargs[ix]=self.frame.valstack.pop(); }");e.code.push("if (self.leave_function()) return self.VMStopped;"),e.code.push("self.enter_function("+n[0]+", "+n[1]+");"),e.code.push("return;"),e.path_ends=!0},352:function(e,n){V(e),B(e,n[1]),e.code.push("self.enter_function("+n[0]+", 0);"),e.code.push("return;"),e.path_ends=!0},353:function(e,n){V(e),e.code.push("self.tempcallargs[0]=("+n[1]+");"),B(e,n[2]),e.code.push("self.enter_function("+n[0]+", 1);"),e.code.push("return;"),e.path_ends=!0},354:function(e,n){V(e),e.code.push("self.tempcallargs[0]=("+n[1]+");"),e.code.push("self.tempcallargs[1]=("+n[2]+");"),B(e,n[3]),e.code.push("self.enter_function("+n[0]+", 2);"),e.code.push("return;"),e.path_ends=!0},355:function(e,n){V(e),e.code.push("self.tempcallargs[0]=("+n[1]+");"),e.code.push("self.tempcallargs[1]=("+n[2]+");"),e.code.push("self.tempcallargs[2]=("+n[3]+");"),B(e,n[4]),e.code.push("self.enter_function("+n[0]+", 3);"),e.code.push("return;"),e.path_ends=!0},49:function(e,n){e.code.push("// quashing offstack for return: "+e.offstack.length),e.offstack.length=0,e.offloc.length=0,e.offlocdirty.length=0,e.code.push("if (self.leave_function()) return self.VMStopped;"),e.code.push("self.pop_callstub("+n[0]+");"),e.code.push("return;"),e.path_ends=!0},50:function(e,n){V(e),B(e,n[0]),e.code.push("self.store_operand("+n[0]+",self.frame.framestart+self.frame.framelen+4*self.frame.valstack.length);"),R(e,n[1],!0),e.path_ends=!0},51:function(e,n){e.code.push("// quashing offstack for throw: "+e.offstack.length),e.offstack.length=0,e.offloc.length=0,e.offlocdirty.length=0,e.code.push("self.pop_stack_to("+n[1]+");"),e.code.push("self.pop_callstub("+n[0]+");"),e.code.push("return;"),e.path_ends=!0},64:function(e,n){q(e,n[1],n[0])},65:function(e,n){q(e,n[1],n[0])},66:function(e,n){q(e,n[1],n[0])},68:function(e,n){var r;H(n[0])?(r=32768&(r=Number(n[0]))?(4294901760|r)>>>0:65535&r,e.code.push(n[1]+r+");")):e.code.push(n[1]+"("+n[0]+" & 0x8000) ? (("+n[0]+" | 0xffff0000) >>> 0) : ("+n[0]+" & 0xffff));")},69:function(e,n){var r;H(n[0])?(r=128&(r=Number(n[0]))?(4294967040|r)>>>0:255&r,e.code.push(n[1]+r+");")):e.code.push(n[1]+"("+n[0]+" & 0x80) ? (("+n[0]+" | 0xffffff00) >>> 0) : ("+n[0]+" & 0xff));")},72:function(e,n){var r,s;H(n[1])?r=H(n[0])?"self.Mem4("+((s=Number(n[0])+4*Number(n[1]))>>>0)+")":(s=4*Number(n[1]))?"self.Mem4(("+n[0]+"+"+s+") >>>0)":"self.Mem4("+n[0]+")":r="self.Mem4(("+n[0]+"+4*"+n[1]+") >>>0)";e.code.push(n[2]+r+");")},73:function(e,n){var r,s;H(n[1])?r=H(n[0])?"self.Mem2("+((s=Number(n[0])+2*Number(n[1]))>>>0)+")":(s=2*Number(n[1]))?"self.Mem2(("+n[0]+"+"+s+") >>>0)":"self.Mem2("+n[0]+")":r="self.Mem2(("+n[0]+"+2*"+n[1]+") >>>0)";e.code.push(n[2]+r+");")},74:function(e,n){var r,s;H(n[1])?r=H(n[0])?"self.Mem1("+((s=Number(n[0])+Number(n[1]))>>>0)+")":(s=Number(n[1]))?"self.Mem1(("+n[0]+"+"+s+") >>>0)":"self.Mem1("+n[0]+")":r="self.Mem1(("+n[0]+"+"+n[1]+") >>>0)";e.code.push(n[2]+r+");")},76:function(e,n){var r,s;H(n[1])?r=H(n[0])?((s=Number(n[0])+4*Number(n[1]))>>>0)+",":(s=4*Number(n[1]))?"("+n[0]+"+"+s+") >>>0,":n[0]+",":r="("+n[0]+"+4*"+n[1]+") >>>0,";e.code.push("self.MemW4("+r+n[2]+");")},77:function(e,n){var r,s;H(n[1])?r=H(n[0])?((s=Number(n[0])+2*Number(n[1]))>>>0)+",":(s=2*Number(n[1]))?"("+n[0]+"+"+s+") >>>0,":n[0]+",":r="("+n[0]+"+2*"+n[1]+") >>>0,";e.code.push("self.MemW2("+r+n[2]+");")},78:function(e,n){var r,s;H(n[1])?r=H(n[0])?((s=Number(n[0])+Number(n[1]))>>>0)+",":(s=Number(n[1]))?"("+n[0]+"+"+s+") >>>0,":n[0]+",":r="("+n[0]+"+"+n[1]+") >>>0,";e.code.push("self.MemW1("+r+n[2]+");")},75:function(e,n){if(H(n[1])){var r,s,t;r=7&(t=4294967295&Number(n[1])),H(n[0])?(s=Number(n[0]),t>=0?s+=t>>3:s-=1+(-1-t>>3)):s=t>=0?t<=7?n[0]:n[0]+"+"+(t>>3):n[0]+"-"+(1+(-1-t>>3)),e.code.push(n[2]+"(self.Mem1("+s+") & "+(1<<r)+")?1:0);")}else{e.varsused.bitx=!0,e.varsused.addrx=!0;var a=I(e,n[1],!0);e.code.push("bitx = "+a+"&7;"),e.code.push("if ("+a+">=0) addrx = "+n[0]+" + ("+a+">>3);"),e.code.push("else addrx = "+n[0]+" - (1+((-1-("+a+"))>>3));"),e.code.push(n[2]+"(self.Mem1(addrx) & (1<<bitx))?1:0);")}},79:function(e,n){var r,s,t,a;if(H(n[1]))r=7&(a=4294967295&Number(n[1])),H(n[0])?(s=Number(n[0]),a>=0?s+=a>>3:s-=1+(-1-a>>3)):s=a>=0?a<=7?n[0]:n[0]+"+"+(a>>3):n[0]+"-"+(1+(-1-a>>3)),t=1<<r;else{e.varsused.bitx=!0,e.varsused.addrx=!0;var o=I(e,n[1],!0);e.code.push("bitx = "+o+"&7;"),e.code.push("if ("+o+">=0) addrx = "+n[0]+" + ("+o+">>3);"),e.code.push("else addrx = "+n[0]+" - (1+((-1-("+o+"))>>3));"),s="addrx",t="(1<<bitx)"}H(n[2])?Number(n[2])?e.code.push("self.MemW1("+s+", self.Mem1("+s+") | "+t+");"):e.code.push("self.MemW1("+s+", self.Mem1("+s+") & ~("+t+"));"):(e.code.push("if ("+n[2]+") self.MemW1("+s+", self.Mem1("+s+") | "+t+");"),e.code.push("else self.MemW1("+s+", self.Mem1("+s+") & ~("+t+"));"))},80:function(e,n){var r,s=e.offstack.length;r=s?"self.frame.valstack.length+"+s:"self.frame.valstack.length",q(e,n[0],r)},81:function(e,n){var r;if(H(n[0])){var s=Number(n[0]);r=s<e.offstack.length?e.offstack[e.offstack.length-(s+1)]:"self.frame.valstack[self.frame.valstack.length-"+(s+1-e.offstack.length)+"]"}else V(e),r="self.frame.valstack[self.frame.valstack.length-("+n[0]+"+1)]";q(e,n[1],r)},82:function(e,n){var r,s;e.offstack.length<2&&function(e,n){var r;for(;e.offstack.length<n;)r=O(e,!0),e.offstack.unshift(r),e.code.push(r+"=self.frame.valstack.pop();")}(e,2),s=e.offstack.length,r=e.offstack[s-1],e.offstack[s-1]=e.offstack[s-2],e.offstack[s-2]=r},83:function(e,n){V(e),e.varsused.ix=!0,e.varsused.pos=!0,e.varsused.roll=!0,e.varsused.vals1=!0;var r=I(e,n[0],!0),s=I(e,n[1],!0);e.code.push("if ("+r+" > 0) {"),e.code.push("if ("+s+" > 0) {"),e.code.push("vals1 = "+s+" % "+r+";"),e.code.push("} else {"),e.code.push("vals1 = "+r+" - (-("+s+")) % "+r+";"),e.code.push("}"),e.code.push("if (vals1) {"),e.code.push("pos = self.frame.valstack.length - "+r+";"),e.code.push("roll = self.frame.valstack.slice(self.frame.valstack.length-vals1, self.frame.valstack.length).concat(self.frame.valstack.slice(pos, self.frame.valstack.length-vals1));"),e.code.push("for (ix=0; ix<"+r+"; ix++) { self.frame.valstack[pos+ix] = roll[ix]; }"),e.code.push("roll = undefined;"),e.code.push("}"),e.code.push("}")},84:function(e,n){if(V(e),H(n[0])){var r,s,t=Number(n[0]);for(r=0;r<t;r++)s=O(e,!0),e.offstack.push(s),e.code.push(s+"=self.frame.valstack[self.frame.valstack.length-"+(t-r)+"];")}else e.varsused.ix=!0,e.varsused.jx=!0,e.code.push("jx = self.frame.valstack.length-("+n[0]+");"),e.code.push("for (ix=0; ix<"+n[0]+"; ix++) { self.frame.valstack.push(self.frame.valstack[jx+ix]); }")},256:function(e,n){var r="self.do_gestalt(("+n[0]+"),("+n[1]+"))";e.code.push(n[2]+r+");")},257:function(e,n){e.code.push("self.fatal_error('User debugtrap encountered.', "+n[0]+");")},258:function(e,n){e.code.push(n[0]+"self.endmem);")},259:function(e,n){e.code.push("self.change_memsize("+n[0]+",false);"),e.code.push(n[1]+"0);")},272:function(e,n){var r;if(H(n[0])){var s=4294967295&Number(n[0]);r=0==s?"(Math.floor(self.random_func() * 0x10000) | (Math.floor(self.random_func() * 0x10000) << 16)) >>>0":s>0?"Math.floor(self.random_func() * "+s+")":"-Math.floor(self.random_func() * "+-s+")"}else{var t=I(e,n[0],!0),a=O(e);r=a,e.code.push("if ("+t+" > 0)"),e.code.push(a+" = Math.floor(self.random_func() * "+t+");"),e.code.push("else if ("+t+" < 0)"),e.code.push(a+" = -Math.floor(self.random_func() * -"+t+");"),e.code.push("else"),e.code.push(a+" = (Math.floor(self.random_func() * 0x10000) | (Math.floor(self.random_func() * 0x10000) << 16)) >>>0;")}e.code.push(n[1]+r+");")},273:function(e,n){e.code.push("self.set_random("+n[0]+");")},288:function(e,n){e.code.push("// quashing offstack for quit: "+e.offstack.length),e.offstack.length=0,e.offloc.length=0,e.offlocdirty.length=0,e.code.push("return self.VMStopped;"),e.path_ends=!0},289:function(e,n){e.code.push(n[0]+"self.perform_verify());")},290:function(e,n){e.code.push("// quashing offstack for quit: "+e.offstack.length),e.offstack.length=0,e.offloc.length=0,e.offlocdirty.length=0,e.code.push("self.vm_restart();"),e.code.push("return;"),e.path_ends=!0},291:function(e,n){V(e),e.varsused.ix=!0,B(e,n[1]),e.code.push("ix = self.vm_save("+n[0]+");"),e.code.push("self.pop_callstub(ix ? 0 : 1);"),e.code.push("return;"),e.path_ends=!0},292:function(e,n){V(e),e.code.push("if (self.vm_restore("+n[0]+")) {"),e.code.push("self.pop_callstub((-1)>>>0);"),e.code.push("} else {"),q(e,n[1],"1"),V(e),e.code.push("self.pc = "+e.cp+";"),e.code.push("}"),e.code.push("return;"),e.path_ends=!0},293:function(e,n){V(e),B(e,n[0]),e.code.push("self.vm_saveundo();"),e.code.push("self.pop_callstub(0);"),e.code.push("return;"),e.path_ends=!0},294:function(e,n){V(e),e.code.push("if (self.vm_restoreundo()) {"),e.code.push("self.pop_callstub((-1)>>>0);"),e.code.push("} else {"),q(e,n[0],"1"),V(e),e.code.push("self.pc = "+e.cp+";"),e.code.push("}"),e.code.push("return;"),e.path_ends=!0},295:function(e,n){e.code.push("self.protectstart="+n[0]+";"),e.code.push("self.protectend=self.protectstart+("+n[1]+");"),e.code.push("if (self.protectstart==self.protectend) {"),e.code.push("  self.protectstart=0; self.protectend=0;"),e.code.push("}")},368:function(e,n){e.varsused.maddr=!0,e.varsused.mlen=!0,e.varsused.ix=!0,e.code.push("mlen="+n[0]+";"),e.code.push("maddr="+n[1]+";"),e.code.push("for (ix=0; ix<mlen; ix++, maddr++) self.MemW1(maddr, 0);")},369:function(e,n){e.varsused.msrc=!0,e.varsused.mdest=!0,e.varsused.mlen=!0,e.varsused.ix=!0,e.code.push("mlen="+n[0]+";"),e.code.push("msrc="+n[1]+";"),e.code.push("mdest="+n[2]+";"),e.code.push("if (mdest < msrc) {"),e.code.push("for (ix=0; ix<mlen; ix++, msrc++, mdest++) self.MemW1(mdest, self.Mem1(msrc));"),e.code.push("} else {"),e.code.push("msrc += (mlen-1); mdest += (mlen-1);"),e.code.push("for (ix=0; ix<mlen; ix++, msrc--, mdest--) self.MemW1(mdest, self.Mem1(msrc));"),e.code.push("}")},376:function(e,n){var r="self.heap_malloc("+n[0]+")";e.code.push(n[1]+r+");"),e.code.push("self.assert_heap_valid();")},377:function(e,n){e.code.push("self.heap_free("+n[0]+");"),e.code.push("self.assert_heap_valid();")},384:function(e,n){e.code.push("self.accel_funcnum_map["+n[1]+"] = "+n[0]+";"),e.code.push("self.accel_address_map["+n[1]+"] = self.accel_func_map["+n[0]+"];")},385:function(e,n){e.code.push("if ("+n[0]+" < 9) {"),e.code.push("  self.accel_params["+n[0]+"] = "+n[1]+";"),e.code.push("}")},336:function(e,n){var r="self.linear_search(("+n[0]+"),("+n[1]+"),("+n[2]+"),("+n[3]+"),("+n[4]+"),("+n[5]+"),("+n[6]+"))";e.code.push(n[7]+r+");")},337:function(e,n){var r="self.binary_search(("+n[0]+"),("+n[1]+"),("+n[2]+"),("+n[3]+"),("+n[4]+"),("+n[5]+"),("+n[6]+"))";e.code.push(n[7]+r+");")},338:function(e,n){var r="self.linked_search(("+n[0]+"),("+n[1]+"),("+n[2]+"),("+n[3]+"),("+n[4]+"),("+n[5]+"))";e.code.push(n[6]+r+");")},112:function(e,n){switch(e.curiosys){case 2:if(H(n[0])){var r=255&Number(n[0]);e.code.push("self.Glk.glk_put_char("+r+");")}else e.code.push("self.Glk.glk_put_char(("+n[0]+")&0xff);");break;case 1:V(e),e.code.push("self.tempcallargs[0]=(("+n[0]+")&0xff);"),B(e,"0,0"),e.code.push("self.enter_function(self.iosysrock, 1);"),e.code.push("return;"),e.path_ends=!0;break;case 0:e.code.push("// null streamchar "+n[0])}},113:function(e,n){switch(e.curiosys){case 2:var r=I(e,n[0]);if(H(n[0])){var s=Number(r).toString(10);e.code.push("self.Glk.glk_put_jstring("+S(s)+", true);")}else e.code.push("self.Glk.glk_put_jstring(("+r+").toString(10), true);");break;case 1:V(e),e.code.push("self.stream_num("+e.cp+","+n[0]+", false, 0);"),e.code.push("return;"),e.path_ends=!0;break;case 0:e.code.push("// null streamnum "+n[0])}},114:function(e,n){V(e),e.code.push("if (self.stream_string("+e.cp+","+n[0]+", 0, 0)) return;")},115:function(e,n){switch(e.curiosys){case 2:if(H(n[0])){var r=Number(n[0]);e.code.push("self.Glk.glk_put_char_uni("+r+");")}else e.code.push("self.Glk.glk_put_char_uni("+n[0]+");");break;case 1:V(e),e.code.push("self.tempcallargs[0]=("+n[0]+");"),B(e,"0,0"),e.code.push("self.enter_function(self.iosysrock, 1);"),e.code.push("return;"),e.path_ends=!0;break;case 0:e.code.push("// null streamchar "+n[0])}},320:function(e,n){e.code.push(n[0]+"self.stringtable)")},321:function(e,n){e.code.push("self.set_string_table("+n[0]+");")},328:function(e,n){e.code.push(n[0]+"self.iosysmode)"),e.code.push(n[1]+"self.iosysrock)")},329:function(e,n){if(e.code.push("self.set_iosys("+n[0]+","+n[1]+");"),H(n[0])){var r=Number(n[0]);e.curiosys=r}else V(e),e.code.push("self.pc = "+e.cp+";"),e.code.push("return;"),e.path_ends=!0},400:function(e,n){var r=I(e,n[0]);if(H(n[0])){var s=Number(r);e.code.push(n[1]+be(s)+");")}else e.code.push(n[1]+"self.encode_float("+r+"));")},401:function(e,n){e.varsused.valf=!0,e.varsused.res=!0,e.code.push("valf = "+U(e,n[0])+";"),e.code.push("if (!("+n[0]+" & 0x80000000)) {"),e.code.push("  if (isNaN(valf) || !isFinite(valf) || (valf > 0x7fffffff))"),e.code.push("    res = 0x7fffffff;"),e.code.push("  else"),e.code.push("    res = Math.floor(valf);"),e.code.push("} else {"),e.code.push("  if (isNaN(valf) || !isFinite(valf) || (valf < -0x80000000))"),e.code.push("    res = -0x80000000;"),e.code.push("  else"),e.code.push("    res = Math.ceil(valf);"),e.code.push("}"),e.code.push(n[1]+"res>>>0);")},402:function(e,n){e.varsused.valf=!0,e.varsused.res=!0,e.code.push("valf = "+U(e,n[0])+";"),e.code.push("if (!("+n[0]+" & 0x80000000)) {"),e.code.push("  if (isNaN(valf) || !isFinite(valf))"),e.code.push("    res = 0x7fffffff;"),e.code.push("  else"),e.code.push("    res = Math.round(valf);"),e.code.push("  if (res > 0x7fffffff) res = 0x7fffffff;"),e.code.push("} else {"),e.code.push("  if (isNaN(valf) || !isFinite(valf))"),e.code.push("    res = -0x80000000;"),e.code.push("  else"),e.code.push("    res = Math.round(valf);"),e.code.push("  if (res < -0x80000000) res = -0x80000000;"),e.code.push("}"),e.code.push(n[1]+"res>>>0);")},408:function(e,n){var r=U(e,n[0]);e.code.push(n[1]+"self.encode_float(Math.ceil("+r+")));")},409:function(e,n){var r=U(e,n[0]);e.code.push(n[1]+"self.encode_float(Math.floor("+r+")));")},416:function(e,n){var r=U(e,n[0]),s=U(e,n[1]);e.code.push(n[2]+"self.encode_float("+r+" + "+s+"));")},417:function(e,n){var r=U(e,n[0]),s=U(e,n[1]);e.code.push(n[2]+"self.encode_float("+r+" - "+s+"));")},418:function(e,n){var r=U(e,n[0]),s=U(e,n[1]);e.code.push(n[2]+"self.encode_float("+r+" * "+s+"));")},419:function(e,n){var r=U(e,n[0]),s=U(e,n[1]);e.code.push(n[2]+"self.encode_float("+r+" / "+s+"));")},420:function(e,n){var r=U(e,n[0],!0),s=U(e,n[1],!0);e.varsused.modv=!0,e.varsused.quov=!0,e.code.push("modv=("+r+" % "+s+");"),e.code.push("quov=self.encode_float(("+r+" - modv) / "+s+");"),e.code.push("if (quov == 0x0 || quov == 0x80000000) {"),e.code.push("  quov = (("+n[0]+" ^ "+n[1]+") & 0x80000000) >>>0;"),e.code.push("}"),e.code.push(n[2]+"self.encode_float(modv));"),e.code.push(n[3]+"quov);")},424:function(e,n){var r=U(e,n[0]);e.code.push(n[1]+"self.encode_float(Math.sqrt("+r+")));")},425:function(e,n){var r=U(e,n[0]);e.code.push(n[1]+"self.encode_float(Math.exp("+r+")));")},426:function(e,n){var r=U(e,n[0]);e.code.push(n[1]+"self.encode_float(Math.log("+r+")));")},427:function(e,n){e.varsused.valf=!0;var r=U(e,n[0],!0),s=U(e,n[1],!0);e.code.push("if ("+n[0]+" == 0x3f800000) {"),e.code.push("  valf = 0x3f800000;"),e.code.push("} else if ("+n[0]+" == 0xbf800000 && ("+n[1]+" == 0xff800000 || "+n[1]+" == 0x7f800000)) {"),e.code.push("  valf = 0x3f800000;"),e.code.push("} else {"),e.code.push("  valf=self.encode_float(Math.pow("+r+", "+s+"));"),e.code.push("}"),e.code.push(n[2]+"valf);")},432:function(e,n){var r=U(e,n[0]);e.code.push(n[1]+"self.encode_float(Math.sin("+r+")));")},433:function(e,n){var r=U(e,n[0]);e.code.push(n[1]+"self.encode_float(Math.cos("+r+")));")},434:function(e,n){var r=U(e,n[0]);e.code.push(n[1]+"self.encode_float(Math.tan("+r+")));")},435:function(e,n){var r=U(e,n[0]);e.code.push(n[1]+"self.encode_float(Math.asin("+r+")));")},436:function(e,n){var r=U(e,n[0]);e.code.push(n[1]+"self.encode_float(Math.acos("+r+")));")},437:function(e,n){var r=U(e,n[0]);e.code.push(n[1]+"self.encode_float(Math.atan("+r+")));")},438:function(e,n){var r=U(e,n[0]),s=U(e,n[1]);e.code.push(n[2]+"self.encode_float(Math.atan2("+r+", "+s+")));")},448:function(e,n){var r,s,t,a;e.varsused.fequal=!0,e.varsused.fdiff=!0,e.code.push("if (("+n[2]+" & 0x7f800000) == 0x7f800000 && ("+n[2]+" & 0x007fffff) != 0) {"),e.code.push("  fequal = 0;"),e.code.push("} else if (("+n[0]+" == 0xff800000 || "+n[0]+" == 0x7f800000) && ("+n[1]+" == 0xff800000 || "+n[1]+" == 0x7f800000)) {"),e.code.push("  fequal = ("+n[0]+" == "+n[1]+");"),e.code.push("} else {"),H(n[2])?a=""+ke(2147483647&(r=Number(n[2]))):(r="self.decode_float(("+n[2]+") & 0x7fffffff)",a=O(e),e.code.push(a+"="+r+";")),s=U(e,n[0]),t=U(e,n[1]),e.code.push("  fdiff = "+t+" - "+s+";"),e.code.push("  fequal = (fdiff <= "+a+" && fdiff >= -("+a+"));"),e.code.push("}"),e.code.push("if (fequal) {"),R(e,n[3]),e.code.push("}")},449:function(e,n){var r,s,t,a;e.varsused.fequal=!0,e.varsused.fdiff=!0,e.code.push("if (("+n[2]+" & 0x7f800000) == 0x7f800000 && ("+n[2]+" & 0x007fffff) != 0) {"),e.code.push("  fequal = 0;"),e.code.push("} else if (("+n[0]+" == 0xff800000 || "+n[0]+" == 0x7f800000) && ("+n[1]+" == 0xff800000 || "+n[1]+" == 0x7f800000)) {"),e.code.push("  fequal = ("+n[0]+" == "+n[1]+");"),e.code.push("} else {"),H(n[2])?a=""+ke(2147483647&(r=Number(n[2]))):(r="self.decode_float(("+n[2]+") & 0x7fffffff)",a=O(e),e.code.push(a+"="+r+";")),s=U(e,n[0]),t=U(e,n[1]),e.code.push("  fdiff = "+t+" - "+s+";"),e.code.push("  fequal = (fdiff <= "+a+" && fdiff >= -("+a+"));"),e.code.push("}"),e.code.push("if (!fequal) {"),R(e,n[3]),e.code.push("}")},450:function(e,n){var r,s;r=U(e,n[0]),s=U(e,n[1]),e.code.push("if ("+r+" < "+s+") {"),R(e,n[2]),e.code.push("}")},451:function(e,n){var r,s;r=U(e,n[0]),s=U(e,n[1]),e.code.push("if ("+r+" <= "+s+") {"),R(e,n[2]),e.code.push("}")},452:function(e,n){var r,s;r=U(e,n[0]),s=U(e,n[1]),e.code.push("if ("+r+" > "+s+") {"),R(e,n[2]),e.code.push("}")},453:function(e,n){var r,s;r=U(e,n[0]),s=U(e,n[1]),e.code.push("if ("+r+" >= "+s+") {"),R(e,n[2]),e.code.push("}")},456:function(e,n){e.code.push("if (("+n[0]+" & 0x7f800000) == 0x7f800000 && ("+n[0]+" & 0x007fffff) != 0) {"),R(e,n[1]),e.code.push("}")},457:function(e,n){e.code.push("if ("+n[0]+" == 0xff800000 || "+n[0]+" == 0x7f800000) {"),R(e,n[1]),e.code.push("}")},304:function(n,r){var s;if((s=!H(r[0])||e.Glk.call_may_not_return(Number(r[0])))&&(n.code.push("  self.prevpc = "+n.prevcp+";"),n.code.push("  self.pc = "+n.cp+";")),n.code.push("self.tempglkargs.length = "+r[1]+";"),H(r[1])){var t,a=Number(r[1]);for(t=0;t<a;t++)if(n.offstack.length){var o=Z(n);n.code.push("self.tempglkargs["+t+"]="+o+";")}else n.code.push("self.tempglkargs["+t+"]=self.frame.valstack.pop();");V(n)}else n.varsused.ix=!0,V(n),n.code.push("for (ix=0; ix<"+r[1]+"; ix++) { self.tempglkargs[ix]=self.frame.valstack.pop(); }");n.varsused.glkret=!0,n.code.push("glkret = self.GiDispa.get_function("+r[0]+")(self.tempglkargs);"),s&&(n.code.push("if (glkret === self.Glk.DidNotReturn) {"),n.code.push("  self.resumefuncop = "+function(n){if(0==n.mode)return"null";var r="m"+n.mode;if(null!=n.argsize&&(r=r+"s"+n.argsize),null!=n.addr&&(r=r+"a"+n.addr),e.funcop_cache.key)return"self.funcop_cache."+r;var s={key:r,mode:n.mode,argsize:n.argsize,addr:n.addr};return e.funcop_cache[r]=s,"self.funcop_cache."+r}(r[2])+";"),n.code.push("  self.resumevalue = 0;"),n.code.push("  self.pc = "+n.cp+";"),n.code.push("  self.done_executing = true;"),n.code.push("  return;"),n.code.push("}")),q(n,r[2],"glkret")}};function O(e,n){for(var r,s=0;;){if(r="_hold"+s,!e.holduse[r])return e.holduse[r]=!n||1,r;s++}}function Z(e){var n=e.offstack.pop();if(H(n))return n;var r=e.holduse[n];return(isNaN(r)||!1===r||!0===r)&&C("Offstack variable not marked as stack.",n),0==--r&&(r=!0),e.holduse[n]=r,n}function P(e,n,r,s){var t=e.offloc[n];if(t&&"_"===t[0]){var a=e.holduse[t];0==--a&&(a=!0),e.holduse[t]=a}if(void 0===r)return e.offloc[n]=void 0,void(e.offlocdirty[n]=!1);if(e.offloc[n]=r,e.offlocdirty[n]=!0,s){var o=r;(a=e.holduse[o])&&!0!==a?a++:a=1,e.holduse[o]=a}}function H(e){return"0"===e[0]}function $(e,n,r,s){var t,a,o,l,i,d,p;for(s.desttype=0,s.numops=r.numops,t=n,n+=r.numops+1>>1,a=0;a<r.numops;a++){0==(1&a)?l=15&(o=c(t)):(l=o>>4&15,t++);var h=r.formlist[a];if("L"!=h)if("E"!=h)if("S"!=h)if("F"!=h)if("C"!=h)C("Unknown operand type.",h);else{switch(l){case 8:s[a]="3,0";continue;case 0:s[a]="0,0";continue}if(l>=9&&l<=11){9==l?(d=c(n),n++):10==l?(d=f(n),n+=2):11==l&&(d=u(n),n+=4),s[a]="2,"+d;continue}switch(l){case 15:d=u(n)+Ce,n+=4;break;case 14:d=f(n)+Ce,n+=2;break;case 13:d=c(n)+Ce,n++;break;case 7:d=u(n),n+=4;break;case 6:d=f(n),n+=2;break;case 5:d=c(n),n++;break;default:C("Unknown addressing mode in store operand.")}s[a]="1,"+d}else{var m=s.func_store;switch(l){case 8:m.mode=8,m.argsize=r.argsize,s[a]=m;continue;case 0:m.mode=0,m.argsize=r.argsize,s[a]=m;continue}if(l>=9&&l<=11){9==l?(d=c(n),n++):10==l?(d=f(n),n+=2):11==l&&(d=u(n),n+=4),m.mode=11,m.addr=d,m.argsize=r.argsize,s[a]=m;continue}switch(l){case 15:d=u(n)+Ce,n+=4;break;case 14:d=f(n)+Ce,n+=2;break;case 13:d=c(n)+Ce,n++;break;case 7:d=u(n),n+=4;break;case 6:d=f(n),n+=2;break;case 5:d=c(n),n++;break;default:C("Unknown addressing mode in store operand.")}m.mode=15,m.addr=d,m.argsize=r.argsize,s[a]=m}else{switch(l){case 8:p=O(e,!0),e.offstack.push(p),s[a]=p+"=(";continue;case 0:s[a]="(";continue}if(l>=9&&l<=11){9==l?(d=c(n),n++):10==l?(d=f(n),n+=2):11==l&&(d=u(n),n+=4),4==r.argsize?(P(e,d,p=O(e,!0),!1),s[a]=p+"=("):2==r.argsize?(P(e,d,void 0),s[a]="self.frame.locals["+d+"]=(0xffff &"):(P(e,d,void 0),s[a]="self.frame.locals["+d+"]=(0xff &");continue}switch(l){case 15:d=u(n)+Ce,n+=4;break;case 14:d=f(n)+Ce,n+=2;break;case 13:d=c(n)+Ce,n++;break;case 7:d=u(n),n+=4;break;case 6:d=f(n),n+=2;break;case 5:d=c(n),n++;break;default:C("Unknown addressing mode in store operand.")}i=4==r.argsize?"self.MemW4("+d+",":2==r.argsize?"self.MemW2("+d+",":"self.MemW1("+d+",",s[a]=i}else{switch(l){case 8:e.offstack.length?s[a]=Z(e):s[a]="self.frame.valstack.pop()";continue;case 0:s[a]="0";continue;case 1:i=b(n),n++,s[a]=i;continue;case 2:i=y(n),n+=2,s[a]=i;continue;case 3:i=x(n),n+=4,s[a]=i;continue}if(l>=9&&l<=11){if(9==l?(d=c(n),n++):10==l?(d=f(n),n+=2):11==l&&(d=u(n),n+=4),void 0!==e.offloc[d]){s[a]=e.offloc[d];continue}i=4==r.argsize?"self.frame.locals["+d+"]":2==r.argsize?"self.frame.locals["+d+"] & 0xffff":"self.frame.locals["+d+"] & 0xff",p=O(e,!0),e.code.push(p+"=("+i+");"),e.offloc[d]=p,e.offlocdirty[d]=!1,s[a]=p;continue}switch(l){case 15:d=u(n)+Ce,n+=4;break;case 14:d=f(n)+Ce,n+=2;break;case 13:d=c(n)+Ce,n++;break;case 7:d=u(n),n+=4;break;case 6:d=f(n),n+=2;break;case 5:d=c(n),n++;break;default:C("Unknown addressing mode in load operand.")}i=4==r.argsize?"self.Mem4("+d+")":2==r.argsize?"self.Mem2("+d+")":"self.Mem1("+d+")",s[a]=i}else{switch(l){case 8:e.offstack.length?s[a]=Z(e):(p=O(e),e.code.push(p+"=self.frame.valstack.pop();"),s[a]=p);continue;case 0:s[a]="0";continue;case 1:i=b(n),n++,s[a]=i;continue;case 2:i=y(n),n+=2,s[a]=i;continue;case 3:i=x(n),n+=4,s[a]=i;continue}if(l>=9&&l<=11){if(9==l?(d=c(n),n++):10==l?(d=f(n),n+=2):11==l&&(d=u(n),n+=4),void 0!==e.offloc[d]){s[a]=e.offloc[d];continue}i=4==r.argsize?"self.frame.locals["+d+"]":2==r.argsize?"self.frame.locals["+d+"] & 0xffff":"self.frame.locals["+d+"] & 0xff",p=O(e,!0),e.code.push(p+"=("+i+");"),e.offloc[d]=p,e.offlocdirty[d]=!1,s[a]=p;continue}switch(l){case 15:d=u(n)+Ce,n+=4;break;case 14:d=f(n)+Ce,n+=2;break;case 13:d=c(n)+Ce,n++;break;case 7:d=u(n),n+=4;break;case 6:d=f(n),n+=2;break;case 5:d=c(n),n++;break;default:C("Unknown addressing mode in load operand.")}i=4==r.argsize?"self.Mem4("+d+")":2==r.argsize?"self.Mem2("+d+")":"self.Mem1("+d+")",p=O(e),e.code.push(p+"=("+i+");"),s[a]=p}}return n}function J(e,n,r){var s,t,a,o=n,l={vmfunc:e,cp:null,prevcp:null,curiosys:r,code:[],holduse:{},varsused:{},offstack:[],offloc:[],offlocdirty:[],path_ends:!1},i={func_store:{}};for(l.code.push("");!l.path_ends;){l.prevcp=o,t=o,void 0===(s=c(o))&&C("Tried to compile nonexistent address",o),o++,128&s&&(64&s?(s=256*(s=256*(s=256*(s&=63)|c(o))|c(++o))|c(++o),o++):(s=256*(s&=127)|c(o),o++)),l.code.push("// "+t.toString(16)+": opcode "+s.toString(16));var f=W[s];f||C("Encountered unknown opcode.",s),o=$(l,o,f,i),l.cp=o;var u=Q[s];for(a in u||C("Encountered unhandled opcode.",s),u(l,i),l.holduse)!0===l.holduse[a]&&(l.holduse[a]=!1);l.offstack.length&&l.code.push("// offstack: "+l.offstack.join(",")),l.offloc.length&&l.code.push("// offloc: "+l.offloc.join(",")+"; dirty: "+l.offlocdirty.join(",")),e.pathaddrs[o]&&!l.path_ends&&(l.code.push("// reached jump-in point"),l.code.push("self.pc="+o+";"),V(l),l.code.push("return;"),l.path_ends=!0)}l.offstack.length&&C("Path compilation ended with nonempty offstack.",l.offstack.length),l.offloc.length&&C("Path compilation ended with nonempty offloc.",l.offloc.length);var d=[];for(a in l.holduse)d.push(a);for(a in l.varsused)d.push(a);return d.length&&(l.code[0]="var "+d.join(",")+";"),j(l.code.join("\n"))}function X(n,r){var s;Qe++;var t=te[n];if(void 0!==t)return Oe++,void Y(t(r,e.tempcallargs));var a=Me[n];void 0===a&&(a=function(e){var n=e,r=c(n);192!=r&&193!=r&&C(r>=192&&r<=223?"Call to unknown type of function.":"Call to non-function.",n);for(var s=[],t=++n;;){var a=c(n),o=c(++n);if(n++,0==a)break;1!=a&&2!=a&&4!=a&&C("Invalid local variable size in function header.",a),s.push({size:a,count:o})}for(var l=ye.slice(t,n);l.length%4;)l.push(0);return new N(e,n,s,l)}(n),n<Ce&&(Me[n]=a)),e.pc=a.startpc;var o=new L(a);if(o.depth=xe.length,0==xe.length?o.framestart=0:o.framestart=e.frame.framestart+e.frame.framelen+4*e.frame.valstack.length,xe.push(o),e.frame=o,192==a.functype){for(s=r-1;s>=0;s--)e.frame.valstack.push(e.tempcallargs[s]);e.frame.valstack.push(r)}else for(s=0;s<r;s++){var l=a.localsindex[s];if(void 0===l)break;4==l.size?e.frame.locals[l.pos]=e.tempcallargs[s]:2==l.size?e.frame.locals[l.pos]=65535&e.tempcallargs[s]:1==l.size&&(e.frame.locals[l.pos]=255&e.tempcallargs[s])}}function Y(n){var r,s;isNaN(n)&&C("Function returned undefined value.");var t=e.frame.valstack,a=t.length,o=t[a-1];switch(o!=e.frame.framestart&&(t.length-=1,C("Call stub frameptr ("+o+") does not match frame ("+e.frame.framestart+")")),e.pc=t[a-2],r=t[a-3],s=t[a-4],t.length-=4,s){case 0:return;case 1:return void m(r,n);case 2:return void(e.frame.locals[r]=n);case 3:return void e.frame.valstack.push(n);case 17:return void C("String-terminator call stub at end of function call.");case 16:return void _e(0,e.pc,225,r);case 18:return void me(0,e.pc,!0,r);case 19:return void _e(0,e.pc,224,r);case 20:return void _e(0,e.pc,226,r);default:C("Unrecognized desttype in callstub.",s)}}function K(n){0==n?e.random_func=Math.random:(!function(e){var n,r,s,t,a;void 0===re&&(re=Array(55));for(re[54]=e,ee=0,ne=31,s=1,n=0;n<55;n++)re[r=21*n%55]=s,s=e-s>>>0,e=re[r];for(a=0;a<4;a++)for(n=0;n<55;n++)t=re[n]-re[(1+n+30)%55],re[n]=t>>>0}(n),e.random_func=se)}e.enter_function=X,e.leave_function=function(){var n=e.frame.depth;if(xe.pop(),0==xe.length)return e.frame=null,!0;e.frame=xe[xe.length-1],e.frame.depth!=n-1&&C("Stack inconsistent after function exit.")},e.pop_stack_to=function(n){for(;xe.length&&xe[xe.length-1].framestart>n;)xe.pop();0==xe.length&&C("Stack evaporated during throw."),e.frame=xe[xe.length-1],(n-=e.frame.framestart+e.frame.framelen)<0&&C("Attempted to throw below the frame value stack."),3&n&&C("Attempted to throw to an unaligned address."),(n>>>=2)>e.frame.valstack.length&&C("Attempted to throw beyond the frame value stack."),e.frame.valstack.length=n},e.pop_callstub=Y,e.store_operand=function(n,r,s){switch(n){case 0:return;case 1:return void m(r,s);case 2:return void(e.frame.locals[r]=s);case 3:return void e.frame.valstack.push(s);default:C("Unrecognized desttype in callstub.",n)}},e.set_random=K;var ee,ne,re=void 0;function se(){return ne=(ne+1)%55,re[ee=(ee+1)%55]=re[ee]-re[ne]>>>0,re[ee]/4294967296}var te={},ae={};e.accel_address_map=te,e.accel_funcnum_map=ae;var oe=[0,0,0,0,0,0,0,0,0];e.accel_params=oe;var le={1:function(n,r){if(n<1)return 0;var s=r[0];if(s<36)return 0;if(s>=e.endmem)return 0;var t=c(s);return t>=224?3:t>=192?2:t>=112&&t<=127&&s>=Ce?1:0},2:function(n,r){var s=n>0?r[0]:0,t=n>1?r[1]:0;if(1!=le[1](n,r))return e.Glk.glk_put_jstring('\n[** Programming error: tried to find the "." of (something) **]\n'),0;var a=u(s+16);if(!a)return 0;var o=u(a);return we(t,2,a+=4,10,o,0,0)},3:function(e,n){var r=fe(e>0?n[0]:0,e>1?n[1]:0);return 0==r?0:u(r+4)},4:function(e,n){var r=fe(e>0?n[0]:0,e>1?n[1]:0);return 0==r?0:4*f(r+2)},5:function(n,r){var s,t,a,o,l,i=n>0?r[0]:0,c=n>1?r[1]:0;if(3==(s=le[1](n,r)))return c==oe[5]?1:0;if(2==s)return c==oe[4]?1:0;if(1!=s)return 0;if(c==oe[2])return ce(i)||i==oe[2]||i==oe[5]||i==oe[4]||i==oe[3]?1:0;if(c==oe[3])return ce(i)||i==oe[2]||i==oe[5]||i==oe[4]||i==oe[3]?0:1;if(c==oe[5]||c==oe[4])return 0;if(!ce(c))return e.Glk.glk_put_jstring("\n[** Programming error: tried to apply 'ofclass' with non-class **]\n"),0;if(0==(t=fe(i,2)))return 0;if(0==(a=u(t+4)))return 0;for(o=f(t+2),l=0;l<o;l++)if(u(a+4*l)==c)return 1;return 0},6:function(n,r){var s,t=n>1?r[1]:0;return 0==(s=le[3](n,r))?t>0&&t<oe[1]?u(oe[8]+4*t):(e.Glk.glk_put_jstring("\n[** Programming error: tried to read (something) **]\n"),0):u(s)},7:function(e,n){var r=e>0?n[0]:0,s=e>1?n[1]:0,t=oe[1],a=le[1](e,n);return 3==a?s==t+6||s==t+7?1:0:2==a?s==t+5?1:0:1!=a?0:s>=t&&s<t+8&&ce(r)||le[3](e,n)?1:0},8:function(n,r){var s=n>0?r[0]:0,t=n>1?r[1]:0;if(1!=le[1](n,r))return e.Glk.glk_put_jstring('\n[** Programming error: tried to find the "." of (something) **]\n'),0;var a=u(s+4*(3+(oe[7]>>2)));if(!a)return 0;var o=u(a);return we(t,2,a+=4,10,o,0,0)},9:function(e,n){var r=ue(e>0?n[0]:0,e>1?n[1]:0);return 0==r?0:u(r+4)},10:function(e,n){var r=ue(e>0?n[0]:0,e>1?n[1]:0);return 0==r?0:4*f(r+2)},11:function(n,r){var s,t,a,o,l,i=n>0?r[0]:0,c=n>1?r[1]:0;if(3==(s=le[1](n,r)))return c==oe[5]?1:0;if(2==s)return c==oe[4]?1:0;if(1!=s)return 0;if(c==oe[2])return ce(i)||i==oe[2]||i==oe[5]||i==oe[4]||i==oe[3]?1:0;if(c==oe[3])return ce(i)||i==oe[2]||i==oe[5]||i==oe[4]||i==oe[3]?0:1;if(c==oe[5]||c==oe[4])return 0;if(!ce(c))return e.Glk.glk_put_jstring("\n[** Programming error: tried to apply 'ofclass' with non-class **]\n"),0;if(0==(t=ue(i,2)))return 0;if(0==(a=u(t+4)))return 0;for(o=f(t+2),l=0;l<o;l++)if(u(a+4*l)==c)return 1;return 0},12:function(n,r){var s,t=n>1?r[1]:0;return 0==(s=le[9](n,r))?t>0&&t<oe[1]?u(oe[8]+4*t):(e.Glk.glk_put_jstring("\n[** Programming error: tried to read (something) **]\n"),0):u(s)},13:function(e,n){var r=e>0?n[0]:0,s=e>1?n[1]:0,t=oe[1],a=le[1](e,n);return 3==a?s==t+6||s==t+7?1:0:2==a?s==t+5?1:0:1!=a?0:s>=t&&s<t+8&&ce(r)||le[9](e,n)?1:0}};e.accel_func_map=le;var ie=[0,0];function ce(e){return u(e+13+oe[7])==oe[2]}function fe(e,n){var r,s=0;if(4294901760&n){if(s=u(oe[0]+4*(65535&n)),ie[0]=e,ie[1]=s,0==le[5](2,ie))return 0;n>>=16,e=s}return ie[0]=e,ie[1]=n,0==(r=le[2](2,ie))||ce(e)&&0==s&&(n<oe[1]||n>=oe[1]+8)||u(oe[6])!=e&&1&c(r+9)?0:r}function ue(e,n){var r,s=0;if(4294901760&n){if(s=u(oe[0]+4*(65535&n)),ie[0]=e,ie[1]=s,0==le[11](2,ie))return 0;n>>=16,e=s}return ie[0]=e,ie[1]=n,0==(r=le[8](2,ie))||ce(e)&&0==s&&(n<oe[1]||n>=oe[1]+8)||u(oe[6])!=e&&1&c(r+9)?0:r}function de(n){if(e.stringtable!=n&&(ze=void 0,Se=void 0,e.stringtable=n,0!=e.stringtable)){var r=Ge[e.stringtable];if(void 0===r){var s=void 0,t=u(e.stringtable),a=u(e.stringtable+8);if(e.stringtable+t<=Ce){var o=Array(1);he(o,a,4,0),void 0===(s=o[0])&&C("Failed to create decoding tree.")}r=new A(e.stringtable,s),Ge[e.stringtable]=r}ze=r.decoding_tree,Se=r.vmstring_tables[e.iosysmode]}}function pe(n,r){switch(n){case 0:case 2:r=0;break;case 1:break;default:n=0,r=0}e.iosysmode=n,e.iosysrock=r;var s=Ge[e.stringtable];Se=void 0===s?void 0:s.vmstring_tables[e.iosysmode]}function he(e,n,r,s){var t,a,o,l;if(0==(a=c(n))&&4==r)return(o=Array(16)).type=0,o.depth=4,e[s]=o,void he(o,n,0,0);if(0==a){var i=u(n+1),f=u(n+5);return he(e,i,r+1,s),void he(e,f,r+1,s|1<<r)}switch(n++,(o={}).type=a,o.depth=r,a){case 2:o.value=c(n),o.cchar=M(o.value);break;case 4:o.value=u(n),o.cchar=M(o.value);break;case 3:case 5:case 10:case 11:o.addr=n;break;case 8:case 9:o.addr=u(n);break;case 1:break;default:C("Unknown node type in string table.",a)}for(l=1<<r,t=s;t<16;t+=l)e[t]=o}function me(n,r,s,t){var a=(4294967295&r).toString(10);switch(e.iosysmode){case 2:t&&(a=a.slice(t)),e.Glk.glk_put_jstring(a,!0);break;case 1:if(s||(e.frame.valstack.push(17,0,n,e.frame.framestart),s=!0),t<a.length){var o=a.charCodeAt(t);return e.frame.valstack.push(18,t+1,r,e.frame.framestart),e.tempcallargs[0]=o,X(e.iosysrock,1),!0}}s&&(e.frame.valstack.pop()!=e.frame.framestart&&C("Call stub frameptr does not match frame."),e.pc=e.frame.valstack.pop(),e.frame.valstack.pop(),17!=e.frame.valstack.pop()&&C("String-on-string call stub while printing number."))}function _e(n,r,s,t){for(var a,o,l,i,c,f=0!=s;;){if(o=void 0,a=0==s?r:r+"/"+s+"/"+t,void 0!==Se&&r<Ce?void 0===(o=Se[a])&&(o=ge(e.iosysmode,r,s,t),Se[a]=o,Je++,$e++):(o=ge(e.iosysmode,r,s,t),Je++),o instanceof Function){if((l=o(e,n,f))instanceof Array){f=!0,r=l[0],s=l[1],t=l[2];continue}if(l)return!0}else if(e.Glk.glk_put_jstring(o),!f)return!1;if(e.frame.valstack.pop()!=e.frame.framestart&&C("Call stub frameptr does not match frame."),e.pc=e.frame.valstack.pop(),c=e.frame.valstack.pop(),17==(i=e.frame.valstack.pop()))return!0;16==i?(f=!0,t=c,s=225,r=e.pc):C("Function-terminator call stub at end of string.")}}function ge(n,r,s,t){var a,o=r,l=t,i=void 0;o||C("Called compile_string with null address.");var f={startaddr:r,startbitnum:t,buffer:[],code:[]};if(0==s?(226==(a=c(o))?o+=4:o++,l=0):a=s,225==a)if(ze){var d,p,h,m,_,g,v=!1;for(d=c(o),l&&(d>>=l),p=8-l,h=!1,ze instanceof Array||(v=!0),_=ze;!v;){if(p<4)d|=c(o+1)<<p,p+=8,h=!0;if(p-=(g=_[15&d]).depth,d>>=g.depth,(l+=g.depth)>=8)if(o+=1,l-=8,h)h=!1;else d|=c(o)<<p,p+=8;if(g instanceof Array)_=g;else switch(g.type){case 1:v=!0;break;case 2:case 4:switch(n){case 2:f.buffer.push(g.cchar);break;case 1:T(f),D(f),B(f,"0x10,"+l,o),f.code.push("self.tempcallargs[0]="+g.value+";"),f.code.push("self.enter_function(self.iosysrock, 1);"),i=!0,v=!0}_=ze;break;case 3:switch(n){case 2:for(m=g.addr;0!=(G=c(m));)f.buffer.push(M(G)),m++;break;case 1:T(f),D(f),B(f,"0x10,"+l,o),i="["+g.addr+", 0xE0, 0]",v=!0}_=ze;break;case 5:switch(n){case 2:for(m=g.addr;0!=(G=u(m));)f.buffer.push(M(G)),m+=4;break;case 1:T(f),D(f),B(f,"0x10,"+l,o),i="["+g.addr+", 0xE2, 0]",v=!0}_=ze;break;case 8:case 9:case 10:case 11:T(f),D(f),f.code.push("var otype, retval;"),f.code.push("var oaddr = "+g.addr+";"),g.type>=9&&f.code.push("oaddr = self.Mem4(oaddr);"),11==g.type&&f.code.push("oaddr = self.Mem4(oaddr);"),f.code.push("otype = self.Mem1(oaddr);"),i="retval",v=!0,B(f,"0x10,"+l,o),f.code.push("if (otype >= 0xE0 && otype <= 0xFF) {"),f.code.push("retval = [oaddr, 0, 0];"),f.code.push("}"),f.code.push("else if (otype >= 0xC0 && otype <= 0xDF) {");var w=0;if(10==g.type||11==g.type){w=u(g.addr+4);for(var k=0;k<w;k++)f.code.push("self.tempcallargs["+k+"]="+u(g.addr+8+4*k)+";")}f.code.push("self.enter_function(oaddr, "+w+");"),f.code.push("retval = true;"),f.code.push("}"),f.code.push("else {"),f.code.push("self.fatal_error('Unknown object while decoding string indirect reference.', otype);"),f.code.push("}");break;default:C("Unknown entity in string decoding (cached).")}}}else{var b,y,x;v=!1;for(e.stringtable||C("Attempted to print a compressed string with no table set."),y=c(o),l&&(y>>=l),b=u(e.stringtable+8);!v;)switch(x=c(b),b++,x){case 0:b=u(1&y?b+4:b+0),7==l?(l=0,y=c(++o)):(l++,y>>=1);break;case 1:i=!1,v=!0;break;case 2:switch(G=c(b),n){case 2:f.buffer.push(M(G));break;case 1:T(f),D(f),B(f,"0x10,"+l,o),f.code.push("self.tempcallargs[0]="+G+";"),f.code.push("self.enter_function(self.iosysrock, 1);"),i=!0,v=!0}b=u(e.stringtable+8);break;case 4:switch(G=u(b),n){case 2:f.buffer.push(M(G));break;case 1:T(f),D(f),B(f,"0x10,"+l,o),f.code.push("self.tempcallargs[0]="+G+";"),f.code.push("self.enter_function(self.iosysrock, 1);"),i=!0,v=!0}b=u(e.stringtable+8);break;case 3:switch(n){case 2:for(;0!=(G=c(b));)f.buffer.push(M(G)),b++;break;case 1:T(f),D(f),B(f,"0x10,"+l,o),i="["+b+", 0xE0, 0]",v=!0}b=u(e.stringtable+8);break;case 5:switch(n){case 2:for(;0!=(G=u(b));)f.buffer.push(M(G)),b+=4;break;case 1:T(f),D(f),B(f,"0x10,"+l,o),i="["+b+", 0xE2, 0]",v=!0}b=u(e.stringtable+8);break;case 8:case 9:case 10:case 11:T(f),D(f),f.code.push("var otype, retval;"),f.code.push("var oaddr = "+u(b)+";"),9!=x&&11!=x||f.code.push("oaddr = self.Mem4(oaddr);"),f.code.push("otype = self.Mem1(oaddr);"),i="retval",v=!0,B(f,"0x10,"+l,o),f.code.push("if (otype >= 0xE0 && otype <= 0xFF) {"),f.code.push("retval = [oaddr, 0, 0];"),f.code.push("}"),f.code.push("else if (otype >= 0xC0 && otype <= 0xDF) {");w=0;if(10==x||11==x){w=u(b+4);for(k=0;k<w;k++)f.code.push("self.tempcallargs["+k+"]="+u(b+8+4*k)+";")}f.code.push("self.enter_function(oaddr, "+w+");"),f.code.push("retval = true;"),f.code.push("}"),f.code.push("else {"),f.code.push("self.fatal_error('Unknown object while decoding string indirect reference.', otype);"),f.code.push("}");break;default:C("Unknown entity in string decoding.",x)}}else if(224==a){switch(n){case 2:for(;G=c(o),o++,0!=G;)f.buffer.push(M(G));break;case 1:T(f),D(f),G=c(o),o++,0!=G?(B(f,"0x13,0",o),f.code.push("self.tempcallargs[0]="+G+";"),f.code.push("self.enter_function(self.iosysrock, 1);"),i=!0):i="false"}}else if(226==a){var G;switch(n){case 2:for(;G=u(o),o+=4,0!=G;)f.buffer.push(M(G));break;case 1:T(f),D(f),G=u(o),o+=4,0!=G?(B(f,"0x14,0",o),f.code.push("self.tempcallargs[0]="+G+";"),f.code.push("self.enter_function(self.iosysrock, 1);"),i=!0):i="false"}}else C(a>=224&&a<=255?"Attempt to print unknown type of string.":"Attempt to print non-string.");return i?(T(f),f.code.push("return "+i+";"),j(f.code.join("\n"),0,"nextcp","substring")):(f.code.length>1&&C("Simple-case string generated code."),f.buffer.join(""))}function ve(e,n,r){if(1&r)return d(e,n);switch(n){case 4:return[e>>24&255,e>>16&255,e>>8&255,255&e];case 2:return[e>>8&255,255&e];case 1:return[255&e];default:C("Direct search key must hold one, two, or four bytes.")}}function we(e,n,r,s,t,a,o){var l,i,f,u,d,p,h,m,_=0!=(4&o),g=ve(e,n,o);for(i=0,l=t;i<l;){for(d=0,f=r+(u=l+i>>1)*s,p=0;!d&&p<n;p++)(h=c(f+a+p))<(m=g[p])?d=-1:h>m&&(d=1);if(!d)return _?u:f;d<0?i=u+1:l=u}return _?4294967295:0}function ke(e){var n,r,s;return 2147483648&e?(n=!0,e&=2147483647):n=!1,0==e?n?-0:0:2139095040==(2139095040&e)?0==(8388607&e)?n?-1/0:1/0:NaN:(r=(s=e>>23&255)?(8388607&e|8388608)/8388608*Math.pow(2,s-127):(8388607&e)/8388608*Math.pow(2,-126),n?-r:r)}function be(e){var n,r,s,t,a;return isNaN(e)?2139095041:isFinite(e)?0==e?1/e<0?2147483648:0:(e<0?(a=!0,n=-e):(a=!1,n=e),t=Math.floor(Math.log(n)/Math.log(2)),s=n/Math.pow(2,t),t>=128?a?4286578688:2139095040:(t<-126?(s*=Math.pow(2,126+t),t=0):0==t&&0==s||(t+=127,s-=1),(r=(s*=8388608)+.4999999999999999<<0)>=8388608&&(r=0,++t>=255)?a?4286578688:2139095040:a?(2147483648|t<<23|r)>>>0:t<<23|r)):e<0?4286578688:2139095040}e.set_string_table=de,e.set_iosys=pe,e.stream_num=me,e.stream_string=_e,e.do_gestalt=function(e,n){switch(e){case 0:return 196866;case 1:return 131584;case 2:case 3:return 1;case 4:switch(n){case 0:case 1:case 2:return 1;default:return 0}case 5:case 6:case 7:return 1;case 8:return Ae;case 9:return 1;case 10:return le[n]?1:0;case 11:return 1;default:return 0}},e.linear_search=function(e,n,r,s,t,a,o){var l,i,c,f,u=0!=(4&o),p=0!=(2&o),h=ve(e,n,o);for(i=0;i<t;i++,r+=s){for(c=!0,f=d(r+a,n),l=0;c&&l<n;l++)f[l]!=h[l]&&(c=!1);if(c)return u?i:r;if(p){for(c=!0,f=d(r+a,n),l=0;c&&l<n;l++)0!=f[l]&&(c=!1);if(c)break}}return u?4294967295:0},e.binary_search=we,e.linked_search=function(e,n,r,s,t,a){for(var o,l,i=0!=(2&a),f=ve(e,n,a);0!=r;){for(l=!0,o=0;l&&o<n;o++)c(r+s+o)!=f[o]&&(l=!1);if(l)return r;if(i){for(l=!0,o=0;l&&o<n;o++)0!=c(r+s+o)&&(l=!1);if(l)break}r=u(r+t)}return 0},e.decode_float=ke,e.encode_float=be;var ye,xe,Me,Ge,ze,Se,Ce,je,Ne,Le,Fe,Ee,Ae,We,qe,Be=null,De=null,Ve=null,Te=null,Ie=null,Ue=null;e.frame=null,e.vm_started=!1,e.vm_stopped=!1,e.tempcallargs=null,e.tempglkargs=null,e.done_executing=null,e.random_func=null,e.pc=null,e.stringtable=null,e.endmem=null,e.protectstart=null,e.protectend=null,e.iosysmode=null,e.iosysrock=null,e.prevpc=null,e.resumefuncop=null,e.resumevalue=null;var Re=0,Qe=0,Oe=0,Ze=0,Pe=0,He=0,$e=0,Je=0;function Xe(){sn();var n=nn();ye=null,ye=Be.slice(0,je),e.endmem=ye.length,en(Ne,!1),rn(n),xe=[],e.frame=null,e.pc=0,e.prevpc=0,e.iosysmode=0,e.iosysrock=0,de(Fe),X(Le,0)}function Ye(e){for(var n=[],r=0;r<e.length;r++){var s=e[r].key,t=e[r].chunk;4!=s.length&&C("Bad chunk ID (must be exactly 4 chars): "+s),null==t&&C("Missing chunk data: "+s),_(n,s),g(n,t.length),1&(n=n.concat(t)).length&&n.push(0)}return n}function Ke(e){for(var n={},s=0;s<e.length;){if(s+8>e.length)return void r("IFF chunk header is truncated");var t=k(e,s,4),a=o(e,s+4);if((s+=8)+a>e.length)return void r(t+" chunk is truncated ("+a+" bytes needed, "+(e.length-s)+" available");n[t]=e.slice(s,s+a),1&(s+=a)&&(s+=1)}return n}function en(n,r){var s;if(n!=e.endmem){if(!r&&tn()&&C("Cannot resize Glulx memory space while heap is active."),n<Ne&&C("Cannot resize Glulx memory space smaller than it started."),255&n&&C("Can only resize Glulx memory space to a 256-byte boundary."),ye.length=n,n>e.endmem)for(s=e.endmem;s<n;s++)ye[s]=0;e.endmem=n}}function nn(){if(e.protectstart>=e.protectend)return null;for(var n=e.protectend-e.protectstart,r={start:e.protectstart,end:e.protectend,len:n},s=ye.slice(e.protectstart,e.protectend);s.length<n;)s.push(0);return r.mem=s,r}function rn(n){if(n){var r,s,t=n.mem,a=n.start,o=n.end;for(o>e.endmem&&(o=e.endmem),r=0,s=a;s<o;r++,s++)ye[s]=t[r]}}function sn(){Ae=0,We=[],qe=[]}function tn(){return We.length>0}function an(e,n){this.addr=e,this.size=n,this.end=e+n}function on(e,n){for(var r=0,s=e.length;r<s;){var t=r+s>>1;e[t].addr<n?r=t+1:s=t}return r}function ln(){if(!tn())return 0!=Ae&&C("Heap inconsistency: heapstart nonzero"),We.length>0&&C("Heap inconsistency: usedlist nonempty"),void(qe.length>0&&C("Heap inconsistency: usedlist nonempty"));0==Ae&&C("Heap inconsistency: heapstart is zero");for(var n=Ae,r=0,s=0;r<We.length||s<qe.length;){var t=We[r],a=qe[s];t&&t.addr==n?(n+=t.size,r++):a&&a.addr==n?(n+=a.size,s++):C("Heap inconsistency: no block at address "+n)}n!=e.endmem&&C("Heap inconsistency: overrun at end of heap")}e.vm_restart=Xe,e.vm_save=function(n){ye.length!=e.endmem&&C("Memory length was incorrect before save."),2!=e.iosysmode&&C("Streams are only available in Glk I/O system.");var r=e.GiDispa.class_obj_from_id("stream",n);if(!r)return!1;var s=[];s.push({key:"IFhd",chunk:Be.slice(0,128)});for(var t,a,o,l=ye.slice(Ce),i=Ce;i<Be.length;i++)l[i-Ce]^=Be[i];l=function(e){for(var n=[],r=0;r<e.length;){for(var s=0;r<e.length&&0==e[r]&&s<=255;)s++,r++;for(s>0&&(n.push(0),n.push(s-1));r<e.length&&0!=e[r];)n.push(e[r]),r++}return n}(l),l.splice(0,0,0,0,0,0),t=l,a=0,o=e.endmem,t[a]=o>>24&255,t[a+1]=o>>16&255,t[a+2]=o>>8&255,t[a+3]=255&o,s.push({key:"CMem",chunk:l});var c=[];for(s.push({key:"Stks",chunk:c}),i=0;i<xe.length;i++)F(xe[i],c);if(tn()){var f=[];s.push({key:"MAll",chunk:f}),g(f,Ae),g(f,We.length);for(i=0;i<We.length;i++)g(f,We[i].addr),g(f,We[i].size)}var u=[];_(u,"IFZS"),u=u.concat(Ye(s));var d=Ye([{key:"FORM",chunk:u}]);return e.Glk.glk_put_buffer_stream(r,d),!0},e.vm_restore=function(n){2!=e.iosysmode&&C("Streams are only available in Glk I/O system.");var s=e.GiDispa.class_obj_from_id("stream",n);if(!s)return!1;for(var t=new Array(0),a=new Array(1024),l=1;l>0;)l=e.Glk.glk_get_buffer_stream(s,a),t=t.concat(a.slice(0,l));if(!(t=Ke(t)))return r("vm_restore failed: file is not Quetzal"),!1;if(!(t=t.FORM)||"IFZS"!=k(t,0,4))return r("vm_restore failed: file doesn't start with FORM/IFZS header"),!1;var i=Ke(t.slice(4));if(!i.IFhd)return r("vm_restore failed: missing required IFhd chunk"),!1;for(var c=0;c<128;c++)if(i.IFhd[c]!=Be[c])return r("vm_restore failed: this save image is for a different game"),!1;if(!i.CMem)return r("vm_restore failed: missing required CMem chunk"),!1;if(!i.Stks)return r("vm_restore failed: missing required Stks chunk"),!1;var f=nn();sn();var u=o(i.CMem,0),d=i.CMem.slice(4);for(d=function(e){for(var n=[],r=0;r<e.length;){var s=e[r++];if(0==s)for(var t=e[r++]+1,a=0;a<t;a++)n.push(0);else n.push(s)}return n}(d);d.length<u-Ce;)d.push(0);for(en(u,!1),ye=Be.slice(0,Ce).concat(d),c=Ce;c<Be.length;c++)ye[c]^=Be[c];ye.length!=e.endmem&&C("Memory length was incorrect after restore.");var p=i.Stks;for(xe=[];p.length;)e.frame=E(p),e.frame||C("vm_restore failed: bad stack frame"),xe.unshift(e.frame);for(c=0;c<xe.length;c++)xe[c].depth=c;e.frame=xe[xe.length-1];var h=i.MAll;if(h&&h.length>=8){Ae=o(h,0);var m=o(h,4);for(c=0;c<m;c++){var _=o(h,8+8*c),g=o(h,12+8*c);We.push(new an(_,g))}We.sort((function(e,n){return e.addr-n.addr}));var v=Ae;for(c=0;c<We.length;c++){_=We[c].addr,g=We[c].size;(_<v||_+g>e.endmem)&&C("vm_restore failed: corrupt dynamic heap"),_>v&&qe.push(new an(v,_-v)),v=_+g}v<e.endmem&&qe.push(new an(v,e.endmem-v))}return ln(),rn(f),!0},e.vm_saveundo=function(){ye.length!=e.endmem&&C("Memory length was incorrect before saveundo.");var n,r,s={};s.ram=ye.slice(Ce),s.endmem=e.endmem,s.pc=e.pc,s.stack=[];for(var t=0;t<xe.length;t++)s.stack[t]=(n=xe[t],r=void 0,(r=new L(n.vmfunc)).depth=n.depth,r.framestart=n.framestart,r.framelen=n.framelen,r.valstack=n.valstack.slice(0),r.localspos=n.localspos,r.locals=n.locals.slice(0),r.framelen=n.framelen,r);s.heapstart=Ae,s.usedlist=We.slice(0),s.freelist=qe.slice(0),Ee.push(s),Ee.length>10&&Ee.shift()},e.vm_restoreundo=function(){if(0==Ee.length)return!1;var n=Ee.pop(),r=nn();return ye=ye.slice(0,Ce).concat(n.ram),e.endmem=n.endmem,xe=n.stack,e.frame=xe[xe.length-1],e.pc=n.pc,Ae=n.heapstart,We=n.usedlist,qe=n.freelist,rn(r),ye.length!=e.endmem&&C("Memory length was incorrect after undo."),ln(),!0},e.change_memsize=en,e.perform_verify=function(){var e,n,r,s=Be.length;if(s<256||0!=(255&s))return 1;if(s!=o(Be,12))return 1;for(n=-(r=o(Be,32))>>>0,e=0;e<s;e+=4)n=n+o(Be,e)>>>0;return n!=r?1:0},e.heap_malloc=function(n){tn()||(Ae=e.endmem);for(var r=0,s=qe.length;r<s;r++){var t=qe[r];if(t.size>=n){t.size>n?qe[r]=new an(t.addr+n,t.size-n):qe.splice(r,1);var a=on(We,t.addr);return We.splice(a,0,new an(t.addr,n)),t.addr}}var o=e.endmem,l=n+255&4294967040;return en(e.endmem+l,!0),l>n&&qe.push(new an(o+n,l-n)),We.push(new an(o,n)),o},e.heap_free=function(e){var n=on(We,e),r=We[n];if(r&&r.addr==e||C("Tried to free non-existent block"),We.splice(n,1),0==We.length)return en(Ae,!0),void sn();n=on(qe,e);var s=qe[n];s&&s.addr==r.end&&(r=new an(e,r.size+s.size),qe.splice(n,1));var t=qe[n-1];t&&t.end==r.addr&&(r=new an(t.addr,t.size+r.size),qe.splice(n-1,1),n-=1),qe.splice(n,0,r)},e.assert_heap_valid=ln;var cn={map:{},functions:[],functionmap:{}};function fn(){var n,s,t,a,o;for(e.resumefuncop&&(!function(n,r){if(n)switch(n.mode){case 8:return void e.frame.valstack.push(r);case 0:return;case 11:return void(4==n.argsize?e.frame.locals[n.addr]=r:2==n.argsize?e.frame.locals[n.addr]=65535&r:e.frame.locals[n.addr]=255&r);case 15:return void(4==n.argsize?m(n.addr,r):2==n.argsize?h(n.addr,r):p(n.addr,r));default:C("Unknown addressing mode in store func by operand.")}}(e.resumefuncop,e.resumevalue),e.resumefuncop=null,e.resumevalue=0),a=(new Date).getTime();!e.done_executing;){void 0===(t=(s=(n=e.frame.vmfunc)[e.iosysmode])[e.pc])&&(n.pathaddrs[e.pc]=!0,t=J(n,e.pc,e.iosysmode),He++,e.pc<Ce&&(s[e.pc]=t,Pe++)),Ze++,t(e)===e.VMStopped&&(e.done_executing=!0,e.vm_stopped=!0)}o=(new Date).getTime(),Re+=(o-a)/1e3,e.vm_stopped&&e.Glk.glk_exit(),e.Glk.update(),Ve&&r("event executed in "+(o-a)+" ms")}return e.VMStopped={dummy:"The top-level function has returned."},{classname:"Quixe",version:"2.2.0",init:function(n,s){e.GiDispa=s.GiDispa,e.GiLoad=s.GiLoad,e.Glk=s.io;var t,a,o=(Be=n).slice(0,64);for(t=0;t<o.length;t++)(a=o[t].toString(16)).length<2&&(a="0"+a),o[t]=a;De=o.join(""),s&&(Ve=s.log_execution_time,Te=s.rethrow_exceptions,Ie=s.do_vm_autosave,Ue=s.clear_vm_autosave),s&&s.debug_info_chunk&&function(){if(!e.GiLoad)return;var n,s,t,a=e.GiLoad.get_debug_info();if(!a)return;if(222!=a[0]||191!=a[1]||0!=a[2]||0!=a[3])return void r("Dbug chunk did not contain an (old-style) Inform gameinfo.dbg file");a[4],a[5],s=6,n=!1;for(;!n;){var o=a[s++];switch(o){case 0:case void 0:n=!0;break;case 1:for(a[s++],t=s;a[s];)s++;for(String.fromCharCode.apply(this,a.slice(t,s)),t=++s;a[s];)s++;String.fromCharCode.apply(this,a.slice(t,s)),s++;break;case 2:for(t=s;a[s];)s++;String.fromCharCode.apply(this,a.slice(t,s)),s++,a.slice(s,s+4),s+=4,a.slice(s,s+4),s+=4;break;case 3:for(a[s++],a[s++],t=s;a[s];)s++;String.fromCharCode.apply(this,a.slice(t,s)),s++,a.slice(s,s+4),s+=4,a.slice(s,s+4),s+=4;break;case 4:for(a[s++],t=s;a[s];)s++;var l=String.fromCharCode.apply(this,a.slice(t,s));s++;break;case 5:for(a[s++],a[s++],t=s;a[s];)s++;l=String.fromCharCode.apply(this,a.slice(t,s));s++;break;case 6:for(a[s++],a[s++],t=s;a[s];)s++;l=String.fromCharCode.apply(this,a.slice(t,s));s++;break;case 7:for(a[s++],a[s++],t=s;a[s];)s++;l=String.fromCharCode.apply(this,a.slice(t,s));s++;break;case 8:for(a[s++],a[s++],t=s;a[s];)s++;l=String.fromCharCode.apply(this,a.slice(t,s));s++;break;case 9:s+=64;break;case 10:var i=a[s++]<<8|a[s++],c=a[s++]<<8|a[s++];s+=6*c;break;case 11:i=a[s++]<<8|a[s++];a.slice(s,s+4),s+=4;var f=a[s++]<<16|a[s++]<<8|a[s++];for(t=s;a[s];)s++;var u=String.fromCharCode.apply(this,a.slice(t,s));s++;for(var d=[];a[s];){for(t=s;a[s];)s++;var p=String.fromCharCode.apply(this,a.slice(t,s));s++,d.push(p)}s++,cn.functions.push({num:i,name:u,addr:f,locals:d});break;case 12:for(a[s++],a[s++],t=s;a[s];)s++;l=String.fromCharCode.apply(this,a.slice(t,s));s++;break;case 13:for(;a[s];){for(t=s;a[s];)s++;l=String.fromCharCode.apply(this,a.slice(t,s));s++;var h=a[s++]<<16|a[s++]<<8|a[s++];cn.map[l]=h}s++;break;case 14:i=a[s++]<<8|a[s++];a.slice(s,s+4),s+=4,a[s++],a[s++],a[s++];break;default:r("Unknown record type in debug data: "+o),n=!0}}var m,_=cn.map["code area"];if(_)for(m=0;m<cn.functions.length;m++){var g=cn.functions[m];cn.functionmap[_+g.addr]=g}}()},inited:function(){return null!=Be},getlibrary:function(n){switch(n){case"GiDispa":return e.GiDispa;case"GiLoad":return e.GiLoad;case"Glk":return e.Glk;case"GlkOte":return e.Glk.getlibrary("GlkOte");case"Dialog":return e.Glk.getlibrary("Dialog")}return null},start:function(){if(e.vm_started)e.Glk.fatal_error("Quixe was inited twice!");else try{!function(){var e,n;for(e=0;e<256;e++)n=e.toString(16),e<16&&(n="0"+n),t[e]=n;for(e=0;e<256;e++)n=e>=32&&e<127?34==e||39==e||92==e?"\\"+String.fromCharCode(e):String.fromCharCode(e):10==e?"\\n":"\\x"+t[e],a[e]=n}(),function(){function e(e,n){this.argsize=n||4,this.numops=e.length;for(var r=[],s=0;s<e.length;s++)r.push(e.charAt(s));this.formlist=r}var n=new e(""),r=new e("L"),s=new e("LL"),t=new e("LLL"),a=new e("LLLL"),o=new e("LS"),l=new e("LLS"),i=new e("LLLLLLS"),c=new e("LLLLLLLS"),f=new e("LLSS"),u=new e("LC"),d=new e("LLC"),p=new e("LLLC"),h=new e("LLLLC"),m=new e("ES"),_=new e("LES"),g=new e("EES"),v=new e("F"),w=new e("LF"),k=new e("LLF"),b=new e("EF"),y=new e("EF",1),x=new e("EF",2),M=new e("S"),G=new e("SS"),z=new e("CL"),S=new e("C");W={0:n,16:g,17:_,18:l,19:l,20:l,21:m,24:g,25:g,26:g,27:m,28:l,29:l,30:l,32:r,34:s,35:s,36:t,37:t,38:t,39:t,40:t,41:t,42:t,43:t,44:t,45:t,48:d,49:r,50:z,51:s,52:s,64:b,65:x,66:y,68:o,69:o,72:l,73:l,74:l,75:l,76:t,77:t,78:t,79:t,80:v,81:w,82:n,83:s,84:r,112:r,113:r,114:r,115:r,256:l,257:r,258:M,259:o,260:r,272:o,273:r,288:n,289:M,290:n,291:u,292:w,293:S,294:v,295:s,304:k,320:M,321:r,328:G,329:s,336:c,337:c,338:i,352:u,353:d,354:p,355:h,368:s,369:t,376:o,377:r,384:s,385:s,400:o,401:o,402:o,408:o,409:o,416:l,417:l,418:l,419:l,420:f,424:o,425:o,426:o,427:l,432:o,433:o,434:o,435:o,436:o,437:o,438:l,448:a,449:a,450:t,451:t,452:t,453:t,456:s,457:s}}(),function(){var s;Be||C("There is no Glulx game file loaded.");var t=e.Glk.getlibrary("Dialog");e.vm_started=!0,e.resumefuncop=null,e.resumevalue=0,ye=null,xe=[],e.frame=null,e.pc=0,e.prevpc=0,Be.length<36&&C("This is too short to be a valid Glulx file.");1198290284!=o(Be,0)&&C("This is not a valid Glulx file.");(s=o(Be,4))<131072&&C("This Glulx file is too old a version to execute.");s>=197120&&C("This Glulx file is too new a version to execute.");Ce=o(Be,8),je=o(Be,12),Ne=o(Be,16),o(Be,20),Le=o(Be,24),Fe=o(Be,28),o(Be,32),e.protectstart=0,e.protectend=0,(Ce<256||je<Ce||Ne<je)&&C("The segment boundaries in the header are in an impossible order.");je!=Be.length&&C("The game file length does not agree with the header.");e.done_executing=!1,Me={},Ge={},ze=void 0,Se=void 0,e.tempcallargs=Array(8),e.tempglkargs=Array(8),K(0),e.endmem=Ne,e.stringtable=0,Ee=[],Ae=0,We=[],qe=[],Ue&&t.autosave_write(De,null);if(Ie&&!Ue)try{var a=t.autosave_read(De);if(a)return r("Found autosave..."),void function(n){ye=(ye=Be.slice(0,je)).slice(0,Ce).concat(n.ram),e.endmem=n.endmem,e.pc=n.pc,xe=[];var r=n.stack.slice(0);for(;r.length;){var s=E(r);s||C("vm_autorestore failed: bad stack frame"),xe.unshift(s)}for(var t=0;t<xe.length;t++)xe[t].depth=t;if(e.frame=xe[xe.length-1],void 0===n.heapstart)Ae=0,We=[],qe=[];else{Ae=n.heapstart,We=[];for(var a=0;a<n.usedlist.length;a+=2){var o=n.usedlist[a],l=n.usedlist[a+1];We.push(new an(o,l))}We.sort((function(e,n){return e.addr-n.addr})),qe=[];var i=Ae;for(t=0;t<We.length;t++){o=We[t].addr,l=We[t].size;(o<i||o+l>e.endmem)&&C("vm_autorestore failed: corrupt dynamic heap"),o>i&&qe.push(new an(i,o-i)),i=o+l}i<e.endmem&&qe.push(new an(i,e.endmem-i))}ln(),de(n.stringtable),pe(n.iosysmode,n.iosysrock),e.protectstart=n.protectstart,e.protectend=n.protectend,void 0===n.srand_table?K(0):(K(1),re=n.srand_table.slice(0),ee=n.srand_index1,ne=n.srand_index2);for(var a in oe=n.accel_params.slice(0),n.accel_funcnum_map)ae[a]=n.accel_funcnum_map[a],te[a]=e.accel_func_map[ae[a]];e.Glk.restore_allstate(n.glk),Y(0)}(a)}catch(e){r("Autorestore failed, deleting it: "+n(e)),e.stack&&r("JS stack dump C:\n"+e.stack),t.autosave_write(De,null)}Xe()}(),fn()}catch(t){throw t.stack&&r("JS stack dump A:\n"+t.stack),s(),e.Glk.fatal_error("Quixe init: "+n(t)),t}},resume:function(t){try{e.done_executing=e.vm_stopped,fn()}catch(t){if(t.stack&&r("JS stack dump B:\n"+t.stack),s(),e.Glk.fatal_error("Quixe run: "+n(t)),Te)throw t}},get_signature:function(){return De},get_vm_internals:function(){return e},get_statistics:function(){return{game_image_length:Be.length,total_execution_time:Re,total_function_calls:Qe,accel_function_calls:Oe,total_path_calls:Ze,paths_cached:Pe,paths_compiled:He,strings_cached:$e,strings_compiled:Je}},get_debuginfo:function(){return cn},ReadByte:function(n){return 4294967295==n?255&e.frame.valstack.pop():c(n)},WriteByte:function(n,r){4294967295==n?e.frame.valstack.push(255&r):p(n,r)},ReadWord:function(n){return 4294967295==n?e.frame.valstack.pop():u(n)},WriteWord:function(n,r){4294967295==n?e.frame.valstack.push(r):m(n,r)},ReadStructField:function(n,r){return 4294967295==n?e.frame.valstack.pop():u(n+4*r)},WriteStructField:function(n,r,s){4294967295==n?e.frame.valstack.push(s):m(n+4*r,s)},SetResumeStore:function(n){e.resumevalue=n},do_autosave:function(n){var s=e.Glk.getlibrary("Dialog");if(n<0)s.autosave_write(De,null);else{var t,a,o=(t=e.prevpc,a=c(t),t++,128&a&&(64&a?(a=(a=(a=(a&=63)<<8|c(t))<<8|c(++t))<<8|c(++t),t++):(a=(a&=127)<<8|c(t),t++)),304!=a?(r("parse_partial_operand: parsed wrong opcode: "+a),null):{selop:15&c(t),argsop:c(t)>>4&15,resop:15&c(t+1)});if(o){var l={},i=e.frame.valstack,f=i.length;i.push(n),8==o.argsop&&i.push(1),8==o.selop&&i.push(192),i.push(0,0,e.prevpc,e.frame.framestart),l.ram=ye.slice(Ce),l.endmem=e.endmem,l.pc=e.pc,l.stack=[];for(var u=0;u<xe.length;u++)F(xe[u],l.stack);if(tn()){l.heapstart=Ae,l.usedlist=[];for(u=0;u<We.length;u++)l.usedlist.push(We[u].addr),l.usedlist.push(We[u].size)}for(var d in i.length=f,l.stringtable=e.stringtable,l.iosysmode=e.iosysmode,l.iosysrock=e.iosysrock,l.protectstart=e.protectstart,l.protectend=e.protectend,e.random_func==se&&re&&(l.srand_table=re.slice(0),l.srand_index1=ee,l.srand_index2=ne),l.accel_params=oe.slice(0),l.accel_funcnum_map={},ae)l.accel_funcnum_map[d]=ae[d];l.glk=e.Glk.save_allstate(),s.autosave_write(De,l)}}}}},r=new n;try{e.Quixe=r,e.QuixeClass=n}catch(e){}var s={};try{s.GiDispaClass=function(){var e={VM:null,Glk:null},n={0:"window",1:"stream",2:"fileref",3:"schannel"};function r(e,n,r){this.id=e,this.name=n,this.proto=r}function s(e,n){this.args=e,this.retarg=n}function t(){this.macro="Byte",this.refsize=1,this.serialize=function(){return{type:"ArgString"}}}function a(){this.macro="Word",this.refsize=4,this.serialize=function(){return{type:"ArgUnicode"}}}function o(e){this.signed=e,this.macro="Byte",this.refsize=1,this.literal=e?"arg_char_signed":"arg_char_unsigned",this.serialize=function(){return{type:"ArgChar",signed:e}}}function l(e){this.signed=e,this.macro="Word",this.refsize=4,this.literal=e?"arg_int_signed":"arg_int_unsigned",this.serialize=function(){return{type:"ArgInt",signed:e}}}function i(e){this.name=e,this.macro="Word",this.refsize=4}function c(e){this.form=e}function f(e,n,r,s){this.arg=e,this.passin=n,this.passout=r,this.nonnull=s}function u(e,n,r,s,t){this.arg=e,this.retained=n,this.passin=r,this.passout=s,this.nonnull=t}function d(e){switch(e.type){case"ArgString":return new t;case"ArgUnicode":return new a;case"ArgInt":return e.signed?h:p;case"ArgChar":return null===e.signed?_:e.signed?g:m}throw new Error("arg_deserialize: unknown type: "+e.type)}var p=new l(!1),h=new l(!0),m=new o(!1),_=new o(null),g=new o(!0),v=new i("window"),w=new i("stream"),k=new i("fileref"),b=new i("schannel"),y={1:new r(1,"exit",new s([],null)),3:new r(3,"tick",new s([],null)),4:new r(4,"gestalt",new s([p,p],new f(p,!1,!0,!0))),5:new r(5,"gestalt_ext",new s([p,p,new u(p,!1,!0,!0,!1)],new f(p,!1,!0,!0))),32:new r(32,"window_iterate",new s([v,new f(p,!1,!0,!1)],new f(v,!1,!0,!0))),33:new r(33,"window_get_rock",new s([v],new f(p,!1,!0,!0))),34:new r(34,"window_get_root",new s([],new f(v,!1,!0,!0))),35:new r(35,"window_open",new s([v,p,p,p,p],new f(v,!1,!0,!0))),36:new r(36,"window_close",new s([v,new f(new c(new s([p,p],null)),!1,!0,!1)],null)),37:new r(37,"window_get_size",new s([v,new f(p,!1,!0,!1),new f(p,!1,!0,!1)],null)),38:new r(38,"window_set_arrangement",new s([v,p,p,v],null)),39:new r(39,"window_get_arrangement",new s([v,new f(p,!1,!0,!1),new f(p,!1,!0,!1),new f(v,!1,!0,!1)],null)),40:new r(40,"window_get_type",new s([v],new f(p,!1,!0,!0))),41:new r(41,"window_get_parent",new s([v],new f(v,!1,!0,!0))),42:new r(42,"window_clear",new s([v],null)),43:new r(43,"window_move_cursor",new s([v,p,p],null)),44:new r(44,"window_get_stream",new s([v],new f(w,!1,!0,!0))),45:new r(45,"window_set_echo_stream",new s([v,w],null)),46:new r(46,"window_get_echo_stream",new s([v],new f(w,!1,!0,!0))),47:new r(47,"set_window",new s([v],null)),48:new r(48,"window_get_sibling",new s([v],new f(v,!1,!0,!0))),64:new r(64,"stream_iterate",new s([w,new f(p,!1,!0,!1)],new f(w,!1,!0,!0))),65:new r(65,"stream_get_rock",new s([w],new f(p,!1,!0,!0))),66:new r(66,"stream_open_file",new s([k,p,p],new f(w,!1,!0,!0))),67:new r(67,"stream_open_memory",new s([new u(_,!0,!0,!0,!1),p,p],new f(w,!1,!0,!0))),68:new r(68,"stream_close",new s([w,new f(new c(new s([p,p],null)),!1,!0,!1)],null)),69:new r(69,"stream_set_position",new s([w,h,p],null)),70:new r(70,"stream_get_position",new s([w],new f(p,!1,!0,!0))),71:new r(71,"stream_set_current",new s([w],null)),72:new r(72,"stream_get_current",new s([],new f(w,!1,!0,!0))),73:new r(73,"stream_open_resource",new s([p,p],new f(w,!1,!0,!0))),96:new r(96,"fileref_create_temp",new s([p,p],new f(k,!1,!0,!0))),97:new r(97,"fileref_create_by_name",new s([p,new t,p],new f(k,!1,!0,!0))),98:new r(98,"fileref_create_by_prompt",new s([p,p,p],new f(k,!1,!0,!0))),99:new r(99,"fileref_destroy",new s([k],null)),100:new r(100,"fileref_iterate",new s([k,new f(p,!1,!0,!1)],new f(k,!1,!0,!0))),101:new r(101,"fileref_get_rock",new s([k],new f(p,!1,!0,!0))),102:new r(102,"fileref_delete_file",new s([k],null)),103:new r(103,"fileref_does_file_exist",new s([k],new f(p,!1,!0,!0))),104:new r(104,"fileref_create_from_fileref",new s([p,k,p],new f(k,!1,!0,!0))),128:new r(128,"put_char",new s([m],null)),129:new r(129,"put_char_stream",new s([w,m],null)),130:new r(130,"put_string",new s([new t],null)),131:new r(131,"put_string_stream",new s([w,new t],null)),132:new r(132,"put_buffer",new s([new u(_,!1,!0,!1,!0)],null)),133:new r(133,"put_buffer_stream",new s([w,new u(_,!1,!0,!1,!0)],null)),134:new r(134,"set_style",new s([p],null)),135:new r(135,"set_style_stream",new s([w,p],null)),144:new r(144,"get_char_stream",new s([w],new f(h,!1,!0,!0))),145:new r(145,"get_line_stream",new s([w,new u(_,!1,!1,!0,!0)],new f(p,!1,!0,!0))),146:new r(146,"get_buffer_stream",new s([w,new u(_,!1,!1,!0,!0)],new f(p,!1,!0,!0))),160:new r(160,"char_to_lower",new s([m],new f(m,!1,!0,!0))),161:new r(161,"char_to_upper",new s([m],new f(m,!1,!0,!0))),176:new r(176,"stylehint_set",new s([p,p,p,h],null)),177:new r(177,"stylehint_clear",new s([p,p,p],null)),178:new r(178,"style_distinguish",new s([v,p,p],new f(p,!1,!0,!0))),179:new r(179,"style_measure",new s([v,p,p,new f(p,!1,!0,!1)],new f(p,!1,!0,!0))),192:new r(192,"select",new s([new f(new c(new s([p,v,p,p],null)),!1,!0,!0)],null)),193:new r(193,"select_poll",new s([new f(new c(new s([p,v,p,p],null)),!1,!0,!0)],null)),208:new r(208,"request_line_event",new s([v,new u(_,!0,!0,!0,!0),p],null)),209:new r(209,"cancel_line_event",new s([v,new f(new c(new s([p,v,p,p],null)),!1,!0,!1)],null)),210:new r(210,"request_char_event",new s([v],null)),211:new r(211,"cancel_char_event",new s([v],null)),212:new r(212,"request_mouse_event",new s([v],null)),213:new r(213,"cancel_mouse_event",new s([v],null)),214:new r(214,"request_timer_events",new s([p],null)),224:new r(224,"image_get_info",new s([p,new f(p,!1,!0,!1),new f(p,!1,!0,!1)],new f(p,!1,!0,!0))),225:new r(225,"image_draw",new s([v,p,h,h],new f(p,!1,!0,!0))),226:new r(226,"image_draw_scaled",new s([v,p,h,h,p,p],new f(p,!1,!0,!0))),232:new r(232,"window_flow_break",new s([v],null)),233:new r(233,"window_erase_rect",new s([v,h,h,p,p],null)),234:new r(234,"window_fill_rect",new s([v,p,h,h,p,p],null)),235:new r(235,"window_set_background_color",new s([v,p],null)),240:new r(240,"schannel_iterate",new s([b,new f(p,!1,!0,!1)],new f(b,!1,!0,!0))),241:new r(241,"schannel_get_rock",new s([b],new f(p,!1,!0,!0))),242:new r(242,"schannel_create",new s([p],new f(b,!1,!0,!0))),243:new r(243,"schannel_destroy",new s([b],null)),244:new r(244,"schannel_create_ext",new s([p,p],new f(b,!1,!0,!0))),247:new r(247,"schannel_play_multi",new s([new u(b,!1,!0,!1,!0),new u(p,!1,!0,!1,!0),p],new f(p,!1,!0,!0))),248:new r(248,"schannel_play",new s([b,p],new f(p,!1,!0,!0))),249:new r(249,"schannel_play_ext",new s([b,p,p,p],new f(p,!1,!0,!0))),250:new r(250,"schannel_stop",new s([b],null)),251:new r(251,"schannel_set_volume",new s([b,p],null)),252:new r(252,"sound_load_hint",new s([p,p],null)),253:new r(253,"schannel_set_volume_ext",new s([b,p,p,p],null)),254:new r(254,"schannel_pause",new s([b],null)),255:new r(255,"schannel_unpause",new s([b],null)),256:new r(256,"set_hyperlink",new s([p],null)),257:new r(257,"set_hyperlink_stream",new s([w,p],null)),258:new r(258,"request_hyperlink_event",new s([v],null)),259:new r(259,"cancel_hyperlink_event",new s([v],null)),288:new r(288,"buffer_to_lower_case_uni",new s([new u(p,!1,!0,!0,!0),p],new f(p,!1,!0,!0))),289:new r(289,"buffer_to_upper_case_uni",new s([new u(p,!1,!0,!0,!0),p],new f(p,!1,!0,!0))),290:new r(290,"buffer_to_title_case_uni",new s([new u(p,!1,!0,!0,!0),p,p],new f(p,!1,!0,!0))),291:new r(291,"buffer_canon_decompose_uni",new s([new u(p,!1,!0,!0,!0),p],new f(p,!1,!0,!0))),292:new r(292,"buffer_canon_normalize_uni",new s([new u(p,!1,!0,!0,!0),p],new f(p,!1,!0,!0))),296:new r(296,"put_char_uni",new s([p],null)),297:new r(297,"put_string_uni",new s([new a],null)),298:new r(298,"put_buffer_uni",new s([new u(p,!1,!0,!1,!0)],null)),299:new r(299,"put_char_stream_uni",new s([w,p],null)),300:new r(300,"put_string_stream_uni",new s([w,new a],null)),301:new r(301,"put_buffer_stream_uni",new s([w,new u(p,!1,!0,!1,!0)],null)),304:new r(304,"get_char_stream_uni",new s([w],new f(h,!1,!0,!0))),305:new r(305,"get_buffer_stream_uni",new s([w,new u(p,!1,!1,!0,!0)],new f(p,!1,!0,!0))),306:new r(306,"get_line_stream_uni",new s([w,new u(p,!1,!1,!0,!0)],new f(p,!1,!0,!0))),312:new r(312,"stream_open_file_uni",new s([k,p,p],new f(w,!1,!0,!0))),313:new r(313,"stream_open_memory_uni",new s([new u(p,!0,!0,!0,!1),p,p],new f(w,!1,!0,!0))),314:new r(314,"stream_open_resource_uni",new s([p,p],new f(w,!1,!0,!0))),320:new r(320,"request_char_event_uni",new s([v],null)),321:new r(321,"request_line_event_uni",new s([v,new u(p,!0,!0,!0,!0),p],null)),336:new r(336,"set_echo_line_event",new s([v,p],null)),337:new r(337,"set_terminators_line_event",new s([v,new u(p,!1,!0,!1,!1)],null)),352:new r(352,"current_time",new s([new f(new c(new s([h,p,h],null)),!1,!0,!0)],null)),353:new r(353,"current_simple_time",new s([p],new f(h,!1,!0,!0))),360:new r(360,"time_to_date_utc",new s([new f(new c(new s([h,p,h],null)),!0,!1,!0),new f(new c(new s([h,h,h,h,h,h,h,h],null)),!1,!0,!0)],null)),361:new r(361,"time_to_date_local",new s([new f(new c(new s([h,p,h],null)),!0,!1,!0),new f(new c(new s([h,h,h,h,h,h,h,h],null)),!1,!0,!0)],null)),362:new r(362,"simple_time_to_date_utc",new s([h,p,new f(new c(new s([h,h,h,h,h,h,h,h],null)),!1,!0,!0)],null)),363:new r(363,"simple_time_to_date_local",new s([h,p,new f(new c(new s([h,h,h,h,h,h,h,h],null)),!1,!0,!0)],null)),364:new r(364,"date_to_time_utc",new s([new f(new c(new s([h,h,h,h,h,h,h,h],null)),!0,!1,!0),new f(new c(new s([h,p,h],null)),!1,!0,!0)],null)),365:new r(365,"date_to_time_local",new s([new f(new c(new s([h,h,h,h,h,h,h,h],null)),!0,!1,!0),new f(new c(new s([h,p,h],null)),!1,!0,!0)],null)),366:new r(366,"date_to_simple_time_utc",new s([new f(new c(new s([h,h,h,h,h,h,h,h],null)),!0,!1,!0),p],new f(h,!1,!0,!0))),367:new r(367,"date_to_simple_time_local",new s([new f(new c(new s([h,h,h,h,h,h,h,h],null)),!0,!1,!0),p],new f(h,!1,!0,!0))),4352:new r(4352,"garglk_set_zcolors",new s([p,p],null)),4353:new r(4353,"garglk_set_zcolors_stream",new s([w,p,p],null)),4354:new r(4354,"garglk_set_reversevideo",new s([p],null)),4355:new r(4355,"garglk_set_reversevideo_stream",new s([w,p],null))};function x(e,n,r){return e instanceof l?n?e.signed?r+" & 0xFFFFFFFF":r:"0":e instanceof o?n?e.signed?"self.cast_signed_char("+r+")":r+" & 0xFF":"0":e instanceof i?n?'self.class_obj_from_id("'+e.name+'", '+r+")":"null":"???"}function M(e,n){return e instanceof l?n+" >>> 0":e instanceof o?e.signed?"self.uncast_signed_char("+n+")":n+" & 0xFF":e instanceof i?'self.class_obj_to_id("'+e.name+'", '+n+")":"???"}function G(e){return 128&(e&=255)&&(e+=4294967040),e}function z(e,n){return n?n.disprock:0}function S(e,n){return 0!=n&&n?W[e][n]:null}e.arg_int_unsigned=p,e.arg_int_signed=h,e.arg_char_unsigned=m,e.arg_char_native=_,e.arg_char_signed=g,e.cast_signed_char=function(e){return 128&(e&=255)&&(e-=256),e},e.uncast_signed_char=G,e.class_obj_to_id=z,e.class_obj_from_id=S;var C={},j=null,N=null,L=-1;e.set_blocked_selector=function(e,n){j=e,N=n.slice(0)};var F=[];e.temp_arg_arrays=F;var E=[];e.retained_arrays=E,e.make_arg_array=function(e,n,r,s){var t;e&&(t={arr:e,addr:n,len:r,arg:s},F.push(t))};var A,W={};return function(){var e;for(e in A=1+Math.round(1e3*Math.random()),n)W[n[e]]={}}(),{classname:"GiDispa",init:function(n){e.VM=n.vm,e.Glk=n.io},inited:function(){return null!=e.VM},getlibrary:function(n){switch(n){case"VM":return e.VM;case"Glk":return e.Glk}return null},get_function:function(n){var r,s=C[n];if(void 0===s){if(void 0===(r=y[n]))throw new Error("dispatch: unknown Glk function: "+n);s=function(n){var r,s,d,p,h,m,_,g,v,w,k,b,y,G,z=[],S={},C=0;for(z.push("// no local vars"),z.push("// "+n.id+": "+n.name),p=null,(d=n.proto).retarg&&(p=d.retarg.arg),z.push("var self = this;"),G=e.Glk.call_may_not_return(n.id),h=0,m=[],r=0;r<d.args.length;r++)if(g=d.args[r],w="glka"+r,m.push(w),S[w]=!0,g instanceof l||g instanceof o||g instanceof i)k=x(g,!0,"callargs["+h+"]"),z.push(w+" = "+k+";"),h+=1;else if(g instanceof f){if(v=g.arg,z.push("if (callargs["+h+"] == 0) {"),g.nonnull?z.push('  throw new Error("glk '+n.name+': null argument");'):z.push("  "+w+" = null;"),z.push("} else {"),v instanceof l||v instanceof o||v instanceof i)z.push("  "+w+" = new self.Glk.RefBox();"),k=x(v,g.passin,"self.VM.ReadWord(callargs["+h+"])"),z.push("  "+w+".set_value("+k+");");else{if(!(v instanceof c))throw new Error("buildfunc: unsupported refarg type: "+n.name);for(_=v.form.args,z.push("  "+w+" = new self.Glk.RefStruct("+_.length+");"),s=0;s<_.length;s++)k=x(_[s],g.passin,"self.VM.ReadStructField(callargs["+h+"], "+s+")"),z.push("  "+w+".push_field("+k+");")}z.push("}"),h+=1}else if(g instanceof u)S.glklen=!0,v=g.arg,z.push("if (callargs["+h+"] == 0) {"),g.nonnull?z.push('  throw new Error("glk '+n.name+': null argument");'):z.push("  "+w+" = null;"),z.push("} else {"),z.push("  glklen = callargs["+(h+1)+"];"),z.push("  "+w+" = Array(glklen);"),g.passin&&(S.ix=!0,S.jx=!0,z.push("  for (ix=0, jx=callargs["+h+"]; ix<glklen; ix++, jx+="+v.refsize+") {"),k=x(v,!0,"self.VM.Read"+v.macro+"(jx)"),z.push("    "+w+"[ix] = "+k+";"),z.push("  }")),g.retained&&(0==C&&z.push("  self.temp_arg_arrays.length = 0;"),C+=1,z.push("  self.make_arg_array("+w+", callargs["+h+"], glklen, self."+v.literal+");")),z.push("}"),h+=2;else{if(!(g instanceof t||g instanceof a))throw new Error("buildfunc: unsupported arg type: "+n.name);var j,N;S.ix=!0,S.jx=!0,g instanceof t?(N="0xE0",j="byte_array_to_string"):(N="0xE2",j="uni_array_to_string"),z.push(w+" = Array();"),z.push("jx = callargs["+h+"];"),z.push("if (self.VM.ReadByte(jx) != "+N+') throw new Error("glk '+n.name+': string argument must be unencoded");'),z.push("for (jx+="+g.refsize+"; true; jx+="+g.refsize+") {"),z.push("  ix = self.VM.Read"+g.macro+"(jx);"),z.push("  if (ix == 0) break;"),z.push("  "+w+".push(ix);"),z.push("}"),z.push(w+" = self.Glk."+j+"("+w+");"),h+=1}for(z.push("if (callargs.length != "+h+') throw "glk '+n.name+': wrong number of arguments";'),p||G?(S.glkret=!0,b="glkret = "):b="",z.push(b+("self.Glk.glk_"+n.name).replace("glk_gar","gar")+"("+m.join(", ")+");"),G&&(z.push("if (glkret === self.Glk.DidNotReturn) {"),z.push("  self.set_blocked_selector("+n.id+", callargs);"),z.push("  return glkret;"),z.push("}")),h=0,r=0;r<d.args.length;r++)if(w="glka"+r,(g=d.args[r])instanceof l||g instanceof o||g instanceof i)h+=1;else if(g instanceof f){if(v=g.arg,g.passout){if(z.push("if ("+w+") {"),v instanceof l||v instanceof o||v instanceof i)k=M(v,w+".get_value()"),z.push("  self.VM.WriteWord(callargs["+h+"], "+k+");");else{if(!(v instanceof c))throw new Error("buildfunc: unsupported refarg type: "+n.name);for(_=v.form.args,s=0;s<_.length;s++)k=M(_[s],w+".get_field("+s+")"),z.push("  self.VM.WriteStructField(callargs["+h+"], "+s+", "+k+");")}z.push("}")}h+=1}else if(g instanceof u)v=g.arg,g.passout&&!g.retained&&(z.push("if ("+w+") {"),S.ix=!0,S.jx=!0,z.push("  for (ix=0, jx=callargs["+h+"]; ix<glklen; ix++, jx+="+v.refsize+") {"),k=M(v,w+"[ix]"),z.push("    self.VM.Write"+v.macro+"(jx, "+k+")"),z.push("  }"),z.push("}")),h+=2;else{if(!(g instanceof t||g instanceof a))throw new Error("buildfunc: unsupported arg type: "+n.name);h+=1}for(k in 0!=C&&z.push("self.temp_arg_arrays.length = 0;"),p?(k=M(p,"glkret"),z.push("return "+k+";")):z.push("return 0;"),y=[],S)y.push(k);return y.length&&(z[0]="var "+y.join(", ")+";"),k=z.join("\n"),new Function("callargs",k).bind(e)}(r),C[n]=s}return s},prepare_resume:function(n){192==j?0!=N[0]&&(L=n.get_field(0)>>>0,e.VM.WriteStructField(N[0],0,n.get_field(0)>>>0),e.VM.WriteStructField(N[0],1,z(0,n.get_field(1))),e.VM.WriteStructField(N[0],2,n.get_field(2)>>>0),e.VM.WriteStructField(N[0],3,n.get_field(3)>>>0)):98==j&&e.VM.SetResumeStore(z(0,n)),j=null,N=null},check_autosave:function(){return 192==j&&N&&N.length>0&&(2==L||3==L||4==L||8==L)?N[0]:null},class_register:function(e,n,r){if(void 0===r){if(n.disprock)throw new Error("class_register: object is already registered");n.disprock=A,A++}else{if(n.disprock!=r)throw new Error("class_register: object is not already registered");A<=r&&(A=r+1)}W[e][n.disprock]=n},class_unregister:function(e,n){if(!n.disprock||void 0===W[e][n.disprock])throw new Error("class_unregister: object is not registered");delete W[e][n.disprock],n.disprock=void 0},class_obj_to_id:z,class_obj_from_id:S,retain_array:function(e,n){var r,s;if(e){if(void 0!==n){if(e!==n.arr)throw new Error("retain_array: array does not match useobj");if((s={addr:n.addr,len:n.len,arr:e,arg:d(n.arg)}).len!=e.length)throw new Error("retain_array: array length from useobj does not match")}else for(s=void 0,r=0;r<F.length;r++)if(F[r].arr===e){s=F[r];break}if(void 0===s)throw new Error("retain_array: array is not an argument");for(r=0;void 0!==E[r];r++);E[r]=s}},unretain_array:function(n){var r,s,t;if(n){for(t=void 0,r=0;r<E.length;r++)if(void 0!==E[r]&&E[r].arr===n){t=E[r],delete E[r];break}if(void 0===t)throw new Error("unretain_array: array was never retained");if(t.arg instanceof l)for(r=0,s=t.addr;r<t.len;r++,s+=4)e.VM.WriteWord(s,t.arr[r]>>>0);else{if(!(t.arg instanceof o))throw new Error("unretain_array: unsupported refarg type");if(t.arg.signed)for(r=0,s=t.addr;r<t.len;r++,s++)e.VM.WriteByte(s,G(t.arr[r]));else for(r=0,s=t.addr;r<t.len;r++,s++)e.VM.WriteByte(s,255&t.arr[r])}}},get_retained_array:function(e){var n;for(n=0;n<E.length;n++)if(void 0!==E[n]&&E[n].arr===e)return E[n];return null}}}}catch(e){}var t={},a=function(){var e={vm:null,io:null,spacing:4,use_query_story:!0,default_story:null,set_page_title:!0,default_page_title:"Game",game_format_name:"",exit_warning:"The game session has ended.",resources:null,image_info_map:null,proxy_url:"https://zcode.appspot.com/proxy/"},n=null,r=!1,s=null;function t(e){var n,r=Array(e.length);for(n=0;n<e.length;n++)r[n]=255&e.charCodeAt(n);return r}function a(e){var n,r=atob(e),s=Array(r.length);for(n=0;n<r.length;n++)s[n]=r.charCodeAt(n);return s}function o(s){if(0==s.length)return void e.io.fatal_error("No game file was loaded. (Zero-length response.)");if(70==s[0]&&79==s[1]&&82==s[2]&&77==s[3]){var t=String.fromCharCode(s[8],s[9],s[10],s[11]);if("IFZS"==t)return void e.io.fatal_error("This is a saved-game file, not a "+e.game_format_name+" game file. You must launch the game first, then restore your save.");if("IFRS"!=t)return void e.io.fatal_error("This IFF file is not a Blorb file!");if(e.blorb_gamechunk_type){if(!e.Blorb)return void e.io.fatal_error("Blorb file could not be parsed because no BlorbClass is available.");try{var a={exec:!0,pict:!0,data:!0};void 0!==e.retainuses&&(a=e.retainuses),e.Blorb.init(s,{format:"blorbbytes",retainuses:a}),s=e.Blorb.get_exec_data(e.blorb_gamechunk_type)}catch(n){return void e.io.fatal_error("Blorb file could not be parsed: "+n)}}if(!s)return void e.io.fatal_error("Blorb file contains no "+e.game_format_name+" game!")}e.Blorb&&!e.Blorb.inited()&&(e.image_info_map?e.Blorb.init(e.image_info_map,{format:"infomap"}):e.resources?e.Blorb.init(e.resource_array):e.Blorb.init([]));var o=null;e.Blorb&&(o=e.Blorb.get_metadata("title")),!o&&n&&(o=n.slice(n.lastIndexOf("/")+1)),o||(o=e.default_page_title),o||(o="Game"),e.recording_label||(e.recording_label=o),e.set_page_title&&(document.title=o+" - "+e.engine_name);const l=Array.from(s);e.vm.init(l,e),r=!0,e.io.init(e)}return{classname:"GiLoad",load_run:function(r,l,i){i?"string"==typeof i&&(i={format:i}):i={};var c=i.format;if(c||(c="array"),e.io=window.Glk,e.vm=window.Quixe,e.GiLoad=this,e.GlkOte=null,e.GiDispa=null,e.Blorb=null,r||(r=window.game_options),!r||!window.Quixe||r.vm&&r.vm!==window.Quixe||(e.engine_name="Quixe",e.blorb_gamechunk_type="GLUL",e.game_format_name="Glulx"),r&&jQuery.extend(e,r),!e.GlkOte&&window.GlkOteClass&&(e.GlkOte=new window.GlkOteClass),!e.GiDispa&&window.GiDispaClass&&(e.GiDispa=new window.GiDispaClass),!e.Blorb&&window.BlorbClass&&(e.Blorb=new window.BlorbClass),s=e.GlkOte,null!=e.resources&&"string"===jQuery.type(e.resources)&&(window[e.resources]?e.resources=window[e.resources]:delete e.resources),null!=e.image_info_map&&"string"===jQuery.type(e.image_info_map)&&(window[e.image_info_map]?e.image_info_map=window[e.image_info_map]:delete e.image_info_map),n=null,e.use_query_story){var f=function(){var e={},n=location.search.substring(1,location.search.length);if(n.length){var r=n.split("&");n=n.replace(/\+/g," ");for(var s=0;s<r.length;s++){var t=r[s].split("="),a=decodeURIComponent(t[0]),o=2==t.length?decodeURIComponent(t[1]):a;e[a]=o}}return e}();n=f.story}if(n||!l)if(n||(n=e.default_story),n){l=null;var u=new XMLHttpRequest,d=void 0!==u.overrideMimeType,p=void 0!==u.withCredentials;u=null;var h=/^(file:|(\w+:)?\/\/[^\/?#]+)/,m=h.exec(location)[0],_=h.exec(n),g=!_,v=_?_[0]:m,w=m==v;navigator.userAgent.match(/chrome/i)&&"file:"==v&&(w=!1);var k=n.match(/[.]js$/i);if(s.log("GiLoad: is_relative="+g+", same_origin="+w+", binary_supported="+d+", crossorigin_supported="+p),k&&w)return s.log("GiLoad: trying old-fashioned load..."),window.processBase64Zcode=function(e){o(a(e))},void jQuery.ajax(n,{type:"GET",dataType:"script",cache:!0,error:function(r,s,t){e.io.fatal_error("The story could not be loaded. ("+n+"): Error "+s+": "+t)}});if(k){if(s.log("GiLoad: trying script load..."),window.processBase64Zcode=function(e){o(a(e))},!(x=$("head")).length)return void e.io.fatal_error("This page has no <head> element!");var b=$("<script>",{src:n,type:"text/javascript"});x.get(0).appendChild(b.get(0))}else{if(d&&w)return s.log("GiLoad: trying binary load..."),void jQuery.ajax(n,{type:"GET",beforeSend:function(e,n){e.overrideMimeType("text/plain; charset=x-user-defined")},success:function(e,n,r){o(t(e))},error:function(r,s,t){e.io.fatal_error("The story could not be loaded. ("+n+"): Error "+s+": "+t)}});if("file:"!=v){var y=n;if(g&&(y=new URL(n,document.location.href).href,s.log("GiLoad: absolutize "+n+" to "+y)),p)return s.log("GiLoad: trying proxy load... ("+e.proxy_url+")"),void jQuery.ajax(e.proxy_url,{type:"GET",data:{encode:"base64",url:y},error:function(r,s,t){e.io.fatal_error("The story could not be loaded. ("+n+"): Error "+s+": "+t)},success:function(e,n,r){o(a(e))}});var x,M=e.proxy_url+"?encode=base64&callback=processBase64Zcode&url="+y;if(s.log("GiLoad: trying proxy-script load... ("+M+")"),window.processBase64Zcode=function(e){o(a(e))},(x=$("head")).length){b=$("<script>",{src:M,type:"text/javascript"});x.append(b)}else e.io.fatal_error("This page has no <head> element!")}else e.io.fatal_error("The story could not be loaded. ("+n+"): A local file cannot be sent to the proxy.")}}else e.io.fatal_error("No story file specified!");else{switch(s.log("GiLoad: trying pre-loaded load ("+c+")..."),c){case"base64":l=a(l);break;case"raw":l=t(l);break;case"array":break;default:return void e.io.fatal_error("Could not decode story file data: "+c)}o(l)}},inited:function(){return r},getlibrary:function(n){switch(n){case"GlkOte":return s;case"GiDispa":return e.GiDispa;case"Blorb":return e.Blorb;case"VM":return e.vm;case"IO":return e.io}return null}}},o=new a;try{t.GiLoad=o,t.GiLoadClass=a}catch(e){}const l=e.Quixe,i=s.GiDispaClass,c=t.GiLoad;export{i as GiDispa,c as GiLoad,l as Quixe};